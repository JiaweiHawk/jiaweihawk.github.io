---
title: 操作系统：设计与实现
date: 2021-07-24 21:14:17
tags: ["操作系统", "手写"]
categories: ["手写"]
---

# 前言

  因为比较欠缺计算机基础知识，这里特别选取了南京大学蒋炎岩老师的[《操作系统：设计与实现》](http://jyywiki.cn/OS/2021/)，从而从理论和实践两方面，补全操作系统相关的知识
  这些博客将简单记录重要的理论知识，以及全部的相关实验和实验心得，作为成长道路上的积累



# 操作系统概述

## M1打印进程树

### 实验背景
  在Linux中，**everything is a file**。因此操作系统的状态也可以成为文件系统的一部分——在保持文件系统基本API没有变化的基础上，添加相关对象管理操作系统的状态信息。


### 实验描述
> 实验要求：实现pstree，打印进程之间的树状的父子关系
>> Linux系统中可以同时运行多个程序。运行的程序称为**进程**。除了所有进程的根外，每个进程都只有唯一的父进程，你的任务就是将这颗树在命令行中输出。你可以自由选择展示树的方式。

#### 总览

  ```bash
pstree [OPTION]...
```

#### 描述

  把系统中的进程按照父亲-孩子的树状结构打印到终端

- \-p --show-pids:打印每个进程的进程号
- \-n --numeric-sort:按照pid的数值从小到大顺序输出一个进程的直接孩子
- \-V --version:打印版本信息

  你可以在命令行中观察系统的`pstree`的执行行为。这些参数可能任意组合

#### 解释

  上述实验要求是参照man page的格式写出的，其中有很多UNIX命令行工具遵守的共同约定，部分如下所示:
  1. 中括号括起来的参数是可选参数,[]后的...代表参数的0次或多次重复。因此\-p、\-n、\-V都是可选的参数
  2. 同一个选项可以有不同的名字。在`pstree`中，\-p和\-\-show-pids的含义相同
  3. 若不另行说明，整数范围在32位有符号整数范围内；但如果数值和文件大小有关，则其合法的范围是0到系统最大支持的文件大小
  此外，`main`函数的返回值代表了命令执行的状态，其中`EXIT_SUCCESS`表示命令执行成功，`EXIT_FAILURE`表示执行失败。对于`POSIX`来说，0表示成功，非0表示失败

### 实验指南
  保持良好的模块化，既可以将复杂的问题分解为多个较为简单的问题并依次解决；亦方便进行调试和维护。整个实验实际上可以分为五部分：
  1. 获取命令行参数，根据要求设置标志变量的数值
  2. 获取系统中所有进程的编号(每个进程都会有唯一编号)并保存至列表中
  3. 对列表中的每个编号，获取其父进程
  4. 在内存中将树创建好，并按照命令行参数要求排序
  5. 输出树到终端上

### 设置实验环境

  按照[指导手册](http://jyywiki.cn/OS/2021/labs/Labs)中说明的，我们从github上拉取相关的实验
  ```bash
git clone https://github.com/NJU-ProjectN/os-workbench.git nju_os
```

  之后在该目录下拉取相关的实验代码即可
  ```bash
cd nju_os
git pull origin M1
```



### 实验实现

  下面是个人的思路及其实现, [实验实现](nju_os.tar.gz)

#### 命令行参数

  获取命令行参数的话，就是`main`中的两个参数`int argc`和`char *argv[]`，其中`argc`表示参数的个数， `argv`存储具体参数
  我们在该部分一方面需要获取传递入的参数信息；另一方面，还需要对其进行简单的解析。这里简单说明一下思考情况及解析规则：
  1. 可能一个命令行参数中包含多个程序参数，如`pstree -pn`
  2. 可能重复出现多个程序参数，如`pstree -pVVp --show-pids`

  根据观察系统`pstree`命令的表现，其应该具有如下规则：
  1. 当命令行参数中包含`-V`或`--version`程序参数时
