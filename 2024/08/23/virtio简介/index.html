<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>virtio简介 | H4wk1ns's blog</title><meta name="keywords" content="qemu,虚拟化"><meta name="author" content="H4wk1ns"><meta name="copyright" content="H4wk1ns"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言在传统的设备模拟中，Qemu仿真完整的物理设备，每次guest的I&#x2F;O操作都需要vm_exit和vcpu irq，如下所示 为了提高虚拟机的I&#x2F;O效率，virtio协议被制定出来。在该方案中，guest能够感知到自己处于虚拟化环境，并且会加载相应的virtio总线驱动和virtio设备驱动与virtio设备进行通信，避免了guest的每次I&#x2F;O操作都需要vm_exit和vcpu irq(仍然需">
<meta property="og:type" content="article">
<meta property="og:title" content="virtio简介">
<meta property="og:url" content="https://jiaweihawk.github.io/2024/08/23/virtio%E7%AE%80%E4%BB%8B/index.html">
<meta property="og:site_name" content="H4wk1ns&#39;s blog">
<meta property="og:description" content="前言在传统的设备模拟中，Qemu仿真完整的物理设备，每次guest的I&#x2F;O操作都需要vm_exit和vcpu irq，如下所示 为了提高虚拟机的I&#x2F;O效率，virtio协议被制定出来。在该方案中，guest能够感知到自己处于虚拟化环境，并且会加载相应的virtio总线驱动和virtio设备驱动与virtio设备进行通信，避免了guest的每次I&#x2F;O操作都需要vm_exit和vcpu irq(仍然需">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jiaweihawk.github.io/img/background.jpg">
<meta property="article:published_time" content="2024-08-23T15:05:52.000Z">
<meta property="article:modified_time" content="2024-10-17T15:54:07.098Z">
<meta property="article:author" content="H4wk1ns">
<meta property="article:tag" content="qemu">
<meta property="article:tag" content="虚拟化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jiaweihawk.github.io/img/background.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://jiaweihawk.github.io/2024/08/23/virtio%E7%AE%80%E4%BB%8B/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'virtio简介',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-17 23:54:07'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><link rel="stylesheet" href="/static/css/custom.css"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/profile.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">45</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/background.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">H4wk1ns's blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">virtio简介</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-08-23T15:05:52.000Z" title="发表于 2024-08-23 23:05:52">2024-08-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-10-17T15:54:07.098Z" title="更新于 2024-10-17 23:54:07">2024-10-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%99%9A%E6%8B%9F%E5%8C%96/">虚拟化</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">20.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>112分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="virtio简介"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在传统的设备模拟中，Qemu仿真完整的物理设备，每次<strong>guest</strong>的I/O操作都需要<strong>vm_exit</strong>和<strong>vcpu irq</strong>，如下所示<br><img src="全虚拟化.png" alt="全虚拟化示意图"></p>
<p>为了提高虚拟机的I/O效率，virtio协议被制定出来。在该方案中，<strong>guest</strong>能够感知到自己处于虚拟化环境，并且会加载相应的virtio总线驱动和virtio设备驱动与virtio设备进行通信，避免了<strong>guest</strong>的每次I/O操作都需要<strong>vm_exit</strong>和<strong>vcpu irq</strong>(仍然需要<strong>vm_exit</strong>和<strong>vcpu irq</strong>，但是将传统模拟中极多的<strong>vm_exit</strong>转换为<strong>virtio shared memory</strong>通信)，如下所示<br><img src="virtio示意图.png" alt="virtio示意图"></p>
<h1 id="virtio协议"><a href="#virtio协议" class="headerlink" title="virtio协议"></a>virtio协议</h1><p>根据<a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/cs01/virtio-v1.2-cs01.html#x1-100002">virtio标准2.</a>中的内容，virtio设备往往包含如下组件</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/cs01/virtio-v1.2-cs01.html#x1-270006">One or more virtqueues</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/cs01/virtio-v1.2-cs01.html#x1-220005">Device Configuration space</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/cs01/virtio-v1.2-cs01.html#x1-180003">Notifications</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/cs01/virtio-v1.2-cs01.html#x1-110001">Device status field</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/cs01/virtio-v1.2-cs01.html#x1-140002">Feature bits</a></li>
</ul>
<h2 id="virtqueue"><a href="#virtqueue" class="headerlink" title="virtqueue"></a>virtqueue</h2><p><strong>virtio设备</strong>和<strong>guest</strong>批量数据传输的机制被称为<strong>virtqueue</strong>，驱动和<strong>virtio设备</strong>共享<strong>virtqueue</strong>内存，整体如下所示(这里仅仅介绍<a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/cs01/virtio-v1.2-cs01.html#x1-350007">split virtqueues</a>，不介绍<a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/cs01/virtio-v1.2-cs01.html#x1-720008">packed virtqueues</a>)<br><img src="virtqueue示意图.png" alt="virtqueue示意图"></p>
<p>当驱动希望将请求提供给设备时，它会从<strong>descritor table</strong>中选择一个空闲的buffer并添加到<strong>available vring</strong>，并选择性地触发一个事件，通过发送<strong>通知</strong>(在后续<a href="#notifications">notifications</a>小节中介绍)给<strong>virtio设备</strong>，告知buffer已经准备好</p>
<p>设备在处理请求后，会将<strong>available vring</strong>中已使用的buffer添加到<strong>used vring</strong>中，并选择性地触发一个事件，发送<strong>通知</strong>给<strong>guest</strong>，表示该<strong>buffer</strong>已被使用过</p>
<p>根据<a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/cs01/virtio-v1.2-cs01.html#x1-270006">virtio标准2.6.</a>，<strong>virtqueue</strong>由<strong>descriptor table</strong>、<strong>available ring</strong>和<strong>used ring</strong>构成</p>
<h3 id="descriptor-table"><a href="#descriptor-table" class="headerlink" title="descriptor table"></a>descriptor table</h3><p><strong>descriptor table</strong>指的是驱动为设备准备的buffer，其中每个元素形式如<a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/cs01/virtio-v1.2-cs01.html#x1-430005">virtio标准2.7.5.</a>中定义<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">virtq_desc</span> &#123;</span> </span><br><span class="line">        <span class="comment">/* Address (guest-physical). */</span> </span><br><span class="line">        le64 addr; </span><br><span class="line">        <span class="comment">/* Length. */</span> </span><br><span class="line">        le32 len; </span><br><span class="line"> </span><br><span class="line"><span class="comment">/* This marks a buffer as continuing via the next field. */</span> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VIRTQ_DESC_F_NEXT   1 </span></span><br><span class="line"><span class="comment">/* This marks a buffer as device write-only (otherwise device read-only). */</span> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VIRTQ_DESC_F_WRITE     2 </span></span><br><span class="line"><span class="comment">/* This means the buffer contains a list of buffer descriptors. */</span> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VIRTQ_DESC_F_INDIRECT   4 </span></span><br><span class="line">        <span class="comment">/* The flags as indicated above. */</span> </span><br><span class="line">        le16 flags; </span><br><span class="line">        <span class="comment">/* Next field if flags &amp; NEXT */</span> </span><br><span class="line">        le16 next; </span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure><br>其中，每个描述符描述一个buffer，<strong>addr</strong>是<strong>guest</strong>的物理地址。描述符可以通过<strong>next</strong>进行链式连接，其中每个描述符描述的buffer要么是设备只读guest只写的，要么是设备只写guest只读的(但无论那种其描述符都是设备只读的)，但一个描述符链可以同时包含两种buffer</p>
<p>buffer的具体内容取决于设备类型，最常见的做法是包含一个设备只读头部表明数据类型，并在其后添加一个设备只写尾部以便设备写入</p>
<h3 id="available-ring"><a href="#available-ring" class="headerlink" title="available ring"></a>available ring</h3><p>驱动使用<strong>available ring</strong>将可用buffer提供给设备，其形式如<a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/cs01/virtio-v1.2-cs01.html#x1-490006">virtio标准2.7.6.</a>所示<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">virtq_avail</span> &#123;</span> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VIRTQ_AVAIL_F_NO_INTERRUPT      1 </span></span><br><span class="line">        le16 flags; </span><br><span class="line">        le16 idx; </span><br><span class="line">        le16 ring[ <span class="comment">/* Queue Size */</span> ]; </span><br><span class="line">        le16 used_event; <span class="comment">/* Only if VIRTIO_F_EVENT_IDX */</span> </span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure></p>
<p>其中，<strong>ring</strong>每个元素指向<strong>descriptor table</strong>中的描述符链，其仅由驱动写入，由设备读取</p>
<p><strong>idx</strong>表示驱动将下一个<strong>ring</strong>元素的位置，仅由驱动维护。除此之外，设备会维护一个<strong>last_avail_idx</strong>，表示设备使用过的最后一个<strong>ring</strong>元素的位置，即<strong>(last_avail_idx, idx)</strong>时所有可用的<strong>ring</strong>元素</p>
<h3 id="used-ring"><a href="#used-ring" class="headerlink" title="used ring"></a>used ring</h3><p>类似的，设备使用<strong>used ring</strong>将已用buffer提供给设备，其形式如<a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/cs01/virtio-v1.2-cs01.html#x1-540008">virtio标准2.7.8.</a>所示<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">virtq_used</span> &#123;</span> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VIRTQ_USED_F_NO_NOTIFY  1 </span></span><br><span class="line">        le16 flags; </span><br><span class="line">        le16 idx; </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">virtq_used_elem</span> <span class="title">ring</span>[ /* <span class="title">Queue</span> <span class="title">Size</span> */];</span> </span><br><span class="line">        le16 avail_event; <span class="comment">/* Only if VIRTIO_F_EVENT_IDX */</span> </span><br><span class="line">&#125;; </span><br><span class="line"> </span><br><span class="line"><span class="comment">/* le32 is used here for ids for padding reasons. */</span> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">virtq_used_elem</span> &#123;</span> </span><br><span class="line">        <span class="comment">/* Index of start of used descriptor chain. */</span> </span><br><span class="line">        le32 id; </span><br><span class="line">        <span class="comment">/* </span></span><br><span class="line"><span class="comment">         * The number of bytes written into the device writable portion of </span></span><br><span class="line"><span class="comment">         * the buffer described by the descriptor chain. </span></span><br><span class="line"><span class="comment">         */</span> </span><br><span class="line">        le32 len; </span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure></p>
<p>其中，<strong>ring</strong>每个元素包含指向<strong>descriptor table</strong>中描述符链的<strong>id</strong>和设备实际写入的字节数<strong>len</strong>，其仅由设备写入，由驱动读取</p>
<p><strong>idx</strong>表示设备将下一个<strong>ring</strong>元素的位置，仅由设备维护。除此之外，驱动会维护一个<strong>last_used_idx</strong>，表示驱动使用过的最后一个<strong>ring</strong>元素的位置，即<strong>(last_used_idx, idx)</strong>时所有可用的<strong>ring</strong>元素</p>
<h2 id="device-configuration-space"><a href="#device-configuration-space" class="headerlink" title="device configuration space"></a>device configuration space</h2><p><strong>设备配置空间</strong>通常用于那些很少更改或在初始化时设定的参数。不同于<strong>PCI设备</strong>的配置空间，其是设备相关的，即不同类型的设备有不同的<strong>设备配置空间</strong>，如<strong>virtio-net</strong>设备的<strong>设备配置空间</strong>如<a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/cs01/virtio-v1.2-cs01.html#x1-2230004">virtio标准5.1.4.</a>所示而<strong>virtio-blk</strong>设备的<strong>设备配置空间</strong>如<a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/cs01/virtio-v1.2-cs01.html#x1-2790004">virtio标准5.2.4.</a>所示。</p>
<h2 id="notifications"><a href="#notifications" class="headerlink" title="notifications"></a>notifications</h2><p>驱动和<strong>virtio设备</strong>通过<strong>notifications</strong>来向对方表明有信息需要传达，根据<a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/cs01/virtio-v1.2-cs01.html#x1-180003">virtio标准2.3.</a>可知，共有三种：</p>
<ul>
<li>设备变更通知</li>
<li>可用buffer通知</li>
<li>已用buffer通知</li>
</ul>
<p>这些通知在不同的设备接口下有不同的表现形式</p>
<h3 id="设备变更通知"><a href="#设备变更通知" class="headerlink" title="设备变更通知"></a>设备变更通知</h3><p>设备变更通知是由设备发送给<strong>guest</strong>，表示前面介绍的<a href="#device-configuration-space">设备配置空间</a>发生了更改。</p>
<p>一般是Qemu利用硬件机制注入设置改变MSIx中断</p>
<h3 id="已用buffer通知"><a href="#已用buffer通知" class="headerlink" title="已用buffer通知"></a>已用buffer通知</h3><p>类似的，已用buffer通知也是由设备发送给<strong>guest</strong>，表示前面介绍的<a href="#used-ring">used vring</a>上更新了新的已用buffer。</p>
<p>一般是Qemu注入对应的MSIx中断</p>
<h3 id="可用buffer通知"><a href="#可用buffer通知" class="headerlink" title="可用buffer通知"></a>可用buffer通知</h3><p>可用buffer通知则是由<strong>guest</strong>驱动发送给设备的，表示前面介绍的<a href="#available-ring">available vring</a>上更新了新的可用buffer。</p>
<p>一般是Qemu设置一段特定的<strong>MMIO</strong>空间，驱动访问后触发<strong>vm_exit</strong>退出到<strong>kvm</strong>后利用ioeventfd机制通知Qemu</p>
<h2 id="device-status-field"><a href="#device-status-field" class="headerlink" title="device status field"></a>device status field</h2><p>在virtio驱动初始化设备期间，virtio驱动将按照<a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/cs01/virtio-v1.2-cs01.html#x1-1070001">virtio标准3.1.</a>中的步骤进行操作，而<strong>device status field</strong>提供了对初始化过程中已完成步骤的简单低级指示。可以将其想象成连接到控制台上的交通信号灯，每个信号灯表示一个设备的状态。</p>
<p>其初始化过程如下所示</p>
<ol>
<li>重置设备</li>
<li>设置<strong>ACKNOWLEDGE</strong>状态位，表明<strong>guest</strong>已经检测到设备</li>
<li>设置<strong>DRIVER</strong>状态位，表明<strong>guest</strong>知道是用什么驱动与设备交互</li>
<li>读取设备<strong>feature bits</strong>，并将驱动理解的<strong>feature bits</strong>子集写入设备</li>
<li>设置<strong>FEATURES_OK</strong>状态位。此步骤后，驱动不得接受新的<strong>feature bits</strong></li>
<li>重新读取<strong>device status field</strong>，确保<strong>FEATURES_OK</strong>状态位仍然设置着：否则设备不支持驱动设置的<strong>feature bits</strong>子集，设备将无法使用</li>
<li>执行设备的相关设置，包括配置设备<strong>virtqueue</strong>等</li>
<li>设置<strong>DRIVER_OK</strong>状态位。表示设备已经被初始化</li>
</ol>
<p><strong>device status field</strong>初始化为0，并在重置过程中由设备重新初始化为0</p>
<h3 id="ACKNOWLEDGE"><a href="#ACKNOWLEDGE" class="headerlink" title="ACKNOWLEDGE"></a>ACKNOWLEDGE</h3><p><strong>ACKNOWLEDGE</strong>的值是1，该字段被设置表明<strong>guest</strong>已经检测到设备并将其识别为有效的<strong>virtio设备</strong></p>
<h3 id="DRIVER"><a href="#DRIVER" class="headerlink" title="DRIVER"></a>DRIVER</h3><p><strong>DRIVER</strong>的值是2，该字段被设置表明<strong>guest</strong>知道如何驱动该设备，即知道使用什么驱动与设备交互</p>
<h3 id="FAILED"><a href="#FAILED" class="headerlink" title="FAILED"></a>FAILED</h3><p><strong>FAILED</strong>的值是128，该字段被设置表明<strong>guest</strong>中有错误，已经放弃了该<strong>virtio设备</strong>。该错误可能是内部错误、驱动错误或者设备操作过程中发生的致命错误</p>
<h3 id="FEATURES-OK"><a href="#FEATURES-OK" class="headerlink" title="FEATURES_OK"></a>FEATURES_OK</h3><p><strong>FEATURES_OK</strong>的值是8，该字段被设置表明<strong>guest</strong>的驱动和设备的<strong>feature bits</strong>协商完成</p>
<h3 id="DRIVER-OK"><a href="#DRIVER-OK" class="headerlink" title="DRIVER_OK"></a>DRIVER_OK</h3><p><strong>DRIVER_OK</strong>的值是4，该字段被设置表明<strong>guest</strong>的驱动已经设置好设备，可以正常驱动设备</p>
<h3 id="DEVICE-NEEDS-RESET"><a href="#DEVICE-NEEDS-RESET" class="headerlink" title="DEVICE_NEEDS_RESET"></a>DEVICE_NEEDS_RESET</h3><p><strong>DRIVER_OK</strong>的值是64，该字段被设置表明<strong>virtio设备</strong>遇到了无法恢复的错误</p>
<h2 id="feature-bits"><a href="#feature-bits" class="headerlink" title="feature bits"></a>feature bits</h2><p>每个<strong>virtio设备</strong>都有自己支持的<strong>feature bits</strong>集合。</p>
<p>在设备初始化期间，驱动会读取这些<strong>feature bits</strong>集合，并告知设备驱动支持的子集。</p>
<p>这种机制支持前向和后向兼容性：即如果设备通过新增<strong>feature bit</strong>进行了增强，较旧的驱动程序不会将该新增的<strong>feature bit</strong>告知给设备；类似的，如果驱动新增了设备不支持的<strong>feature bit</strong>，则其无法从设备中读取到新增的<strong>feature bit</strong></p>
<h1 id="virtio-transport"><a href="#virtio-transport" class="headerlink" title="virtio transport"></a>virtio transport</h1><p>根据<a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/cs01/virtio-v1.2-cs01.html#x1-1140004">virtio标准4.</a>可知，<strong>virtio协议</strong>可以使用各种不同的总线，因此<strong>virtio协议</strong>被分为通用部分和总线相关部分。即<strong>virtio协议</strong>规定都需要有<a href="#virtio协议">前面小节</a>介绍的5个组件，但驱动和<strong>virtio</strong>设备如何设置这些组件就是总线相关的。其主要可分为<strong>Virtio Over PCI Bus</strong>、<strong>Virtio Over MMIO</strong>和<strong>Virtio Over Channel I/O</strong>，而<strong>virtio-net-pci设备</strong>自然属于是<strong>Virtio Over PCI BUS</strong>。</p>
<p>根据<a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/cs01/virtio-v1.2-cs01.html#x1-1210003">virtio标准4.1.3.</a>可知，<strong>Virtio Over PCI BUS</strong>通过<strong>PCI Capabilities</strong>来设置<strong>virtio协议</strong>。根据<a href="/2024/08/04/qemu%E7%9A%84PCI%E8%AE%BE%E5%A4%87/" title="qemu的PCI设备">qemu的PCI设备</a>可知，标准的<strong>PCI配置空间</strong>如下图所示<br><img src="PCI配置空间.png" alt="PCI配置空间"></p>
<p>其中<strong>virtio协议</strong>使用这些<strong>PCI Capabilities</strong>作为<strong>virtio</strong>结构的配置空间，如下所示<br><img src="virtio的PCI配置空间.png" alt="virtio的PCI配置空间"></p>
<h2 id="capability"><a href="#capability" class="headerlink" title="capability"></a>capability</h2><p>具体的，每个配置空间的位置由下述格式的<strong>PCI Capabilities</strong>指定<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">virtio_pci_cap</span> &#123;</span> </span><br><span class="line">        u8 cap_vndr;    <span class="comment">/* Generic PCI field: PCI_CAP_ID_VNDR */</span> </span><br><span class="line">        u8 cap_next;    <span class="comment">/* Generic PCI field: next ptr. */</span> </span><br><span class="line">        u8 cap_len;     <span class="comment">/* Generic PCI field: capability length */</span> </span><br><span class="line">        u8 cfg_type;    <span class="comment">/* Identifies the structure. */</span> </span><br><span class="line">        u8 bar;         <span class="comment">/* Where to find it. */</span> </span><br><span class="line">        u8 id;          <span class="comment">/* Multiple capabilities of the same type */</span> </span><br><span class="line">        u8 padding[<span class="number">2</span>];  <span class="comment">/* Pad to full dword. */</span> </span><br><span class="line">        le32 offset;    <span class="comment">/* Offset within bar. */</span> </span><br><span class="line">        le32 length;    <span class="comment">/* Length of the structure, in bytes. */</span> </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><strong>cap_vndr</strong>字段值为0x9，用于标识vendor；<strong>cap_next</strong>字段指向下一个<strong>PCI Capability</strong>在<strong>PCI设置空间</strong>的偏移</li>
<li><strong>cap_len</strong>字段表示当前<strong>capability</strong>的长度，包括紧跟在<strong>struct virtio_pci_cap</strong>后的数据</li>
<li><strong>cfg_type</strong>字段表示<strong>capability</strong>配置空间的类型，包括<strong>VIRTIO_PCI_CAP_COMMON_CFG</strong>、<strong>VIRTIO_PCI_CAP_NOTIFY_CFG</strong>、<strong>VIRTIO_PCI_CAP_ISR_CFG</strong>、<strong>VIRTIO_PCI_CAP_DEVICE_CFG</strong>、<strong>VIRTIO_PCI_CAP_PCI_CFG</strong>、<strong>VIRTIO_PCI_CAP_SHARED_MEMORY_CFG</strong>和<strong>VIRTIO_PCI_CAP_VENDOR_CFG</strong></li>
<li><strong>bar</strong>字段指向<strong>PCI配置空间</strong>的<strong>BAR</strong>寄存器，将组件配置空间映射到<strong>BAR</strong>寄存器指向的内存空间或I/O空间</li>
<li><strong>id</strong>字段用于唯一标识<strong>capability</strong></li>
<li><strong>offset</strong>字段表示组件配置空间在<strong>BAR</strong>空间的起始偏移</li>
<li><strong>length</strong>字段表示组件配置空间在<strong>BAR</strong>空间的长度</li>
</ul>
<p>其中，此结构根据<strong>cfg_type</strong>字段还会再数据结构后跟随额外的数据，例如<strong>VIRTIO_PCI_CAP_NOTIFY_CFG</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">virtio_pci_notify_cap</span> &#123;</span> </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">virtio_pci_cap</span> <span class="title">cap</span>;</span> </span><br><span class="line">        le32 notify_off_multiplier; <span class="comment">/* Multiplier for queue_notify_off. */</span> </span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure></p>
<h2 id="配置空间"><a href="#配置空间" class="headerlink" title="配置空间"></a>配置空间</h2><p>根据前面的描述，<strong>capability</strong>配置空间包含<strong>VIRTIO_PCI_CAP_COMMON_CFG</strong>、<strong>VIRTIO_PCI_CAP_NOTIFY_CFG</strong>、<strong>VIRTIO_PCI_CAP_ISR_CFG</strong>、<strong>VIRTIO_PCI_CAP_DEVICE_CFG</strong>、<strong>VIRTIO_PCI_CAP_PCI_CFG</strong>、<strong>VIRTIO_PCI_CAP_SHARED_MEMORY_CFG</strong>和<strong>VIRTIO_PCI_CAP_VENDOR_CFG</strong>等。</p>
<p>这里以最重要的<strong>VIRTIO_PCI_CAP_COMMON_CFG</strong>配置空间为例，根据<a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/cs01/virtio-v1.2-cs01.html#x1-1270003">virtio标准4.1.4.3.</a>，其配置空间结构如下所示<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">virtio_pci_common_cfg</span> &#123;</span> </span><br><span class="line">        <span class="comment">/* About the whole device. */</span> </span><br><span class="line">        le32 device_feature_select;     <span class="comment">/* read-write */</span> </span><br><span class="line">        le32 device_feature;            <span class="comment">/* read-only for driver */</span> </span><br><span class="line">        le32 driver_feature_select;     <span class="comment">/* read-write */</span> </span><br><span class="line">        le32 driver_feature;            <span class="comment">/* read-write */</span> </span><br><span class="line">        le16 config_msix_vector;        <span class="comment">/* read-write */</span> </span><br><span class="line">        le16 num_queues;                <span class="comment">/* read-only for driver */</span> </span><br><span class="line">        u8 device_status;               <span class="comment">/* read-write */</span> </span><br><span class="line">        u8 config_generation;           <span class="comment">/* read-only for driver */</span> </span><br><span class="line"> </span><br><span class="line">        <span class="comment">/* About a specific virtqueue. */</span> </span><br><span class="line">        le16 queue_select;              <span class="comment">/* read-write */</span> </span><br><span class="line">        le16 queue_size;                <span class="comment">/* read-write */</span> </span><br><span class="line">        le16 queue_msix_vector;         <span class="comment">/* read-write */</span> </span><br><span class="line">        le16 queue_enable;              <span class="comment">/* read-write */</span> </span><br><span class="line">        le16 queue_notify_off;          <span class="comment">/* read-only for driver */</span> </span><br><span class="line">        le64 queue_desc;                <span class="comment">/* read-write */</span> </span><br><span class="line">        le64 queue_driver;              <span class="comment">/* read-write */</span> </span><br><span class="line">        le64 queue_device;              <span class="comment">/* read-write */</span> </span><br><span class="line">        le16 queue_notify_data;         <span class="comment">/* read-only for driver */</span> </span><br><span class="line">        le16 queue_reset;               <span class="comment">/* read-write */</span> </span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure><br>可以看到，其包含了前面<a href="#virtqueue">virtqueue</a>、<a href="#device-status-field">device status field</a>和<a href="#feature-bits">feature bits</a>等相关信息。具体的，其每个字段含义如下所示</p>
<ul>
<li><strong>device_feature_select</strong>字段被驱动用来选择读取设备哪些<a href="#feature-bits"><strong>feature bits</strong></a>。例如值0表示读取低32位的<a href="#feature-bits"><strong>feature bits</strong></a>，值1表示读取高32位的<a href="#feature-bits"><strong>feature bits</strong></a></li>
<li><strong>device_feature</strong>字段则是驱动通过<strong>device_feature_select</strong>选择的设备的对应<a href="#feature-bits"><strong>feature bits</strong></a></li>
<li><strong>driver_feature_select</strong>字段类似<strong>device_feature_select</strong>字段，被驱动用来选择想写入设备的<a href="#feature-bits"><strong>feature bits</strong></a>范围。值0表示写入低32位的<a href="#feature-bits"><strong>feature bits</strong></a>，值1表示写入高32位的<a href="#feature-bits"><strong>feature bits</strong></a></li>
<li><strong>driver_feature</strong>字段则是驱动通过<strong>driver_feature_select</strong>选择的写入设备的对应<a href="#feature-bits"><strong>feature bits</strong></a></li>
<li><strong>config_msix_vector</strong>字段用来设置MSI-X的<strong>Configuration Vector</strong></li>
<li><strong>num_queues</strong>字段表示设备支持的<a href="#virtqueue"><strong>virtqueues</strong></a>最大数量</li>
<li><strong>device_status</strong>字段用来设置<a href="#device-status-field"><strong>device status</strong></a></li>
<li><strong>config_generation</strong>字段会被设备每次更改设置后变化</li>
<li><strong>queue_select</strong>字段用来表示后续<strong>queue_</strong>字段所设置的<a href="#virtqueue"><strong>virtqueue</strong></a>序号</li>
<li><strong>queue_size</strong>字段用来表示<strong>queue_select</strong>指定的<a href="#virtqueue"><strong>virtqueue</strong></a>的大小</li>
<li><strong>queue_msix_vector</strong>字段用来指定<strong>queue_select</strong>指定的<a href="#virtqueue"><strong>virtqueue</strong></a>的MSI-X向量</li>
<li><strong>queue_enable</strong>字段用来指定<strong>queue_select</strong>指定的<a href="#virtqueue"><strong>virtqueue</strong></a>是否被启用</li>
<li><strong>queue_notify_off</strong>字段用来计算<strong>queue_select</strong>指定的<a href="#virtqueue"><strong>virtqueue</strong></a>的<strong>notification</strong>在<strong>VIRTIO_PCI_CAP_NOTIFY_CFG</strong>配置空间的偏移</li>
<li><strong>queue_desc</strong>字段用来指定<strong>queue_select</strong>指定的<a href="#virtqueue"><strong>virtqueue</strong></a>的<strong>descriptor table</strong>的物理地址</li>
<li><strong>queue_driver</strong>字段用来指定<strong>queue_select</strong>指定的<a href="#virtqueue"><strong>virtqueue</strong></a>的<strong>available ring</strong>的物理地址</li>
<li><strong>queue_device</strong>字段用来指定<strong>queue_select</strong>指定的<a href="#virtqueue"><strong>virtqueue</strong></a>的<strong>used ring</strong>的物理地址</li>
<li><strong>queue_reset</strong>字段用来指定<strong>queue_select</strong>指定的<a href="#virtqueue"><strong>virtqueue</strong></a>是否需要被重置</li>
</ul>
<p>可以看到，基本包含了之前接介绍的<a href="#virtio协议">virtio协议组件</a>的设置内容</p>
<h1 id="virtio设备"><a href="#virtio设备" class="headerlink" title="virtio设备"></a>virtio设备</h1><p>这里我们以<strong>virtio-net-pci</strong>为例，分析一下Qemu中的<strong>virtio</strong>协议</p>
<p><strong>virtio-pci</strong>类型的设备并没有静态的<strong>TypeInfo</strong>变量，其是通过<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-pci.c#L2569"><strong>virtio_pci_types_register()</strong></a>动态生成并注册对应的<strong>TypeInfo</strong>。<strong>virtio-net-pci</strong>就是让<strong>virtio_pci_types_register()</strong>基于<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-net-pci.c#L93"><strong>virtio_net_pci_info</strong></a>生成对应的<strong>TypeInfo</strong>变量并注册，如下所示<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> VirtioPCIDeviceTypeInfo virtio_net_pci_info = &#123;</span><br><span class="line">    .base_name             = TYPE_VIRTIO_NET_PCI,</span><br><span class="line">    .generic_name          = <span class="string">&quot;virtio-net-pci&quot;</span>,</span><br><span class="line">    .transitional_name     = <span class="string">&quot;virtio-net-pci-transitional&quot;</span>,</span><br><span class="line">    .non_transitional_name = <span class="string">&quot;virtio-net-pci-non-transitional&quot;</span>,</span><br><span class="line">    .instance_size = <span class="keyword">sizeof</span>(VirtIONetPCI),</span><br><span class="line">    .instance_init = virtio_net_pci_instance_init,</span><br><span class="line">    .class_init    = virtio_net_pci_class_init,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_net_pci_register</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    virtio_pci_types_register(&amp;virtio_net_pci_info);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">virtio_pci_types_register</span><span class="params">(<span class="type">const</span> VirtioPCIDeviceTypeInfo *t)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *base_name = <span class="literal">NULL</span>;</span><br><span class="line">    TypeInfo base_type_info = &#123;</span><br><span class="line">        .name          = t-&gt;base_name,</span><br><span class="line">        .parent        = t-&gt;parent ? t-&gt;parent : TYPE_VIRTIO_PCI,</span><br><span class="line">        .instance_size = t-&gt;instance_size,</span><br><span class="line">        .instance_init = t-&gt;instance_init,</span><br><span class="line">        .instance_finalize = t-&gt;instance_finalize,</span><br><span class="line">        .class_size    = t-&gt;class_size,</span><br><span class="line">        .abstract      = <span class="literal">true</span>,</span><br><span class="line">        .interfaces    = t-&gt;interfaces,</span><br><span class="line">    &#125;;</span><br><span class="line">    TypeInfo generic_type_info = &#123;</span><br><span class="line">        .name = t-&gt;generic_name,</span><br><span class="line">        .parent = base_type_info.name,</span><br><span class="line">        .class_init = virtio_pci_generic_class_init,</span><br><span class="line">        .interfaces = (InterfaceInfo[]) &#123;</span><br><span class="line">            &#123; INTERFACE_PCIE_DEVICE &#125;,</span><br><span class="line">            &#123; INTERFACE_CONVENTIONAL_PCI_DEVICE &#125;,</span><br><span class="line">            &#123; &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!base_type_info.name) &#123;</span><br><span class="line">        <span class="comment">/* No base type -&gt; register a single generic device type */</span></span><br><span class="line">        <span class="comment">/* use intermediate %s-base-type to add generic device props */</span></span><br><span class="line">        base_name = g_strdup_printf(<span class="string">&quot;%s-base-type&quot;</span>, t-&gt;generic_name);</span><br><span class="line">        base_type_info.name = base_name;</span><br><span class="line">        base_type_info.class_init = virtio_pci_generic_class_init;</span><br><span class="line"></span><br><span class="line">        generic_type_info.parent = base_name;</span><br><span class="line">        generic_type_info.class_init = virtio_pci_base_class_init;</span><br><span class="line">        generic_type_info.class_data = (<span class="type">void</span> *)t;</span><br><span class="line"></span><br><span class="line">        assert(!t-&gt;non_transitional_name);</span><br><span class="line">        assert(!t-&gt;transitional_name);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        base_type_info.class_init = virtio_pci_base_class_init;</span><br><span class="line">        base_type_info.class_data = (<span class="type">void</span> *)t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    type_register(&amp;base_type_info);</span><br><span class="line">    <span class="keyword">if</span> (generic_type_info.name) &#123;</span><br><span class="line">        type_register(&amp;generic_type_info);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>实际最后会生成如下的<strong>TypeInfo</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; frame </span><br><span class="line"><span class="comment">#0  virtio_pci_types_register (t=0x555556ed8840 &lt;virtio_net_pci_info&gt;) at ../../qemu/hw/virtio/virtio-pci.c:2616</span></span><br><span class="line">2616	    <span class="keyword">if</span> (t-&gt;non_transitional_name) &#123;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; p generic_type_info </span><br><span class="line"><span class="variable">$1</span> = &#123;</span><br><span class="line">  name = 0x5555562ddbf5 <span class="string">&quot;virtio-net-pci&quot;</span>,</span><br><span class="line">  parent = 0x5555562ddbb6 <span class="string">&quot;virtio-net-pci-base&quot;</span>,</span><br><span class="line">  instance_size = 0,</span><br><span class="line">  instance_align = 0,</span><br><span class="line">  instance_init = 0x0,</span><br><span class="line">  instance_post_init = 0x0,</span><br><span class="line">  instance_finalize = 0x0,</span><br><span class="line">  abstract = <span class="literal">false</span>,</span><br><span class="line">  class_size = 0,</span><br><span class="line">  class_init = 0x555555b74f0b &lt;virtio_pci_generic_class_init&gt;,</span><br><span class="line">  class_base_init = 0x0,</span><br><span class="line">  class_data = 0x0,</span><br><span class="line">  interfaces = 0x7fffffffd700</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><p>要想分析<strong>virtio设备</strong>的初始化过程，需要罗列相关的<strong>TypeInfo</strong>变量，如下所示<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p generic_type_info </span><br><span class="line"><span class="variable">$4</span> = &#123;</span><br><span class="line">  name = 0x5555562ddbf5 <span class="string">&quot;virtio-net-pci&quot;</span>,</span><br><span class="line">  parent = 0x5555562ddbb6 <span class="string">&quot;virtio-net-pci-base&quot;</span>,</span><br><span class="line">  instance_size = 0,</span><br><span class="line">  instance_align = 0,</span><br><span class="line">  instance_init = 0x0,</span><br><span class="line">  instance_post_init = 0x0,</span><br><span class="line">  instance_finalize = 0x0,</span><br><span class="line">  abstract = <span class="literal">false</span>,</span><br><span class="line">  class_size = 0,</span><br><span class="line">  class_init = 0x555555b74f0b &lt;virtio_pci_generic_class_init&gt;,</span><br><span class="line">  class_base_init = 0x0,</span><br><span class="line">  class_data = 0x0,</span><br><span class="line">  interfaces = 0x7fffffffd700</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; p base_type_info </span><br><span class="line"><span class="variable">$5</span> = &#123;</span><br><span class="line">  name = 0x5555562ddbb6 <span class="string">&quot;virtio-net-pci-base&quot;</span>,</span><br><span class="line">  parent = 0x55555626674d <span class="string">&quot;virtio-pci&quot;</span>,</span><br><span class="line">  instance_size = 43376,</span><br><span class="line">  instance_align = 0,</span><br><span class="line">  instance_init = 0x555555e0fa2b &lt;virtio_net_pci_instance_init&gt;,</span><br><span class="line">  instance_post_init = 0x0,</span><br><span class="line">  instance_finalize = 0x0,</span><br><span class="line">  abstract = <span class="literal">true</span>,</span><br><span class="line">  class_size = 0,</span><br><span class="line">  class_init = 0x555555b74ec1 &lt;virtio_pci_base_class_init&gt;,</span><br><span class="line">  class_base_init = 0x0,</span><br><span class="line">  class_data = 0x555556ed8840 &lt;virtio_net_pci_info&gt;,</span><br><span class="line">  interfaces = 0x0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; p virtio_pci_info </span><br><span class="line"><span class="variable">$6</span> = &#123;</span><br><span class="line">  name = 0x55555626674d <span class="string">&quot;virtio-pci&quot;</span>,</span><br><span class="line">  parent = 0x5555562666ba <span class="string">&quot;pci-device&quot;</span>,</span><br><span class="line">  instance_size = 34032,</span><br><span class="line">  instance_align = 0,</span><br><span class="line">  instance_init = 0x0,</span><br><span class="line">  instance_post_init = 0x0,</span><br><span class="line">  instance_finalize = 0x0,</span><br><span class="line">  abstract = <span class="literal">true</span>,</span><br><span class="line">  class_size = 248,</span><br><span class="line">  class_init = 0x555555b74dd1 &lt;virtio_pci_class_init&gt;,</span><br><span class="line">  class_base_init = 0x0,</span><br><span class="line">  class_data = 0x0,</span><br><span class="line">  interfaces = 0x0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; p pci_device_type_info</span><br><span class="line"><span class="variable">$7</span> = &#123;</span><br><span class="line">  name = 0x55555623a47a <span class="string">&quot;pci-device&quot;</span>,</span><br><span class="line">  parent = 0x55555623a35d <span class="string">&quot;device&quot;</span>,</span><br><span class="line">  instance_size = 2608,</span><br><span class="line">  instance_align = 0,</span><br><span class="line">  instance_init = 0x0,</span><br><span class="line">  instance_post_init = 0x0,</span><br><span class="line">  instance_finalize = 0x0,</span><br><span class="line">  abstract = <span class="literal">true</span>,</span><br><span class="line">  class_size = 232,</span><br><span class="line">  class_init = 0x555555a9c002 &lt;pci_device_class_init&gt;,</span><br><span class="line">  class_base_init = 0x555555a9c07d &lt;pci_device_class_base_init&gt;,</span><br><span class="line">  class_data = 0x0,</span><br><span class="line">  interfaces = 0x0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; p device_type_info </span><br><span class="line"><span class="variable">$8</span> = &#123;</span><br><span class="line">  name = 0x5555562f9c0d <span class="string">&quot;device&quot;</span>,</span><br><span class="line">  parent = 0x5555562f9f27 <span class="string">&quot;object&quot;</span>,</span><br><span class="line">  instance_size = 160,</span><br><span class="line">  instance_align = 0,</span><br><span class="line">  instance_init = 0x555555e9ca7f &lt;device_initfn&gt;,</span><br><span class="line">  instance_post_init = 0x555555e9caf9 &lt;device_post_init&gt;,</span><br><span class="line">  instance_finalize = 0x555555e9cb30 &lt;device_finalize&gt;,</span><br><span class="line">  abstract = <span class="literal">true</span>,</span><br><span class="line">  class_size = 176,</span><br><span class="line">  class_init = 0x555555e9cf54 &lt;device_class_init&gt;,</span><br><span class="line">  class_base_init = 0x555555e9cd10 &lt;device_class_base_init&gt;,</span><br><span class="line">  class_data = 0x0,</span><br><span class="line">  interfaces = 0x5555570085a0 &lt;__compound_literal.0&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，<strong>virtio_pci_info</strong>的<strong>class_size</strong>字段非0，因此<strong>virtio设备</strong>使用<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/include/hw/virtio/virtio-pci.h#L108"><strong>struct VirtioPCIClass</strong></a>表征其类信息；<strong>base_type_info</strong>的<strong>instance_size</strong>字段非0，根据前面<a href="#virtio设备">virtio设备</a>小节的内容，因此<strong>virtio设备</strong>使用<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-net-pci.c#L36"><strong>struct VirtIONetPCI</strong></a>表征其对象信息。</p>
<h3 id="类初始化"><a href="#类初始化" class="headerlink" title="类初始化"></a>类初始化</h3><p>根据<a href="#初始化">前面小节</a>的内容，<strong>virtio设备</strong>使用<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-pci.c#L2546"><strong>virtio_pci_generic_class_init()</strong></a>、<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-pci.c#L2538"><strong>virtio_pci_base_class_init()</strong></a>、<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-pci.c#L2504"><strong>virtio_pci_class_init()</strong></a>、<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/pci/pci.c#L2628"><strong>pci_device_class_init()</strong></a>和<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/core/qdev.c#L801"><strong>device_class_init()</strong></a>分别初始化对应的类数据结构，如下所示<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_pci_generic_class_init</span><span class="params">(ObjectClass *klass, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    DeviceClass *dc = DEVICE_CLASS(klass);</span><br><span class="line"></span><br><span class="line">    device_class_set_props(dc, virtio_pci_generic_properties);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_pci_base_class_init</span><span class="params">(ObjectClass *klass, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> VirtioPCIDeviceTypeInfo *t = data;</span><br><span class="line">    <span class="keyword">if</span> (t-&gt;class_init) &#123;</span><br><span class="line">        t-&gt;class_init(klass, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_pci_class_init</span><span class="params">(ObjectClass *klass, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    DeviceClass *dc = DEVICE_CLASS(klass);</span><br><span class="line">    PCIDeviceClass *k = PCI_DEVICE_CLASS(klass);</span><br><span class="line">    VirtioPCIClass *vpciklass = VIRTIO_PCI_CLASS(klass);</span><br><span class="line">    ResettableClass *rc = RESETTABLE_CLASS(klass);</span><br><span class="line"></span><br><span class="line">    device_class_set_props(dc, virtio_pci_properties);</span><br><span class="line">    k-&gt;realize = virtio_pci_realize;</span><br><span class="line">    k-&gt;<span class="built_in">exit</span> = virtio_pci_exit;</span><br><span class="line">    k-&gt;vendor_id = PCI_VENDOR_ID_REDHAT_QUMRANET;</span><br><span class="line">    k-&gt;revision = VIRTIO_PCI_ABI_VERSION;</span><br><span class="line">    k-&gt;class_id = PCI_CLASS_OTHERS;</span><br><span class="line">    device_class_set_parent_realize(dc, virtio_pci_dc_realize,</span><br><span class="line">                                    &amp;vpciklass-&gt;parent_dc_realize);</span><br><span class="line">    rc-&gt;phases.hold = virtio_pci_bus_reset_hold;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">pci_device_class_init</span><span class="params">(ObjectClass *klass, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    DeviceClass *k = DEVICE_CLASS(klass);</span><br><span class="line"></span><br><span class="line">    k-&gt;realize = pci_qdev_realize;</span><br><span class="line">    k-&gt;unrealize = pci_qdev_unrealize;</span><br><span class="line">    k-&gt;bus_type = TYPE_PCI_BUS;</span><br><span class="line">    device_class_set_props(k, pci_props);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">device_class_init</span><span class="params">(ObjectClass *class, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    DeviceClass *dc = DEVICE_CLASS(class);</span><br><span class="line">    VMStateIfClass *vc = VMSTATE_IF_CLASS(class);</span><br><span class="line">    ResettableClass *rc = RESETTABLE_CLASS(class);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span>-&gt;</span>unparent = device_unparent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* by default all devices were considered as hotpluggable,</span></span><br><span class="line"><span class="comment">     * so with intent to check it in generic qdev_unplug() /</span></span><br><span class="line"><span class="comment">     * device_set_realized() functions make every device</span></span><br><span class="line"><span class="comment">     * hotpluggable. Devices that shouldn&#x27;t be hotpluggable,</span></span><br><span class="line"><span class="comment">     * should override it in their class_init()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    dc-&gt;hotpluggable = <span class="literal">true</span>;</span><br><span class="line">    dc-&gt;user_creatable = <span class="literal">true</span>;</span><br><span class="line">    vc-&gt;get_id = device_vmstate_if_get_id;</span><br><span class="line">    rc-&gt;get_state = device_get_reset_state;</span><br><span class="line">    rc-&gt;child_foreach = device_reset_child_foreach;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * @device_phases_reset is put as the default reset method below, allowing</span></span><br><span class="line"><span class="comment">     * to do the multi-phase transition from base classes to leaf classes. It</span></span><br><span class="line"><span class="comment">     * allows a legacy-reset Device class to extend a multi-phases-reset</span></span><br><span class="line"><span class="comment">     * Device class for the following reason:</span></span><br><span class="line"><span class="comment">     * + If a base class B has been moved to multi-phase, then it does not</span></span><br><span class="line"><span class="comment">     *   override this default reset method and may have defined phase methods.</span></span><br><span class="line"><span class="comment">     * + A child class C (extending class B) which uses</span></span><br><span class="line"><span class="comment">     *   device_class_set_parent_reset() (or similar means) to override the</span></span><br><span class="line"><span class="comment">     *   reset method will still work as expected. @device_phases_reset function</span></span><br><span class="line"><span class="comment">     *   will be registered as the parent reset method and effectively call</span></span><br><span class="line"><span class="comment">     *   parent reset phases.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    dc-&gt;reset = device_phases_reset;</span><br><span class="line">    rc-&gt;get_transitional_function = device_get_transitional_reset;</span><br><span class="line"></span><br><span class="line">    object_class_property_add_bool(class, <span class="string">&quot;realized&quot;</span>,</span><br><span class="line">                                   device_get_realized, device_set_realized);</span><br><span class="line">    object_class_property_add_bool(class, <span class="string">&quot;hotpluggable&quot;</span>,</span><br><span class="line">                                   device_get_hotpluggable, <span class="literal">NULL</span>);</span><br><span class="line">    object_class_property_add_bool(class, <span class="string">&quot;hotplugged&quot;</span>,</span><br><span class="line">                                   device_get_hotplugged, <span class="literal">NULL</span>);</span><br><span class="line">    object_class_property_add_link(class, <span class="string">&quot;parent_bus&quot;</span>, TYPE_BUS,</span><br><span class="line">                                   offsetof(DeviceState, parent_bus), <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>其中，根据<a href="#初始化">前面初始化</a>的内容，<strong>virtio_pci_base_class_init()</strong>的参数是<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-net-pci.c#L93"><strong>virtio_net_pci_info</strong></a>，其<strong>class_init</strong>字段为<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-net-pci.c#L67"><strong>virtio_net_pci_class_init()</strong></a>，如下所示<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_net_pci_class_init</span><span class="params">(ObjectClass *klass, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    DeviceClass *dc = DEVICE_CLASS(klass);</span><br><span class="line">    PCIDeviceClass *k = PCI_DEVICE_CLASS(klass);</span><br><span class="line">    VirtioPCIClass *vpciklass = VIRTIO_PCI_CLASS(klass);</span><br><span class="line"></span><br><span class="line">    k-&gt;romfile = <span class="string">&quot;efi-virtio.rom&quot;</span>;</span><br><span class="line">    k-&gt;vendor_id = PCI_VENDOR_ID_REDHAT_QUMRANET;</span><br><span class="line">    k-&gt;device_id = PCI_DEVICE_ID_VIRTIO_NET;</span><br><span class="line">    k-&gt;revision = VIRTIO_PCI_ABI_VERSION;</span><br><span class="line">    k-&gt;class_id = PCI_CLASS_NETWORK_ETHERNET;</span><br><span class="line">    set_bit(DEVICE_CATEGORY_NETWORK, dc-&gt;categories);</span><br><span class="line">    device_class_set_props(dc, virtio_net_properties);</span><br><span class="line">    vpciklass-&gt;realize = virtio_net_pci_realize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>可以看到，这些类的初始化基本就是覆盖父类的<strong>realize</strong>函数指针或当前类的<strong>parent_dc_realize</strong>函数指针，从而在实例化时执行相关的逻辑</p>
<h3 id="对象初始化"><a href="#对象初始化" class="headerlink" title="对象初始化"></a>对象初始化</h3><p><strong>virtio设备</strong>使用<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-net-pci.c#L83"><strong>virtio_net_pci_instance_init()</strong></a>和<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/core/qdev.c#L652"><strong>device_initfn()</strong></a>来初始化对应的对象数据结构，如下所示<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#0  virtio_net_pci_instance_init (obj=0x5555580bdd70) at ../../qemu/hw/virtio/virtio-net-pci.c:85</span></span><br><span class="line"><span class="comment">//#1  0x0000555555ea793a in object_init_with_type (obj=0x5555580bdd70, ti=0x5555570e88f0) at ../../qemu/qom/object.c:429</span></span><br><span class="line"><span class="comment">//#2  0x0000555555ea791c in object_init_with_type (obj=0x5555580bdd70, ti=0x5555570e8ab0) at ../../qemu/qom/object.c:425</span></span><br><span class="line"><span class="comment">//#3  0x0000555555ea7f00 in object_initialize_with_type (obj=0x5555580bdd70, size=43376, type=0x5555570e8ab0) at ../../qemu/qom/object.c:571</span></span><br><span class="line"><span class="comment">//#4  0x0000555555ea86cf in object_new_with_type (type=0x5555570e8ab0) at ../../qemu/qom/object.c:791</span></span><br><span class="line"><span class="comment">//#5  0x0000555555ea873b in object_new (typename=0x5555580bbfd0 &quot;virtio-net-pci&quot;) at ../../qemu/qom/object.c:806</span></span><br><span class="line"><span class="comment">//#6  0x0000555555e9ff6a in qdev_new (name=0x5555580bbfd0 &quot;virtio-net-pci&quot;) at ../../qemu/hw/core/qdev.c:166</span></span><br><span class="line"><span class="comment">//#7  0x0000555555bd01c4 in qdev_device_add_from_qdict (opts=0x5555580bc3b0, from_json=false, errp=0x7fffffffd6a0) at ../../qemu/system/qdev-monitor.c:681</span></span><br><span class="line"><span class="comment">//#8  0x0000555555bd03d9 in qdev_device_add (opts=0x5555570f7230, errp=0x55555706a160 &lt;error_fatal&gt;) at ../../qemu/system/qdev-monitor.c:737</span></span><br><span class="line"><span class="comment">//#9  0x0000555555bda4e7 in device_init_func (opaque=0x0, opts=0x5555570f7230, errp=0x55555706a160 &lt;error_fatal&gt;) at ../../qemu/system/vl.c:1200</span></span><br><span class="line"><span class="comment">//#10 0x00005555560c2a63 in qemu_opts_foreach (list=0x555556f53ec0 &lt;qemu_device_opts&gt;, func=0x555555bda4bc &lt;device_init_func&gt;, opaque=0x0, errp=0x55555706a160 &lt;error_fatal&gt;) at ../../qemu/util/qemu-option.c:1135</span></span><br><span class="line"><span class="comment">//#11 0x0000555555bde1b8 in qemu_create_cli_devices () at ../../qemu/system/vl.c:2637</span></span><br><span class="line"><span class="comment">//#12 0x0000555555bde3fe in qmp_x_exit_preconfig (errp=0x55555706a160 &lt;error_fatal&gt;) at ../../qemu/system/vl.c:2706</span></span><br><span class="line"><span class="comment">//#13 0x0000555555be0db6 in qemu_init (argc=39, argv=0x7fffffffdae8) at ../../qemu/system/vl.c:3739</span></span><br><span class="line"><span class="comment">//#14 0x0000555555e9b7ed in main (argc=39, argv=0x7fffffffdae8) at ../../qemu/system/main.c:47</span></span><br><span class="line"><span class="comment">//#15 0x00007ffff7629d90 in __libc_start_call_main (main=main@entry=0x555555e9b7c9 &lt;main&gt;, argc=argc@entry=39, argv=argv@entry=0x7fffffffdae8) at ../sysdeps/nptl/libc_start_call_main.h:58</span></span><br><span class="line"><span class="comment">//#16 0x00007ffff7629e40 in __libc_start_main_impl (main=0x555555e9b7c9 &lt;main&gt;, argc=39, argv=0x7fffffffdae8, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7fffffffdad8) at ../csu/libc-start.c:392</span></span><br><span class="line"><span class="comment">//#17 0x000055555586f0d5 in _start ()</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_net_pci_instance_init</span><span class="params">(Object *obj)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtIONetPCI *dev = VIRTIO_NET_PCI(obj);</span><br><span class="line"></span><br><span class="line">    virtio_instance_init_common(obj, &amp;dev-&gt;vdev, <span class="keyword">sizeof</span>(dev-&gt;vdev),</span><br><span class="line">                                TYPE_VIRTIO_NET);</span><br><span class="line">    object_property_add_alias(obj, <span class="string">&quot;bootindex&quot;</span>, OBJECT(&amp;dev-&gt;vdev),</span><br><span class="line">                              <span class="string">&quot;bootindex&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//#0  device_initfn (obj=0x5555580bdd70) at ../../qemu/hw/core/qdev.c:654</span></span><br><span class="line"><span class="comment">//#1  0x0000555555ea793a in object_init_with_type (obj=0x5555580bdd70, ti=0x5555570ec4a0) at ../../qemu/qom/object.c:429</span></span><br><span class="line"><span class="comment">//#2  0x0000555555ea791c in object_init_with_type (obj=0x5555580bdd70, ti=0x5555570a7830) at ../../qemu/qom/object.c:425</span></span><br><span class="line"><span class="comment">//#3  0x0000555555ea791c in object_init_with_type (obj=0x5555580bdd70, ti=0x5555570b5a80) at ../../qemu/qom/object.c:425</span></span><br><span class="line"><span class="comment">//#4  0x0000555555ea791c in object_init_with_type (obj=0x5555580bdd70, ti=0x5555570e88f0) at ../../qemu/qom/object.c:425</span></span><br><span class="line"><span class="comment">//#5  0x0000555555ea791c in object_init_with_type (obj=0x5555580bdd70, ti=0x5555570e8ab0) at ../../qemu/qom/object.c:425</span></span><br><span class="line"><span class="comment">//#6  0x0000555555ea7f00 in object_initialize_with_type (obj=0x5555580bdd70, size=43376, type=0x5555570e8ab0) at ../../qemu/qom/object.c:571</span></span><br><span class="line"><span class="comment">//#7  0x0000555555ea86cf in object_new_with_type (type=0x5555570e8ab0) at ../../qemu/qom/object.c:791</span></span><br><span class="line"><span class="comment">//#8  0x0000555555ea873b in object_new (typename=0x5555580bbfd0 &quot;virtio-net-pci&quot;) at ../../qemu/qom/object.c:806</span></span><br><span class="line"><span class="comment">//#9  0x0000555555e9ff6a in qdev_new (name=0x5555580bbfd0 &quot;virtio-net-pci&quot;) at ../../qemu/hw/core/qdev.c:166</span></span><br><span class="line"><span class="comment">//#10 0x0000555555bd01c4 in qdev_device_add_from_qdict (opts=0x5555580bc3b0, from_json=false, errp=0x7fffffffd690) at ../../qemu/system/qdev-monitor.c:681</span></span><br><span class="line"><span class="comment">//#11 0x0000555555bd03d9 in qdev_device_add (opts=0x5555570f7230, errp=0x55555706a160 &lt;error_fatal&gt;) at ../../qemu/system/qdev-monitor.c:737</span></span><br><span class="line"><span class="comment">//#12 0x0000555555bda4e7 in device_init_func (opaque=0x0, opts=0x5555570f7230, errp=0x55555706a160 &lt;error_fatal&gt;) at ../../qemu/system/vl.c:1200</span></span><br><span class="line"><span class="comment">//#13 0x00005555560c2a63 in qemu_opts_foreach (list=0x555556f53ec0 &lt;qemu_device_opts&gt;, func=0x555555bda4bc &lt;device_init_func&gt;, opaque=0x0, errp=0x55555706a160 &lt;error_fatal&gt;) at ../../qemu/util/qemu-option.c:1135</span></span><br><span class="line"><span class="comment">//#14 0x0000555555bde1b8 in qemu_create_cli_devices () at ../../qemu/system/vl.c:2637</span></span><br><span class="line"><span class="comment">//#15 0x0000555555bde3fe in qmp_x_exit_preconfig (errp=0x55555706a160 &lt;error_fatal&gt;) at ../../qemu/system/vl.c:2706</span></span><br><span class="line"><span class="comment">//#16 0x0000555555be0db6 in qemu_init (argc=39, argv=0x7fffffffdad8) at ../../qemu/system/vl.c:3739</span></span><br><span class="line"><span class="comment">//#17 0x0000555555e9b7ed in main (argc=39, argv=0x7fffffffdad8) at ../../qemu/system/main.c:47</span></span><br><span class="line"><span class="comment">//#18 0x00007ffff7629d90 in __libc_start_call_main (main=main@entry=0x555555e9b7c9 &lt;main&gt;, argc=argc@entry=39, argv=argv@entry=0x7fffffffdad8) at ../sysdeps/nptl/libc_start_call_main.h:58</span></span><br><span class="line"><span class="comment">//#19 0x00007ffff7629e40 in __libc_start_main_impl (main=0x555555e9b7c9 &lt;main&gt;, argc=39, argv=0x7fffffffdad8, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7fffffffdac8) at ../csu/libc-start.c:392</span></span><br><span class="line"><span class="comment">//#20 0x000055555586f0d5 in _start ()</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">device_initfn</span><span class="params">(Object *obj)</span></span><br><span class="line">&#123;</span><br><span class="line">    DeviceState *dev = DEVICE(obj);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (phase_check(PHASE_MACHINE_READY)) &#123;</span><br><span class="line">        dev-&gt;hotplugged = <span class="number">1</span>;</span><br><span class="line">        qdev_hot_added = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dev-&gt;instance_id_alias = <span class="number">-1</span>;</span><br><span class="line">    dev-&gt;realized = <span class="literal">false</span>;</span><br><span class="line">    dev-&gt;allow_unplug_during_migration = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    QLIST_INIT(&amp;dev-&gt;gpios);</span><br><span class="line">    QLIST_INIT(&amp;dev-&gt;clocks);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这里仅仅是初始化了必要的字段。</p>
<h2 id="实例化"><a href="#实例化" class="headerlink" title="实例化"></a>实例化</h2><p>根据前面<a href="#类初始化">类初始化</a>的内容，<strong>virtio</strong>设备将其父类数据结构的<strong>realize</strong>函数指针依次设置为了<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-pci.c#L2490"><strong>virtio_pci_dc_realize()</strong></a>、<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-pci.c#L2272"><strong>virtio_pci_realize()</strong></a>和<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-net-pci.c#L49"><strong>virtio_net_pci_realize()</strong></a>，而<strong>virtio-pci</strong>类的<strong>parent_dc_realize</strong>字段为<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/pci/pci.c#L2031"><strong>pci_qdev_realize()</strong></a><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#0  virtio_net_pci_realize (vpci_dev=0x5555580a4fa0, errp=0x7fffffffd2f0) at ../../qemu/hw/virtio/virtio-net-pci.c:51</span></span><br><span class="line"><span class="comment">//#1  0x0000555555b749a9 in virtio_pci_realize (pci_dev=0x5555580a4fa0, errp=0x7fffffffd2f0) at ../../qemu/hw/virtio/virtio-pci.c:2407</span></span><br><span class="line"><span class="comment">//#2  0x0000555555a9a921 in pci_qdev_realize (qdev=0x5555580a4fa0, errp=0x7fffffffd3b0) at ../../qemu/hw/pci/pci.c:2093</span></span><br><span class="line"><span class="comment">//#3  0x0000555555b74dc4 in virtio_pci_dc_realize (qdev=0x5555580a4fa0, errp=0x7fffffffd3b0) at ../../qemu/hw/virtio/virtio-pci.c:2501</span></span><br><span class="line"><span class="comment">//#4  0x0000555555e9c4f4 in device_set_realized (obj=0x5555580a4fa0, value=true, errp=0x7fffffffd620) at ../../qemu/hw/core/qdev.c:510</span></span><br><span class="line"><span class="comment">//#5  0x0000555555ea7cfb in property_set_bool (obj=0x5555580a4fa0, v=0x5555580b51a0, name=0x5555562f9dd1 &quot;realized&quot;, opaque=0x5555570f4510, errp=0x7fffffffd620) at ../../qemu/qom/object.c:2358</span></span><br><span class="line"><span class="comment">//#6  0x0000555555ea5891 in object_property_set (obj=0x5555580a4fa0, name=0x5555562f9dd1 &quot;realized&quot;, v=0x5555580b51a0, errp=0x7fffffffd620) at ../../qemu/qom/object.c:1472</span></span><br><span class="line"><span class="comment">//#7  0x0000555555eaa4ca in object_property_set_qobject (obj=0x5555580a4fa0, name=0x5555562f9dd1 &quot;realized&quot;, value=0x5555580b3d60, errp=0x7fffffffd620) at ../../qemu/qom/qom-qobject.c:28</span></span><br><span class="line"><span class="comment">//#8  0x0000555555ea5c4a in object_property_set_bool (obj=0x5555580a4fa0, name=0x5555562f9dd1 &quot;realized&quot;, value=true, errp=0x7fffffffd620) at ../../qemu/qom/object.c:1541</span></span><br><span class="line"><span class="comment">//#9  0x0000555555e9bc0e in qdev_realize (dev=0x5555580a4fa0, bus=0x555557415420, errp=0x7fffffffd620) at ../../qemu/hw/core/qdev.c:292</span></span><br><span class="line"><span class="comment">//#10 0x0000555555bcdee9 in qdev_device_add_from_qdict (opts=0x5555580a31b0, from_json=false, errp=0x7fffffffd620) at ../../qemu/system/qdev-monitor.c:718</span></span><br><span class="line"><span class="comment">//#11 0x0000555555bcdf99 in qdev_device_add (opts=0x5555570ef1c0, errp=0x555557061f60 &lt;error_fatal&gt;) at ../../qemu/system/qdev-monitor.c:737</span></span><br><span class="line"><span class="comment">//#12 0x0000555555bd80a7 in device_init_func (opaque=0x0, opts=0x5555570ef1c0, errp=0x555557061f60 &lt;error_fatal&gt;) at ../../qemu/system/vl.c:1200</span></span><br><span class="line"><span class="comment">//#13 0x00005555560be1e2 in qemu_opts_foreach (list=0x555556f4bec0 &lt;qemu_device_opts&gt;, func=0x555555bd807c &lt;device_init_func&gt;, opaque=0x0, errp=0x555557061f60 &lt;error_fatal&gt;) at ../../qemu/util/qemu-option.c:1135</span></span><br><span class="line"><span class="comment">//#14 0x0000555555bdbd46 in qemu_create_cli_devices () at ../../qemu/system/vl.c:2637</span></span><br><span class="line"><span class="comment">//#15 0x0000555555bdbf8c in qmp_x_exit_preconfig (errp=0x555557061f60 &lt;error_fatal&gt;) at ../../qemu/system/vl.c:2706</span></span><br><span class="line"><span class="comment">//#16 0x0000555555bde944 in qemu_init (argc=35, argv=0x7fffffffda68) at ../../qemu/system/vl.c:3739</span></span><br><span class="line"><span class="comment">//#17 0x0000555555e96f93 in main (argc=35, argv=0x7fffffffda68) at ../../qemu/system/main.c:47</span></span><br><span class="line"><span class="comment">//#18 0x00007ffff7829d90 in __libc_start_call_main (main=main@entry=0x555555e96f6f &lt;main&gt;, argc=argc@entry=35, argv=argv@entry=0x7fffffffda68) at ../sysdeps/nptl/libc_start_call_main.h:58</span></span><br><span class="line"><span class="comment">//#19 0x00007ffff7829e40 in __libc_start_main_impl (main=0x555555e96f6f &lt;main&gt;, argc=35, argv=0x7fffffffda68, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7fffffffda58) at ../csu/libc-start.c:392</span></span><br><span class="line"><span class="comment">//#20 0x000055555586cc95 in _start ()</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_net_pci_realize</span><span class="params">(VirtIOPCIProxy *vpci_dev, Error **errp)</span></span><br><span class="line">&#123;</span><br><span class="line">    DeviceState *qdev = DEVICE(vpci_dev);</span><br><span class="line">    VirtIONetPCI *dev = VIRTIO_NET_PCI(vpci_dev);</span><br><span class="line">    DeviceState *vdev = DEVICE(&amp;dev-&gt;vdev);</span><br><span class="line">    VirtIONet *net = VIRTIO_NET(vdev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vpci_dev-&gt;nvectors == DEV_NVECTORS_UNSPECIFIED) &#123;</span><br><span class="line">        vpci_dev-&gt;nvectors = <span class="number">2</span> * MAX(net-&gt;nic_conf.peers.queues, <span class="number">1</span>)</span><br><span class="line">            + <span class="number">1</span> <span class="comment">/* Config interrupt */</span></span><br><span class="line">            + <span class="number">1</span> <span class="comment">/* Control vq */</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtio_net_set_netclient_name(&amp;dev-&gt;vdev, qdev-&gt;id,</span><br><span class="line">                                  object_get_typename(OBJECT(qdev)));</span><br><span class="line">    qdev_realize(vdev, BUS(&amp;vpci_dev-&gt;bus), errp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_pci_realize</span><span class="params">(PCIDevice *pci_dev, Error **errp)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtIOPCIProxy *proxy = VIRTIO_PCI(pci_dev);</span><br><span class="line">    VirtioPCIClass *k = VIRTIO_PCI_GET_CLASS(pci_dev);</span><br><span class="line">    <span class="type">bool</span> pcie_port = pci_bus_is_express(pci_get_bus(pci_dev)) &amp;&amp;</span><br><span class="line">                     !pci_bus_is_root(pci_get_bus(pci_dev));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* fd-based ioevents can&#x27;t be synchronized in record/replay */</span></span><br><span class="line">    <span class="keyword">if</span> (replay_mode != REPLAY_MODE_NONE) &#123;</span><br><span class="line">        proxy-&gt;flags &amp;= ~VIRTIO_PCI_FLAG_USE_IOEVENTFD;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * virtio pci bar layout used by default.</span></span><br><span class="line"><span class="comment">     * subclasses can re-arrange things if needed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *   region 0   --  virtio legacy io bar</span></span><br><span class="line"><span class="comment">     *   region 1   --  msi-x bar</span></span><br><span class="line"><span class="comment">     *   region 2   --  virtio modern io bar (off by default)</span></span><br><span class="line"><span class="comment">     *   region 4+5 --  virtio modern memory (64bit) bar</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    proxy-&gt;legacy_io_bar_idx  = <span class="number">0</span>;</span><br><span class="line">    proxy-&gt;msix_bar_idx       = <span class="number">1</span>;</span><br><span class="line">    proxy-&gt;modern_io_bar_idx  = <span class="number">2</span>;</span><br><span class="line">    proxy-&gt;modern_mem_bar_idx = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    proxy-&gt;common.offset = <span class="number">0x0</span>;</span><br><span class="line">    proxy-&gt;common.size = <span class="number">0x1000</span>;</span><br><span class="line">    proxy-&gt;common.type = VIRTIO_PCI_CAP_COMMON_CFG;</span><br><span class="line"></span><br><span class="line">    proxy-&gt;isr.offset = <span class="number">0x1000</span>;</span><br><span class="line">    proxy-&gt;isr.size = <span class="number">0x1000</span>;</span><br><span class="line">    proxy-&gt;isr.type = VIRTIO_PCI_CAP_ISR_CFG;</span><br><span class="line"></span><br><span class="line">    proxy-&gt;device.offset = <span class="number">0x2000</span>;</span><br><span class="line">    proxy-&gt;device.size = <span class="number">0x1000</span>;</span><br><span class="line">    proxy-&gt;device.type = VIRTIO_PCI_CAP_DEVICE_CFG;</span><br><span class="line"></span><br><span class="line">    proxy-&gt;notify.offset = <span class="number">0x3000</span>;</span><br><span class="line">    proxy-&gt;notify.size = virtio_pci_queue_mem_mult(proxy) * VIRTIO_QUEUE_MAX;</span><br><span class="line">    proxy-&gt;notify.type = VIRTIO_PCI_CAP_NOTIFY_CFG;</span><br><span class="line"></span><br><span class="line">    proxy-&gt;notify_pio.offset = <span class="number">0x0</span>;</span><br><span class="line">    proxy-&gt;notify_pio.size = <span class="number">0x4</span>;</span><br><span class="line">    proxy-&gt;notify_pio.type = VIRTIO_PCI_CAP_NOTIFY_CFG;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* subclasses can enforce modern, so do this unconditionally */</span></span><br><span class="line">    <span class="keyword">if</span> (!(proxy-&gt;flags &amp; VIRTIO_PCI_FLAG_VDPA)) &#123;</span><br><span class="line">        memory_region_init(&amp;proxy-&gt;modern_bar, OBJECT(proxy), <span class="string">&quot;virtio-pci&quot;</span>,</span><br><span class="line">                           <span class="comment">/* PCI BAR regions must be powers of 2 */</span></span><br><span class="line">                           pow2ceil(proxy-&gt;notify.offset + proxy-&gt;notify.size));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        proxy-&gt;lm.offset = proxy-&gt;notify.offset + proxy-&gt;notify.size;</span><br><span class="line">        proxy-&gt;lm.size = <span class="number">0x20</span> + VIRTIO_QUEUE_MAX * <span class="number">4</span>;</span><br><span class="line">        memory_region_init(&amp;proxy-&gt;modern_bar, OBJECT(proxy), <span class="string">&quot;virtio-pci&quot;</span>,</span><br><span class="line">                           <span class="comment">/* PCI BAR regions must be powers of 2 */</span></span><br><span class="line">                           pow2ceil(proxy-&gt;lm.offset + proxy-&gt;lm.size));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (proxy-&gt;disable_legacy == ON_OFF_AUTO_AUTO) &#123;</span><br><span class="line">        proxy-&gt;disable_legacy = pcie_port ? ON_OFF_AUTO_ON : ON_OFF_AUTO_OFF;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!virtio_pci_modern(proxy) &amp;&amp; !virtio_pci_legacy(proxy)) &#123;</span><br><span class="line">        error_setg(errp, <span class="string">&quot;device cannot work as neither modern nor legacy mode&quot;</span></span><br><span class="line">                   <span class="string">&quot; is enabled&quot;</span>);</span><br><span class="line">        error_append_hint(errp, <span class="string">&quot;Set either disable-modern or disable-legacy&quot;</span></span><br><span class="line">                          <span class="string">&quot; to off\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pcie_port &amp;&amp; pci_is_express(pci_dev)) &#123;</span><br><span class="line">        <span class="type">int</span> pos;</span><br><span class="line">        <span class="type">uint16_t</span> last_pcie_cap_offset = PCI_CONFIG_SPACE_SIZE;</span><br><span class="line"></span><br><span class="line">        pos = pcie_endpoint_cap_init(pci_dev, <span class="number">0</span>);</span><br><span class="line">        assert(pos &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        pos = pci_add_capability(pci_dev, PCI_CAP_ID_PM, <span class="number">0</span>,</span><br><span class="line">                                 PCI_PM_SIZEOF, errp);</span><br><span class="line">        <span class="keyword">if</span> (pos &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pci_dev-&gt;<span class="built_in">exp</span>.pm_cap = pos;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Indicates that this function complies with revision 1.2 of the</span></span><br><span class="line"><span class="comment">         * PCI Power Management Interface Specification.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        pci_set_word(pci_dev-&gt;config + pos + PCI_PM_PMC, <span class="number">0x3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (proxy-&gt;flags &amp; VIRTIO_PCI_FLAG_AER) &#123;</span><br><span class="line">            pcie_aer_init(pci_dev, PCI_ERR_VER, last_pcie_cap_offset,</span><br><span class="line">                          PCI_ERR_SIZEOF, <span class="literal">NULL</span>);</span><br><span class="line">            last_pcie_cap_offset += PCI_ERR_SIZEOF;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (proxy-&gt;flags &amp; VIRTIO_PCI_FLAG_INIT_DEVERR) &#123;</span><br><span class="line">            <span class="comment">/* Init error enabling flags */</span></span><br><span class="line">            pcie_cap_deverr_init(pci_dev);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (proxy-&gt;flags &amp; VIRTIO_PCI_FLAG_INIT_LNKCTL) &#123;</span><br><span class="line">            <span class="comment">/* Init Link Control Register */</span></span><br><span class="line">            pcie_cap_lnkctl_init(pci_dev);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (proxy-&gt;flags &amp; VIRTIO_PCI_FLAG_INIT_PM) &#123;</span><br><span class="line">            <span class="comment">/* Init Power Management Control Register */</span></span><br><span class="line">            pci_set_word(pci_dev-&gt;wmask + pos + PCI_PM_CTRL,</span><br><span class="line">                         PCI_PM_CTRL_STATE_MASK);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (proxy-&gt;flags &amp; VIRTIO_PCI_FLAG_ATS) &#123;</span><br><span class="line">            pcie_ats_init(pci_dev, last_pcie_cap_offset,</span><br><span class="line">                          proxy-&gt;flags &amp; VIRTIO_PCI_FLAG_ATS_PAGE_ALIGNED);</span><br><span class="line">            last_pcie_cap_offset += PCI_EXT_CAP_ATS_SIZEOF;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (proxy-&gt;flags &amp; VIRTIO_PCI_FLAG_INIT_FLR) &#123;</span><br><span class="line">            <span class="comment">/* Set Function Level Reset capability bit */</span></span><br><span class="line">            pcie_cap_flr_init(pci_dev);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * make future invocations of pci_is_express() return false</span></span><br><span class="line"><span class="comment">         * and pci_config_size() return PCI_CONFIG_SPACE_SIZE.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        pci_dev-&gt;cap_present &amp;= ~QEMU_PCI_CAP_EXPRESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtio_pci_bus_new(&amp;proxy-&gt;bus, <span class="keyword">sizeof</span>(proxy-&gt;bus), proxy);</span><br><span class="line">    <span class="keyword">if</span> (k-&gt;realize) &#123;</span><br><span class="line">        k-&gt;realize(proxy, errp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">pci_qdev_realize</span><span class="params">(DeviceState *qdev, Error **errp)</span></span><br><span class="line">&#123;</span><br><span class="line">    PCIDevice *pci_dev = (PCIDevice *)qdev;</span><br><span class="line">    PCIDeviceClass *pc = PCI_DEVICE_GET_CLASS(pci_dev);</span><br><span class="line">    ObjectClass *klass = OBJECT_CLASS(pc);</span><br><span class="line">    Error *local_err = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">bool</span> is_default_rom;</span><br><span class="line">    <span class="type">uint16_t</span> class_id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * capped by systemd (see: udev-builtin-net_id.c)</span></span><br><span class="line"><span class="comment">     * as it&#x27;s the only known user honor it to avoid users</span></span><br><span class="line"><span class="comment">     * misconfigure QEMU and then wonder why acpi-index doesn&#x27;t work</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (pci_dev-&gt;acpi_index &gt; ONBOARD_INDEX_MAX) &#123;</span><br><span class="line">        error_setg(errp, <span class="string">&quot;acpi-index should be less or equal to %u&quot;</span>,</span><br><span class="line">                   ONBOARD_INDEX_MAX);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * make sure that acpi-index is unique across all present PCI devices</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (pci_dev-&gt;acpi_index) &#123;</span><br><span class="line">        GSequence *used_indexes = pci_acpi_index_list();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (g_sequence_lookup(used_indexes,</span><br><span class="line">                              GINT_TO_POINTER(pci_dev-&gt;acpi_index),</span><br><span class="line">                              g_cmp_uint32, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">            error_setg(errp, <span class="string">&quot;a PCI device with acpi-index = %&quot;</span> PRIu32</span><br><span class="line">                       <span class="string">&quot; already exist&quot;</span>, pci_dev-&gt;acpi_index);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        g_sequence_insert_sorted(used_indexes,</span><br><span class="line">                                 GINT_TO_POINTER(pci_dev-&gt;acpi_index),</span><br><span class="line">                                 g_cmp_uint32, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pci_dev-&gt;romsize != <span class="number">-1</span> &amp;&amp; !is_power_of_2(pci_dev-&gt;romsize)) &#123;</span><br><span class="line">        error_setg(errp, <span class="string">&quot;ROM size %u is not a power of two&quot;</span>, pci_dev-&gt;romsize);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* initialize cap_present for pci_is_express() and pci_config_size(),</span></span><br><span class="line"><span class="comment">     * Note that hybrid PCIs are not set automatically and need to manage</span></span><br><span class="line"><span class="comment">     * QEMU_PCI_CAP_EXPRESS manually */</span></span><br><span class="line">    <span class="keyword">if</span> (object_class_dynamic_cast(klass, INTERFACE_PCIE_DEVICE) &amp;&amp;</span><br><span class="line">       !object_class_dynamic_cast(klass, INTERFACE_CONVENTIONAL_PCI_DEVICE)) &#123;</span><br><span class="line">        pci_dev-&gt;cap_present |= QEMU_PCI_CAP_EXPRESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (object_class_dynamic_cast(klass, INTERFACE_CXL_DEVICE)) &#123;</span><br><span class="line">        pci_dev-&gt;cap_present |= QEMU_PCIE_CAP_CXL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pci_dev = do_pci_register_device(pci_dev,</span><br><span class="line">                                     object_get_typename(OBJECT(qdev)),</span><br><span class="line">                                     pci_dev-&gt;devfn, errp);</span><br><span class="line">    <span class="keyword">if</span> (pci_dev == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pc-&gt;realize) &#123;</span><br><span class="line">        pc-&gt;realize(pci_dev, &amp;local_err);</span><br><span class="line">        <span class="keyword">if</span> (local_err) &#123;</span><br><span class="line">            error_propagate(errp, local_err);</span><br><span class="line">            do_pci_unregister_device(pci_dev);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * A PCIe Downstream Port that do not have ARI Forwarding enabled must</span></span><br><span class="line"><span class="comment">     * associate only Device 0 with the device attached to the bus</span></span><br><span class="line"><span class="comment">     * representing the Link from the Port (PCIe base spec rev 4.0 ver 0.3,</span></span><br><span class="line"><span class="comment">     * sec 7.3.1).</span></span><br><span class="line"><span class="comment">     * With ARI, PCI_SLOT() can return non-zero value as the traditional</span></span><br><span class="line"><span class="comment">     * 5-bit Device Number and 3-bit Function Number fields in its associated</span></span><br><span class="line"><span class="comment">     * Routing IDs, Requester IDs and Completer IDs are interpreted as a</span></span><br><span class="line"><span class="comment">     * single 8-bit Function Number. Hence, ignore ARI capable devices.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (pci_is_express(pci_dev) &amp;&amp;</span><br><span class="line">        !pcie_find_capability(pci_dev, PCI_EXT_CAP_ID_ARI) &amp;&amp;</span><br><span class="line">        pcie_has_upstream_port(pci_dev) &amp;&amp;</span><br><span class="line">        PCI_SLOT(pci_dev-&gt;devfn)) &#123;</span><br><span class="line">        warn_report(<span class="string">&quot;PCI: slot %d is not valid for %s,&quot;</span></span><br><span class="line">                    <span class="string">&quot; parent device only allows plugging into slot 0.&quot;</span>,</span><br><span class="line">                    PCI_SLOT(pci_dev-&gt;devfn), pci_dev-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pci_dev-&gt;failover_pair_id) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!pci_bus_is_express(pci_get_bus(pci_dev))) &#123;</span><br><span class="line">            error_setg(errp, <span class="string">&quot;failover primary device must be on &quot;</span></span><br><span class="line">                             <span class="string">&quot;PCIExpress bus&quot;</span>);</span><br><span class="line">            pci_qdev_unrealize(DEVICE(pci_dev));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        class_id = pci_get_word(pci_dev-&gt;config + PCI_CLASS_DEVICE);</span><br><span class="line">        <span class="keyword">if</span> (class_id != PCI_CLASS_NETWORK_ETHERNET) &#123;</span><br><span class="line">            error_setg(errp, <span class="string">&quot;failover primary device is not an &quot;</span></span><br><span class="line">                             <span class="string">&quot;Ethernet device&quot;</span>);</span><br><span class="line">            pci_qdev_unrealize(DEVICE(pci_dev));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((pci_dev-&gt;cap_present &amp; QEMU_PCI_CAP_MULTIFUNCTION)</span><br><span class="line">            || (PCI_FUNC(pci_dev-&gt;devfn) != <span class="number">0</span>)) &#123;</span><br><span class="line">            error_setg(errp, <span class="string">&quot;failover: primary device must be in its own &quot;</span></span><br><span class="line">                              <span class="string">&quot;PCI slot&quot;</span>);</span><br><span class="line">            pci_qdev_unrealize(DEVICE(pci_dev));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        qdev-&gt;allow_unplug_during_migration = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* rom loading */</span></span><br><span class="line">    is_default_rom = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (pci_dev-&gt;romfile == <span class="literal">NULL</span> &amp;&amp; pc-&gt;romfile != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        pci_dev-&gt;romfile = g_strdup(pc-&gt;romfile);</span><br><span class="line">        is_default_rom = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pci_add_option_rom(pci_dev, is_default_rom, &amp;local_err);</span><br><span class="line">    <span class="keyword">if</span> (local_err) &#123;</span><br><span class="line">        error_propagate(errp, local_err);</span><br><span class="line">        pci_qdev_unrealize(DEVICE(pci_dev));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pci_set_power(pci_dev, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    pci_dev-&gt;msi_trigger = pci_msi_trigger;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_pci_dc_realize</span><span class="params">(DeviceState *qdev, Error **errp)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtioPCIClass *vpciklass = VIRTIO_PCI_GET_CLASS(qdev);</span><br><span class="line">    VirtIOPCIProxy *proxy = VIRTIO_PCI(qdev);</span><br><span class="line">    PCIDevice *pci_dev = &amp;proxy-&gt;pci_dev;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(proxy-&gt;flags &amp; VIRTIO_PCI_FLAG_DISABLE_PCIE) &amp;&amp;</span><br><span class="line">        virtio_pci_modern(proxy)) &#123;</span><br><span class="line">        pci_dev-&gt;cap_present |= QEMU_PCI_CAP_EXPRESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vpciklass-&gt;parent_dc_realize(qdev, errp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>可以看到，在实例化设备时，基于<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/core/qdev.c#L470"><strong>device_set_realized()</strong></a>，不停调用子类在类初始化时覆盖的<strong>realize</strong>函数指针/<strong>parent_dc_realize</strong>函数，从而完成最终的实例化。</p>
<p>具体的，由于<strong>virtio-net-pci设备</strong>属于<strong>Virtio Over PCI BUS</strong>，因此<strong>VirtIONetPCI</strong>对象中包含<strong>VirtIOPCIProxy</strong>对象，即<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-pci.c#L2719"><strong>virtio-pci-bus</strong>总线</a>的<strong>PCIDevice</strong>对象，其相关的实例化在<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-pci.c#L2272"><strong>virtio_pci_realize()</strong></a>，其分配了<strong>VIRTIO_PCI_CAP_COMMON_CFG</strong>、<strong>VIRTIO_PCI_CAP_ISR_CFG</strong>、<strong>VIRTIO_PCI_CAP_DEVICE_CFG</strong>和io的<strong>VIRTIO_PCI_CAP_NOTIFY_CFG</strong>等配置空间，并使用<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-pci.c#L2682"><strong>virtio_pci_bus_new()</strong></a>初始化<strong>VirtIOPCIProxy</strong>总线。但此时还未完成与<strong>guest驱动</strong>的协商，因此此时并不会正常使用，为了与<strong>guest驱动</strong>进行通信协商，还需要实例化<strong>virtio设备</strong>相关信息，其在<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-net-pci.c#L49"><strong>virtio_net_pci_realize()</strong></a>中通过实例化<strong>VirtIONet</strong>对象实现。该对象的<strong>TypeInfo</strong>变量是<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/net/virtio-net.c#L4052">virtio_net_info</a>，如下所示<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> TypeInfo virtio_net_info = &#123;</span><br><span class="line">    .name = TYPE_VIRTIO_NET,</span><br><span class="line">    .parent = TYPE_VIRTIO_DEVICE,</span><br><span class="line">    .instance_size = <span class="keyword">sizeof</span>(VirtIONet),</span><br><span class="line">    .instance_init = virtio_net_instance_init,</span><br><span class="line">    .class_init = virtio_net_class_init,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> TypeInfo virtio_device_info = &#123;</span><br><span class="line">    .name = TYPE_VIRTIO_DEVICE,</span><br><span class="line">    .parent = TYPE_DEVICE,</span><br><span class="line">    .instance_size = <span class="keyword">sizeof</span>(VirtIODevice),</span><br><span class="line">    .class_init = virtio_device_class_init,</span><br><span class="line">    .instance_finalize = virtio_device_instance_finalize,</span><br><span class="line">    .abstract = <span class="literal">true</span>,</span><br><span class="line">    .class_size = <span class="keyword">sizeof</span>(VirtioDeviceClass),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>其<strong>class_init</strong>函数指针分别设置对应的父类<strong>realize</strong>函数指针为<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio.c#L3738">virtio_device_realize()</a>和<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/net/virtio-net.c#L3656">virtio_net_device_realize()</a>，如下所示<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#0  virtio_net_device_realize (dev=0x5555580c6260, errp=0x7fffffffd030) at ../../qemu/hw/net/virtio-net.c:3657</span></span><br><span class="line"><span class="comment">//#1  0x0000555555df39c2 in virtio_device_realize (dev=0x5555580c6260, errp=0x7fffffffd090) at ../../qemu/hw/virtio/virtio.c:3748</span></span><br><span class="line"><span class="comment">//#2  0x0000555555ea0d4e in device_set_realized (obj=0x5555580c6260, value=true, errp=0x7fffffffd360) at ../../qemu/hw/core/qdev.c:510</span></span><br><span class="line"><span class="comment">//#3  0x0000555555eac555 in property_set_bool (obj=0x5555580c6260, v=0x5555580d4190, name=0x555556300c31 &quot;realized&quot;, opaque=0x5555570fc6e0, errp=0x7fffffffd360) at ../../qemu/qom/object.c:2358</span></span><br><span class="line"><span class="comment">//#4  0x0000555555eaa0eb in object_property_set (obj=0x5555580c6260, name=0x555556300c31 &quot;realized&quot;, v=0x5555580d4190, errp=0x7fffffffd360) at ../../qemu/qom/object.c:1472</span></span><br><span class="line"><span class="comment">//#5  0x0000555555eaed24 in object_property_set_qobject (obj=0x5555580c6260, name=0x555556300c31 &quot;realized&quot;, value=0x5555580d40d0, errp=0x7fffffffd360) at ../../qemu/qom/qom-qobject.c:28</span></span><br><span class="line"><span class="comment">//#6  0x0000555555eaa4a4 in object_property_set_bool (obj=0x5555580c6260, name=0x555556300c31 &quot;realized&quot;, value=true, errp=0x7fffffffd360) at ../../qemu/qom/object.c:1541</span></span><br><span class="line"><span class="comment">//#7  0x0000555555ea0468 in qdev_realize (dev=0x5555580c6260, bus=0x5555580c61e0, errp=0x7fffffffd360) at ../../qemu/hw/core/qdev.c:292</span></span><br><span class="line"><span class="comment">//#8  0x0000555555e141a8 in virtio_net_pci_realize (vpci_dev=0x5555580bdd70, errp=0x7fffffffd360) at ../../qemu/hw/virtio/virtio-net-pci.c:64</span></span><br><span class="line"><span class="comment">//#9  0x0000555555b76de9 in virtio_pci_realize (pci_dev=0x5555580bdd70, errp=0x7fffffffd360) at ../../qemu/hw/virtio/virtio-pci.c:2407</span></span><br><span class="line"><span class="comment">//#10 0x0000555555a9cd61 in pci_qdev_realize (qdev=0x5555580bdd70, errp=0x7fffffffd420) at ../../qemu/hw/pci/pci.c:2093</span></span><br><span class="line"><span class="comment">//#11 0x0000555555b77204 in virtio_pci_dc_realize (qdev=0x5555580bdd70, errp=0x7fffffffd420) at ../../qemu/hw/virtio/virtio-pci.c:2501</span></span><br><span class="line"><span class="comment">//#12 0x0000555555ea0d4e in device_set_realized (obj=0x5555580bdd70, value=true, errp=0x7fffffffd690) at ../../qemu/hw/core/qdev.c:510</span></span><br><span class="line"><span class="comment">//#13 0x0000555555eac555 in property_set_bool (obj=0x5555580bdd70, v=0x5555580cdea0, name=0x555556300c31 &quot;realized&quot;, opaque=0x5555570fc6e0, errp=0x7fffffffd690) at ../../qemu/qom/object.c:2358</span></span><br><span class="line"><span class="comment">//#14 0x0000555555eaa0eb in object_property_set (obj=0x5555580bdd70, name=0x555556300c31 &quot;realized&quot;, v=0x5555580cdea0, errp=0x7fffffffd690) at ../../qemu/qom/object.c:1472</span></span><br><span class="line"><span class="comment">//#15 0x0000555555eaed24 in object_property_set_qobject (obj=0x5555580bdd70, name=0x555556300c31 &quot;realized&quot;, value=0x5555580cca90, errp=0x7fffffffd690) at ../../qemu/qom/qom-qobject.c:28</span></span><br><span class="line"><span class="comment">//#16 0x0000555555eaa4a4 in object_property_set_bool (obj=0x5555580bdd70, name=0x555556300c31 &quot;realized&quot;, value=true, errp=0x7fffffffd690) at ../../qemu/qom/object.c:1541</span></span><br><span class="line"><span class="comment">//#17 0x0000555555ea0468 in qdev_realize (dev=0x5555580bdd70, bus=0x555557430730, errp=0x7fffffffd690) at ../../qemu/hw/core/qdev.c:292</span></span><br><span class="line"><span class="comment">//#18 0x0000555555bd0329 in qdev_device_add_from_qdict (opts=0x5555580bc3b0, from_json=false, errp=0x7fffffffd690) at ../../qemu/system/qdev-monitor.c:718</span></span><br><span class="line"><span class="comment">//#19 0x0000555555bd03d9 in qdev_device_add (opts=0x5555570f7230, errp=0x55555706a160 &lt;error_fatal&gt;) at ../../qemu/system/qdev-monitor.c:737</span></span><br><span class="line"><span class="comment">//#20 0x0000555555bda4e7 in device_init_func (opaque=0x0, opts=0x5555570f7230, errp=0x55555706a160 &lt;error_fatal&gt;) at ../../qemu/system/vl.c:1200</span></span><br><span class="line"><span class="comment">//#21 0x00005555560c2a63 in qemu_opts_foreach (list=0x555556f53ec0 &lt;qemu_device_opts&gt;, func=0x555555bda4bc &lt;device_init_func&gt;, opaque=0x0, errp=0x55555706a160 &lt;error_fatal&gt;) at ../../qemu/util/qemu-option.c:1135</span></span><br><span class="line"><span class="comment">//#22 0x0000555555bde1b8 in qemu_create_cli_devices () at ../../qemu/system/vl.c:2637</span></span><br><span class="line"><span class="comment">//#23 0x0000555555bde3fe in qmp_x_exit_preconfig (errp=0x55555706a160 &lt;error_fatal&gt;) at ../../qemu/system/vl.c:2706</span></span><br><span class="line"><span class="comment">//#24 0x0000555555be0db6 in qemu_init (argc=39, argv=0x7fffffffdad8) at ../../qemu/system/vl.c:3739</span></span><br><span class="line"><span class="comment">//#25 0x0000555555e9b7ed in main (argc=39, argv=0x7fffffffdad8) at ../../qemu/system/main.c:47</span></span><br><span class="line"><span class="comment">//#26 0x00007ffff7629d90 in __libc_start_call_main (main=main@entry=0x555555e9b7c9 &lt;main&gt;, argc=argc@entry=39, argv=argv@entry=0x7fffffffdad8) at ../sysdeps/nptl/libc_start_call_main.h:58</span></span><br><span class="line"><span class="comment">//#27 0x00007ffff7629e40 in __libc_start_main_impl (main=0x555555e9b7c9 &lt;main&gt;, argc=39, argv=0x7fffffffdad8, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7fffffffdac8) at ../csu/libc-start.c:392</span></span><br><span class="line"><span class="comment">//#28 0x000055555586f0d5 in _start ()</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_net_device_realize</span><span class="params">(DeviceState *dev, Error **errp)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtIODevice *vdev = VIRTIO_DEVICE(dev);</span><br><span class="line">    VirtIONet *n = VIRTIO_NET(dev);</span><br><span class="line">    NetClientState *nc;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n-&gt;net_conf.mtu) &#123;</span><br><span class="line">        n-&gt;host_features |= (<span class="number">1ULL</span> &lt;&lt; VIRTIO_NET_F_MTU);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n-&gt;net_conf.duplex_str) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strncmp</span>(n-&gt;net_conf.duplex_str, <span class="string">&quot;half&quot;</span>, <span class="number">5</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            n-&gt;net_conf.duplex = DUPLEX_HALF;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(n-&gt;net_conf.duplex_str, <span class="string">&quot;full&quot;</span>, <span class="number">5</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            n-&gt;net_conf.duplex = DUPLEX_FULL;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            error_setg(errp, <span class="string">&quot;&#x27;duplex&#x27; must be &#x27;half&#x27; or &#x27;full&#x27;&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        n-&gt;host_features |= (<span class="number">1ULL</span> &lt;&lt; VIRTIO_NET_F_SPEED_DUPLEX);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        n-&gt;net_conf.duplex = DUPLEX_UNKNOWN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n-&gt;net_conf.speed &lt; SPEED_UNKNOWN) &#123;</span><br><span class="line">        error_setg(errp, <span class="string">&quot;&#x27;speed&#x27; must be between 0 and INT_MAX&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (n-&gt;net_conf.speed &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        n-&gt;host_features |= (<span class="number">1ULL</span> &lt;&lt; VIRTIO_NET_F_SPEED_DUPLEX);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n-&gt;failover) &#123;</span><br><span class="line">        n-&gt;primary_listener.hide_device = failover_hide_primary_device;</span><br><span class="line">        qatomic_set(&amp;n-&gt;failover_primary_hidden, <span class="literal">true</span>);</span><br><span class="line">        device_listener_register(&amp;n-&gt;primary_listener);</span><br><span class="line">        migration_add_notifier(&amp;n-&gt;migration_state,</span><br><span class="line">                               virtio_net_migration_state_notifier);</span><br><span class="line">        n-&gt;host_features |= (<span class="number">1ULL</span> &lt;&lt; VIRTIO_NET_F_STANDBY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtio_net_set_config_size(n, n-&gt;host_features);</span><br><span class="line">    virtio_init(vdev, VIRTIO_ID_NET, n-&gt;config_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * We set a lower limit on RX queue size to what it always was.</span></span><br><span class="line"><span class="comment">     * Guests that want a smaller ring can always resize it without</span></span><br><span class="line"><span class="comment">     * help from us (using virtio 1 and up).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (n-&gt;net_conf.rx_queue_size &lt; VIRTIO_NET_RX_QUEUE_MIN_SIZE ||</span><br><span class="line">        n-&gt;net_conf.rx_queue_size &gt; VIRTQUEUE_MAX_SIZE ||</span><br><span class="line">        !is_power_of_2(n-&gt;net_conf.rx_queue_size)) &#123;</span><br><span class="line">        error_setg(errp, <span class="string">&quot;Invalid rx_queue_size (= %&quot;</span> PRIu16 <span class="string">&quot;), &quot;</span></span><br><span class="line">                   <span class="string">&quot;must be a power of 2 between %d and %d.&quot;</span>,</span><br><span class="line">                   n-&gt;net_conf.rx_queue_size, VIRTIO_NET_RX_QUEUE_MIN_SIZE,</span><br><span class="line">                   VIRTQUEUE_MAX_SIZE);</span><br><span class="line">        virtio_cleanup(vdev);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n-&gt;net_conf.tx_queue_size &lt; VIRTIO_NET_TX_QUEUE_MIN_SIZE ||</span><br><span class="line">        n-&gt;net_conf.tx_queue_size &gt; virtio_net_max_tx_queue_size(n) ||</span><br><span class="line">        !is_power_of_2(n-&gt;net_conf.tx_queue_size)) &#123;</span><br><span class="line">        error_setg(errp, <span class="string">&quot;Invalid tx_queue_size (= %&quot;</span> PRIu16 <span class="string">&quot;), &quot;</span></span><br><span class="line">                   <span class="string">&quot;must be a power of 2 between %d and %d&quot;</span>,</span><br><span class="line">                   n-&gt;net_conf.tx_queue_size, VIRTIO_NET_TX_QUEUE_MIN_SIZE,</span><br><span class="line">                   virtio_net_max_tx_queue_size(n));</span><br><span class="line">        virtio_cleanup(vdev);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    n-&gt;max_ncs = MAX(n-&gt;nic_conf.peers.queues, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Figure out the datapath queue pairs since the backend could</span></span><br><span class="line"><span class="comment">     * provide control queue via peers as well.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (n-&gt;nic_conf.peers.queues) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n-&gt;max_ncs; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (n-&gt;nic_conf.peers.ncs[i]-&gt;is_datapath) &#123;</span><br><span class="line">                ++n-&gt;max_queue_pairs;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    n-&gt;max_queue_pairs = MAX(n-&gt;max_queue_pairs, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n-&gt;max_queue_pairs * <span class="number">2</span> + <span class="number">1</span> &gt; VIRTIO_QUEUE_MAX) &#123;</span><br><span class="line">        error_setg(errp, <span class="string">&quot;Invalid number of queue pairs (= %&quot;</span> PRIu32 <span class="string">&quot;), &quot;</span></span><br><span class="line">                   <span class="string">&quot;must be a positive integer less than %d.&quot;</span>,</span><br><span class="line">                   n-&gt;max_queue_pairs, (VIRTIO_QUEUE_MAX - <span class="number">1</span>) / <span class="number">2</span>);</span><br><span class="line">        virtio_cleanup(vdev);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    n-&gt;vqs = g_new0(VirtIONetQueue, n-&gt;max_queue_pairs);</span><br><span class="line">    n-&gt;curr_queue_pairs = <span class="number">1</span>;</span><br><span class="line">    n-&gt;tx_timeout = n-&gt;net_conf.txtimer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n-&gt;net_conf.tx &amp;&amp; <span class="built_in">strcmp</span>(n-&gt;net_conf.tx, <span class="string">&quot;timer&quot;</span>)</span><br><span class="line">                       &amp;&amp; <span class="built_in">strcmp</span>(n-&gt;net_conf.tx, <span class="string">&quot;bh&quot;</span>)) &#123;</span><br><span class="line">        warn_report(<span class="string">&quot;virtio-net: &quot;</span></span><br><span class="line">                    <span class="string">&quot;Unknown option tx=%s, valid options: \&quot;timer\&quot; \&quot;bh\&quot;&quot;</span>,</span><br><span class="line">                    n-&gt;net_conf.tx);</span><br><span class="line">        error_printf(<span class="string">&quot;Defaulting to \&quot;bh\&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    n-&gt;net_conf.tx_queue_size = MIN(virtio_net_max_tx_queue_size(n),</span><br><span class="line">                                    n-&gt;net_conf.tx_queue_size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n-&gt;max_queue_pairs; i++) &#123;</span><br><span class="line">        virtio_net_add_queue(n, i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    n-&gt;ctrl_vq = virtio_add_queue(vdev, <span class="number">64</span>, virtio_net_handle_ctrl);</span><br><span class="line">    qemu_macaddr_default_if_unset(&amp;n-&gt;nic_conf.macaddr);</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;n-&gt;mac[<span class="number">0</span>], &amp;n-&gt;nic_conf.macaddr, <span class="keyword">sizeof</span>(n-&gt;mac));</span><br><span class="line">    n-&gt;status = VIRTIO_NET_S_LINK_UP;</span><br><span class="line">    qemu_announce_timer_reset(&amp;n-&gt;announce_timer, migrate_announce_params(),</span><br><span class="line">                              QEMU_CLOCK_VIRTUAL,</span><br><span class="line">                              virtio_net_announce_timer, n);</span><br><span class="line">    n-&gt;announce_timer.round = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n-&gt;netclient_type) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Happen when virtio_net_set_netclient_name has been called.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        n-&gt;nic = qemu_new_nic(&amp;net_virtio_info, &amp;n-&gt;nic_conf,</span><br><span class="line">                              n-&gt;netclient_type, n-&gt;netclient_name,</span><br><span class="line">                              &amp;dev-&gt;mem_reentrancy_guard, n);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        n-&gt;nic = qemu_new_nic(&amp;net_virtio_info, &amp;n-&gt;nic_conf,</span><br><span class="line">                              object_get_typename(OBJECT(dev)), dev-&gt;id,</span><br><span class="line">                              &amp;dev-&gt;mem_reentrancy_guard, n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n-&gt;max_queue_pairs; i++) &#123;</span><br><span class="line">        n-&gt;nic-&gt;ncs[i].do_not_pad = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    peer_test_vnet_hdr(n);</span><br><span class="line">    <span class="keyword">if</span> (peer_has_vnet_hdr(n)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n-&gt;max_queue_pairs; i++) &#123;</span><br><span class="line">            qemu_using_vnet_hdr(qemu_get_subqueue(n-&gt;nic, i)-&gt;peer, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        n-&gt;host_hdr_len = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> virtio_net_hdr);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        n-&gt;host_hdr_len = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    qemu_format_nic_info_str(qemu_get_queue(n-&gt;nic), n-&gt;nic_conf.macaddr.a);</span><br><span class="line"></span><br><span class="line">    n-&gt;vqs[<span class="number">0</span>].tx_waiting = <span class="number">0</span>;</span><br><span class="line">    n-&gt;tx_burst = n-&gt;net_conf.txburst;</span><br><span class="line">    virtio_net_set_mrg_rx_bufs(n, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    n-&gt;promisc = <span class="number">1</span>; <span class="comment">/* for compatibility */</span></span><br><span class="line"></span><br><span class="line">    n-&gt;mac_table.macs = g_malloc0(MAC_TABLE_ENTRIES * ETH_ALEN);</span><br><span class="line"></span><br><span class="line">    n-&gt;vlans = g_malloc0(MAX_VLAN &gt;&gt; <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    nc = qemu_get_queue(n-&gt;nic);</span><br><span class="line">    nc-&gt;rxfilter_notify_enabled = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (nc-&gt;peer &amp;&amp; nc-&gt;peer-&gt;info-&gt;type == NET_CLIENT_DRIVER_VHOST_VDPA) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">virtio_net_config</span> <span class="title">netcfg</span> =</span> &#123;&#125;;</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;netcfg.mac, &amp;n-&gt;nic_conf.macaddr, ETH_ALEN);</span><br><span class="line">        vhost_net_set_config(get_vhost_net(nc-&gt;peer),</span><br><span class="line">            (<span class="type">uint8_t</span> *)&amp;netcfg, <span class="number">0</span>, ETH_ALEN, VHOST_SET_CONFIG_TYPE_FRONTEND);</span><br><span class="line">    &#125;</span><br><span class="line">    QTAILQ_INIT(&amp;n-&gt;rsc_chains);</span><br><span class="line">    n-&gt;qdev = dev;</span><br><span class="line"></span><br><span class="line">    net_rx_pkt_init(&amp;n-&gt;rx_pkt);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (virtio_has_feature(n-&gt;host_features, VIRTIO_NET_F_RSS)) &#123;</span><br><span class="line">        virtio_net_load_ebpf(n, errp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_device_realize</span><span class="params">(DeviceState *dev, Error **errp)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtIODevice *vdev = VIRTIO_DEVICE(dev);</span><br><span class="line">    VirtioDeviceClass *vdc = VIRTIO_DEVICE_GET_CLASS(dev);</span><br><span class="line">    Error *err = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Devices should either use vmsd or the load/save methods */</span></span><br><span class="line">    assert(!vdc-&gt;vmsd || !vdc-&gt;load);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vdc-&gt;realize != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        vdc-&gt;realize(dev, &amp;err);</span><br><span class="line">        <span class="keyword">if</span> (err != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            error_propagate(errp, err);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtio_bus_device_plugged(vdev, &amp;err);</span><br><span class="line">    <span class="keyword">if</span> (err != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        error_propagate(errp, err);</span><br><span class="line">        vdc-&gt;unrealize(dev);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vdev-&gt;listener.commit = virtio_memory_listener_commit;</span><br><span class="line">    vdev-&gt;listener.name = <span class="string">&quot;virtio&quot;</span>;</span><br><span class="line">    memory_listener_register(&amp;vdev-&gt;listener, vdev-&gt;dma_as);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，这里实例化了<strong>virtio设备</strong>具体的组件，诸如<strong>virtquues</strong>、<strong>feature bits</strong>等。除此之外，根据<a href="/2024/08/04/qemu%E7%9A%84PCI%E8%AE%BE%E5%A4%87/" title="qemu的PCI设备">qemu的PCI设备</a>，其需要实例化<strong>PCI配置空间</strong>，是在上述<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/net/virtio-net.c#L3656">virtio_net_device_realize()</a>中调用<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-bus.c#L43"><strong>virtio_bus_device_plugged()</strong></a>中实现的。该函数会调用<strong>virtio设备</strong>所在的<strong>bus</strong>的<strong>device_plugged</strong>函数指针进行，而前面<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-pci.c#L2272"><strong>virtio_pci_realize()</strong></a>将<strong>VirtIOPCIProxy</strong>对象设置为<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-pci.c#L2719"><strong>virtio-pci-bus总线</strong></a>，并在<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-net-pci.c#L49"><strong>virtio_net_pci_realize()</strong></a>中将<strong>virtio设备</strong>，即<strong>VirtIONet</strong>对象的总线类型也设为<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-pci.c#L2719"><strong>virtio-pci-bus总线</strong></a>，其在类初始化时将<strong>device_plugged</strong>函数指针设置为<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-pci.c#L2089"><strong>virtio_pci_device_plugged()</strong></a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#0  virtio_pci_device_plugged (d=0x5555580bdd70, errp=0x7fffffffcfd8) at ../../qemu/hw/virtio/virtio-pci.c:2090</span></span><br><span class="line"><span class="comment">//#1  0x0000555555b6fb63 in virtio_bus_device_plugged (vdev=0x5555580c6260, errp=0x7fffffffd030) at ../../qemu/hw/virtio/virtio-bus.c:74</span></span><br><span class="line"><span class="comment">//#2  0x0000555555df39f6 in virtio_device_realize (dev=0x5555580c6260, errp=0x7fffffffd090) at ../../qemu/hw/virtio/virtio.c:3755</span></span><br><span class="line"><span class="comment">//#3  0x0000555555ea0d4e in device_set_realized (obj=0x5555580c6260, value=true, errp=0x7fffffffd360) at ../../qemu/hw/core/qdev.c:510</span></span><br><span class="line"><span class="comment">//#4  0x0000555555eac555 in property_set_bool (obj=0x5555580c6260, v=0x5555580d4190, name=0x555556300c31 &quot;realized&quot;, opaque=0x5555570fc6e0, errp=0x7fffffffd360) at ../../qemu/qom/object.c:2358</span></span><br><span class="line"><span class="comment">//#5  0x0000555555eaa0eb in object_property_set (obj=0x5555580c6260, name=0x555556300c31 &quot;realized&quot;, v=0x5555580d4190, errp=0x7fffffffd360) at ../../qemu/qom/object.c:1472</span></span><br><span class="line"><span class="comment">//#6  0x0000555555eaed24 in object_property_set_qobject (obj=0x5555580c6260, name=0x555556300c31 &quot;realized&quot;, value=0x5555580d40d0, errp=0x7fffffffd360) at ../../qemu/qom/qom-qobject.c:28</span></span><br><span class="line"><span class="comment">//#7  0x0000555555eaa4a4 in object_property_set_bool (obj=0x5555580c6260, name=0x555556300c31 &quot;realized&quot;, value=true, errp=0x7fffffffd360) at ../../qemu/qom/object.c:1541</span></span><br><span class="line"><span class="comment">//#8  0x0000555555ea0468 in qdev_realize (dev=0x5555580c6260, bus=0x5555580c61e0, errp=0x7fffffffd360) at ../../qemu/hw/core/qdev.c:292</span></span><br><span class="line"><span class="comment">//#9  0x0000555555e141a8 in virtio_net_pci_realize (vpci_dev=0x5555580bdd70, errp=0x7fffffffd360) at ../../qemu/hw/virtio/virtio-net-pci.c:64</span></span><br><span class="line"><span class="comment">//#10 0x0000555555b76de9 in virtio_pci_realize (pci_dev=0x5555580bdd70, errp=0x7fffffffd360) at ../../qemu/hw/virtio/virtio-pci.c:2407</span></span><br><span class="line"><span class="comment">//#11 0x0000555555a9cd61 in pci_qdev_realize (qdev=0x5555580bdd70, errp=0x7fffffffd420) at ../../qemu/hw/pci/pci.c:2093</span></span><br><span class="line"><span class="comment">//#12 0x0000555555b77204 in virtio_pci_dc_realize (qdev=0x5555580bdd70, errp=0x7fffffffd420) at ../../qemu/hw/virtio/virtio-pci.c:2501</span></span><br><span class="line"><span class="comment">//#13 0x0000555555ea0d4e in device_set_realized (obj=0x5555580bdd70, value=true, errp=0x7fffffffd690) at ../../qemu/hw/core/qdev.c:510</span></span><br><span class="line"><span class="comment">//#14 0x0000555555eac555 in property_set_bool (obj=0x5555580bdd70, v=0x5555580cdea0, name=0x555556300c31 &quot;realized&quot;, opaque=0x5555570fc6e0, errp=0x7fffffffd690) at ../../qemu/qom/object.c:2358</span></span><br><span class="line"><span class="comment">//#15 0x0000555555eaa0eb in object_property_set (obj=0x5555580bdd70, name=0x555556300c31 &quot;realized&quot;, v=0x5555580cdea0, errp=0x7fffffffd690) at ../../qemu/qom/object.c:1472</span></span><br><span class="line"><span class="comment">//#16 0x0000555555eaed24 in object_property_set_qobject (obj=0x5555580bdd70, name=0x555556300c31 &quot;realized&quot;, value=0x5555580cca90, errp=0x7fffffffd690) at ../../qemu/qom/qom-qobject.c:28</span></span><br><span class="line"><span class="comment">//#17 0x0000555555eaa4a4 in object_property_set_bool (obj=0x5555580bdd70, name=0x555556300c31 &quot;realized&quot;, value=true, errp=0x7fffffffd690) at ../../qemu/qom/object.c:1541</span></span><br><span class="line"><span class="comment">//#18 0x0000555555ea0468 in qdev_realize (dev=0x5555580bdd70, bus=0x555557430730, errp=0x7fffffffd690) at ../../qemu/hw/core/qdev.c:292</span></span><br><span class="line"><span class="comment">//#19 0x0000555555bd0329 in qdev_device_add_from_qdict (opts=0x5555580bc3b0, from_json=false, errp=0x7fffffffd690) at ../../qemu/system/qdev-monitor.c:718</span></span><br><span class="line"><span class="comment">//#20 0x0000555555bd03d9 in qdev_device_add (opts=0x5555570f7230, errp=0x55555706a160 &lt;error_fatal&gt;) at ../../qemu/system/qdev-monitor.c:737</span></span><br><span class="line"><span class="comment">//#21 0x0000555555bda4e7 in device_init_func (opaque=0x0, opts=0x5555570f7230, errp=0x55555706a160 &lt;error_fatal&gt;) at ../../qemu/system/vl.c:1200</span></span><br><span class="line"><span class="comment">//#22 0x00005555560c2a63 in qemu_opts_foreach (list=0x555556f53ec0 &lt;qemu_device_opts&gt;, func=0x555555bda4bc &lt;device_init_func&gt;, opaque=0x0, errp=0x55555706a160 &lt;error_fatal&gt;) at ../../qemu/util/qemu-option.c:1135</span></span><br><span class="line"><span class="comment">//#23 0x0000555555bde1b8 in qemu_create_cli_devices () at ../../qemu/system/vl.c:2637</span></span><br><span class="line"><span class="comment">//#24 0x0000555555bde3fe in qmp_x_exit_preconfig (errp=0x55555706a160 &lt;error_fatal&gt;) at ../../qemu/system/vl.c:2706</span></span><br><span class="line"><span class="comment">//#25 0x0000555555be0db6 in qemu_init (argc=39, argv=0x7fffffffdad8) at ../../qemu/system/vl.c:3739</span></span><br><span class="line"><span class="comment">//#26 0x0000555555e9b7ed in main (argc=39, argv=0x7fffffffdad8) at ../../qemu/system/main.c:47</span></span><br><span class="line"><span class="comment">//#27 0x00007ffff7629d90 in __libc_start_call_main (main=main@entry=0x555555e9b7c9 &lt;main&gt;, argc=argc@entry=39, argv=argv@entry=0x7fffffffdad8) at ../sysdeps/nptl/libc_start_call_main.h:58</span></span><br><span class="line"><span class="comment">//#28 0x00007ffff7629e40 in __libc_start_main_impl (main=0x555555e9b7c9 &lt;main&gt;, argc=39, argv=0x7fffffffdad8, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7fffffffdac8) at ../csu/libc-start.c:392</span></span><br><span class="line"><span class="comment">//#29 0x000055555586f0d5 in _start ()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* This is called by virtio-bus just after the device is plugged. */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_pci_device_plugged</span><span class="params">(DeviceState *d, Error **errp)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtIOPCIProxy *proxy = VIRTIO_PCI(d);</span><br><span class="line">    VirtioBusState *bus = &amp;proxy-&gt;bus;</span><br><span class="line">    <span class="type">bool</span> legacy = virtio_pci_legacy(proxy);</span><br><span class="line">    <span class="type">bool</span> modern;</span><br><span class="line">    <span class="type">bool</span> modern_pio = proxy-&gt;flags &amp; VIRTIO_PCI_FLAG_MODERN_PIO_NOTIFY;</span><br><span class="line">    <span class="type">uint8_t</span> *config;</span><br><span class="line">    <span class="type">uint32_t</span> size;</span><br><span class="line">    VirtIODevice *vdev = virtio_bus_get_device(bus);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Virtio capabilities present without</span></span><br><span class="line"><span class="comment">     * VIRTIO_F_VERSION_1 confuses guests</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!proxy-&gt;ignore_backend_features &amp;&amp;</span><br><span class="line">            !virtio_has_feature(vdev-&gt;host_features, VIRTIO_F_VERSION_1)) &#123;</span><br><span class="line">        virtio_pci_disable_modern(proxy);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!legacy) &#123;</span><br><span class="line">            error_setg(errp, <span class="string">&quot;Device doesn&#x27;t support modern mode, and legacy&quot;</span></span><br><span class="line">                             <span class="string">&quot; mode is disabled&quot;</span>);</span><br><span class="line">            error_append_hint(errp, <span class="string">&quot;Set disable-legacy to off\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modern = virtio_pci_modern(proxy);</span><br><span class="line"></span><br><span class="line">    config = proxy-&gt;pci_dev.config;</span><br><span class="line">    <span class="keyword">if</span> (proxy-&gt;class_code) &#123;</span><br><span class="line">        pci_config_set_class(config, proxy-&gt;class_code);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (legacy) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!virtio_legacy_allowed(vdev)) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * To avoid migration issues, we allow legacy mode when legacy</span></span><br><span class="line"><span class="comment">             * check is disabled in the old machine types (&lt; 5.1).</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (virtio_legacy_check_disabled(vdev)) &#123;</span><br><span class="line">                warn_report(<span class="string">&quot;device is modern-only, but for backward &quot;</span></span><br><span class="line">                            <span class="string">&quot;compatibility legacy is allowed&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                error_setg(errp,</span><br><span class="line">                           <span class="string">&quot;device is modern-only, use disable-legacy=on&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (virtio_host_has_feature(vdev, VIRTIO_F_IOMMU_PLATFORM)) &#123;</span><br><span class="line">            error_setg(errp, <span class="string">&quot;VIRTIO_F_IOMMU_PLATFORM was supported by&quot;</span></span><br><span class="line">                       <span class="string">&quot; neither legacy nor transitional device&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Legacy and transitional devices use specific subsystem IDs.</span></span><br><span class="line"><span class="comment">         * Note that the subsystem vendor ID (config + PCI_SUBSYSTEM_VENDOR_ID)</span></span><br><span class="line"><span class="comment">         * is set to PCI_SUBVENDOR_ID_REDHAT_QUMRANET by default.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        pci_set_word(config + PCI_SUBSYSTEM_ID, virtio_bus_get_vdev_id(bus));</span><br><span class="line">        <span class="keyword">if</span> (proxy-&gt;trans_devid) &#123;</span><br><span class="line">            pci_config_set_device_id(config, proxy-&gt;trans_devid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* pure virtio-1.0 */</span></span><br><span class="line">        pci_set_word(config + PCI_VENDOR_ID,</span><br><span class="line">                     PCI_VENDOR_ID_REDHAT_QUMRANET);</span><br><span class="line">        pci_set_word(config + PCI_DEVICE_ID,</span><br><span class="line">                     PCI_DEVICE_ID_VIRTIO_10_BASE + virtio_bus_get_vdev_id(bus));</span><br><span class="line">        pci_config_set_revision(config, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    config[PCI_INTERRUPT_PIN] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (modern) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">virtio_pci_cap</span> <span class="title">cap</span> =</span> &#123;</span><br><span class="line">            .cap_len = <span class="keyword">sizeof</span> cap,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">virtio_pci_notify_cap</span> <span class="title">notify</span> =</span> &#123;</span><br><span class="line">            .cap.cap_len = <span class="keyword">sizeof</span> notify,</span><br><span class="line">            .notify_off_multiplier =</span><br><span class="line">                cpu_to_le32(virtio_pci_queue_mem_mult(proxy)),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">virtio_pci_cfg_cap</span> <span class="title">cfg</span> =</span> &#123;</span><br><span class="line">            .cap.cap_len = <span class="keyword">sizeof</span> cfg,</span><br><span class="line">            .cap.cfg_type = VIRTIO_PCI_CAP_PCI_CFG,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">virtio_pci_notify_cap</span> <span class="title">notify_pio</span> =</span> &#123;</span><br><span class="line">            .cap.cap_len = <span class="keyword">sizeof</span> notify,</span><br><span class="line">            .notify_off_multiplier = cpu_to_le32(<span class="number">0x0</span>),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">virtio_pci_cfg_cap</span> *<span class="title">cfg_mask</span>;</span></span><br><span class="line"></span><br><span class="line">        virtio_pci_modern_regions_init(proxy, vdev-&gt;name);</span><br><span class="line"></span><br><span class="line">        virtio_pci_modern_mem_region_map(proxy, &amp;proxy-&gt;common, &amp;cap);</span><br><span class="line">        virtio_pci_modern_mem_region_map(proxy, &amp;proxy-&gt;isr, &amp;cap);</span><br><span class="line">        virtio_pci_modern_mem_region_map(proxy, &amp;proxy-&gt;device, &amp;cap);</span><br><span class="line">        virtio_pci_modern_mem_region_map(proxy, &amp;proxy-&gt;notify, &amp;notify.cap);</span><br><span class="line">        <span class="keyword">if</span> (proxy-&gt;flags &amp; VIRTIO_PCI_FLAG_VDPA) &#123;</span><br><span class="line">            memory_region_add_subregion(&amp;proxy-&gt;modern_bar,</span><br><span class="line">                                        proxy-&gt;lm.offset, &amp;proxy-&gt;lm.mr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (modern_pio) &#123;</span><br><span class="line">            memory_region_init(&amp;proxy-&gt;io_bar, OBJECT(proxy),</span><br><span class="line">                               <span class="string">&quot;virtio-pci-io&quot;</span>, <span class="number">0x4</span>);</span><br><span class="line"></span><br><span class="line">            pci_register_bar(&amp;proxy-&gt;pci_dev, proxy-&gt;modern_io_bar_idx,</span><br><span class="line">                             PCI_BASE_ADDRESS_SPACE_IO, &amp;proxy-&gt;io_bar);</span><br><span class="line"></span><br><span class="line">            virtio_pci_modern_io_region_map(proxy, &amp;proxy-&gt;notify_pio,</span><br><span class="line">                                            &amp;notify_pio.cap);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pci_register_bar(&amp;proxy-&gt;pci_dev, proxy-&gt;modern_mem_bar_idx,</span><br><span class="line">                         PCI_BASE_ADDRESS_SPACE_MEMORY |</span><br><span class="line">                         PCI_BASE_ADDRESS_MEM_PREFETCH |</span><br><span class="line">                         PCI_BASE_ADDRESS_MEM_TYPE_64,</span><br><span class="line">                         &amp;proxy-&gt;modern_bar);</span><br><span class="line"></span><br><span class="line">        proxy-&gt;config_cap = virtio_pci_add_mem_cap(proxy, &amp;cfg.cap);</span><br><span class="line">        cfg_mask = (<span class="type">void</span> *)(proxy-&gt;pci_dev.wmask + proxy-&gt;config_cap);</span><br><span class="line">        pci_set_byte(&amp;cfg_mask-&gt;cap.bar, ~<span class="number">0x0</span>);</span><br><span class="line">        pci_set_long((<span class="type">uint8_t</span> *)&amp;cfg_mask-&gt;cap.offset, ~<span class="number">0x0</span>);</span><br><span class="line">        pci_set_long((<span class="type">uint8_t</span> *)&amp;cfg_mask-&gt;cap.length, ~<span class="number">0x0</span>);</span><br><span class="line">        pci_set_long(cfg_mask-&gt;pci_cfg_data, ~<span class="number">0x0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (proxy-&gt;nvectors) &#123;</span><br><span class="line">        <span class="type">int</span> err = msix_init_exclusive_bar(&amp;proxy-&gt;pci_dev, proxy-&gt;nvectors,</span><br><span class="line">                                          proxy-&gt;msix_bar_idx, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="comment">/* Notice when a system that supports MSIx can&#x27;t initialize it */</span></span><br><span class="line">            <span class="keyword">if</span> (err != -ENOTSUP) &#123;</span><br><span class="line">                warn_report(<span class="string">&quot;unable to init msix vectors to %&quot;</span> PRIu32,</span><br><span class="line">                            proxy-&gt;nvectors);</span><br><span class="line">            &#125;</span><br><span class="line">            proxy-&gt;nvectors = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    proxy-&gt;pci_dev.config_write = virtio_write_config;</span><br><span class="line">    proxy-&gt;pci_dev.config_read = virtio_read_config;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (legacy) &#123;</span><br><span class="line">        size = VIRTIO_PCI_REGION_SIZE(&amp;proxy-&gt;pci_dev)</span><br><span class="line">            + virtio_bus_get_vdev_config_len(bus);</span><br><span class="line">        size = pow2ceil(size);</span><br><span class="line"></span><br><span class="line">        memory_region_init_io(&amp;proxy-&gt;bar, OBJECT(proxy),</span><br><span class="line">                              &amp;virtio_pci_config_ops,</span><br><span class="line">                              proxy, <span class="string">&quot;virtio-pci&quot;</span>, size);</span><br><span class="line"></span><br><span class="line">        pci_register_bar(&amp;proxy-&gt;pci_dev, proxy-&gt;legacy_io_bar_idx,</span><br><span class="line">                         PCI_BASE_ADDRESS_SPACE_IO, &amp;proxy-&gt;bar);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* A VirtIODevice is being plugged */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">virtio_bus_device_plugged</span><span class="params">(VirtIODevice *vdev, Error **errp)</span></span><br><span class="line">&#123;</span><br><span class="line">    DeviceState *qdev = DEVICE(vdev);</span><br><span class="line">    BusState *qbus = BUS(qdev_get_parent_bus(qdev));</span><br><span class="line">    VirtioBusState *bus = VIRTIO_BUS(qbus);</span><br><span class="line">    VirtioBusClass *klass = VIRTIO_BUS_GET_CLASS(bus);</span><br><span class="line">    VirtioDeviceClass *vdc = VIRTIO_DEVICE_GET_CLASS(vdev);</span><br><span class="line">    <span class="type">bool</span> has_iommu = virtio_host_has_feature(vdev, VIRTIO_F_IOMMU_PLATFORM);</span><br><span class="line">    <span class="type">bool</span> vdev_has_iommu;</span><br><span class="line">    Error *local_err = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    DPRINTF(<span class="string">&quot;%s: plug device.\n&quot;</span>, qbus-&gt;name);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (klass-&gt;device_plugged != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        klass-&gt;device_plugged(qbus-&gt;parent, &amp;local_err);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，在<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-pci.c#L2089"><strong>virtio_pci_device_plugged()</strong></a>中完成了<strong>PCI配置空间</strong>的设置。</p>
<p>整体来看，<strong>virtio设备</strong>实例化时会分别实例化<strong>virtio transport</strong>和<strong>virtio设备</strong>，这样子具有更好的拓展性。</p>
<h2 id="virtio设置"><a href="#virtio设置" class="headerlink" title="virtio设置"></a>virtio设置</h2><p>在qemu实例化完<strong>virtio-net-pci</strong>设备后，需要与<strong>guest驱动</strong>通信完成<strong>virtio</strong>的设置，即virtio各个组件的设置</p>
<h3 id="virtio结构的配置空间"><a href="#virtio结构的配置空间" class="headerlink" title="virtio结构的配置空间"></a>virtio结构的配置空间</h3><p>根据前面<a href="#virtio-transport">virtio transport</a>章节可知，<strong>virtio-net-pci</strong>设备<strong>PCI配置空间</strong>的capability指定着virtio各个组件的配置空间</p>
<p><img src="virtio的PCI配置空间.png" alt="virtio的PCI配置空间"></p>
<p>因此首先就需要设置<strong>virtio结构的配置空间</strong>，即根据capability确定组件配置空间的<strong>BAR</strong>。</p>
<p>在前面<a href="#实例化">virtio设备的实例化</a>中，<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-pci.c#L2089"><strong>virtio_pci_device_plugged()</strong></a>将所有capability配置空间设置在<strong>proxy-&gt;modern_bar</strong>上。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This is called by virtio-bus just after the device is plugged. */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_pci_device_plugged</span><span class="params">(DeviceState *d, Error **errp)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">virtio_pci_cap</span> <span class="title">cap</span> =</span> &#123;</span><br><span class="line">        .cap_len = <span class="keyword">sizeof</span> cap,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">virtio_pci_notify_cap</span> <span class="title">notify</span> =</span> &#123;</span><br><span class="line">        .cap.cap_len = <span class="keyword">sizeof</span> notify,</span><br><span class="line">        .notify_off_multiplier =</span><br><span class="line">            cpu_to_le32(virtio_pci_queue_mem_mult(proxy)),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">virtio_pci_cfg_cap</span> <span class="title">cfg</span> =</span> &#123;</span><br><span class="line">        .cap.cap_len = <span class="keyword">sizeof</span> cfg,</span><br><span class="line">        .cap.cfg_type = VIRTIO_PCI_CAP_PCI_CFG,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">virtio_pci_notify_cap</span> <span class="title">notify_pio</span> =</span> &#123;</span><br><span class="line">        .cap.cap_len = <span class="keyword">sizeof</span> notify,</span><br><span class="line">        .notify_off_multiplier = cpu_to_le32(<span class="number">0x0</span>),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">virtio_pci_cfg_cap</span> *<span class="title">cfg_mask</span>;</span></span><br><span class="line">    ...</span><br><span class="line">    virtio_pci_modern_mem_region_map(proxy, &amp;proxy-&gt;common, &amp;cap);</span><br><span class="line">    virtio_pci_modern_mem_region_map(proxy, &amp;proxy-&gt;isr, &amp;cap);</span><br><span class="line">    virtio_pci_modern_mem_region_map(proxy, &amp;proxy-&gt;device, &amp;cap);</span><br><span class="line">    virtio_pci_modern_mem_region_map(proxy, &amp;proxy-&gt;notify, &amp;notify.cap);</span><br><span class="line">    ...</span><br><span class="line">    pci_register_bar(&amp;proxy-&gt;pci_dev, proxy-&gt;modern_mem_bar_idx,</span><br><span class="line">                     PCI_BASE_ADDRESS_SPACE_MEMORY |</span><br><span class="line">                     PCI_BASE_ADDRESS_MEM_PREFETCH |</span><br><span class="line">                     PCI_BASE_ADDRESS_MEM_TYPE_64,</span><br><span class="line">                     &amp;proxy-&gt;modern_bar);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_pci_modern_mem_region_map</span><span class="params">(VirtIOPCIProxy *proxy,</span></span><br><span class="line"><span class="params">                                             VirtIOPCIRegion *region,</span></span><br><span class="line"><span class="params">                                             <span class="keyword">struct</span> virtio_pci_cap *cap)</span></span><br><span class="line">&#123;</span><br><span class="line">    virtio_pci_modern_region_map(proxy, region, cap,</span><br><span class="line">                                 &amp;proxy-&gt;modern_bar, proxy-&gt;modern_mem_bar_idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_pci_modern_region_map</span><span class="params">(VirtIOPCIProxy *proxy,</span></span><br><span class="line"><span class="params">                                         VirtIOPCIRegion *region,</span></span><br><span class="line"><span class="params">                                         <span class="keyword">struct</span> virtio_pci_cap *cap,</span></span><br><span class="line"><span class="params">                                         MemoryRegion *mr,</span></span><br><span class="line"><span class="params">                                         <span class="type">uint8_t</span> bar)</span></span><br><span class="line">&#123;</span><br><span class="line">    memory_region_add_subregion(mr, region-&gt;offset, &amp;region-&gt;mr);</span><br><span class="line"></span><br><span class="line">    cap-&gt;cfg_type = region-&gt;type;</span><br><span class="line">    cap-&gt;bar = bar;</span><br><span class="line">    cap-&gt;offset = cpu_to_le32(region-&gt;offset);</span><br><span class="line">    cap-&gt;length = cpu_to_le32(region-&gt;size);</span><br><span class="line">    virtio_pci_add_mem_cap(proxy, cap);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而<strong>proxy-&gt;modern_mem_bar_idx</strong>在<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-pci.c#L2272"><strong>virtio_pci_realize()</strong></a>中被设置为4，即capability配置空间被设置在<strong>BAR4</strong>上<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_pci_realize</span><span class="params">(PCIDevice *pci_dev, Error **errp)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * virtio pci bar layout used by default.</span></span><br><span class="line"><span class="comment">     * subclasses can re-arrange things if needed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *   region 0   --  virtio legacy io bar</span></span><br><span class="line"><span class="comment">     *   region 1   --  msi-x bar</span></span><br><span class="line"><span class="comment">     *   region 2   --  virtio modern io bar (off by default)</span></span><br><span class="line"><span class="comment">     *   region 4+5 --  virtio modern memory (64bit) bar</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    proxy-&gt;modern_mem_bar_idx = <span class="number">4</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>根据<a href="/2024/08/04/qemu%E7%9A%84PCI%E8%AE%BE%E5%A4%87/" title="qemu的PCI设备">qemu的PCI设备</a>可知，<strong>guest驱动</strong>在<strong>PCI配置空间</strong>中设置<strong>BAR4</strong>的物理地址即可完成virtio结构的配置空间的设置<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#0  pci_default_write_config (d=0x5555580bdd70, addr=32, val_in=4294967295, l=4) at ../../qemu/hw/pci/pci.c:1594</span></span><br><span class="line"><span class="comment">//#1  0x0000555555b729ad in virtio_write_config (pci_dev=0x5555580bdd70, address=32, val=4294967295, len=4) at ../../qemu/hw/virtio/virtio-pci.c:747</span></span><br><span class="line"><span class="comment">//#2  0x0000555555aa0c9a in pci_host_config_write_common (pci_dev=0x5555580bdd70, addr=32, limit=256, val=4294967295, len=4) at ../../qemu/hw/pci/pci_host.c:96</span></span><br><span class="line"><span class="comment">//#3  0x0000555555aa0ee6 in pci_data_write (s=0x555557430730, addr=2147489824, val=4294967295, len=4) at ../../qemu/hw/pci/pci_host.c:138</span></span><br><span class="line"><span class="comment">//#4  0x0000555555aa10bb in pci_host_data_write (opaque=0x5555573f9ad0, addr=0, val=4294967295, len=4) at ../../qemu/hw/pci/pci_host.c:188</span></span><br><span class="line"><span class="comment">//#5  0x0000555555e1e25a in memory_region_write_accessor (mr=0x5555573f9f10, addr=0, value=0x7ffff65ff598, size=4, shift=0, mask=4294967295, attrs=...) at ../../qemu/system/memory.c:497</span></span><br><span class="line"><span class="comment">//#6  0x0000555555e1e593 in access_with_adjusted_size (addr=0, value=0x7ffff65ff598, size=4, access_size_min=1, access_size_max=4, access_fn=0x555555e1e160 &lt;memory_region_write_accessor&gt;, mr=0x5555573f9f10, attrs=...) at ../../qemu/system/memory.c:573</span></span><br><span class="line"><span class="comment">//#7  0x0000555555e218ad in memory_region_dispatch_write (mr=0x5555573f9f10, addr=0, data=4294967295, op=MO_32, attrs=...) at ../../qemu/system/memory.c:1521</span></span><br><span class="line"><span class="comment">//#8  0x0000555555e2fffa in flatview_write_continue_step (attrs=..., buf=0x7ffff7f8a000 &quot;\377\377\377\377&quot;, len=4, mr_addr=0, l=0x7ffff65ff680, mr=0x5555573f9f10) at ../../qemu/system/physmem.c:2713</span></span><br><span class="line"><span class="comment">//#9  0x0000555555e300ca in flatview_write_continue (fv=0x7ffee8043b90, addr=3324, attrs=..., ptr=0x7ffff7f8a000, len=4, mr_addr=0, l=4, mr=0x5555573f9f10) at ../../qemu/system/physmem.c:2743</span></span><br><span class="line"><span class="comment">//#10 0x0000555555e301dc in flatview_write (fv=0x7ffee8043b90, addr=3324, attrs=..., buf=0x7ffff7f8a000, len=4) at ../../qemu/system/physmem.c:2774</span></span><br><span class="line"><span class="comment">//#11 0x0000555555e3062a in address_space_write (as=0x555557055e80 &lt;address_space_io&gt;, addr=3324, attrs=..., buf=0x7ffff7f8a000, len=4) at ../../qemu/system/physmem.c:2894</span></span><br><span class="line"><span class="comment">//#12 0x0000555555e306a6 in address_space_rw (as=0x555557055e80 &lt;address_space_io&gt;, addr=3324, attrs=..., buf=0x7ffff7f8a000, len=4, is_write=true) at ../../qemu/system/physmem.c:2904</span></span><br><span class="line"><span class="comment">//#13 0x0000555555e89cd0 in kvm_handle_io (port=3324, attrs=..., data=0x7ffff7f8a000, direction=1, size=4, count=1) at ../../qemu/accel/kvm/kvm-all.c:2631</span></span><br><span class="line"><span class="comment">//#14 0x0000555555e8a640 in kvm_cpu_exec (cpu=0x5555573bc6a0) at ../../qemu/accel/kvm/kvm-all.c:2903</span></span><br><span class="line"><span class="comment">//#15 0x0000555555e8d712 in kvm_vcpu_thread_fn (arg=0x5555573bc6a0) at ../../qemu/accel/kvm/kvm-accel-ops.c:50</span></span><br><span class="line"><span class="comment">//#16 0x00005555560b6f08 in qemu_thread_start (args=0x5555573c5850) at ../../qemu/util/qemu-thread-posix.c:541</span></span><br><span class="line"><span class="comment">//#17 0x00007ffff7694ac3 in start_thread (arg=&lt;optimized out&gt;) at ./nptl/pthread_create.c:442</span></span><br><span class="line"><span class="comment">//#18 0x00007ffff7726850 in clone3 () at ../sysdeps/unix/sysv/linux/x86_64/clone3.S:81</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">pci_default_write_config</span><span class="params">(PCIDevice *d, <span class="type">uint32_t</span> addr, <span class="type">uint32_t</span> val_in, <span class="type">int</span> l)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (ranges_overlap(addr, l, PCI_BASE_ADDRESS_0, <span class="number">24</span>) ||</span><br><span class="line">        ranges_overlap(addr, l, PCI_ROM_ADDRESS, <span class="number">4</span>) ||</span><br><span class="line">        ranges_overlap(addr, l, PCI_ROM_ADDRESS1, <span class="number">4</span>) ||</span><br><span class="line">        range_covers_byte(addr, l, PCI_COMMAND))</span><br><span class="line">        pci_update_mappings(d);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="virtio组件"><a href="#virtio组件" class="headerlink" title="virtio组件"></a>virtio组件</h3><p>根据前面<a href="#virtio-transport">virtio transport</a>章节，virtio组件通过对应的配置空间进行设置。而virtio结构的配置空间在前面<a href="#virtio结构的配置空间">virtio结构的配置空间</a>完成初始化，映射入<strong>AddressSpace</strong>中。 此时<strong>guest</strong>即可通过读写组件的配置空间完成组件的设置</p>
<p>具体的，在实例化时<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-pci.c#L2089"><strong>virtio_pci_device_plugged()</strong></a>为每一个virito结构的配置空间分配了一个单独的MemoryRegion，则<strong>guest</strong>读写组件的配置空间即可触发对应MemoryRegion的回调函数，完成virtio组件的设置<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This is called by virtio-bus just after the device is plugged. */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_pci_device_plugged</span><span class="params">(DeviceState *d, Error **errp)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    virtio_pci_modern_regions_init(proxy, vdev-&gt;name);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_pci_modern_regions_init</span><span class="params">(VirtIOPCIProxy *proxy,</span></span><br><span class="line"><span class="params">                                           <span class="type">const</span> <span class="type">char</span> *vdev_name)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> MemoryRegionOps common_ops = &#123;</span><br><span class="line">        .read = virtio_pci_common_read,</span><br><span class="line">        .write = virtio_pci_common_write,</span><br><span class="line">        .impl = &#123;</span><br><span class="line">            .min_access_size = <span class="number">1</span>,</span><br><span class="line">            .max_access_size = <span class="number">4</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        .endianness = DEVICE_LITTLE_ENDIAN,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> MemoryRegionOps isr_ops = &#123;</span><br><span class="line">        .read = virtio_pci_isr_read,</span><br><span class="line">        .write = virtio_pci_isr_write,</span><br><span class="line">        .impl = &#123;</span><br><span class="line">            .min_access_size = <span class="number">1</span>,</span><br><span class="line">            .max_access_size = <span class="number">4</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        .endianness = DEVICE_LITTLE_ENDIAN,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> MemoryRegionOps device_ops = &#123;</span><br><span class="line">        .read = virtio_pci_device_read,</span><br><span class="line">        .write = virtio_pci_device_write,</span><br><span class="line">        .impl = &#123;</span><br><span class="line">            .min_access_size = <span class="number">1</span>,</span><br><span class="line">            .max_access_size = <span class="number">4</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        .endianness = DEVICE_LITTLE_ENDIAN,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> MemoryRegionOps notify_ops = &#123;</span><br><span class="line">        .read = virtio_pci_notify_read,</span><br><span class="line">        .write = virtio_pci_notify_write,</span><br><span class="line">        .impl = &#123;</span><br><span class="line">            .min_access_size = <span class="number">1</span>,</span><br><span class="line">            .max_access_size = <span class="number">4</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        .endianness = DEVICE_LITTLE_ENDIAN,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> MemoryRegionOps notify_pio_ops = &#123;</span><br><span class="line">        .read = virtio_pci_notify_read,</span><br><span class="line">        .write = virtio_pci_notify_write_pio,</span><br><span class="line">        .impl = &#123;</span><br><span class="line">            .min_access_size = <span class="number">1</span>,</span><br><span class="line">            .max_access_size = <span class="number">4</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        .endianness = DEVICE_LITTLE_ENDIAN,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> MemoryRegionOps lm_ops = &#123;</span><br><span class="line">        .read = virtio_pci_lm_read,</span><br><span class="line">        .write = virtio_pci_lm_write,</span><br><span class="line">        .impl = &#123;</span><br><span class="line">            .min_access_size = <span class="number">1</span>,</span><br><span class="line">            .max_access_size = <span class="number">4</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        .endianness = DEVICE_LITTLE_ENDIAN,</span><br><span class="line">    &#125;;</span><br><span class="line">    g_autoptr(GString) name = g_string_new(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    g_string_printf(name, <span class="string">&quot;virtio-pci-common-%s&quot;</span>, vdev_name);</span><br><span class="line">    memory_region_init_io(&amp;proxy-&gt;common.mr, OBJECT(proxy),</span><br><span class="line">                          &amp;common_ops,</span><br><span class="line">                          proxy,</span><br><span class="line">                          name-&gt;str,</span><br><span class="line">                          proxy-&gt;common.size);</span><br><span class="line"></span><br><span class="line">    g_string_printf(name, <span class="string">&quot;virtio-pci-isr-%s&quot;</span>, vdev_name);</span><br><span class="line">    memory_region_init_io(&amp;proxy-&gt;isr.mr, OBJECT(proxy),</span><br><span class="line">                          &amp;isr_ops,</span><br><span class="line">                          proxy,</span><br><span class="line">                          name-&gt;str,</span><br><span class="line">                          proxy-&gt;isr.size);</span><br><span class="line"></span><br><span class="line">    g_string_printf(name, <span class="string">&quot;virtio-pci-device-%s&quot;</span>, vdev_name);</span><br><span class="line">    memory_region_init_io(&amp;proxy-&gt;device.mr, OBJECT(proxy),</span><br><span class="line">                          &amp;device_ops,</span><br><span class="line">                          proxy,</span><br><span class="line">                          name-&gt;str,</span><br><span class="line">                          proxy-&gt;device.size);</span><br><span class="line"></span><br><span class="line">    g_string_printf(name, <span class="string">&quot;virtio-pci-notify-%s&quot;</span>, vdev_name);</span><br><span class="line">    memory_region_init_io(&amp;proxy-&gt;notify.mr, OBJECT(proxy),</span><br><span class="line">                          &amp;notify_ops,</span><br><span class="line">                          proxy,</span><br><span class="line">                          name-&gt;str,</span><br><span class="line">                          proxy-&gt;notify.size);</span><br><span class="line"></span><br><span class="line">    g_string_printf(name, <span class="string">&quot;virtio-pci-notify-pio-%s&quot;</span>, vdev_name);</span><br><span class="line">    memory_region_init_io(&amp;proxy-&gt;notify_pio.mr, OBJECT(proxy),</span><br><span class="line">                          &amp;notify_pio_ops,</span><br><span class="line">                          proxy,</span><br><span class="line">                          name-&gt;str,</span><br><span class="line">                          proxy-&gt;notify_pio.size);</span><br><span class="line">    <span class="keyword">if</span> (proxy-&gt;flags &amp; VIRTIO_PCI_FLAG_VDPA) &#123;</span><br><span class="line">        g_string_printf(name, <span class="string">&quot;virtio-pci-lm-%s&quot;</span>, vdev_name);</span><br><span class="line">        memory_region_init_io(&amp;proxy-&gt;lm.mr, OBJECT(proxy),</span><br><span class="line">                          &amp;lm_ops,</span><br><span class="line">                          proxy,</span><br><span class="line">                          name-&gt;str,</span><br><span class="line">                          proxy-&gt;lm.size);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里重点介绍一下<strong>VIRTIO_PCI_CAP_COMMON_CFG</strong>设置空间的回调函数，根据前面<a href="#配置空间">VIRTIO_PCI_CAP_COMMON_CFG配置空间</a>章节可知，读写其字段可以设置<strong>virtqueue</strong>和<strong>feature bits</strong>等组件。根据前面<a href="#virtio组件">virtio组件</a>章节中代码可知，qemu使用<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-pci.c#L1686"><strong>virtio_pci_common_writes()</strong></a>来进行设置的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#0  virtio_pci_common_write (opaque=0x5555580bdd70, addr=22, val=0, size=2) at ../../qemu/hw/virtio/virtio-pci.c:1689</span></span><br><span class="line"><span class="comment">//#1  0x0000555555e1e25a in memory_region_write_accessor (mr=0x5555580be8b0, addr=22, value=0x7ffff5bff5d8, size=2, shift=0, mask=65535, attrs=...) at ../../qemu/system/memory.c:497</span></span><br><span class="line"><span class="comment">//#2  0x0000555555e1e593 in access_with_adjusted_size (addr=22, value=0x7ffff5bff5d8, size=2, access_size_min=1, access_size_max=4, access_fn=0x555555e1e160 &lt;memory_region_write_accessor&gt;, mr=0x5555580be8b0, attrs=...) at ../../qemu/system/memory.c:573</span></span><br><span class="line"><span class="comment">//#3  0x0000555555e218ad in memory_region_dispatch_write (mr=0x5555580be8b0, addr=22, data=0, op=MO_16, attrs=...) at ../../qemu/system/memory.c:1521</span></span><br><span class="line"><span class="comment">//#4  0x0000555555e2fffa in flatview_write_continue_step (attrs=..., buf=0x7ffff7f86028 &quot;&quot;, len=2, mr_addr=22, l=0x7ffff5bff6c0, mr=0x5555580be8b0) at ../../qemu/system/physmem.c:2713</span></span><br><span class="line"><span class="comment">//#5  0x0000555555e300ca in flatview_write_continue (fv=0x7ffee0703240, addr=481036337174, attrs=..., ptr=0x7ffff7f86028, len=2, mr_addr=22, l=2, mr=0x5555580be8b0) at ../../qemu/system/physmem.c:2743</span></span><br><span class="line"><span class="comment">//#6  0x0000555555e301dc in flatview_write (fv=0x7ffee0703240, addr=481036337174, attrs=..., buf=0x7ffff7f86028, len=2) at ../../qemu/system/physmem.c:2774</span></span><br><span class="line"><span class="comment">//#7  0x0000555555e3062a in address_space_write (as=0x555557055ee0 &lt;address_space_memory&gt;, addr=481036337174, attrs=..., buf=0x7ffff7f86028, len=2) at ../../qemu/system/physmem.c:2894</span></span><br><span class="line"><span class="comment">//#8  0x0000555555e306a6 in address_space_rw (as=0x555557055ee0 &lt;address_space_memory&gt;, addr=481036337174, attrs=..., buf=0x7ffff7f86028, len=2, is_write=true) at ../../qemu/system/physmem.c:2904</span></span><br><span class="line"><span class="comment">//#9  0x0000555555e8a690 in kvm_cpu_exec (cpu=0x5555573ef900) at ../../qemu/accel/kvm/kvm-all.c:2912</span></span><br><span class="line"><span class="comment">//#10 0x0000555555e8d712 in kvm_vcpu_thread_fn (arg=0x5555573ef900) at ../../qemu/accel/kvm/kvm-accel-ops.c:50</span></span><br><span class="line"><span class="comment">//#11 0x00005555560b6f08 in qemu_thread_start (args=0x5555573f8ad0) at ../../qemu/util/qemu-thread-posix.c:541</span></span><br><span class="line"><span class="comment">//#12 0x00007ffff7694ac3 in start_thread (arg=&lt;optimized out&gt;) at ./nptl/pthread_create.c:442</span></span><br><span class="line"><span class="comment">//#13 0x00007ffff7726850 in clone3 () at ../sysdeps/unix/sysv/linux/x86_64/clone3.S:81</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_pci_common_write</span><span class="params">(<span class="type">void</span> *opaque, hwaddr addr,</span></span><br><span class="line"><span class="params">                                    <span class="type">uint64_t</span> val, <span class="type">unsigned</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtIOPCIProxy *proxy = opaque;</span><br><span class="line">    VirtIODevice *vdev = virtio_bus_get_device(&amp;proxy-&gt;bus);</span><br><span class="line">    <span class="type">uint16_t</span> <span class="built_in">vector</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vdev == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (addr) &#123;</span><br><span class="line">    <span class="keyword">case</span> VIRTIO_PCI_COMMON_DFSELECT:</span><br><span class="line">        proxy-&gt;dfselect = val;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VIRTIO_PCI_COMMON_GFSELECT:</span><br><span class="line">        proxy-&gt;gfselect = val;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VIRTIO_PCI_COMMON_GF:</span><br><span class="line">        <span class="keyword">if</span> (proxy-&gt;gfselect &lt; ARRAY_SIZE(proxy-&gt;guest_features)) &#123;</span><br><span class="line">            proxy-&gt;guest_features[proxy-&gt;gfselect] = val;</span><br><span class="line">            virtio_set_features(vdev,</span><br><span class="line">                                (((<span class="type">uint64_t</span>)proxy-&gt;guest_features[<span class="number">1</span>]) &lt;&lt; <span class="number">32</span>) |</span><br><span class="line">                                proxy-&gt;guest_features[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VIRTIO_PCI_COMMON_MSIX:</span><br><span class="line">        <span class="keyword">if</span> (vdev-&gt;config_vector != VIRTIO_NO_VECTOR) &#123;</span><br><span class="line">            msix_vector_unuse(&amp;proxy-&gt;pci_dev, vdev-&gt;config_vector);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* Make it possible for guest to discover an error took place. */</span></span><br><span class="line">        <span class="keyword">if</span> (val &lt; proxy-&gt;nvectors) &#123;</span><br><span class="line">            msix_vector_use(&amp;proxy-&gt;pci_dev, val);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            val = VIRTIO_NO_VECTOR;</span><br><span class="line">        &#125;</span><br><span class="line">        vdev-&gt;config_vector = val;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VIRTIO_PCI_COMMON_STATUS:</span><br><span class="line">        <span class="keyword">if</span> (!(val &amp; VIRTIO_CONFIG_S_DRIVER_OK)) &#123;</span><br><span class="line">            virtio_pci_stop_ioeventfd(proxy);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        virtio_set_status(vdev, val &amp; <span class="number">0xFF</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (val &amp; VIRTIO_CONFIG_S_DRIVER_OK) &#123;</span><br><span class="line">            virtio_pci_start_ioeventfd(proxy);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (vdev-&gt;status == <span class="number">0</span>) &#123;</span><br><span class="line">            virtio_pci_reset(DEVICE(proxy));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VIRTIO_PCI_COMMON_Q_SELECT:</span><br><span class="line">        <span class="keyword">if</span> (val &lt; VIRTIO_QUEUE_MAX) &#123;</span><br><span class="line">            vdev-&gt;queue_sel = val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VIRTIO_PCI_COMMON_Q_SIZE:</span><br><span class="line">        proxy-&gt;vqs[vdev-&gt;queue_sel].num = val;</span><br><span class="line">        virtio_queue_set_num(vdev, vdev-&gt;queue_sel,</span><br><span class="line">                             proxy-&gt;vqs[vdev-&gt;queue_sel].num);</span><br><span class="line">        virtio_init_region_cache(vdev, vdev-&gt;queue_sel);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VIRTIO_PCI_COMMON_Q_MSIX:</span><br><span class="line">        <span class="built_in">vector</span> = virtio_queue_vector(vdev, vdev-&gt;queue_sel);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">vector</span> != VIRTIO_NO_VECTOR) &#123;</span><br><span class="line">            msix_vector_unuse(&amp;proxy-&gt;pci_dev, <span class="built_in">vector</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* Make it possible for guest to discover an error took place. */</span></span><br><span class="line">        <span class="keyword">if</span> (val &lt; proxy-&gt;nvectors) &#123;</span><br><span class="line">            msix_vector_use(&amp;proxy-&gt;pci_dev, val);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            val = VIRTIO_NO_VECTOR;</span><br><span class="line">        &#125;</span><br><span class="line">        virtio_queue_set_vector(vdev, vdev-&gt;queue_sel, val);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VIRTIO_PCI_COMMON_Q_ENABLE:</span><br><span class="line">        <span class="keyword">if</span> (val == <span class="number">1</span>) &#123;</span><br><span class="line">            virtio_queue_set_num(vdev, vdev-&gt;queue_sel,</span><br><span class="line">                                 proxy-&gt;vqs[vdev-&gt;queue_sel].num);</span><br><span class="line">            virtio_queue_set_rings(vdev, vdev-&gt;queue_sel,</span><br><span class="line">                       ((<span class="type">uint64_t</span>)proxy-&gt;vqs[vdev-&gt;queue_sel].desc[<span class="number">1</span>]) &lt;&lt; <span class="number">32</span> |</span><br><span class="line">                       proxy-&gt;vqs[vdev-&gt;queue_sel].desc[<span class="number">0</span>],</span><br><span class="line">                       ((<span class="type">uint64_t</span>)proxy-&gt;vqs[vdev-&gt;queue_sel].avail[<span class="number">1</span>]) &lt;&lt; <span class="number">32</span> |</span><br><span class="line">                       proxy-&gt;vqs[vdev-&gt;queue_sel].avail[<span class="number">0</span>],</span><br><span class="line">                       ((<span class="type">uint64_t</span>)proxy-&gt;vqs[vdev-&gt;queue_sel].used[<span class="number">1</span>]) &lt;&lt; <span class="number">32</span> |</span><br><span class="line">                       proxy-&gt;vqs[vdev-&gt;queue_sel].used[<span class="number">0</span>]);</span><br><span class="line">            proxy-&gt;vqs[vdev-&gt;queue_sel].enabled = <span class="number">1</span>;</span><br><span class="line">            proxy-&gt;vqs[vdev-&gt;queue_sel].reset = <span class="number">0</span>;</span><br><span class="line">            virtio_queue_enable(vdev, vdev-&gt;queue_sel);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            virtio_error(vdev, <span class="string">&quot;wrong value for queue_enable %&quot;</span>PRIx64, val);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VIRTIO_PCI_COMMON_Q_DESCLO:</span><br><span class="line">        proxy-&gt;vqs[vdev-&gt;queue_sel].desc[<span class="number">0</span>] = val;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VIRTIO_PCI_COMMON_Q_DESCHI:</span><br><span class="line">        proxy-&gt;vqs[vdev-&gt;queue_sel].desc[<span class="number">1</span>] = val;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VIRTIO_PCI_COMMON_Q_AVAILLO:</span><br><span class="line">        proxy-&gt;vqs[vdev-&gt;queue_sel].avail[<span class="number">0</span>] = val;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VIRTIO_PCI_COMMON_Q_AVAILHI:</span><br><span class="line">        proxy-&gt;vqs[vdev-&gt;queue_sel].avail[<span class="number">1</span>] = val;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VIRTIO_PCI_COMMON_Q_USEDLO:</span><br><span class="line">        proxy-&gt;vqs[vdev-&gt;queue_sel].used[<span class="number">0</span>] = val;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VIRTIO_PCI_COMMON_Q_USEDHI:</span><br><span class="line">        proxy-&gt;vqs[vdev-&gt;queue_sel].used[<span class="number">1</span>] = val;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VIRTIO_PCI_COMMON_Q_RESET:</span><br><span class="line">        <span class="keyword">if</span> (val == <span class="number">1</span>) &#123;</span><br><span class="line">            proxy-&gt;vqs[vdev-&gt;queue_sel].reset = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            virtio_queue_reset(vdev, vdev-&gt;queue_sel);</span><br><span class="line"></span><br><span class="line">            proxy-&gt;vqs[vdev-&gt;queue_sel].reset = <span class="number">0</span>;</span><br><span class="line">            proxy-&gt;vqs[vdev-&gt;queue_sel].enabled = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="数据处理"><a href="#数据处理" class="headerlink" title="数据处理"></a>数据处理</h2><p>实际上数据处理包括数据传输和通知两部分，数据传输是通过内存共享实现的，而通知是通过内核的<a target="_blank" rel="noopener" href="https://juejin.cn/post/6989608237226000391">eventfd机制</a>实现的</p>
<h3 id="数据传输"><a href="#数据传输" class="headerlink" title="数据传输"></a>数据传输</h3><p>由于<strong>guest</strong>物理地址空间位于qemu的进程地址空间中，因此qemu天然就可以访问<strong>guest</strong>的任意物理地址。<br>因此，只要知道<strong>guest</strong>中为<strong>virtqueue</strong>分配的物理地址空间，<strong>virtio设备</strong>即可找到这些空间在<strong>qemu</strong>进程空间中的<strong>hva</strong>，即可完成访问，这是在<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio.c#L2178"><strong>virtio_queue_set_rings()</strong></a>中完成的</p>
<p>具体的，根据前面<a href="#virtio组件">virtio组件</a>小节可知，当<strong>guest</strong>设置<strong>VIRTIO_PCI_COMMON_Q_ENABLE</strong>字段来完成virtqueue的设置时，qemu会调用<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio.c#L2178"><strong>virtio_queue_set_rings()</strong></a>，如下所示<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">virtio_queue_set_rings</span><span class="params">(VirtIODevice *vdev, <span class="type">int</span> n, hwaddr desc,</span></span><br><span class="line"><span class="params">                            hwaddr avail, hwaddr used)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!vdev-&gt;vq[n].vring.num) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    vdev-&gt;vq[n].vring.desc = desc;</span><br><span class="line">    vdev-&gt;vq[n].vring.avail = avail;</span><br><span class="line">    vdev-&gt;vq[n].vring.used = used;</span><br><span class="line">    virtio_init_region_cache(vdev, n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">virtio_init_region_cache</span><span class="params">(VirtIODevice *vdev, <span class="type">int</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtQueue *vq = &amp;vdev-&gt;vq[n];</span><br><span class="line">    VRingMemoryRegionCaches *old = vq-&gt;vring.caches;</span><br><span class="line">    VRingMemoryRegionCaches *new = <span class="literal">NULL</span>;</span><br><span class="line">    hwaddr addr, size;</span><br><span class="line">    <span class="type">int64_t</span> len;</span><br><span class="line">    <span class="type">bool</span> packed;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    new = g_new0(VRingMemoryRegionCaches, <span class="number">1</span>);</span><br><span class="line">    size = virtio_queue_get_desc_size(vdev, n);</span><br><span class="line">    packed = virtio_vdev_has_feature(vq-&gt;vdev, VIRTIO_F_RING_PACKED) ?</span><br><span class="line">                                   <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">    len = address_space_cache_init(&amp;new-&gt;desc, vdev-&gt;dma_as,</span><br><span class="line">                                   addr, size, packed);</span><br><span class="line">    <span class="keyword">if</span> (len &lt; size) &#123;</span><br><span class="line">        virtio_error(vdev, <span class="string">&quot;Cannot map desc&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    size = virtio_queue_get_used_size(vdev, n);</span><br><span class="line">    len = address_space_cache_init(&amp;new-&gt;used, vdev-&gt;dma_as,</span><br><span class="line">                                   vq-&gt;vring.used, size, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (len &lt; size) &#123;</span><br><span class="line">        virtio_error(vdev, <span class="string">&quot;Cannot map used&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_used;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    size = virtio_queue_get_avail_size(vdev, n);</span><br><span class="line">    len = address_space_cache_init(&amp;new-&gt;avail, vdev-&gt;dma_as,</span><br><span class="line">                                   vq-&gt;vring.avail, size, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (len &lt; size) &#123;</span><br><span class="line">        virtio_error(vdev, <span class="string">&quot;Cannot map avail&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_avail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    qatomic_rcu_set(&amp;vq-&gt;vring.caches, new);</span><br><span class="line">    <span class="keyword">if</span> (old) &#123;</span><br><span class="line">        call_rcu(old, virtio_free_region_cache, rcu);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int64_t</span> <span class="title function_">address_space_cache_init</span><span class="params">(MemoryRegionCache *cache,</span></span><br><span class="line"><span class="params">                                 AddressSpace *as,</span></span><br><span class="line"><span class="params">                                 hwaddr addr,</span></span><br><span class="line"><span class="params">                                 hwaddr len,</span></span><br><span class="line"><span class="params">                                 <span class="type">bool</span> is_write)</span></span><br><span class="line">&#123;</span><br><span class="line">    AddressSpaceDispatch *d;</span><br><span class="line">    hwaddr l;</span><br><span class="line">    MemoryRegion *mr;</span><br><span class="line">    Int128 diff;</span><br><span class="line"></span><br><span class="line">    assert(len &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    l = len;</span><br><span class="line">    cache-&gt;fv = address_space_get_flatview(as);</span><br><span class="line">    d = flatview_to_dispatch(cache-&gt;fv);</span><br><span class="line">    cache-&gt;mrs = *address_space_translate_internal(d, addr, &amp;cache-&gt;xlat, &amp;l, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * cache-&gt;xlat is now relative to cache-&gt;mrs.mr, not to the section itself.</span></span><br><span class="line"><span class="comment">     * Take that into account to compute how many bytes are there between</span></span><br><span class="line"><span class="comment">     * cache-&gt;xlat and the end of the section.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    diff = int128_sub(cache-&gt;mrs.size,</span><br><span class="line">                      int128_make64(cache-&gt;xlat - cache-&gt;mrs.offset_within_region));</span><br><span class="line">    l = int128_get64(int128_min(diff, int128_make64(l)));</span><br><span class="line"></span><br><span class="line">    mr = cache-&gt;mrs.mr;</span><br><span class="line">    memory_region_ref(mr);</span><br><span class="line">    <span class="keyword">if</span> (memory_access_is_direct(mr, is_write)) &#123;</span><br><span class="line">        <span class="comment">/* We don&#x27;t care about the memory attributes here as we&#x27;re only</span></span><br><span class="line"><span class="comment">         * doing this if we found actual RAM, which behaves the same</span></span><br><span class="line"><span class="comment">         * regardless of attributes; so UNSPECIFIED is fine.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        l = flatview_extend_translation(cache-&gt;fv, addr, len, mr,</span><br><span class="line">                                        cache-&gt;xlat, l, is_write,</span><br><span class="line">                                        MEMTXATTRS_UNSPECIFIED);</span><br><span class="line">        cache-&gt;ptr = qemu_ram_ptr_length(mr-&gt;ram_block, cache-&gt;xlat, &amp;l, <span class="literal">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cache-&gt;ptr = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cache-&gt;len = l;</span><br><span class="line">    cache-&gt;is_write = is_write;</span><br><span class="line">    <span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>根据<a href="/2024/07/20/qemu%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" title="qemu内存模型">qemu内存模型</a>可知，这里直接将<strong>virtqueue</strong>对应的<strong>gpa</strong>转换为qemu中的<strong>hva</strong>存储在<strong>VRingMemoryRegionCaches</strong>结构中。因此<strong>virito设备</strong>可通过该结构直接访问<strong>virtiqueue</strong>中的数据，而<strong>guest</strong>通过<strong>gpa</strong>直接访问<strong>virtqueue</strong>中的数据，从而实现数据传输</p>
<h3 id="数据通知"><a href="#数据通知" class="headerlink" title="数据通知"></a>数据通知</h3><p>通知包括两部分——<strong>guest</strong>通知<strong>virtio设备</strong>(ioeventfd)、<strong>virtio设备</strong>中断<strong>guest</strong>(ioctl)。</p>
<p>其中前半部分是由内核的<strong>eventfd</strong>机制实现</p>
<blockquote>
<p>eventfd() creates an “eventfd object” that can be used as an<br>event wait/notify mechanism by user-space applications, and by<br>the kernel to notify user-space applications of events.</p>
</blockquote>
<p>而后半部分则是由硬件提供的机制实现的，即cpu提供了向<strong>guest</strong>注入中断的接口，则<strong>virtio设备</strong>通过ioctl调用该接口即可</p>
<h4 id="通知设备"><a href="#通知设备" class="headerlink" title="通知设备"></a>通知设备</h4><p>ioeventfd机制的示意图如下图所示<br><img src="ioeventfd示意图.png" alt="ioeventfd示意图"></p>
<p>根据前面<a href="#virtio组件">virtio组件</a>小节可知，当<strong>guest</strong>设置<strong>VIRTIO_PCI_COMMON_STATUS</strong>字段来完成virtio设备的设置时，qemu会调用<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-pci.c#L373"><strong>virtio_pci_start_ioeventfd()</strong></a>设置<strong>eventfd</strong>，如下所示<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#0  virtio_bus_start_ioeventfd (bus=0x5555580b8df0) at ../../qemu/hw/virtio/virtio-bus.c:220</span></span><br><span class="line"><span class="comment">//#1  0x0000555555b6f952 in virtio_pci_start_ioeventfd (proxy=0x5555580b0900) at ../../qemu/hw/virtio/virtio-pci.c:375</span></span><br><span class="line"><span class="comment">//#2  0x0000555555b72cae in virtio_pci_common_write (opaque=0x5555580b0900, addr=20, val=15, size=1) at ../../qemu/hw/virtio/virtio-pci.c:1732</span></span><br><span class="line"><span class="comment">//#3  0x0000555555e19a00 in memory_region_write_accessor (mr=0x5555580b1440, addr=20, value=0x7ffff65ff5d8, size=1, shift=0, mask=255, attrs=...) at ../../qemu/system/memory.c:497</span></span><br><span class="line"><span class="comment">//#4  0x0000555555e19d39 in access_with_adjusted_size (addr=20, value=0x7ffff65ff5d8, size=1, access_size_min=1, access_size_max=4, access_fn=0x555555e19906 &lt;memory_region_write_accessor&gt;, mr=0x5555580b1440, attrs=...) at ../../qemu/system/memory.c:573</span></span><br><span class="line"><span class="comment">//#5  0x0000555555e1d053 in memory_region_dispatch_write (mr=0x5555580b1440, addr=20, data=15, op=MO_8, attrs=...) at ../../qemu/system/memory.c:1521</span></span><br><span class="line"><span class="comment">//#6  0x0000555555e2b7a0 in flatview_write_continue_step (attrs=..., buf=0x7ffff7f89028 &quot;\017&quot;, len=1, mr_addr=20, l=0x7ffff65ff6c0, mr=0x5555580b1440) at ../../qemu/system/physmem.c:2713</span></span><br><span class="line"><span class="comment">//#7  0x0000555555e2b870 in flatview_write_continue (fv=0x7ffee8000c10, addr=30786325577748, attrs=..., ptr=0x7ffff7f89028, len=1, mr_addr=20, l=1, mr=0x5555580b1440) at ../../qemu/system/physmem.c:2743</span></span><br><span class="line"><span class="comment">//#8  0x0000555555e2b982 in flatview_write (fv=0x7ffee8000c10, addr=30786325577748, attrs=..., buf=0x7ffff7f89028, len=1) at ../../qemu/system/physmem.c:2774</span></span><br><span class="line"><span class="comment">//#9  0x0000555555e2bdd0 in address_space_write (as=0x55555704dce0 &lt;address_space_memory&gt;, addr=30786325577748, attrs=..., buf=0x7ffff7f89028, len=1) at ../../qemu/system/physmem.c:2894</span></span><br><span class="line"><span class="comment">//#10 0x0000555555e2be4c in address_space_rw (as=0x55555704dce0 &lt;address_space_memory&gt;, addr=30786325577748, attrs=..., buf=0x7ffff7f89028, len=1, is_write=true) at ../../qemu/system/physmem.c:2904</span></span><br><span class="line"><span class="comment">//#11 0x0000555555e85e36 in kvm_cpu_exec (cpu=0x5555573b4110) at ../../qemu/accel/kvm/kvm-all.c:2912</span></span><br><span class="line"><span class="comment">//#12 0x0000555555e88eb8 in kvm_vcpu_thread_fn (arg=0x5555573b4110) at ../../qemu/accel/kvm/kvm-accel-ops.c:50</span></span><br><span class="line"><span class="comment">//#13 0x00005555560b2687 in qemu_thread_start (args=0x5555573bd220) at ../../qemu/util/qemu-thread-posix.c:541</span></span><br><span class="line"><span class="comment">//#14 0x00007ffff7894ac3 in start_thread (arg=&lt;optimized out&gt;) at ./nptl/pthread_create.c:442</span></span><br><span class="line"><span class="comment">//#15 0x00007ffff7926850 in clone3 () at ../sysdeps/unix/sysv/linux/x86_64/clone3.S:81</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_pci_start_ioeventfd</span><span class="params">(VirtIOPCIProxy *proxy)</span></span><br><span class="line">&#123;</span><br><span class="line">    virtio_bus_start_ioeventfd(&amp;proxy-&gt;bus);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">virtio_bus_start_ioeventfd</span><span class="params">(VirtioBusState *bus)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtioBusClass *k = VIRTIO_BUS_GET_CLASS(bus);</span><br><span class="line">    DeviceState *proxy = DEVICE(BUS(bus)-&gt;parent);</span><br><span class="line">    VirtIODevice *vdev = virtio_bus_get_device(bus);</span><br><span class="line">    VirtioDeviceClass *vdc = VIRTIO_DEVICE_GET_CLASS(vdev);</span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!k-&gt;ioeventfd_assign || !k-&gt;ioeventfd_enabled(proxy)) &#123;</span><br><span class="line">        <span class="keyword">return</span> -ENOSYS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (bus-&gt;ioeventfd_started) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Only set our notifier if we have ownership.  */</span></span><br><span class="line">    <span class="keyword">if</span> (!bus-&gt;ioeventfd_grabbed) &#123;</span><br><span class="line">        r = vdc-&gt;start_ioeventfd(vdev);</span><br><span class="line">        <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            error_report(<span class="string">&quot;%s: failed. Fallback to userspace (slower).&quot;</span>, __func__);</span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    bus-&gt;ioeventfd_started = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">virtio_device_start_ioeventfd_impl</span><span class="params">(VirtIODevice *vdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtioBusState *qbus = VIRTIO_BUS(qdev_get_parent_bus(DEVICE(vdev)));</span><br><span class="line">    <span class="type">int</span> i, n, r, err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Batch all the host notifiers in a single transaction to avoid</span></span><br><span class="line"><span class="comment">     * quadratic time complexity in address_space_update_ioeventfds().</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    memory_region_transaction_begin();</span><br><span class="line">    <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; VIRTIO_QUEUE_MAX; n++) &#123;</span><br><span class="line">        VirtQueue *vq = &amp;vdev-&gt;vq[n];</span><br><span class="line">        <span class="keyword">if</span> (!virtio_queue_get_num(vdev, n)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        r = virtio_bus_set_host_notifier(qbus, n, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            err = r;</span><br><span class="line">            <span class="keyword">goto</span> assign_error;</span><br><span class="line">        &#125;</span><br><span class="line">        event_notifier_set_handler(&amp;vq-&gt;host_notifier,</span><br><span class="line">                                   virtio_queue_host_notifier_read);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    memory_region_transaction_commit();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其可划分两部分——<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio-bus.c#L276"><strong>virtio_bus_set_host_notifier()</strong></a>向kvm注册eventfd、<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/util/main-loop.c#L648"><strong>event_notifier_set_handler()</strong></a>注册等待线程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#0  memory_region_add_eventfd (mr=0x55555820ae80, addr=0, size=0, match_data=false, data=0, e=0x55555821cbb4) at ../../qemu/system/memory.c:2565</span></span><br><span class="line"><span class="comment">//#1  0x0000555555b6f81c in virtio_pci_ioeventfd_assign (d=0x555558209fe0, notifier=0x55555821cbb4, n=0, assign=true) at ../../qemu/hw/virtio/virtio-pci.c:345</span></span><br><span class="line"><span class="comment">//#2  0x0000555555b6df98 in virtio_bus_set_host_notifier (bus=0x555558212450, n=0, assign=true) at ../../qemu/hw/virtio/virtio-bus.c:296</span></span><br><span class="line"><span class="comment">//#3  0x0000555555def47c in virtio_device_start_ioeventfd_impl (vdev=0x5555582124d0) at ../../qemu/hw/virtio/virtio.c:3833</span></span><br><span class="line"><span class="comment">//#4  0x0000555555b6dd54 in virtio_bus_start_ioeventfd (bus=0x555558212450) at ../../qemu/hw/virtio/virtio-bus.c:236</span></span><br><span class="line"><span class="comment">//#5  0x0000555555b6f952 in virtio_pci_start_ioeventfd (proxy=0x555558209fe0) at ../../qemu/hw/virtio/virtio-pci.c:375</span></span><br><span class="line"><span class="comment">//#6  0x0000555555b72cae in virtio_pci_common_write (opaque=0x555558209fe0, addr=20, val=15, size=1) at ../../qemu/hw/virtio/virtio-pci.c:1732</span></span><br><span class="line"><span class="comment">//#7  0x0000555555e19a00 in memory_region_write_accessor (mr=0x55555820ab20, addr=20, value=0x7ffff65ff5d8, size=1, shift=0, mask=255, attrs=...) at ../../qemu/system/memory.c:497</span></span><br><span class="line"><span class="comment">//#8  0x0000555555e19d39 in access_with_adjusted_size (addr=20, value=0x7ffff65ff5d8, size=1, access_size_min=1, access_size_max=4, access_fn=0x555555e19906 &lt;memory_region_write_accessor&gt;, mr=0x55555820ab20, attrs=...) at ../../qemu/system/memory.c:573</span></span><br><span class="line"><span class="comment">//#9  0x0000555555e1d053 in memory_region_dispatch_write (mr=0x55555820ab20, addr=20, data=15, op=MO_8, attrs=...) at ../../qemu/system/memory.c:1521</span></span><br><span class="line"><span class="comment">//#10 0x0000555555e2b7a0 in flatview_write_continue_step (attrs=..., buf=0x7ffff7f89028 &quot;\017&quot;, len=1, mr_addr=20, l=0x7ffff65ff6c0, mr=0x55555820ab20) at ../../qemu/system/physmem.c:2713</span></span><br><span class="line"><span class="comment">//#11 0x0000555555e2b870 in flatview_write_continue (fv=0x7ffee8000c10, addr=30786325594132, attrs=..., ptr=0x7ffff7f89028, len=1, mr_addr=20, l=1, mr=0x55555820ab20) at ../../qemu/system/physmem.c:2743</span></span><br><span class="line"><span class="comment">//#12 0x0000555555e2b982 in flatview_write (fv=0x7ffee8000c10, addr=30786325594132, attrs=..., buf=0x7ffff7f89028, len=1) at ../../qemu/system/physmem.c:2774</span></span><br><span class="line"><span class="comment">//#13 0x0000555555e2bdd0 in address_space_write (as=0x55555704dce0 &lt;address_space_memory&gt;, addr=30786325594132, attrs=..., buf=0x7ffff7f89028, len=1) at ../../qemu/system/physmem.c:2894</span></span><br><span class="line"><span class="comment">//#14 0x0000555555e2be4c in address_space_rw (as=0x55555704dce0 &lt;address_space_memory&gt;, addr=30786325594132, attrs=..., buf=0x7ffff7f89028, len=1, is_write=true) at ../../qemu/system/physmem.c:2904</span></span><br><span class="line"><span class="comment">//#15 0x0000555555e85e36 in kvm_cpu_exec (cpu=0x5555573b4110) at ../../qemu/accel/kvm/kvm-all.c:2912</span></span><br><span class="line"><span class="comment">//#16 0x0000555555e88eb8 in kvm_vcpu_thread_fn (arg=0x5555573b4110) at ../../qemu/accel/kvm/kvm-accel-ops.c:50</span></span><br><span class="line"><span class="comment">//#17 0x00005555560b2687 in qemu_thread_start (args=0x5555573bd220) at ../../qemu/util/qemu-thread-posix.c:541</span></span><br><span class="line"><span class="comment">//#18 0x00007ffff7894ac3 in start_thread (arg=&lt;optimized out&gt;) at ./nptl/pthread_create.c:442</span></span><br><span class="line"><span class="comment">//#19 0x00007ffff7926850 in clone3 () at ../sysdeps/unix/sysv/linux/x86_64/clone3.S:81</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">virtio_bus_set_host_notifier</span><span class="params">(VirtioBusState *bus, <span class="type">int</span> n, <span class="type">bool</span> assign)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtIODevice *vdev = virtio_bus_get_device(bus);</span><br><span class="line">    VirtioBusClass *k = VIRTIO_BUS_GET_CLASS(bus);</span><br><span class="line">    DeviceState *proxy = DEVICE(BUS(bus)-&gt;parent);</span><br><span class="line">    VirtQueue *vq = virtio_get_queue(vdev, n);</span><br><span class="line">    EventNotifier *notifier = virtio_queue_get_host_notifier(vq);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    r = event_notifier_init(notifier, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        error_report(<span class="string">&quot;%s: unable to init event notifier: %s (%d)&quot;</span>,</span><br><span class="line">                     __func__, strerror(-r), r);</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    r = k-&gt;ioeventfd_assign(proxy, notifier, n, <span class="literal">true</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">event_notifier_init</span><span class="params">(EventNotifier *e, <span class="type">int</span> active)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fds[<span class="number">2</span>];</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    ret = eventfd(<span class="number">0</span>, EFD_NONBLOCK | EFD_CLOEXEC);</span><br><span class="line">    ...</span><br><span class="line">    e-&gt;rfd = e-&gt;wfd = ret;</span><br><span class="line">    e-&gt;initialized = <span class="literal">true</span>;</span><br><span class="line">    event_notifier_set(e);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">event_notifier_set</span><span class="params">(EventNotifier *e)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">uint64_t</span> value = <span class="number">1</span>;</span><br><span class="line">    <span class="type">ssize_t</span> ret;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        ret = write(e-&gt;wfd, &amp;value, <span class="keyword">sizeof</span>(value));</span><br><span class="line">    &#125; <span class="keyword">while</span> (ret &lt; <span class="number">0</span> &amp;&amp; errno == EINTR);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">virtio_pci_ioeventfd_assign</span><span class="params">(DeviceState *d, EventNotifier *notifier,</span></span><br><span class="line"><span class="params">                                       <span class="type">int</span> n, <span class="type">bool</span> assign)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtIOPCIProxy *proxy = to_virtio_pci_proxy(d);</span><br><span class="line">    VirtIODevice *vdev = virtio_bus_get_device(&amp;proxy-&gt;bus);</span><br><span class="line">    VirtQueue *vq = virtio_get_queue(vdev, n);</span><br><span class="line">    <span class="type">bool</span> modern = virtio_pci_modern(proxy);</span><br><span class="line">    MemoryRegion *modern_mr = &amp;proxy-&gt;notify.mr;</span><br><span class="line">    hwaddr modern_addr = virtio_pci_queue_mem_mult(proxy) *</span><br><span class="line">                         virtio_get_queue_index(vq);</span><br><span class="line">    hwaddr legacy_addr = VIRTIO_PCI_QUEUE_NOTIFY;</span><br><span class="line">    ...</span><br><span class="line">    memory_region_add_eventfd(modern_mr, modern_addr, <span class="number">0</span>,</span><br><span class="line">                              <span class="literal">false</span>, n, notifier);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">memory_region_add_eventfd</span><span class="params">(MemoryRegion *mr,</span></span><br><span class="line"><span class="params">                               hwaddr addr,</span></span><br><span class="line"><span class="params">                               <span class="type">unsigned</span> size,</span></span><br><span class="line"><span class="params">                               <span class="type">bool</span> match_data,</span></span><br><span class="line"><span class="params">                               <span class="type">uint64_t</span> data,</span></span><br><span class="line"><span class="params">                               EventNotifier *e)</span></span><br><span class="line">&#123;</span><br><span class="line">    MemoryRegionIoeventfd mrfd = &#123;</span><br><span class="line">        .addr.start = int128_make64(addr),</span><br><span class="line">        .addr.size = int128_make64(size),</span><br><span class="line">        .match_data = match_data,</span><br><span class="line">        .data = data,</span><br><span class="line">        .e = e,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">unsigned</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size) &#123;</span><br><span class="line">        adjust_endianness(mr, &amp;mrfd.data, size_memop(size) | MO_TE);</span><br><span class="line">    &#125;</span><br><span class="line">    memory_region_transaction_begin();</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; mr-&gt;ioeventfd_nb; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (memory_region_ioeventfd_before(&amp;mrfd, &amp;mr-&gt;ioeventfds[i])) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ++mr-&gt;ioeventfd_nb;</span><br><span class="line">    mr-&gt;ioeventfds = g_realloc(mr-&gt;ioeventfds,</span><br><span class="line">                                  <span class="keyword">sizeof</span>(*mr-&gt;ioeventfds) * mr-&gt;ioeventfd_nb);</span><br><span class="line">    memmove(&amp;mr-&gt;ioeventfds[i+<span class="number">1</span>], &amp;mr-&gt;ioeventfds[i],</span><br><span class="line">            <span class="keyword">sizeof</span>(*mr-&gt;ioeventfds) * (mr-&gt;ioeventfd_nb<span class="number">-1</span> - i));</span><br><span class="line">    mr-&gt;ioeventfds[i] = mrfd;</span><br><span class="line">    ioeventfd_update_pending |= mr-&gt;enabled;</span><br><span class="line">    memory_region_transaction_commit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//#0  kvm_set_ioeventfd_mmio (fd=28, addr=481036349440, val=0, assign=true, size=0, datamatch=false) at ../../qemu/accel/kvm/kvm-all.c:1187</span></span><br><span class="line"><span class="comment">//#1  0x0000555555e8764a in kvm_mem_ioeventfd_add (listener=0x555557101240, section=0x7ffff65ff290, match_data=false, data=0, e=0x5555580d4334) at ../../qemu/accel/kvm/kvm-all.c:1655</span></span><br><span class="line"><span class="comment">//#2  0x0000555555e1f689 in address_space_add_del_ioeventfds (as=0x555557055ee0 &lt;address_space_memory&gt;, fds_new=0x7ffee0417450, fds_new_nb=5, fds_old=0x7ffee00533a0, fds_old_nb=2) at ../../qemu/system/memory.c:818</span></span><br><span class="line"><span class="comment">//#3  0x0000555555e1fa13 in address_space_update_ioeventfds (as=0x555557055ee0 &lt;address_space_memory&gt;) at ../../qemu/system/memory.c:883</span></span><br><span class="line"><span class="comment">//#4  0x0000555555e208e4 in memory_region_transaction_commit () at ../../qemu/system/memory.c:1140</span></span><br><span class="line"><span class="comment">//#5  0x0000555555df3d83 in virtio_device_start_ioeventfd_impl (vdev=0x5555580c6260) at ../../qemu/hw/virtio/virtio.c:3850</span></span><br><span class="line"><span class="comment">//#6  0x0000555555b70194 in virtio_bus_start_ioeventfd (bus=0x5555580c61e0) at ../../qemu/hw/virtio/virtio-bus.c:236</span></span><br><span class="line"><span class="comment">//#7  0x0000555555b71d92 in virtio_pci_start_ioeventfd (proxy=0x5555580bdd70) at ../../qemu/hw/virtio/virtio-pci.c:375</span></span><br><span class="line"><span class="comment">//#8  0x0000555555b750ee in virtio_pci_common_write (opaque=0x5555580bdd70, addr=20, val=15, size=1) at ../../qemu/hw/virtio/virtio-pci.c:1732</span></span><br><span class="line"><span class="comment">//#9  0x0000555555e1e25a in memory_region_write_accessor (mr=0x5555580be8b0, addr=20, value=0x7ffff65ff5d8, size=1, shift=0, mask=255, attrs=...) at ../../qemu/system/memory.c:497</span></span><br><span class="line"><span class="comment">//#10 0x0000555555e1e593 in access_with_adjusted_size (addr=20, value=0x7ffff65ff5d8, size=1, access_size_min=1, access_size_max=4, access_fn=0x555555e1e160 &lt;memory_region_write_accessor&gt;, mr=0x5555580be8b0, attrs=...) at ../../qemu/system/memory.c:573</span></span><br><span class="line"><span class="comment">//#11 0x0000555555e218ad in memory_region_dispatch_write (mr=0x5555580be8b0, addr=20, data=15, op=MO_8, attrs=...) at ../../qemu/system/memory.c:1521</span></span><br><span class="line"><span class="comment">//#12 0x0000555555e2fffa in flatview_write_continue_step (attrs=..., buf=0x7ffff7f89028 &quot;\017&quot;, len=1, mr_addr=20, l=0x7ffff65ff6c0, mr=0x5555580be8b0) at ../../qemu/system/physmem.c:2713</span></span><br><span class="line"><span class="comment">//#13 0x0000555555e300ca in flatview_write_continue (fv=0x7ffee80eb500, addr=481036337172, attrs=..., ptr=0x7ffff7f89028, len=1, mr_addr=20, l=1, mr=0x5555580be8b0) at ../../qemu/system/physmem.c:2743</span></span><br><span class="line"><span class="comment">//#14 0x0000555555e301dc in flatview_write (fv=0x7ffee80eb500, addr=481036337172, attrs=..., buf=0x7ffff7f89028, len=1) at ../../qemu/system/physmem.c:2774</span></span><br><span class="line"><span class="comment">//#15 0x0000555555e3062a in address_space_write (as=0x555557055ee0 &lt;address_space_memory&gt;, addr=481036337172, attrs=..., buf=0x7ffff7f89028, len=1) at ../../qemu/system/physmem.c:2894</span></span><br><span class="line"><span class="comment">//#16 0x0000555555e306a6 in address_space_rw (as=0x555557055ee0 &lt;address_space_memory&gt;, addr=481036337172, attrs=..., buf=0x7ffff7f89028, len=1, is_write=true) at ../../qemu/system/physmem.c:2904</span></span><br><span class="line"><span class="comment">//#17 0x0000555555e8a690 in kvm_cpu_exec (cpu=0x5555573bc6a0) at ../../qemu/accel/kvm/kvm-all.c:2912</span></span><br><span class="line"><span class="comment">//#18 0x0000555555e8d712 in kvm_vcpu_thread_fn (arg=0x5555573bc6a0) at ../../qemu/accel/kvm/kvm-accel-ops.c:50</span></span><br><span class="line"><span class="comment">//#19 0x00005555560b6f08 in qemu_thread_start (args=0x5555573c5850) at ../../qemu/util/qemu-thread-posix.c:541</span></span><br><span class="line"><span class="comment">//#20 0x00007ffff7694ac3 in start_thread (arg=&lt;optimized out&gt;) at ./nptl/pthread_create.c:442</span></span><br><span class="line"><span class="comment">//#21 0x00007ffff7726850 in clone3 () at ../sysdeps/unix/sysv/linux/x86_64/clone3.S:81</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">address_space_update_ioeventfds</span><span class="params">(AddressSpace *as)</span></span><br><span class="line">&#123;</span><br><span class="line">    FlatView *view;</span><br><span class="line">    FlatRange *fr;</span><br><span class="line">    <span class="type">unsigned</span> ioeventfd_nb = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> ioeventfd_max;</span><br><span class="line">    MemoryRegionIoeventfd *ioeventfds;</span><br><span class="line">    AddrRange tmp;</span><br><span class="line">    <span class="type">unsigned</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!as-&gt;ioeventfd_notifiers) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * It is likely that the number of ioeventfds hasn&#x27;t changed much, so use</span></span><br><span class="line"><span class="comment">     * the previous size as the starting value, with some headroom to avoid</span></span><br><span class="line"><span class="comment">     * gratuitous reallocations.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ioeventfd_max = QEMU_ALIGN_UP(as-&gt;ioeventfd_nb, <span class="number">4</span>);</span><br><span class="line">    ioeventfds = g_new(MemoryRegionIoeventfd, ioeventfd_max);</span><br><span class="line"></span><br><span class="line">    view = address_space_get_flatview(as);</span><br><span class="line">    FOR_EACH_FLAT_RANGE(fr, view) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; fr-&gt;mr-&gt;ioeventfd_nb; ++i) &#123;</span><br><span class="line">            tmp = addrrange_shift(fr-&gt;mr-&gt;ioeventfds[i].addr,</span><br><span class="line">                                  int128_sub(fr-&gt;addr.start,</span><br><span class="line">                                             int128_make64(fr-&gt;offset_in_region)));</span><br><span class="line">            <span class="keyword">if</span> (addrrange_intersects(fr-&gt;addr, tmp)) &#123;</span><br><span class="line">                ++ioeventfd_nb;</span><br><span class="line">                <span class="keyword">if</span> (ioeventfd_nb &gt; ioeventfd_max) &#123;</span><br><span class="line">                    ioeventfd_max = MAX(ioeventfd_max * <span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line">                    ioeventfds = g_realloc(ioeventfds,</span><br><span class="line">                            ioeventfd_max * <span class="keyword">sizeof</span>(*ioeventfds));</span><br><span class="line">                &#125;</span><br><span class="line">                ioeventfds[ioeventfd_nb<span class="number">-1</span>] = fr-&gt;mr-&gt;ioeventfds[i];</span><br><span class="line">                ioeventfds[ioeventfd_nb<span class="number">-1</span>].addr = tmp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    address_space_add_del_ioeventfds(as, ioeventfds, ioeventfd_nb,</span><br><span class="line">                                     as-&gt;ioeventfds, as-&gt;ioeventfd_nb);</span><br><span class="line"></span><br><span class="line">    g_free(as-&gt;ioeventfds);</span><br><span class="line">    as-&gt;ioeventfds = ioeventfds;</span><br><span class="line">    as-&gt;ioeventfd_nb = ioeventfd_nb;</span><br><span class="line">    flatview_unref(view);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">address_space_add_del_ioeventfds</span><span class="params">(AddressSpace *as,</span></span><br><span class="line"><span class="params">                                             MemoryRegionIoeventfd *fds_new,</span></span><br><span class="line"><span class="params">                                             <span class="type">unsigned</span> fds_new_nb,</span></span><br><span class="line"><span class="params">                                             MemoryRegionIoeventfd *fds_old,</span></span><br><span class="line"><span class="params">                                             <span class="type">unsigned</span> fds_old_nb)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> iold, inew;</span><br><span class="line">    MemoryRegionIoeventfd *fd;</span><br><span class="line">    MemoryRegionSection section;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Generate a symmetric difference of the old and new fd sets, adding</span></span><br><span class="line"><span class="comment">     * and deleting as necessary.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    iold = inew = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (iold &lt; fds_old_nb || inew &lt; fds_new_nb) &#123;</span><br><span class="line">        <span class="keyword">if</span> (iold &lt; fds_old_nb</span><br><span class="line">            &amp;&amp; (inew == fds_new_nb</span><br><span class="line">                || memory_region_ioeventfd_before(&amp;fds_old[iold],</span><br><span class="line">                                                  &amp;fds_new[inew]))) &#123;</span><br><span class="line">            fd = &amp;fds_old[iold];</span><br><span class="line">            section = (MemoryRegionSection) &#123;</span><br><span class="line">                .fv = address_space_to_flatview(as),</span><br><span class="line">                .offset_within_address_space = int128_get64(fd-&gt;addr.start),</span><br><span class="line">                .size = fd-&gt;addr.size,</span><br><span class="line">            &#125;;</span><br><span class="line">            MEMORY_LISTENER_CALL(as, eventfd_del, Forward, &amp;section,</span><br><span class="line">                                 fd-&gt;match_data, fd-&gt;data, fd-&gt;e);</span><br><span class="line">            ++iold;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inew &lt; fds_new_nb</span><br><span class="line">                   &amp;&amp; (iold == fds_old_nb</span><br><span class="line">                       || memory_region_ioeventfd_before(&amp;fds_new[inew],</span><br><span class="line">                                                         &amp;fds_old[iold]))) &#123;</span><br><span class="line">            fd = &amp;fds_new[inew];</span><br><span class="line">            section = (MemoryRegionSection) &#123;</span><br><span class="line">                .fv = address_space_to_flatview(as),</span><br><span class="line">                .offset_within_address_space = int128_get64(fd-&gt;addr.start),</span><br><span class="line">                .size = fd-&gt;addr.size,</span><br><span class="line">            &#125;;</span><br><span class="line">            MEMORY_LISTENER_CALL(as, eventfd_add, Reverse, &amp;section,</span><br><span class="line">                                 fd-&gt;match_data, fd-&gt;data, fd-&gt;e);</span><br><span class="line">            ++inew;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ++iold;</span><br><span class="line">            ++inew;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">kvm_mem_ioeventfd_add</span><span class="params">(MemoryListener *listener,</span></span><br><span class="line"><span class="params">                                  MemoryRegionSection *section,</span></span><br><span class="line"><span class="params">                                  <span class="type">bool</span> match_data, <span class="type">uint64_t</span> data,</span></span><br><span class="line"><span class="params">                                  EventNotifier *e)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd = event_notifier_get_fd(e);</span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line"></span><br><span class="line">    r = kvm_set_ioeventfd_mmio(fd, section-&gt;offset_within_address_space,</span><br><span class="line">                               data, <span class="literal">true</span>, int128_get64(section-&gt;size),</span><br><span class="line">                               match_data);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">event_notifier_get_fd</span><span class="params">(<span class="type">const</span> EventNotifier *e)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> e-&gt;rfd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">kvm_set_ioeventfd_mmio</span><span class="params">(<span class="type">int</span> fd, hwaddr addr, <span class="type">uint32_t</span> val,</span></span><br><span class="line"><span class="params">                                  <span class="type">bool</span> assign, <span class="type">uint32_t</span> size, <span class="type">bool</span> datamatch)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_ioeventfd</span> <span class="title">iofd</span> =</span> &#123;</span><br><span class="line">        .datamatch = datamatch ? adjust_ioeventfd_endianness(val, size) : <span class="number">0</span>,</span><br><span class="line">        .addr = addr,</span><br><span class="line">        .len = size,</span><br><span class="line">        .flags = <span class="number">0</span>,</span><br><span class="line">        .fd = fd,</span><br><span class="line">    &#125;;</span><br><span class="line">    ...</span><br><span class="line">    ret = kvm_vm_ioctl(kvm_state, KVM_IOEVENTFD, &amp;iofd);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单来说，其在<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/util/event_notifier-posix.c#L35"><strong>event_notifier_init()</strong></a>中调用<strong>eventfd</strong>系统调用并获取对应的文件描述符，然后在<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/accel/kvm/kvm-all.c#L1647"><strong>kvm_mem_ioeventfd_add()</strong></a>中将该文件描述符通过<strong>ioctl</strong>传递给<strong>kvm内核模块</strong>，后续<strong>kvm内核模块</strong>可以唤醒被阻塞的用于轮询的<strong>virtio设备</strong>的任务，完成<strong>guest</strong>通知<strong>virtio设备</strong></p>
<p>下面分析一下<strong>virtio设备</strong>如何将<strong>eventfd</strong>的文件描述符绑定到等待线程任务上的，其相关代码如下所示<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#0  aio_set_event_notifier (ctx=0x5555570ea810, notifier=0x5555580ca6e4, io_read=0x555555deed70 &lt;virtio_queue_host_notifier_read&gt;, io_poll=0x0, io_poll_ready=0x0) at ../../qemu/util/aio-posix.c:201</span></span><br><span class="line"><span class="comment">//#1  0x00005555560ce889 in event_notifier_set_handler (e=0x5555580ca6e4, handler=0x555555deed70 &lt;virtio_queue_host_notifier_read&gt;) at ../../qemu/util/main-loop.c:652</span></span><br><span class="line"><span class="comment">//#2  0x0000555555def4b1 in virtio_device_start_ioeventfd_impl (vdev=0x5555580b8df0) at ../../qemu/hw/virtio/virtio.c:3838</span></span><br><span class="line"><span class="comment">//#3  0x0000555555b6dd54 in virtio_bus_start_ioeventfd (bus=0x5555580b8d70) at ../../qemu/hw/virtio/virtio-bus.c:236</span></span><br><span class="line"><span class="comment">//#4  0x0000555555b6f952 in virtio_pci_start_ioeventfd (proxy=0x5555580b0900) at ../../qemu/hw/virtio/virtio-pci.c:375</span></span><br><span class="line"><span class="comment">//#5  0x0000555555b72cae in virtio_pci_common_write (opaque=0x5555580b0900, addr=20, val=15, size=1) at ../../qemu/hw/virtio/virtio-pci.c:1732</span></span><br><span class="line"><span class="comment">//#6  0x0000555555e19a00 in memory_region_write_accessor (mr=0x5555580b1440, addr=20, value=0x7ffff5bff5d8, size=1, shift=0, mask=255, attrs=...) at ../../qemu/system/memory.c:497</span></span><br><span class="line"><span class="comment">//#7  0x0000555555e19d39 in access_with_adjusted_size (addr=20, value=0x7ffff5bff5d8, size=1, access_size_min=1, access_size_max=4, access_fn=0x555555e19906 &lt;memory_region_write_accessor&gt;, mr=0x5555580b1440, attrs=...) at ../../qemu/system/memory.c:573</span></span><br><span class="line"><span class="comment">//#8  0x0000555555e1d053 in memory_region_dispatch_write (mr=0x5555580b1440, addr=20, data=15, op=MO_8, attrs=...) at ../../qemu/system/memory.c:1521</span></span><br><span class="line"><span class="comment">//#9  0x0000555555e2b7a0 in flatview_write_continue_step (attrs=..., buf=0x7ffff7f86028 &quot;\017\020&quot;, len=1, mr_addr=20, l=0x7ffff5bff6c0, mr=0x5555580b1440) at ../../qemu/system/physmem.c:2713</span></span><br><span class="line"><span class="comment">//#10 0x0000555555e2b870 in flatview_write_continue (fv=0x7ffee0040190, addr=30786325577748, attrs=..., ptr=0x7ffff7f86028, len=1, mr_addr=20, l=1, mr=0x5555580b1440) at ../../qemu/system/physmem.c:2743</span></span><br><span class="line"><span class="comment">//#11 0x0000555555e2b982 in flatview_write (fv=0x7ffee0040190, addr=30786325577748, attrs=..., buf=0x7ffff7f86028, len=1) at ../../qemu/system/physmem.c:2774</span></span><br><span class="line"><span class="comment">//#12 0x0000555555e2bdd0 in address_space_write (as=0x55555704dce0 &lt;address_space_memory&gt;, addr=30786325577748, attrs=..., buf=0x7ffff7f86028, len=1) at ../../qemu/system/physmem.c:2894</span></span><br><span class="line"><span class="comment">//#13 0x0000555555e2be4c in address_space_rw (as=0x55555704dce0 &lt;address_space_memory&gt;, addr=30786325577748, attrs=..., buf=0x7ffff7f86028, len=1, is_write=true) at ../../qemu/system/physmem.c:2904</span></span><br><span class="line"><span class="comment">//#14 0x0000555555e85e36 in kvm_cpu_exec (cpu=0x5555573e72d0) at ../../qemu/accel/kvm/kvm-all.c:2912</span></span><br><span class="line"><span class="comment">//#15 0x0000555555e88eb8 in kvm_vcpu_thread_fn (arg=0x5555573e72d0) at ../../qemu/accel/kvm/kvm-accel-ops.c:50</span></span><br><span class="line"><span class="comment">//#16 0x00005555560b2687 in qemu_thread_start (args=0x5555573f04a0) at ../../qemu/util/qemu-thread-posix.c:541</span></span><br><span class="line"><span class="comment">//#17 0x00007ffff7894ac3 in start_thread (arg=&lt;optimized out&gt;) at ./nptl/pthread_create.c:442</span></span><br><span class="line"><span class="comment">//#18 0x00007ffff7926850 in clone3 () at ../sysdeps/unix/sysv/linux/x86_64/clone3.S:81</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">event_notifier_set_handler</span><span class="params">(EventNotifier *e,</span></span><br><span class="line"><span class="params">                                EventNotifierHandler *handler)</span></span><br><span class="line">&#123;</span><br><span class="line">    iohandler_init();</span><br><span class="line">    aio_set_event_notifier(iohandler_ctx, e, handler, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">aio_set_event_notifier</span><span class="params">(AioContext *ctx,</span></span><br><span class="line"><span class="params">                            EventNotifier *notifier,</span></span><br><span class="line"><span class="params">                            EventNotifierHandler *io_read,</span></span><br><span class="line"><span class="params">                            AioPollFn *io_poll,</span></span><br><span class="line"><span class="params">                            EventNotifierHandler *io_poll_ready)</span></span><br><span class="line">&#123;</span><br><span class="line">    aio_set_fd_handler(ctx, event_notifier_get_fd(notifier),</span><br><span class="line">                       (IOHandler *)io_read, <span class="literal">NULL</span>, io_poll,</span><br><span class="line">                       (IOHandler *)io_poll_ready, notifier);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，其在<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/util/main-loop.c#L648"><strong>event_notifier_set_handler</strong></a>中将<strong>eventfd</strong>的文件描述符绑定到<strong>io-handler</strong>任务上，并注册<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio.c#L3667"><strong>virtio_queue_host_notifier_read()</strong></a>为对应的<strong>read</strong>回调函数，即当<strong>kvm内核模块</strong>唤醒等待线程时，<strong>qemu</strong>会执行如下的回调函数<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#0  virtio_net_handle_tx_bh (vdev=0x5555580b8df0, vq=0x5555580ca708) at ../../qemu/hw/net/virtio-net.c:2865</span></span><br><span class="line"><span class="comment">//#1  0x0000555555deb477 in virtio_queue_notify_vq (vq=0x5555580ca708) at ../../qemu/hw/virtio/virtio.c:2268</span></span><br><span class="line"><span class="comment">//#2  0x0000555555deedb0 in virtio_queue_host_notifier_read (n=0x5555580ca77c) at ../../qemu/hw/virtio/virtio.c:3671</span></span><br><span class="line"><span class="comment">//#3  0x00005555560acf67 in aio_dispatch_handler (ctx=0x5555570ea810, node=0x7ffee0c08b20) at ../../qemu/util/aio-posix.c:372</span></span><br><span class="line"><span class="comment">//#4  0x00005555560ad116 in aio_dispatch_handlers (ctx=0x5555570ea810) at ../../qemu/util/aio-posix.c:414</span></span><br><span class="line"><span class="comment">//#5  0x00005555560ad176 in aio_dispatch (ctx=0x5555570ea810) at ../../qemu/util/aio-posix.c:424</span></span><br><span class="line"><span class="comment">//#6  0x00005555560cce95 in aio_ctx_dispatch (source=0x5555570ea810, callback=0x0, user_data=0x0) at ../../qemu/util/async.c:360</span></span><br><span class="line"><span class="comment">//#7  0x00007ffff7b86d3b in g_main_context_dispatch () at /lib/x86_64-linux-gnu/libglib-2.0.so.0</span></span><br><span class="line"><span class="comment">//#8  0x00005555560ce520 in glib_pollfds_poll () at ../../qemu/util/main-loop.c:287</span></span><br><span class="line"><span class="comment">//#9  0x00005555560ce5ab in os_host_main_loop_wait (timeout=79205277539000) at ../../qemu/util/main-loop.c:310</span></span><br><span class="line"><span class="comment">//#10 0x00005555560ce6d7 in main_loop_wait (nonblocking=0) at ../../qemu/util/main-loop.c:589</span></span><br><span class="line"><span class="comment">//#11 0x0000555555bd4e54 in qemu_main_loop () at ../../qemu/system/runstate.c:783</span></span><br><span class="line"><span class="comment">//#12 0x0000555555e96f5b in qemu_default_main () at ../../qemu/system/main.c:37</span></span><br><span class="line"><span class="comment">//#13 0x0000555555e96f9c in main (argc=39, argv=0x7fffffffd9e8) at ../../qemu/system/main.c:48</span></span><br><span class="line"><span class="comment">//#14 0x00007ffff7829d90 in __libc_start_call_main (main=main@entry=0x555555e96f6f &lt;main&gt;, argc=argc@entry=39, argv=argv@entry=0x7fffffffd9e8) at ../sysdeps/nptl/libc_start_call_main.h:58</span></span><br><span class="line"><span class="comment">//#15 0x00007ffff7829e40 in __libc_start_main_impl (main=0x555555e96f6f &lt;main&gt;, argc=39, argv=0x7fffffffd9e8, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7fffffffd9d8) at ../csu/libc-start.c:392</span></span><br><span class="line"><span class="comment">//#16 0x000055555586cc95 in _start ()</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">virtio_queue_host_notifier_read</span><span class="params">(EventNotifier *n)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtQueue *vq = container_of(n, VirtQueue, host_notifier);</span><br><span class="line">    <span class="keyword">if</span> (event_notifier_test_and_clear(n)) &#123;</span><br><span class="line">        virtio_queue_notify_vq(vq);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">event_notifier_test_and_clear</span><span class="params">(EventNotifier *e)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> value;</span><br><span class="line">    <span class="type">ssize_t</span> len;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">512</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!e-&gt;initialized) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Drain the notify pipe.  For eventfd, only 8 bytes will be read.  */</span></span><br><span class="line">    value = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        len = read(e-&gt;rfd, buffer, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">        value |= (len &gt; <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> ((len == <span class="number">-1</span> &amp;&amp; errno == EINTR) || len == <span class="keyword">sizeof</span>(buffer));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_queue_notify_vq</span><span class="params">(VirtQueue *vq)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (vq-&gt;vring.desc &amp;&amp; vq-&gt;handle_output) &#123;</span><br><span class="line">        VirtIODevice *vdev = vq-&gt;vdev;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (unlikely(vdev-&gt;broken)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        trace_virtio_queue_notify(vdev, vq - vdev-&gt;vq, vq);</span><br><span class="line">        vq-&gt;handle_output(vdev, vq);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (unlikely(vdev-&gt;start_on_kick)) &#123;</span><br><span class="line">            virtio_set_started(vdev, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_net_handle_tx_bh</span><span class="params">(VirtIODevice *vdev, VirtQueue *vq)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtIONet *n = VIRTIO_NET(vdev);</span><br><span class="line">    VirtIONetQueue *q = &amp;n-&gt;vqs[vq2q(virtio_get_queue_index(vq))];</span><br><span class="line">    ...</span><br><span class="line">    virtio_queue_set_notification(vq, <span class="number">0</span>);</span><br><span class="line">    qemu_bh_schedule(q-&gt;tx_bh);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//#0  virtio_net_tx_bh (opaque=0x5555580f06e0) at ../../qemu/hw/net/virtio-net.c:2941</span></span><br><span class="line"><span class="comment">//#1  0x00005555560cc8d9 in aio_bh_call (bh=0x5555580c4380) at ../../qemu/util/async.c:171</span></span><br><span class="line"><span class="comment">//#2  0x00005555560cca00 in aio_bh_poll (ctx=0x5555570f0bf0) at ../../qemu/util/async.c:218</span></span><br><span class="line"><span class="comment">//#3  0x00005555560ad16a in aio_dispatch (ctx=0x5555570f0bf0) at ../../qemu/util/aio-posix.c:423</span></span><br><span class="line"><span class="comment">//#4  0x00005555560cce95 in aio_ctx_dispatch (source=0x5555570f0bf0, callback=0x0, user_data=0x0) at ../../qemu/util/async.c:360</span></span><br><span class="line"><span class="comment">//#5  0x00007ffff7b86d3b in g_main_context_dispatch () at /lib/x86_64-linux-gnu/libglib-2.0.so.0</span></span><br><span class="line"><span class="comment">//#6  0x00005555560ce520 in glib_pollfds_poll () at ../../qemu/util/main-loop.c:287</span></span><br><span class="line"><span class="comment">//#7  0x00005555560ce5ab in os_host_main_loop_wait (timeout=0) at ../../qemu/util/main-loop.c:310</span></span><br><span class="line"><span class="comment">//#8  0x00005555560ce6d7 in main_loop_wait (nonblocking=0) at ../../qemu/util/main-loop.c:589</span></span><br><span class="line"><span class="comment">//#9  0x0000555555bd4e54 in qemu_main_loop () at ../../qemu/system/runstate.c:783</span></span><br><span class="line"><span class="comment">//#10 0x0000555555e96f5b in qemu_default_main () at ../../qemu/system/main.c:37</span></span><br><span class="line"><span class="comment">//#11 0x0000555555e96f9c in main (argc=39, argv=0x7fffffffd9e8) at ../../qemu/system/main.c:48</span></span><br><span class="line"><span class="comment">//#12 0x00007ffff7829d90 in __libc_start_call_main (main=main@entry=0x555555e96f6f &lt;main&gt;, argc=argc@entry=39, argv=argv@entry=0x7fffffffd9e8) at ../sysdeps/nptl/libc_start_call_main.h:58</span></span><br><span class="line"><span class="comment">//#13 0x00007ffff7829e40 in __libc_start_main_impl (main=0x555555e96f6f &lt;main&gt;, argc=39, argv=0x7fffffffd9e8, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7fffffffd9d8) at ../csu/libc-start.c:392</span></span><br><span class="line"><span class="comment">//#14 0x000055555586cc95 in _start ()</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_net_tx_bh</span><span class="params">(<span class="type">void</span> *opaque)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    ret = virtio_net_flush_tx(q);</span><br><span class="line">    <span class="keyword">if</span> (ret == -EBUSY || ret == -EINVAL) &#123;</span><br><span class="line">        <span class="keyword">return</span>; <span class="comment">/* Notification re-enable handled by tx_complete or device</span></span><br><span class="line"><span class="comment">                 * broken */</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>在前面<a href="#实例化">实例化</a>中，其<strong>handle_output</strong>字段在<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/net/virtio-net.c#L2988"><strong>virtio_net_add_queue()</strong></a>中注册为<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/net/virtio-net.c#L2863"><strong>virtio_net_handle_tx_bh()</strong></a>，并将对应的<strong>bottom half</strong>设置为<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/net/virtio-net.c#L2889"><strong>virtio_net_tx_timer()</strong></a></p>
<p>所以当<strong>kvm内核模块</strong>唤醒等待线程时，<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/virtio/virtio.c#L3667"><strong>virtio_queue_host_notifier_read()</strong></a>被回调，并在<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/net/virtio-net.c#L2863"><strong>virtio_net_handle_tx_bh()</strong></a>中唤醒对应的<strong>bottom half</strong>任务，执行<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/net/virtio-net.c#L2889"><strong>virtio_net_tx_timer()</strong></a>最终处理<strong>virtqueue</strong>中传递的数据</p>
<h4 id="通知guest"><a href="#通知guest" class="headerlink" title="通知guest"></a>通知guest</h4><p>根据前面<a href="#可用buffer通知">virtio标准</a>小节可知，一般是Qemu注入对应的MSIx中断来通知<strong>guest</strong>，msix中断通知的示意图如下所示<br><img src="msi中断示意图.png" alt="msix中断示意图"></p>
<p>由于<strong>msix中断</strong>涉及中断虚拟化等多方面的内容，这里不详细分析，只简单介绍一下。</p>
<p><strong>msix中断</strong>是<strong>pci协议</strong>为了绕过较慢的<strong>ioapic</strong>中断处理器直接将设备中断发送到处理速度更快的<strong>lapic</strong>中断处理器的机制。具体来说，<strong>pci设备</strong>根据PCI设置空间的<strong>msix table</strong>中指定的地址(即<strong>lapic</strong>映射到的地址空间)中写入数据，从而触发<strong>lapic</strong>中断。</p>
<p>而qemu模拟了该操作，其<strong>msix table</strong>中指定的地址空间属于<strong>apic设备</strong>，该地址的写由对应<strong>MemoryRegion</strong>的回调函数<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/qemu/v9.0.0-rc2/source/hw/i386/kvm/apic.c#L206"><strong>kvm_apic_mem_write()</strong></a>处理<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#0  kvm_irqchip_send_msi (s=0x5555570f9160, msg=...) at ../../qemu/accel/kvm/kvm-all.c:1951</span></span><br><span class="line"><span class="comment">//#1  0x0000555555ce262c in kvm_send_msi (msg=0x7fffffff5300) at ../../qemu/hw/i386/kvm/apic.c:193</span></span><br><span class="line"><span class="comment">//#2  0x0000555555ce26d6 in kvm_apic_mem_write (opaque=0x555557276400, addr=4096, data=36, size=4) at ../../qemu/hw/i386/kvm/apic.c:211</span></span><br><span class="line"><span class="comment">//#3  0x0000555555e19a00 in memory_region_write_accessor (mr=0x5555572764a0, addr=4096, value=0x7fffffff5428, size=4, shift=0, mask=4294967295, attrs=...) at ../../qemu/system/memory.c:497</span></span><br><span class="line"><span class="comment">//#4  0x0000555555e19d39 in access_with_adjusted_size (addr=4096, value=0x7fffffff5428, size=4, access_size_min=1, access_size_max=4, access_fn=0x555555e19906 &lt;memory_region_write_accessor&gt;, mr=0x5555572764a0, attrs=...) at ../../qemu/system/memory.c:573</span></span><br><span class="line"><span class="comment">//#5  0x0000555555e1d053 in memory_region_dispatch_write (mr=0x5555572764a0, addr=4096, data=36, op=MO_32, attrs=...) at ../../qemu/system/memory.c:1521</span></span><br><span class="line"><span class="comment">//#6  0x0000555555e2d666 in address_space_stl_internal (as=0x5555580b58e0, addr=4276097024, val=36, attrs=..., result=0x0, endian=DEVICE_LITTLE_ENDIAN) at ../../qemu/system/memory_ldst.c.inc:319</span></span><br><span class="line"><span class="comment">//#7  0x0000555555e2d7c5 in address_space_stl_le (as=0x5555580b58e0, addr=4276097024, val=36, attrs=..., result=0x0) at ../../qemu/system/memory_ldst.c.inc:357</span></span><br><span class="line"><span class="comment">//#8  0x0000555555a96287 in pci_msi_trigger (dev=0x5555580b56a0, msg=...) at ../../qemu/hw/pci/pci.c:364</span></span><br><span class="line"><span class="comment">//#9  0x0000555555a92222 in msi_send_message (dev=0x5555580b56a0, msg=...) at ../../qemu/hw/pci/msi.c:380</span></span><br><span class="line"><span class="comment">//#10 0x0000555555a93f21 in msix_notify (dev=0x5555580b56a0, vector=2) at ../../qemu/hw/pci/msix.c:542</span></span><br><span class="line"><span class="comment">//#11 0x0000555555b6f142 in virtio_pci_notify (d=0x5555580b56a0, vector=2) at ../../qemu/hw/virtio/virtio-pci.c:77</span></span><br><span class="line"><span class="comment">//#12 0x0000555555dea808 in virtio_notify_vector (vdev=0x5555580bdb90, vector=2) at ../../qemu/hw/virtio/virtio.c:2001</span></span><br><span class="line"><span class="comment">//#13 0x0000555555debf63 in virtio_irq (vq=0x5555580e4738) at ../../qemu/hw/virtio/virtio.c:2491</span></span><br><span class="line"><span class="comment">//#14 0x0000555555dec011 in virtio_notify (vdev=0x5555580bdb90, vq=0x5555580e4738) at ../../qemu/hw/virtio/virtio.c:2503</span></span><br><span class="line"><span class="comment">//#15 0x0000555555db2d6b in virtio_net_flush_tx (q=0x5555580cb6f0) at ../../qemu/hw/net/virtio-net.c:2822</span></span><br><span class="line"><span class="comment">//#16 0x0000555555db3271 in virtio_net_tx_bh (opaque=0x5555580cb6f0) at ../../qemu/hw/net/virtio-net.c:2960</span></span><br><span class="line"><span class="comment">//#17 0x00005555560cc8d9 in aio_bh_call (bh=0x5555580c5390) at ../../qemu/util/async.c:171</span></span><br><span class="line"><span class="comment">//#18 0x00005555560cca00 in aio_bh_poll (ctx=0x5555570f0bf0) at ../../qemu/util/async.c:218</span></span><br><span class="line"><span class="comment">//#19 0x00005555560ad16a in aio_dispatch (ctx=0x5555570f0bf0) at ../../qemu/util/aio-posix.c:423</span></span><br><span class="line"><span class="comment">//#20 0x00005555560cce95 in aio_ctx_dispatch (source=0x5555570f0bf0, callback=0x0, user_data=0x0) at ../../qemu/util/async.c:360</span></span><br><span class="line"><span class="comment">//#21 0x00007ffff7b88d3b in g_main_context_dispatch () at /lib/x86_64-linux-gnu/libglib-2.0.so.0</span></span><br><span class="line"><span class="comment">//#22 0x00005555560ce520 in glib_pollfds_poll () at ../../qemu/util/main-loop.c:287</span></span><br><span class="line"><span class="comment">//#23 0x00005555560ce5ab in os_host_main_loop_wait (timeout=0) at ../../qemu/util/main-loop.c:310</span></span><br><span class="line"><span class="comment">//#24 0x00005555560ce6d7 in main_loop_wait (nonblocking=0) at ../../qemu/util/main-loop.c:589</span></span><br><span class="line"><span class="comment">//#25 0x0000555555bd4e54 in qemu_main_loop () at ../../qemu/system/runstate.c:783</span></span><br><span class="line"><span class="comment">//#26 0x0000555555e96f5b in qemu_default_main () at ../../qemu/system/main.c:37</span></span><br><span class="line"><span class="comment">//#27 0x0000555555e96f9c in main (argc=39, argv=0x7fffffffdac8) at ../../qemu/system/main.c:48</span></span><br><span class="line"><span class="comment">//#28 0x00007ffff7829d90 in __libc_start_call_main (main=main@entry=0x555555e96f6f &lt;main&gt;, argc=argc@entry=39, argv=argv@entry=0x7fffffffdac8) at ../sysdeps/nptl/libc_start_call_main.h:58</span></span><br><span class="line"><span class="comment">//#29 0x00007ffff7829e40 in __libc_start_main_impl (main=0x555555e96f6f &lt;main&gt;, argc=39, argv=0x7fffffffdac8, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7fffffffdab8) at ../csu/libc-start.c:392</span></span><br><span class="line"><span class="comment">//#30 0x000055555586cc95 in _start ()</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">pci_msi_trigger</span><span class="params">(PCIDevice *dev, MSIMessage msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    MemTxAttrs attrs = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Xen uses the high bits of the address to contain some of the bits</span></span><br><span class="line"><span class="comment">     * of the PIRQ#. Therefore we can&#x27;t just send the write cycle and</span></span><br><span class="line"><span class="comment">     * trust that it&#x27;s caught by the APIC at 0xfee00000 because the</span></span><br><span class="line"><span class="comment">     * target of the write might be e.g. 0x0x1000fee46000 for PIRQ#4166.</span></span><br><span class="line"><span class="comment">     * So we intercept the delivery here instead of in kvm_send_msi().</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (xen_mode == XEN_EMULATE &amp;&amp;</span><br><span class="line">        xen_evtchn_deliver_pirq_msi(msg.address, msg.data)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    attrs.requester_id = pci_requester_id(dev);</span><br><span class="line">    address_space_stl_le(&amp;dev-&gt;bus_master_as, msg.address, msg.data,</span><br><span class="line">                         attrs, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">kvm_apic_mem_write</span><span class="params">(<span class="type">void</span> *opaque, hwaddr addr,</span></span><br><span class="line"><span class="params">                               <span class="type">uint64_t</span> data, <span class="type">unsigned</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    MSIMessage msg = &#123; .address = addr, .data = data &#125;;</span><br><span class="line"></span><br><span class="line">    kvm_send_msi(&amp;msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">kvm_send_msi</span><span class="params">(MSIMessage *msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * The message has already passed through interrupt remapping if enabled,</span></span><br><span class="line"><span class="comment">     * but the legacy extended destination ID in low bits still needs to be</span></span><br><span class="line"><span class="comment">     * handled.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    msg-&gt;address = kvm_swizzle_msi_ext_dest_id(msg-&gt;address);</span><br><span class="line"></span><br><span class="line">    ret = kvm_irqchip_send_msi(kvm_state, *msg);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">kvm_irqchip_send_msi</span><span class="params">(KVMState *s, MSIMessage msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_msi</span> <span class="title">msi</span>;</span></span><br><span class="line"></span><br><span class="line">    msi.address_lo = (<span class="type">uint32_t</span>)msg.address;</span><br><span class="line">    msi.address_hi = msg.address &gt;&gt; <span class="number">32</span>;</span><br><span class="line">    msi.data = le32_to_cpu(msg.data);</span><br><span class="line">    msi.flags = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(msi.pad, <span class="number">0</span>, <span class="keyword">sizeof</span>(msi.pad));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> kvm_vm_ioctl(s, KVM_SIGNAL_MSI, &amp;msi);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>可以看到，最后其通过<strong>ioctl()</strong>，陷入<strong>kvm内核模块</strong>，让<strong>kvm内核模块</strong>根据cpu提供的中断注入接口向<strong>guest</strong>注入中断。</p>
<h1 id="virtio驱动"><a href="#virtio驱动" class="headerlink" title="virtio驱动"></a>virtio驱动</h1><p>这里主要介绍一下<strong>guest驱动</strong>设置virtio组件和数据处理的逻辑</p>
<h2 id="virtio设置-1"><a href="#virtio设置-1" class="headerlink" title="virtio设置"></a>virtio设置</h2><p><strong>guest驱动</strong>主要的任务是申请资源地址空间，并将对应的资源空间按照前面<a href="#virtio-transport">virtio transport</a>小节的协议传递给<strong>virtio设备</strong>，即通过读写<strong>PCI设置空间</strong>和<strong>virtio配置空间</strong>将资源gpa传递给<strong>virtio设备</strong></p>
<p>因为<strong>virtio-net-pci设备</strong>即包含<strong>virtio-pci</strong>的<strong>virtio transport</strong>，也包含<strong>virtio-net</strong>的<strong>virtio设备</strong>，因此其由<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.9-rc2/source/drivers/virtio/virtio_pci_common.c#L555"><strong>virtio_pci_probe()</strong></a>和<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.9-rc2/source/drivers/net/virtio_net.c#L4624"><strong>virtnet_probe()</strong></a>共同设置，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#0  virtio_pci_probe (pci_dev=0xffff888100941000, id=0xffffffff82299f00 &lt;virtio_pci_id_table&gt;) at /home/hawk/Desktop/mqemu/kernel/drivers/virtio/virtio_pci_common.c:557</span></span><br><span class="line"><span class="comment">//#1  0xffffffff816050a2 in local_pci_probe (_ddi=_ddi@entry=0xffffc90000013d40) at /home/hawk/Desktop/mqemu/kernel/drivers/pci/pci-driver.c:324</span></span><br><span class="line"><span class="comment">//#2  0xffffffff81605fdd in pci_call_probe (id=&lt;optimized out&gt;, dev=0xffff888100941000, drv=&lt;optimized out&gt;) at /home/hawk/Desktop/mqemu/kernel/drivers/pci/pci-driver.c:392</span></span><br><span class="line"><span class="comment">//#3  __pci_device_probe (pci_dev=0xffff888100941000, drv=&lt;optimized out&gt;) at /home/hawk/Desktop/mqemu/kernel/drivers/pci/pci-driver.c:417</span></span><br><span class="line"><span class="comment">//#4  pci_device_probe (dev=0xffff8881009410c0) at /home/hawk/Desktop/mqemu/kernel/drivers/pci/pci-driver.c:451</span></span><br><span class="line"><span class="comment">//#5  0xffffffff8193dd1c in call_driver_probe (drv=0xffffffff82be1a88 &lt;virtio_pci_driver+104&gt;, dev=0xffff8881009410c0) at /home/hawk/Desktop/mqemu/kernel/drivers/base/dd.c:578</span></span><br><span class="line"><span class="comment">//#6  really_probe (dev=dev@entry=0xffff8881009410c0, drv=drv@entry=0xffffffff82be1a88 &lt;virtio_pci_driver+104&gt;) at /home/hawk/Desktop/mqemu/kernel/drivers/base/dd.c:656</span></span><br><span class="line"><span class="comment">//#7  0xffffffff8193df8e in __driver_probe_device (drv=drv@entry=0xffffffff82be1a88 &lt;virtio_pci_driver+104&gt;, dev=dev@entry=0xffff8881009410c0) at /home/hawk/Desktop/mqemu/kernel/drivers/base/dd.c:798</span></span><br><span class="line"><span class="comment">//#8  0xffffffff8193e069 in driver_probe_device (drv=drv@entry=0xffffffff82be1a88 &lt;virtio_pci_driver+104&gt;, dev=dev@entry=0xffff8881009410c0) at /home/hawk/Desktop/mqemu/kernel/drivers/base/dd.c:828</span></span><br><span class="line"><span class="comment">//#9  0xffffffff8193e2e5 in __driver_attach (data=0xffffffff82be1a88 &lt;virtio_pci_driver+104&gt;, dev=0xffff8881009410c0) at /home/hawk/Desktop/mqemu/kernel/drivers/base/dd.c:1214</span></span><br><span class="line"><span class="comment">//#10 __driver_attach (dev=0xffff8881009410c0, data=0xffffffff82be1a88 &lt;virtio_pci_driver+104&gt;) at /home/hawk/Desktop/mqemu/kernel/drivers/base/dd.c:1154</span></span><br><span class="line"><span class="comment">//#11 0xffffffff8193bab7 in bus_for_each_dev (bus=&lt;optimized out&gt;, start=start@entry=0x0 &lt;fixed_percpu_data&gt;, data=data@entry=0xffffffff82be1a88 &lt;virtio_pci_driver+104&gt;, fn=fn@entry=0xffffffff8193e260 &lt;__driver_attach&gt;) at /home/hawk/Desktop/mqemu/kernel/drivers/base/bus.c:368</span></span><br><span class="line"><span class="comment">//#12 0xffffffff8193d6f9 in driver_attach (drv=drv@entry=0xffffffff82be1a88 &lt;virtio_pci_driver+104&gt;) at /home/hawk/Desktop/mqemu/kernel/drivers/base/dd.c:1231</span></span><br><span class="line"><span class="comment">//#13 0xffffffff8193ce97 in bus_add_driver (drv=drv@entry=0xffffffff82be1a88 &lt;virtio_pci_driver+104&gt;) at /home/hawk/Desktop/mqemu/kernel/drivers/base/bus.c:673</span></span><br><span class="line"><span class="comment">//#14 0xffffffff8193f48b in driver_register (drv=0xffffffff82be1a88 &lt;virtio_pci_driver+104&gt;) at /home/hawk/Desktop/mqemu/kernel/drivers/base/driver.c:246</span></span><br><span class="line"><span class="comment">//#15 0xffffffff81001a63 in do_one_initcall (fn=0xffffffff832dfeb0 &lt;virtio_pci_driver_init&gt;) at /home/hawk/Desktop/mqemu/kernel/init/main.c:1238</span></span><br><span class="line"><span class="comment">//#16 0xffffffff8328d1d7 in do_initcall_level (command_line=0xffff88810033a140 &quot;rdinit&quot;, level=6) at /home/hawk/Desktop/mqemu/kernel/init/main.c:1300</span></span><br><span class="line"><span class="comment">//#17 do_initcalls () at /home/hawk/Desktop/mqemu/kernel/init/main.c:1316</span></span><br><span class="line"><span class="comment">//#18 do_basic_setup () at /home/hawk/Desktop/mqemu/kernel/init/main.c:1335</span></span><br><span class="line"><span class="comment">//#19 kernel_init_freeable () at /home/hawk/Desktop/mqemu/kernel/init/main.c:1548</span></span><br><span class="line"><span class="comment">//#20 0xffffffff81f657a5 in kernel_init (unused=&lt;optimized out&gt;) at /home/hawk/Desktop/mqemu/kernel/init/main.c:1437</span></span><br><span class="line"><span class="comment">//#21 0xffffffff810baddf in ret_from_fork (prev=&lt;optimized out&gt;, regs=0xffffc90000013f58, fn=0xffffffff81f65790 &lt;kernel_init&gt;, fn_arg=0x0 &lt;fixed_percpu_data&gt;) at /home/hawk/Desktop/mqemu/kernel/arch/x86/kernel/process.c:147</span></span><br><span class="line"><span class="comment">//#22 0xffffffff8100244a in ret_from_fork_asm () at /home/hawk/Desktop/mqemu/kernel/arch/x86/entry/entry_64.S:243</span></span><br><span class="line"><span class="comment">//#23 0x0000000000000000 in ?? ()</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">virtio_pci_probe</span><span class="params">(<span class="keyword">struct</span> pci_dev *pci_dev,</span></span><br><span class="line"><span class="params">			    <span class="type">const</span> <span class="keyword">struct</span> pci_device_id *id)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">	rc = virtio_pci_modern_probe(vp_dev);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">virtio_pci_modern_probe</span><span class="params">(<span class="keyword">struct</span> virtio_pci_device *vp_dev)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">	err = vp_modern_probe(mdev);</span><br><span class="line">    ...</span><br><span class="line">	vp_dev-&gt;vdev.config = &amp;virtio_pci_config_ops;</span><br><span class="line">	vp_dev-&gt;config_vector = vp_config_vector;</span><br><span class="line">	vp_dev-&gt;setup_vq = setup_vq;</span><br><span class="line">	vp_dev-&gt;del_vq = del_vq;</span><br><span class="line">	vp_dev-&gt;is_avq = vp_is_avq;</span><br><span class="line">	vp_dev-&gt;isr = mdev-&gt;isr;</span><br><span class="line">    ...</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">vp_modern_probe</span><span class="params">(<span class="keyword">struct</span> virtio_pci_modern_device *mdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">	<span class="comment">/* check for a common config: if not, use legacy mode (bar 0). */</span></span><br><span class="line">	common = virtio_pci_find_capability(pci_dev, VIRTIO_PCI_CAP_COMMON_CFG,</span><br><span class="line">					    IORESOURCE_IO | IORESOURCE_MEM,</span><br><span class="line">					    &amp;mdev-&gt;modern_bars);</span><br><span class="line">    ...</span><br><span class="line">	<span class="comment">/* If common is there, these should be too... */</span></span><br><span class="line">	isr = virtio_pci_find_capability(pci_dev, VIRTIO_PCI_CAP_ISR_CFG,</span><br><span class="line">					 IORESOURCE_IO | IORESOURCE_MEM,</span><br><span class="line">					 &amp;mdev-&gt;modern_bars);</span><br><span class="line">	notify = virtio_pci_find_capability(pci_dev, VIRTIO_PCI_CAP_NOTIFY_CFG,</span><br><span class="line">					    IORESOURCE_IO | IORESOURCE_MEM,</span><br><span class="line">					    &amp;mdev-&gt;modern_bars);</span><br><span class="line">    ...</span><br><span class="line">	<span class="comment">/* Device capability is only mandatory for devices that have</span></span><br><span class="line"><span class="comment">	 * device-specific configuration.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	device = virtio_pci_find_capability(pci_dev, VIRTIO_PCI_CAP_DEVICE_CFG,</span><br><span class="line">					    IORESOURCE_IO | IORESOURCE_MEM,</span><br><span class="line">					    &amp;mdev-&gt;modern_bars);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">	mdev-&gt;common = vp_modern_map_capability(mdev, common,</span><br><span class="line">			      <span class="keyword">sizeof</span>(<span class="keyword">struct</span> virtio_pci_common_cfg), <span class="number">4</span>, <span class="number">0</span>,</span><br><span class="line">			      offsetofend(<span class="keyword">struct</span> virtio_pci_modern_common_cfg,</span><br><span class="line">					  admin_queue_num),</span><br><span class="line">			      &amp;mdev-&gt;common_len, <span class="literal">NULL</span>);</span><br><span class="line">    ...</span><br><span class="line">	mdev-&gt;isr = vp_modern_map_capability(mdev, isr, <span class="keyword">sizeof</span>(u8), <span class="number">1</span>,</span><br><span class="line">					     <span class="number">0</span>, <span class="number">1</span>,</span><br><span class="line">					     <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Read notify_off_multiplier from config space. */</span></span><br><span class="line">	pci_read_config_dword(pci_dev,</span><br><span class="line">			      notify + offsetof(<span class="keyword">struct</span> virtio_pci_notify_cap,</span><br><span class="line">						notify_off_multiplier),</span><br><span class="line">			      &amp;mdev-&gt;notify_offset_multiplier);</span><br><span class="line">	<span class="comment">/* Read notify length and offset from config space. */</span></span><br><span class="line">	pci_read_config_dword(pci_dev,</span><br><span class="line">			      notify + offsetof(<span class="keyword">struct</span> virtio_pci_notify_cap,</span><br><span class="line">						cap.length),</span><br><span class="line">			      &amp;notify_length);</span><br><span class="line"></span><br><span class="line">	pci_read_config_dword(pci_dev,</span><br><span class="line">			      notify + offsetof(<span class="keyword">struct</span> virtio_pci_notify_cap,</span><br><span class="line">						cap.offset),</span><br><span class="line">			      &amp;notify_offset);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">	<span class="comment">/* We don&#x27;t know how many VQs we&#x27;ll map, ahead of the time.</span></span><br><span class="line"><span class="comment">	 * If notify length is small, map it all now.</span></span><br><span class="line"><span class="comment">	 * Otherwise, map each VQ individually later.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> ((u64)notify_length + (notify_offset % PAGE_SIZE) &lt;= PAGE_SIZE) &#123;</span><br><span class="line">		mdev-&gt;notify_base = vp_modern_map_capability(mdev, notify,</span><br><span class="line">							     <span class="number">2</span>, <span class="number">2</span>,</span><br><span class="line">							     <span class="number">0</span>, notify_length,</span><br><span class="line">							     &amp;mdev-&gt;notify_len,</span><br><span class="line">							     &amp;mdev-&gt;notify_pa);</span><br><span class="line">		<span class="keyword">if</span> (!mdev-&gt;notify_base)</span><br><span class="line">			<span class="keyword">goto</span> err_map_notify;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		mdev-&gt;notify_map_cap = notify;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Again, we don&#x27;t know how much we should map, but PAGE_SIZE</span></span><br><span class="line"><span class="comment">	 * is more than enough for all existing devices.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (device) &#123;</span><br><span class="line">		mdev-&gt;device = vp_modern_map_capability(mdev, device, <span class="number">0</span>, <span class="number">4</span>,</span><br><span class="line">							<span class="number">0</span>, PAGE_SIZE,</span><br><span class="line">							&amp;mdev-&gt;device_len,</span><br><span class="line">							<span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">if</span> (!mdev-&gt;device)</span><br><span class="line">			<span class="keyword">goto</span> err_map_device;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据<a href="/2024/08/04/qemu%E7%9A%84PCI%E8%AE%BE%E5%A4%87/" title="qemu的PCI设备">qemu的PCI设备</a>可知，<strong>acpi(Advanced Configuration and Power Interface)</strong>驱动会将<strong>PCI配置空间</strong>设置好，接着这里的<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.9-rc2/source/drivers/virtio/virtio_pci_modern_dev.c#L223"><strong>vp_modern_probe()</strong></a>会解析<strong>PCI配置空间</strong>(capability)并解析各个<strong>virtio配置空间</strong>。但此时未进行设置，仅仅注册了<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.9-rc2/source/drivers/virtio/virtio_pci_modern.c#L800"><strong>virtio_pci_config_ops</strong></a>、<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.9-rc2/source/drivers/virtio/virtio_pci_modern.c#L530"><strong>setup_vq()</strong></a>和<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.9-rc2/source/drivers/virtio/virtio_pci_modern.c#L516"><strong>vp_config_vector()</strong></a>的函数指针，等后续<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.9-rc2/source/drivers/net/virtio_net.c#L4624"><strong>virtnet_probe()</strong></a>继续设置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#0  virtnet_probe (vdev=0xffff888100953000) at /home/hawk/Desktop/mqemu/kernel/drivers/net/virtio_net.c:4625</span></span><br><span class="line"><span class="comment">//#1  0xffffffff81692f5e in virtio_dev_probe (_d=0xffff888100953010) at /home/hawk/Desktop/mqemu/kernel/drivers/virtio/virtio.c:311</span></span><br><span class="line"><span class="comment">//#2  0xffffffff8193dd1c in call_driver_probe (drv=0xffffffff82c0ffa0 &lt;virtio_net_driver&gt;, dev=0xffff888100953010) at /home/hawk/Desktop/mqemu/kernel/drivers/base/dd.c:578</span></span><br><span class="line"><span class="comment">//#3  really_probe (dev=dev@entry=0xffff888100953010, drv=drv@entry=0xffffffff82c0ffa0 &lt;virtio_net_driver&gt;) at /home/hawk/Desktop/mqemu/kernel/drivers/base/dd.c:656</span></span><br><span class="line"><span class="comment">//#4  0xffffffff8193df8e in __driver_probe_device (drv=drv@entry=0xffffffff82c0ffa0 &lt;virtio_net_driver&gt;, dev=dev@entry=0xffff888100953010) at /home/hawk/Desktop/mqemu/kernel/drivers/base/dd.c:798</span></span><br><span class="line"><span class="comment">//#5  0xffffffff8193e069 in driver_probe_device (drv=drv@entry=0xffffffff82c0ffa0 &lt;virtio_net_driver&gt;, dev=dev@entry=0xffff888100953010) at /home/hawk/Desktop/mqemu/kernel/drivers/base/dd.c:828</span></span><br><span class="line"><span class="comment">//#6  0xffffffff8193e2e5 in __driver_attach (data=0xffffffff82c0ffa0 &lt;virtio_net_driver&gt;, dev=0xffff888100953010) at /home/hawk/Desktop/mqemu/kernel/drivers/base/dd.c:1214</span></span><br><span class="line"><span class="comment">//#7  __driver_attach (dev=0xffff888100953010, data=0xffffffff82c0ffa0 &lt;virtio_net_driver&gt;) at /home/hawk/Desktop/mqemu/kernel/drivers/base/dd.c:1154</span></span><br><span class="line"><span class="comment">//#8  0xffffffff8193bab7 in bus_for_each_dev (bus=&lt;optimized out&gt;, start=start@entry=0x0 &lt;fixed_percpu_data&gt;, data=data@entry=0xffffffff82c0ffa0 &lt;virtio_net_driver&gt;, fn=fn@entry=0xffffffff8193e260 &lt;__driver_attach&gt;) at /home/hawk/Desktop/mqemu/kernel/drivers/base/bus.c:368</span></span><br><span class="line"><span class="comment">//#9  0xffffffff8193d6f9 in driver_attach (drv=drv@entry=0xffffffff82c0ffa0 &lt;virtio_net_driver&gt;) at /home/hawk/Desktop/mqemu/kernel/drivers/base/dd.c:1231</span></span><br><span class="line"><span class="comment">//#10 0xffffffff8193ce97 in bus_add_driver (drv=drv@entry=0xffffffff82c0ffa0 &lt;virtio_net_driver&gt;) at /home/hawk/Desktop/mqemu/kernel/drivers/base/bus.c:673</span></span><br><span class="line"><span class="comment">//#11 0xffffffff8193f48b in driver_register (drv=drv@entry=0xffffffff82c0ffa0 &lt;virtio_net_driver&gt;) at /home/hawk/Desktop/mqemu/kernel/drivers/base/driver.c:246</span></span><br><span class="line"><span class="comment">//#12 0xffffffff816926bb in register_virtio_driver (driver=driver@entry=0xffffffff82c0ffa0 &lt;virtio_net_driver&gt;) at /home/hawk/Desktop/mqemu/kernel/drivers/virtio/virtio.c:370</span></span><br><span class="line"><span class="comment">//#13 0xffffffff832ea609 in virtio_net_driver_init () at /home/hawk/Desktop/mqemu/kernel/drivers/net/virtio_net.c:5050</span></span><br><span class="line"><span class="comment">//#14 0xffffffff81001a63 in do_one_initcall (fn=0xffffffff832ea580 &lt;virtio_net_driver_init&gt;) at /home/hawk/Desktop/mqemu/kernel/init/main.c:1238</span></span><br><span class="line"><span class="comment">//#15 0xffffffff8328d1d7 in do_initcall_level (command_line=0xffff88810033a140 &quot;rdinit&quot;, level=6) at /home/hawk/Desktop/mqemu/kernel/init/main.c:1300</span></span><br><span class="line"><span class="comment">//#16 do_initcalls () at /home/hawk/Desktop/mqemu/kernel/init/main.c:1316</span></span><br><span class="line"><span class="comment">//#17 do_basic_setup () at /home/hawk/Desktop/mqemu/kernel/init/main.c:1335</span></span><br><span class="line"><span class="comment">//#18 kernel_init_freeable () at /home/hawk/Desktop/mqemu/kernel/init/main.c:1548</span></span><br><span class="line"><span class="comment">//#19 0xffffffff81f657a5 in kernel_init (unused=&lt;optimized out&gt;) at /home/hawk/Desktop/mqemu/kernel/init/main.c:1437</span></span><br><span class="line"><span class="comment">//#20 0xffffffff810baddf in ret_from_fork (prev=&lt;optimized out&gt;, regs=0xffffc90000013f58, fn=0xffffffff81f65790 &lt;kernel_init&gt;, fn_arg=0x0 &lt;fixed_percpu_data&gt;) at /home/hawk/Desktop/mqemu/kernel/arch/x86/kernel/process.c:147</span></span><br><span class="line"><span class="comment">//#21 0xffffffff8100244a in ret_from_fork_asm () at /home/hawk/Desktop/mqemu/kernel/arch/x86/entry/entry_64.S:243</span></span><br><span class="line"><span class="comment">//#22 0x0000000000000000 in ?? ()</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">virtnet_probe</span><span class="params">(<span class="keyword">struct</span> virtio_device *vdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">	dev-&gt;netdev_ops = &amp;virtnet_netdev;</span><br><span class="line">    ...</span><br><span class="line">	<span class="comment">/* Enable multiqueue by default */</span></span><br><span class="line">	<span class="keyword">if</span> (num_online_cpus() &gt;= max_queue_pairs)</span><br><span class="line">		vi-&gt;curr_queue_pairs = max_queue_pairs;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		vi-&gt;curr_queue_pairs = num_online_cpus();</span><br><span class="line">	vi-&gt;max_queue_pairs = max_queue_pairs;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Allocate/initialize the rx/tx queues, and invoke find_vqs */</span></span><br><span class="line">	err = init_vqs(vi);</span><br><span class="line">    ...</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">init_vqs</span><span class="params">(<span class="keyword">struct</span> virtnet_info *vi)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Allocate send &amp; receive queues */</span></span><br><span class="line">	ret = virtnet_alloc_queues(vi);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">	ret = virtnet_find_vqs(vi);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		<span class="keyword">goto</span> err_free;</span><br><span class="line">    ...</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">virtnet_find_vqs</span><span class="params">(<span class="keyword">struct</span> virtnet_info *vi)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* We expect 1 RX virtqueue followed by 1 TX virtqueue, followed by</span></span><br><span class="line"><span class="comment">	 * possible N-1 RX/TX queue pairs used in multiqueue mode, followed by</span></span><br><span class="line"><span class="comment">	 * possible control vq.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	total_vqs = vi-&gt;max_queue_pairs * <span class="number">2</span> +</span><br><span class="line">		    virtio_has_feature(vi-&gt;vdev, VIRTIO_NET_F_CTRL_VQ);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Allocate space for find_vqs parameters */</span></span><br><span class="line">	vqs = kcalloc(total_vqs, <span class="keyword">sizeof</span>(*vqs), GFP_KERNEL);</span><br><span class="line">    ...</span><br><span class="line">	ret = virtio_find_vqs_ctx(vi-&gt;vdev, total_vqs, vqs, callbacks,</span><br><span class="line">				  names, ctx, <span class="literal">NULL</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">virtio_find_vqs_ctx</span><span class="params">(<span class="keyword">struct</span> virtio_device *vdev, <span class="type">unsigned</span> nvqs,</span></span><br><span class="line"><span class="params">			<span class="keyword">struct</span> virtqueue *vqs[], <span class="type">vq_callback_t</span> *callbacks[],</span></span><br><span class="line"><span class="params">			<span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> names[], <span class="type">const</span> <span class="type">bool</span> *ctx,</span></span><br><span class="line"><span class="params">			<span class="keyword">struct</span> irq_affinity *desc)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> vdev-&gt;config-&gt;find_vqs(vdev, nvqs, vqs, callbacks, names, ctx,</span><br><span class="line">				      desc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">vp_modern_find_vqs</span><span class="params">(<span class="keyword">struct</span> virtio_device *vdev, <span class="type">unsigned</span> <span class="type">int</span> nvqs,</span></span><br><span class="line"><span class="params">			      <span class="keyword">struct</span> virtqueue *vqs[],</span></span><br><span class="line"><span class="params">			      <span class="type">vq_callback_t</span> *callbacks[],</span></span><br><span class="line"><span class="params">			      <span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> names[], <span class="type">const</span> <span class="type">bool</span> *ctx,</span></span><br><span class="line"><span class="params">			      <span class="keyword">struct</span> irq_affinity *desc)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">virtio_pci_device</span> *<span class="title">vp_dev</span> =</span> to_vp_device(vdev);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">virtqueue</span> *<span class="title">vq</span>;</span></span><br><span class="line">	<span class="type">int</span> rc = vp_find_vqs(vdev, nvqs, vqs, callbacks, names, ctx, desc);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (rc)</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Select and activate all queues. Has to be done last: once we do</span></span><br><span class="line"><span class="comment">	 * this, there&#x27;s no way to go back except reset.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	list_for_each_entry(vq, &amp;vdev-&gt;vqs, <span class="built_in">list</span>)</span><br><span class="line">		vp_modern_set_queue_enable(&amp;vp_dev-&gt;mdev, vq-&gt;index, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">vp_find_vqs</span><span class="params">(<span class="keyword">struct</span> virtio_device *vdev, <span class="type">unsigned</span> <span class="type">int</span> nvqs,</span></span><br><span class="line"><span class="params">		<span class="keyword">struct</span> virtqueue *vqs[], <span class="type">vq_callback_t</span> *callbacks[],</span></span><br><span class="line"><span class="params">		<span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> names[], <span class="type">const</span> <span class="type">bool</span> *ctx,</span></span><br><span class="line"><span class="params">		<span class="keyword">struct</span> irq_affinity *desc)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* Try MSI-X with one vector per queue. */</span></span><br><span class="line">	err = vp_find_vqs_msix(vdev, nvqs, vqs, callbacks, names, <span class="literal">true</span>, ctx, desc);</span><br><span class="line">	<span class="keyword">if</span> (!err)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">vp_find_vqs_msix</span><span class="params">(<span class="keyword">struct</span> virtio_device *vdev, <span class="type">unsigned</span> <span class="type">int</span> nvqs,</span></span><br><span class="line"><span class="params">		<span class="keyword">struct</span> virtqueue *vqs[], <span class="type">vq_callback_t</span> *callbacks[],</span></span><br><span class="line"><span class="params">		<span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> names[], <span class="type">bool</span> per_vq_vectors,</span></span><br><span class="line"><span class="params">		<span class="type">const</span> <span class="type">bool</span> *ctx,</span></span><br><span class="line"><span class="params">		<span class="keyword">struct</span> irq_affinity *desc)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">	allocated_vectors = vp_dev-&gt;msix_used_vectors;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nvqs; ++i) &#123;</span><br><span class="line">        ...</span><br><span class="line">		vqs[i] = vp_setup_vq(vdev, queue_idx++, callbacks[i], names[i],</span><br><span class="line">				     ctx ? ctx[i] : <span class="literal">false</span>,</span><br><span class="line">				     msix_vec);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> virtqueue *<span class="title function_">vp_setup_vq</span><span class="params">(<span class="keyword">struct</span> virtio_device *vdev, <span class="type">unsigned</span> <span class="type">int</span> index,</span></span><br><span class="line"><span class="params">				     <span class="type">void</span> (*callback)(<span class="keyword">struct</span> virtqueue *vq),</span></span><br><span class="line"><span class="params">				     <span class="type">const</span> <span class="type">char</span> *name,</span></span><br><span class="line"><span class="params">				     <span class="type">bool</span> ctx,</span></span><br><span class="line"><span class="params">				     u16 msix_vec)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">	vq = vp_dev-&gt;setup_vq(vp_dev, info, index, callback, name, ctx,</span><br><span class="line">			      msix_vec);</span><br><span class="line">	info-&gt;vq = vq;</span><br><span class="line">    ...</span><br><span class="line">	vp_dev-&gt;vqs[index] = info;</span><br><span class="line">	<span class="keyword">return</span> vq;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> virtqueue *<span class="title function_">setup_vq</span><span class="params">(<span class="keyword">struct</span> virtio_pci_device *vp_dev,</span></span><br><span class="line"><span class="params">				  <span class="keyword">struct</span> virtio_pci_vq_info *info,</span></span><br><span class="line"><span class="params">				  <span class="type">unsigned</span> <span class="type">int</span> index,</span></span><br><span class="line"><span class="params">				  <span class="type">void</span> (*callback)(<span class="keyword">struct</span> virtqueue *vq),</span></span><br><span class="line"><span class="params">				  <span class="type">const</span> <span class="type">char</span> *name,</span></span><br><span class="line"><span class="params">				  <span class="type">bool</span> ctx,</span></span><br><span class="line"><span class="params">				  u16 msix_vec)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">	<span class="comment">/* create the vring */</span></span><br><span class="line">	vq = vring_create_virtqueue(index, num,</span><br><span class="line">				    SMP_CACHE_BYTES, &amp;vp_dev-&gt;vdev,</span><br><span class="line">				    <span class="literal">true</span>, <span class="literal">true</span>, ctx,</span><br><span class="line">				    notify, callback, name);</span><br><span class="line">    ...</span><br><span class="line">	err = vp_active_vq(vq, msix_vec);</span><br><span class="line">    ...</span><br><span class="line">	vq-&gt;priv = (<span class="type">void</span> __force *)vp_modern_map_vq_notify(mdev, index, <span class="literal">NULL</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">vp_active_vq</span><span class="params">(<span class="keyword">struct</span> virtqueue *vq, u16 msix_vec)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">virtio_pci_device</span> *<span class="title">vp_dev</span> =</span> to_vp_device(vq-&gt;vdev);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">virtio_pci_modern_device</span> *<span class="title">mdev</span> =</span> &amp;vp_dev-&gt;mdev;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> index;</span><br><span class="line"></span><br><span class="line">	index = vq-&gt;index;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* activate the queue */</span></span><br><span class="line">	vp_modern_set_queue_size(mdev, index, virtqueue_get_vring_size(vq));</span><br><span class="line">	vp_modern_queue_address(mdev, index, virtqueue_get_desc_addr(vq),</span><br><span class="line">				virtqueue_get_avail_addr(vq),</span><br><span class="line">				virtqueue_get_used_addr(vq));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (msix_vec != VIRTIO_MSI_NO_VECTOR) &#123;</span><br><span class="line">		msix_vec = vp_modern_queue_vector(mdev, index, msix_vec);</span><br><span class="line">		<span class="keyword">if</span> (msix_vec == VIRTIO_MSI_NO_VECTOR)</span><br><span class="line">			<span class="keyword">return</span> -EBUSY;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vp_modern_set_queue_size</span><span class="params">(<span class="keyword">struct</span> virtio_pci_modern_device *mdev, u16 index, u16 size)</span></span><br><span class="line">&#123;</span><br><span class="line">	vp_iowrite16(index, &amp;mdev-&gt;common-&gt;queue_select);</span><br><span class="line">	vp_iowrite16(size, &amp;mdev-&gt;common-&gt;queue_size);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vp_modern_queue_address</span><span class="params">(<span class="keyword">struct</span> virtio_pci_modern_device *mdev,</span></span><br><span class="line"><span class="params">			     u16 index, u64 desc_addr, u64 driver_addr,</span></span><br><span class="line"><span class="params">			     u64 device_addr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">virtio_pci_common_cfg</span> __<span class="title">iomem</span> *<span class="title">cfg</span> =</span> mdev-&gt;common;</span><br><span class="line"></span><br><span class="line">	vp_iowrite16(index, &amp;cfg-&gt;queue_select);</span><br><span class="line"></span><br><span class="line">	vp_iowrite64_twopart(desc_addr, &amp;cfg-&gt;queue_desc_lo,</span><br><span class="line">			     &amp;cfg-&gt;queue_desc_hi);</span><br><span class="line">	vp_iowrite64_twopart(driver_addr, &amp;cfg-&gt;queue_avail_lo,</span><br><span class="line">			     &amp;cfg-&gt;queue_avail_hi);</span><br><span class="line">	vp_iowrite64_twopart(device_addr, &amp;cfg-&gt;queue_used_lo,</span><br><span class="line">			     &amp;cfg-&gt;queue_used_hi);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vp_modern_set_queue_enable</span><span class="params">(<span class="keyword">struct</span> virtio_pci_modern_device *mdev,</span></span><br><span class="line"><span class="params">				u16 index, <span class="type">bool</span> enable)</span></span><br><span class="line">&#123;</span><br><span class="line">	vp_iowrite16(index, &amp;mdev-&gt;common-&gt;queue_select);</span><br><span class="line">	vp_iowrite16(enable, &amp;mdev-&gt;common-&gt;queue_enable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，这里分配了对应的<strong>virtqueue</strong>数据，并向<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.9-rc2/source/drivers/virtio/virtio_pci_modern_dev.c#L223"><strong>vp_modern_probe()</strong></a>中解析的<strong>VIRTIO_PCI_CAP_COMMON_CFG配置空间</strong>写入对应的信息，符合前面<a href="#virtio组件">virtio设备的virtio组件设置</a>部分的分析</p>
<h2 id="数据处理-1"><a href="#数据处理-1" class="headerlink" title="数据处理"></a>数据处理</h2><h3 id="数据传输-1"><a href="#数据传输-1" class="headerlink" title="数据传输"></a>数据传输</h3><p>根据前面<a href="#数据传输">virtio设备的数据传输</a>章节，由于<strong>guest</strong>的pva就是<strong>qemu</strong>进程空间的<strong>hva</strong>，因此对于<strong>guest</strong>来说，正常访问前面分配的<strong>virtqueue</strong>地址即可和<strong>virtio设备</strong>正常进行数据通信。</p>
<p>这里分析<strong>guest</strong>发送数据的代码来加以确认。在前面<a href="#virtio设置-1">guest的virtio设置</a>小结简单介绍了<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.9-rc2/source/drivers/net/virtio_net.c#L4624"><strong>virtnet_probe()</strong></a>，其中其替换了<strong>struct net_device</strong>结构体的<strong>netdev_ops</strong>字段为<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.9-rc2/source/drivers/net/virtio_net.c#L4169"><strong>virtnet_netdev</strong></a>，如下所示<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">virtnet_probe</span><span class="params">(<span class="keyword">struct</span> virtio_device *vdev)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">dev</span>;</span></span><br><span class="line">    ...</span><br><span class="line">	<span class="comment">/* Allocate ourselves a network device with room for our info */</span></span><br><span class="line">	dev = alloc_etherdev_mq(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> virtnet_info), max_queue_pairs);</span><br><span class="line">	<span class="keyword">if</span> (!dev)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Set up network device as normal. */</span></span><br><span class="line">	dev-&gt;priv_flags |= IFF_UNICAST_FLT | IFF_LIVE_ADDR_CHANGE |</span><br><span class="line">			   IFF_TX_SKB_NO_LINEAR;</span><br><span class="line">	dev-&gt;netdev_ops = &amp;virtnet_netdev;</span><br><span class="line">	dev-&gt;features = NETIF_F_HIGHDMA;</span><br><span class="line"></span><br><span class="line">	dev-&gt;ethtool_ops = &amp;virtnet_ethtool_ops;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_device_ops</span> <span class="title">virtnet_netdev</span> =</span> &#123;</span><br><span class="line">	.ndo_open            = virtnet_open,</span><br><span class="line">	.ndo_stop   	     = virtnet_close,</span><br><span class="line">	.ndo_start_xmit      = start_xmit,</span><br><span class="line">	.ndo_validate_addr   = eth_validate_addr,</span><br><span class="line">	.ndo_set_mac_address = virtnet_set_mac_address,</span><br><span class="line">	.ndo_set_rx_mode     = virtnet_set_rx_mode,</span><br><span class="line">	.ndo_get_stats64     = virtnet_stats,</span><br><span class="line">	.ndo_vlan_rx_add_vid = virtnet_vlan_rx_add_vid,</span><br><span class="line">	.ndo_vlan_rx_kill_vid = virtnet_vlan_rx_kill_vid,</span><br><span class="line">	.ndo_bpf		= virtnet_xdp,</span><br><span class="line">	.ndo_xdp_xmit		= virtnet_xdp_xmit,</span><br><span class="line">	.ndo_features_check	= passthru_features_check,</span><br><span class="line">	.ndo_get_phys_port_name	= virtnet_get_phys_port_name,</span><br><span class="line">	.ndo_set_features	= virtnet_set_features,</span><br><span class="line">	.ndo_tx_timeout		= virtnet_tx_timeout,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>其中<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.9-rc2/source/drivers/net/virtio_net.c#L2402"><strong>start_xmit</strong></a>就是发送数据包的回调函数，如下所示<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#0  0xffffffff816969a8 in virtqueue_add (gfp=&lt;optimized out&gt;, ctx=&lt;optimized out&gt;, data=&lt;optimized out&gt;, in_sgs=0, out_sgs=1, total_sg=1, sgs=0xffffc90000003b98, _vq=0xffff88810096f900) at /home/hawk/Desktop/mqemu/kernel/drivers/virtio/virtio_ring.c:2209</span></span><br><span class="line"><span class="comment">//#1  virtqueue_add_outbuf (vq=0xffff88810096f900, sg=sg@entry=0xffff888100370808, num=1, data=data@entry=0xffff88801cefb500, gfp=gfp@entry=2080) at /home/hawk/Desktop/mqemu/kernel/drivers/virtio/virtio_ring.c:2267</span></span><br><span class="line"><span class="comment">//#2  0xffffffff819ed584 in xmit_skb (skb=0xffff88801cefb500, sq=0xffff888100370800) at /home/hawk/Desktop/mqemu/kernel/drivers/net/virtio_net.c:2399</span></span><br><span class="line"><span class="comment">//#3  start_xmit (skb=0xffff88801cefb500, dev=0xffff88810793c000) at /home/hawk/Desktop/mqemu/kernel/drivers/net/virtio_net.c:2426</span></span><br><span class="line"><span class="comment">//#4  0xffffffff81c11797 in __netdev_start_xmit (more=false, dev=0xffff88810793c000, skb=0xffff88801cefb500, ops=&lt;optimized out&gt;) at /home/hawk/Desktop/mqemu/kernel/include/linux/netdevice.h:4903</span></span><br><span class="line"><span class="comment">//#5  netdev_start_xmit (more=false, txq=0xffff88810080f200, dev=0xffff88810793c000, skb=0xffff88801cefb500) at /home/hawk/Desktop/mqemu/kernel/include/linux/netdevice.h:4917</span></span><br><span class="line"><span class="comment">//#6  xmit_one (more=false, txq=0xffff88810080f200, dev=0xffff88810793c000, skb=0xffff88801cefb500) at /home/hawk/Desktop/mqemu/kernel/net/core/dev.c:3531</span></span><br><span class="line"><span class="comment">//#7  dev_hard_start_xmit (first=first@entry=0xffff88801cefb500, dev=dev@entry=0xffff88810793c000, txq=txq@entry=0xffff88810080f200, ret=ret@entry=0xffffc90000003c64) at /home/hawk/Desktop/mqemu/kernel/net/core/dev.c:3547</span></span><br><span class="line"><span class="comment">//#8  0xffffffff81c66525 in sch_direct_xmit (skb=skb@entry=0xffff88801cefb500, q=q@entry=0xffff8880289bbc00, dev=dev@entry=0xffff88810793c000, txq=txq@entry=0xffff88810080f200, root_lock=root_lock@entry=0x0 &lt;fixed_percpu_data&gt;, validate=validate@entry=true) at /home/hawk/Desktop/mqemu/kernel/net/sched/sch_generic.c:343</span></span><br><span class="line"><span class="comment">//#9  0xffffffff81c11e7e in __dev_xmit_skb (txq=0xffff88810080f200, dev=0xffff88810793c000, q=0xffff8880289bbc00, skb=0xffff88801cefb500) at /home/hawk/Desktop/mqemu/kernel/net/core/dev.c:3760</span></span><br><span class="line"><span class="comment">//#10 __dev_queue_xmit (skb=skb@entry=0xffff88801cefb500, sb_dev=sb_dev@entry=0x0 &lt;fixed_percpu_data&gt;) at /home/hawk/Desktop/mqemu/kernel/net/core/dev.c:4301</span></span><br><span class="line"><span class="comment">//#11 0xffffffff81d6d34a in dev_queue_xmit (skb=0xffff88801cefb500) at /home/hawk/Desktop/mqemu/kernel/include/linux/netdevice.h:3091</span></span><br><span class="line"><span class="comment">//#12 neigh_hh_output (skb=&lt;optimized out&gt;, hh=&lt;optimized out&gt;) at /home/hawk/Desktop/mqemu/kernel/include/net/neighbour.h:526</span></span><br><span class="line"><span class="comment">//#13 neigh_output (skip_cache=false, skb=0xffff88801cefb500, n=0xffff888028686800) at /home/hawk/Desktop/mqemu/kernel/include/net/neighbour.h:540</span></span><br><span class="line"><span class="comment">//#14 ip6_finish_output2 (net=&lt;optimized out&gt;, sk=&lt;optimized out&gt;, skb=0xffff88801cefb500) at /home/hawk/Desktop/mqemu/kernel/net/ipv6/ip6_output.c:137</span></span><br><span class="line"><span class="comment">//#15 0xffffffff81d949a5 in ndisc_send_skb (skb=0xffff88801cefb500, daddr=&lt;optimized out&gt;, saddr=0xffffc90000003e80) at /home/hawk/Desktop/mqemu/kernel/net/ipv6/ndisc.c:509</span></span><br><span class="line"><span class="comment">//#16 0xffffffff81d97afa in ndisc_send_rs (dev=&lt;optimized out&gt;, saddr=&lt;optimized out&gt;, daddr=&lt;optimized out&gt;) at /home/hawk/Desktop/mqemu/kernel/net/ipv6/ndisc.c:719</span></span><br><span class="line"><span class="comment">//#17 0xffffffff81d7c143 in addrconf_rs_timer (t=0xffff8881070a63b0) at /home/hawk/Desktop/mqemu/kernel/net/ipv6/addrconf.c:4037</span></span><br><span class="line"><span class="comment">//#18 0xffffffff811b64a5 in call_timer_fn (timer=timer@entry=0xffff8881070a63b0, fn=fn@entry=0xffffffff81d7c070 &lt;addrconf_rs_timer&gt;, baseclk=baseclk@entry=4294687232) at /home/hawk/Desktop/mqemu/kernel/kernel/time/timer.c:1793</span></span><br><span class="line"><span class="comment">//#19 0xffffffff811b6782 in expire_timers (head=0xffffc90000003f10, base=0xffff88813bc1e1c0) at /home/hawk/Desktop/mqemu/kernel/kernel/time/timer.c:1844</span></span><br><span class="line"><span class="comment">//#20 __run_timers (base=0xffff88813bc1e1c0) at /home/hawk/Desktop/mqemu/kernel/kernel/time/timer.c:2418</span></span><br><span class="line"><span class="comment">//#21 __run_timer_base (base=0xffff88813bc1e1c0) at /home/hawk/Desktop/mqemu/kernel/kernel/time/timer.c:2429</span></span><br><span class="line"><span class="comment">//#22 0xffffffff811b688c in __run_timer_base (base=&lt;optimized out&gt;) at /home/hawk/Desktop/mqemu/kernel/kernel/time/timer.c:2424</span></span><br><span class="line"><span class="comment">//#23 run_timer_base (index=1) at /home/hawk/Desktop/mqemu/kernel/kernel/time/timer.c:2438</span></span><br><span class="line"><span class="comment">//#24 run_timer_softirq (h=&lt;optimized out&gt;) at /home/hawk/Desktop/mqemu/kernel/kernel/time/timer.c:2448</span></span><br><span class="line"><span class="comment">//#25 0xffffffff81f6f6af in __do_softirq () at /home/hawk/Desktop/mqemu/kernel/kernel/softirq.c:554</span></span><br><span class="line"><span class="comment">//#26 0xffffffff8110e814 in invoke_softirq () at /home/hawk/Desktop/mqemu/kernel/kernel/softirq.c:428</span></span><br><span class="line"><span class="comment">//#27 __irq_exit_rcu () at /home/hawk/Desktop/mqemu/kernel/kernel/softirq.c:633</span></span><br><span class="line"><span class="comment">//#28 irq_exit_rcu () at /home/hawk/Desktop/mqemu/kernel/kernel/softirq.c:645</span></span><br><span class="line"><span class="comment">//#29 0xffffffff81f63220 in instr_sysvec_apic_timer_interrupt (regs=0xffffffff82a03de8) at /home/hawk/Desktop/mqemu/kernel/arch/x86/kernel/apic/apic.c:1043</span></span><br><span class="line"><span class="comment">//#30 sysvec_apic_timer_interrupt (regs=0xffffffff82a03de8) at /home/hawk/Desktop/mqemu/kernel/arch/x86/kernel/apic/apic.c:1043</span></span><br><span class="line"><span class="type">static</span> <span class="type">netdev_tx_t</span> <span class="title function_">start_xmit</span><span class="params">(<span class="keyword">struct</span> sk_buff *skb, <span class="keyword">struct</span> net_device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">virtnet_info</span> *<span class="title">vi</span> =</span> netdev_priv(dev);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">send_queue</span> *<span class="title">sq</span> =</span> &amp;vi-&gt;sq[qnum];</span><br><span class="line">    ...</span><br><span class="line">	<span class="comment">/* Try to transmit */</span></span><br><span class="line">	err = xmit_skb(sq, skb);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xmit_skb</span><span class="params">(<span class="keyword">struct</span> send_queue *sq, <span class="keyword">struct</span> sk_buff *skb)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">	<span class="keyword">return</span> virtqueue_add_outbuf(sq-&gt;vq, sq-&gt;sg, num_sg, skb, GFP_ATOMIC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">virtqueue_add_outbuf</span><span class="params">(<span class="keyword">struct</span> virtqueue *vq,</span></span><br><span class="line"><span class="params">			 <span class="keyword">struct</span> scatterlist *sg, <span class="type">unsigned</span> <span class="type">int</span> num,</span></span><br><span class="line"><span class="params">			 <span class="type">void</span> *data,</span></span><br><span class="line"><span class="params">			 <span class="type">gfp_t</span> gfp)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> virtqueue_add(vq, &amp;sg, num, <span class="number">1</span>, <span class="number">0</span>, data, <span class="literal">NULL</span>, gfp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">virtqueue_add</span><span class="params">(<span class="keyword">struct</span> virtqueue *_vq,</span></span><br><span class="line"><span class="params">				<span class="keyword">struct</span> scatterlist *sgs[],</span></span><br><span class="line"><span class="params">				<span class="type">unsigned</span> <span class="type">int</span> total_sg,</span></span><br><span class="line"><span class="params">				<span class="type">unsigned</span> <span class="type">int</span> out_sgs,</span></span><br><span class="line"><span class="params">				<span class="type">unsigned</span> <span class="type">int</span> in_sgs,</span></span><br><span class="line"><span class="params">				<span class="type">void</span> *data,</span></span><br><span class="line"><span class="params">				<span class="type">void</span> *ctx,</span></span><br><span class="line"><span class="params">				<span class="type">gfp_t</span> gfp)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vring_virtqueue</span> *<span class="title">vq</span> =</span> to_vvq(_vq);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> vq-&gt;packed_ring ? virtqueue_add_packed(_vq, sgs, total_sg,</span><br><span class="line">					out_sgs, in_sgs, data, ctx, gfp) :</span><br><span class="line">				 virtqueue_add_split(_vq, sgs, total_sg,</span><br><span class="line">					out_sgs, in_sgs, data, ctx, gfp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">virtqueue_add_split</span><span class="params">(<span class="keyword">struct</span> virtqueue *_vq,</span></span><br><span class="line"><span class="params">				      <span class="keyword">struct</span> scatterlist *sgs[],</span></span><br><span class="line"><span class="params">				      <span class="type">unsigned</span> <span class="type">int</span> total_sg,</span></span><br><span class="line"><span class="params">				      <span class="type">unsigned</span> <span class="type">int</span> out_sgs,</span></span><br><span class="line"><span class="params">				      <span class="type">unsigned</span> <span class="type">int</span> in_sgs,</span></span><br><span class="line"><span class="params">				      <span class="type">void</span> *data,</span></span><br><span class="line"><span class="params">				      <span class="type">void</span> *ctx,</span></span><br><span class="line"><span class="params">				      <span class="type">gfp_t</span> gfp)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">	<span class="type">dma_addr_t</span> addr;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (vring_map_one_sg(vq, sg, DMA_TO_DEVICE, &amp;addr))</span><br><span class="line">		<span class="keyword">goto</span> unmap_release;</span><br><span class="line"></span><br><span class="line">	prev = i;</span><br><span class="line">	<span class="comment">/* Note that we trust indirect descriptor</span></span><br><span class="line"><span class="comment">	 * table since it use stream DMA mapping.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	i = virtqueue_add_desc_split(_vq, desc, i, addr, sg-&gt;length,</span><br><span class="line">				     VRING_DESC_F_NEXT,</span><br><span class="line">				     indirect);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">virtqueue_add_desc_split</span><span class="params">(<span class="keyword">struct</span> virtqueue *vq,</span></span><br><span class="line"><span class="params">						    <span class="keyword">struct</span> vring_desc *desc,</span></span><br><span class="line"><span class="params">						    <span class="type">unsigned</span> <span class="type">int</span> i,</span></span><br><span class="line"><span class="params">						    <span class="type">dma_addr_t</span> addr,</span></span><br><span class="line"><span class="params">						    <span class="type">unsigned</span> <span class="type">int</span> len,</span></span><br><span class="line"><span class="params">						    u16 flags,</span></span><br><span class="line"><span class="params">						    <span class="type">bool</span> indirect)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vring_virtqueue</span> *<span class="title">vring</span> =</span> to_vvq(vq);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vring_desc_extra</span> *<span class="title">extra</span> =</span> vring-&gt;split.desc_extra;</span><br><span class="line">	u16 next;</span><br><span class="line"></span><br><span class="line">	desc[i].flags = cpu_to_virtio16(vq-&gt;vdev, flags);</span><br><span class="line">	desc[i].addr = cpu_to_virtio64(vq-&gt;vdev, addr);</span><br><span class="line">	desc[i].len = cpu_to_virtio32(vq-&gt;vdev, len);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!indirect) &#123;</span><br><span class="line">		next = extra[i].next;</span><br><span class="line">		desc[i].next = cpu_to_virtio16(vq-&gt;vdev, next);</span><br><span class="line"></span><br><span class="line">		extra[i].addr = addr;</span><br><span class="line">		extra[i].len = len;</span><br><span class="line">		extra[i].flags = flags;</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line">		next = virtio16_to_cpu(vq-&gt;vdev, desc[i].next);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这里<strong>virtqueue</strong>就是<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.9-rc2/source/drivers/net/virtio_net.c#L4624"><strong>virtnet_probe()</strong></a>逻辑中绑定的<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">virtnet_find_vqs</span><span class="params">(<span class="keyword">struct</span> virtnet_info *vi)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">	ret = virtio_find_vqs_ctx(vi-&gt;vdev, total_vqs, vqs, callbacks,</span><br><span class="line">				  names, ctx, <span class="literal">NULL</span>);</span><br><span class="line">    ...</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; vi-&gt;max_queue_pairs; i++) &#123;</span><br><span class="line">		vi-&gt;rq[i].vq = vqs[rxq2vq(i)];</span><br><span class="line">		vi-&gt;rq[i].min_buf_len = mergeable_min_buf_len(vi, vi-&gt;rq[i].vq);</span><br><span class="line">		vi-&gt;sq[i].vq = vqs[txq2vq(i)];</span><br><span class="line">	&#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，最后确实是通过<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.9-rc2/source/drivers/virtio/virtio_ring.c#L2197"><strong>virtqueue_add()</strong></a>向<strong>virtqueue</strong>内存处读写完成数据传输。</p>
<h3 id="数据通知-1"><a href="#数据通知-1" class="headerlink" title="数据通知"></a><del>数据通知</del></h3><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a target="_blank" rel="noopener" href="https://blogs.oracle.com/linux/post/introduction-to-virtio">Introduction to VirtIO</a></li>
<li><a target="_blank" rel="noopener" href="https://tinylab.org/virtio-intro/">半虚拟化技术 - VIRTIO 简介</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/virtio-v1.2.html">Virtual I/O Device (VIRTIO) Version 1.2</a></li>
<li><a target="_blank" rel="noopener" href="http://wiki.osdev.org/Virtio">Virtio</a></li>
<li><a target="_blank" rel="noopener" href="https://www.redhat.com/en/blog/virtqueues-and-virtio-ring-how-data-travels">Virtqueues and virtio ring: How the data travels</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/LoyenWang/p/14589296.html">【原创】Linux虚拟化KVM-Qemu分析（十一）之virtqueue</a></li>
<li><a target="_blank" rel="noopener" href="https://www.openeuler.org/zh/blog/yorifang/virtio-spec-overview.html">Virtio协议概述</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/huang987246510/article/details/103379926">VirtIO实现原理——PCI基础</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/haiyonghao/p/14440743.html">qemu-kvm的ioeventfd机制</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/haiyonghao/p/14440723.html">qemu-kvm的irqfd机制</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/read/cv22112391/">深入分析Linux虚拟化KVM-Qemu之ioeventfd与irqfd</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/haiyonghao/p/14440424.html">中断虚拟化-内核端(一)</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/home19900111/article/details/128610752">KVM IO虚拟化</a></li>
<li><a target="_blank" rel="noopener" href="https://richardweiyang-2.gitbook.io/understanding_qemu/00-advance_interrupt_controller/02-qemu_kernel_emulate">Qemu/kernel混合模拟</a></li>
<li><a target="_blank" rel="noopener" href="http://liujunming.top/pdf/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3MSI-X%E4%B8%AD%E6%96%AD%E5%92%8C%E4%B8%AD%E6%96%AD%E8%99%9A%E6%8B%9F%E5%8C%96.pdf">深入理解 MSI/MSI-X 中断和中断虚拟化</a></li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">H4wk1ns</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://jiaweihawk.github.io/2024/08/23/virtio%E7%AE%80%E4%BB%8B/">https://jiaweihawk.github.io/2024/08/23/virtio简介/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://jiaweihawk.github.io" target="_blank">H4wk1ns's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/qemu/">qemu</a><a class="post-meta__tags" href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/">虚拟化</a></div><div class="post_share"><div class="social-share" data-image="/img/background.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2024/08/04/qemu%E7%9A%84PCI%E8%AE%BE%E5%A4%87/"><img class="prev-cover" src="/img/background.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">qemu的PCI设备</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/04/08/qemu基本知识/" title="qemu基本知识"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-08</div><div class="title">qemu基本知识</div></div></a></div><div><a href="/2024/07/20/qemu内存模型/" title="qemu内存模型"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-20</div><div class="title">qemu内存模型</div></div></a></div><div><a href="/2024/07/31/qemu设备模型/" title="qemu设备模型"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-31</div><div class="title">qemu设备模型</div></div></a></div><div><a href="/2024/08/04/qemu的PCI设备/" title="qemu的PCI设备"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-04</div><div class="title">qemu的PCI设备</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/profile.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">H4wk1ns</div><div class="author-info__description">coder && ctfer</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">45</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/jiaweihawk"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="/static/cv/cv_zh.pdf" target="_blank" title="个人简历"><i class="fa-solid fa-file-pdf"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#virtio%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.</span> <span class="toc-text">virtio协议</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#virtqueue"><span class="toc-number">2.1.</span> <span class="toc-text">virtqueue</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#descriptor-table"><span class="toc-number">2.1.1.</span> <span class="toc-text">descriptor table</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#available-ring"><span class="toc-number">2.1.2.</span> <span class="toc-text">available ring</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#used-ring"><span class="toc-number">2.1.3.</span> <span class="toc-text">used ring</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#device-configuration-space"><span class="toc-number">2.2.</span> <span class="toc-text">device configuration space</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#notifications"><span class="toc-number">2.3.</span> <span class="toc-text">notifications</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E5%8F%98%E6%9B%B4%E9%80%9A%E7%9F%A5"><span class="toc-number">2.3.1.</span> <span class="toc-text">设备变更通知</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%B2%E7%94%A8buffer%E9%80%9A%E7%9F%A5"><span class="toc-number">2.3.2.</span> <span class="toc-text">已用buffer通知</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E7%94%A8buffer%E9%80%9A%E7%9F%A5"><span class="toc-number">2.3.3.</span> <span class="toc-text">可用buffer通知</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#device-status-field"><span class="toc-number">2.4.</span> <span class="toc-text">device status field</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ACKNOWLEDGE"><span class="toc-number">2.4.1.</span> <span class="toc-text">ACKNOWLEDGE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DRIVER"><span class="toc-number">2.4.2.</span> <span class="toc-text">DRIVER</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FAILED"><span class="toc-number">2.4.3.</span> <span class="toc-text">FAILED</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FEATURES-OK"><span class="toc-number">2.4.4.</span> <span class="toc-text">FEATURES_OK</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DRIVER-OK"><span class="toc-number">2.4.5.</span> <span class="toc-text">DRIVER_OK</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DEVICE-NEEDS-RESET"><span class="toc-number">2.4.6.</span> <span class="toc-text">DEVICE_NEEDS_RESET</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#feature-bits"><span class="toc-number">2.5.</span> <span class="toc-text">feature bits</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#virtio-transport"><span class="toc-number">3.</span> <span class="toc-text">virtio transport</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#capability"><span class="toc-number">3.1.</span> <span class="toc-text">capability</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%A9%BA%E9%97%B4"><span class="toc-number">3.2.</span> <span class="toc-text">配置空间</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#virtio%E8%AE%BE%E5%A4%87"><span class="toc-number">4.</span> <span class="toc-text">virtio设备</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">4.1.</span> <span class="toc-text">初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">4.1.1.</span> <span class="toc-text">类初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">4.1.2.</span> <span class="toc-text">对象初始化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="toc-number">4.2.</span> <span class="toc-text">实例化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#virtio%E8%AE%BE%E7%BD%AE"><span class="toc-number">4.3.</span> <span class="toc-text">virtio设置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#virtio%E7%BB%93%E6%9E%84%E7%9A%84%E9%85%8D%E7%BD%AE%E7%A9%BA%E9%97%B4"><span class="toc-number">4.3.1.</span> <span class="toc-text">virtio结构的配置空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#virtio%E7%BB%84%E4%BB%B6"><span class="toc-number">4.3.2.</span> <span class="toc-text">virtio组件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><span class="toc-number">4.4.</span> <span class="toc-text">数据处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93"><span class="toc-number">4.4.1.</span> <span class="toc-text">数据传输</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%80%9A%E7%9F%A5"><span class="toc-number">4.4.2.</span> <span class="toc-text">数据通知</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E7%9F%A5%E8%AE%BE%E5%A4%87"><span class="toc-number">4.4.2.1.</span> <span class="toc-text">通知设备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E7%9F%A5guest"><span class="toc-number">4.4.2.2.</span> <span class="toc-text">通知guest</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#virtio%E9%A9%B1%E5%8A%A8"><span class="toc-number">5.</span> <span class="toc-text">virtio驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#virtio%E8%AE%BE%E7%BD%AE-1"><span class="toc-number">5.1.</span> <span class="toc-text">virtio设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86-1"><span class="toc-number">5.2.</span> <span class="toc-text">数据处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93-1"><span class="toc-number">5.2.1.</span> <span class="toc-text">数据传输</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%80%9A%E7%9F%A5-1"><span class="toc-number">5.2.2.</span> <span class="toc-text">数据通知</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/23/virtio%E7%AE%80%E4%BB%8B/" title="virtio简介">virtio简介</a><time datetime="2024-08-23T15:05:52.000Z" title="发表于 2024-08-23 23:05:52">2024-08-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/04/qemu%E7%9A%84PCI%E8%AE%BE%E5%A4%87/" title="qemu的PCI设备">qemu的PCI设备</a><time datetime="2024-08-04T04:33:06.000Z" title="发表于 2024-08-04 12:33:06">2024-08-04</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/31/qemu%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B/" title="qemu设备模型">qemu设备模型</a><time datetime="2024-07-31T15:38:12.000Z" title="发表于 2024-07-31 23:38:12">2024-07-31</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/20/qemu%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" title="qemu内存模型">qemu内存模型</a><time datetime="2024-07-20T01:37:13.000Z" title="发表于 2024-07-20 09:37:13">2024-07-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/04/14/%E7%BD%91%E5%8D%A1%E4%B8%8E%E7%BD%91%E7%BB%9C%E6%A0%88/" title="网卡与网络栈">网卡与网络栈</a><time datetime="2024-04-14T10:24:48.000Z" title="发表于 2024-04-14 18:24:48">2024-04-14</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2024 By H4wk1ns</div><div class="footer_custom_text">come to hack me!!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    loader: {
      source: {
        '[tex]/amsCd': '[tex]/amscd'
      }
    },
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        addClass: [200,() => {
          document.querySelectorAll('mjx-container:not([display=\'true\']').forEach( node => {
            const target = node.parentNode
            if (!target.classList.contains('has-jax')) {
              target.classList.add('mathjax-overflow')
            }
          })
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>